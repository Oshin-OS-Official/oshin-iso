(()=>{var e={350:function(){"undefined"!=typeof window&&(window.findAndReplaceDOMText=function(){var e="first",t=document,s={}.hasOwnProperty;function i(){return a.apply(null,arguments)||o.apply(null,arguments)}function a(e,t,s,a,r){if(t&&!t.nodeType&&arguments.length<=2)return!1;var n,l="function"==typeof s;l&&(n=s,s=function(e,t){return n(e.text,t.startIndex)});var d=o(t,{find:e,wrap:l?null:s,replace:l?s:"$"+(a||"&"),prepMatch:function(e,t){if(!e[0])throw"findAndReplaceDOMText cannot handle zero-length matches";if(a>0){var s=e[a];e.index+=e[0].indexOf(s),e[0]=s}return e.endIndex=e.index+e[0].length,e.startIndex=e.index,e.index=t,e},filterElements:r});return i.revert=function(){return d.revert()},!0}function o(e,t){return new r(e,t)}function r(e,t){var a=t.preset&&i.PRESETS[t.preset];if(t.portionMode=t.portionMode||"retain",a)for(var o in a)s.call(a,o)&&!s.call(t,o)&&(t[o]=a[o]);this.node=e,this.options=t,this.prepMatch=t.prepMatch||this.prepMatch,this.reverts=[],this.matches=this.search(),this.matches.length&&this.processMatches()}return i.NON_PROSE_ELEMENTS={br:1,hr:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1},i.NON_CONTIGUOUS_PROSE_ELEMENTS={address:1,article:1,aside:1,blockquote:1,dd:1,div:1,dl:1,fieldset:1,figcaption:1,figure:1,footer:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,header:1,hgroup:1,hr:1,main:1,nav:1,noscript:1,ol:1,output:1,p:1,pre:1,section:1,ul:1,br:1,li:1,summary:1,dt:1,details:1,rp:1,rt:1,rtc:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1,table:1,tbody:1,thead:1,th:1,tr:1,td:1,caption:1,col:1,tfoot:1,colgroup:1},i.NON_INLINE_PROSE=function(e){return s.call(i.NON_CONTIGUOUS_PROSE_ELEMENTS,e.nodeName.toLowerCase())},i.PRESETS={prose:{forceContext:i.NON_INLINE_PROSE,filterElements:function(e){return!s.call(i.NON_PROSE_ELEMENTS,e.nodeName.toLowerCase())}}},i.Finder=r,r.prototype={search:function(){var e,t=0,s=0,i=this.options.find,a=this.getAggregateText(),o=[],r=this;return i="string"==typeof i?RegExp(String(i).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"g"):i,function a(n){for(var l=0,d=n.length;l<d;++l){var u=n[l];if("string"==typeof u){if(i.global)for(;e=i.exec(u);)o.push(r.prepMatch(e,t++,s));else(e=u.match(i))&&o.push(r.prepMatch(e,0,s));s+=u.length}else a(u)}}(a),o},prepMatch:function(e,t,s){if(!e[0])throw new Error("findAndReplaceDOMText cannot handle zero-length matches");return e.endIndex=s+e.index+e[0].length,e.startIndex=s+e.index,e.index=t,e},getAggregateText:function(){var e=this.options.filterElements,t=this.options.forceContext;return function s(i){if(i.nodeType===Node.TEXT_NODE)return[i.data];if(e&&!e(i))return[];var a=[""],o=0;if(i=i.firstChild)do{if(i.nodeType!==Node.TEXT_NODE){var r=s(i);t&&i.nodeType===Node.ELEMENT_NODE&&(!0===t||t(i))?(a[++o]=r,a[++o]=""):("string"==typeof r[0]&&(a[o]+=r.shift()),r.length&&(a[++o]=r,a[++o]=""))}else a[o]+=i.data}while(i=i.nextSibling);return a}(this.node)},processMatches:function(){var e,t,s,i=this.matches,a=this.node,o=this.options.filterElements,r=[],n=a,l=i.shift(),d=0,u=0,c=[a];e:for(;;){if(n.nodeType===Node.TEXT_NODE&&(!t&&n.length+d>=l.endIndex?t={node:n,index:u++,text:n.data.substring(l.startIndex-d,l.endIndex-d),indexInMatch:0===d?0:d-l.startIndex,indexInNode:l.startIndex-d,endIndexInNode:l.endIndex-d,isEnd:!0}:e&&r.push({node:n,index:u++,text:n.data,indexInMatch:d-l.startIndex,indexInNode:0}),!e&&n.length+d>l.startIndex&&(e={node:n,index:u++,indexInMatch:0,indexInNode:l.startIndex-d,endIndexInNode:l.endIndex-d,text:n.data.substring(l.startIndex-d,l.endIndex-d)}),d+=n.data.length),s=n.nodeType===Node.ELEMENT_NODE&&o&&!o(n),e&&t){if(n=this.replaceMatch(l,e,r,t),d-=t.node.data.length-t.endIndexInNode,e=null,t=null,r=[],u=0,!(l=i.shift()))break}else if(!s&&(n.firstChild||n.nextSibling)){n.firstChild?(c.push(n),n=n.firstChild):n=n.nextSibling;continue}for(;;){if(n.nextSibling){n=n.nextSibling;break}if((n=c.pop())===a)break e}}},revert:function(){for(var e=this.reverts.length;e--;)this.reverts[e]();this.reverts=[]},prepareReplacementString:function(t,s,i){var a=this.options.portionMode;return a===e&&s.indexInMatch>0?"":(t=t.replace(/\$(\d+|&|`|')/g,(function(e,t){var s;switch(t){case"&":s=i[0];break;case"`":s=i.input.substring(0,i.startIndex);break;case"'":s=i.input.substring(i.endIndex);break;default:s=i[+t]||""}return s})),a===e?t:s.isEnd?t.substring(s.indexInMatch):t.substring(s.indexInMatch,s.indexInMatch+s.text.length))},getPortionReplacementNode:function(e,s){var i=this.options.replace||"$&";if("function"==typeof i)return(i=i(e,s))&&i.nodeType?i:t.createTextNode(String(i))},replaceMatch:function(e,s,i,a){var o,r,n=s.node,l=a.node;if(n===l){var d=n;s.indexInNode>0&&(o=t.createTextNode(d.data.substring(0,s.indexInNode)),d.parentNode.insertBefore(o,d));var u=this.getPortionReplacementNode(a,e);return d.parentNode.insertBefore(u,d),a.endIndexInNode<d.length&&(r=t.createTextNode(d.data.substring(a.endIndexInNode)),d.parentNode.insertBefore(r,d)),d.parentNode.removeChild(d),this.reverts.push((function(){o===u.previousSibling&&o.parentNode.removeChild(o),r===u.nextSibling&&r.parentNode.removeChild(r),u.parentNode.replaceChild(d,u)})),u}o=t.createTextNode(n.data.substring(0,s.indexInNode)),r=t.createTextNode(l.data.substring(a.endIndexInNode));for(var c=this.getPortionReplacementNode(s,e),h=[],p=0,m=i.length;p<m;++p){var g=i[p],f=this.getPortionReplacementNode(g,e);g.node.parentNode.replaceChild(f,g.node),this.reverts.push(function(e,t){return function(){t.parentNode.replaceChild(e.node,t)}}(g,f)),h.push(f)}var S=this.getPortionReplacementNode(a,e);return n.parentNode.insertBefore(o,n),n.parentNode.insertBefore(c,n),n.parentNode.removeChild(n),l.parentNode.insertBefore(S,l),l.parentNode.insertBefore(r,l),l.parentNode.removeChild(l),this.reverts.push((function(){o.parentNode.removeChild(o),c.parentNode.replaceChild(n,c),r.parentNode.removeChild(r),S.parentNode.replaceChild(l,S)})),S}},i}())}},t={};function s(i){var a=t[i];if(void 0!==a)return a.exports;var o=t[i]={exports:{}};return e[i].call(o.exports,o,o.exports,s),o.exports}(()=>{"use strict";function e(e,s=document){return t(e,s,"querySelector")}function t(e,t=document,s="querySelector"){let i;const a=e.split(">>>");if(1==a.length)return t[s](e);for(;a.length;){if(!t)return null;{const e=a.shift().trim();if(0==a.length)return t[s](e);if(i=t.querySelector(e),!i)return null;t=i.shadowRoot}}}function i(e,s=document){return t(e,s,"querySelectorAll")}function a(e,t=1){return e?t>0?a(e.parentElement,t-1):e:null}function o(e,t=3){const[s="0",i="0",a="0"]=(e||"0:0:0").split(":"),o=parseInt(s,10)||0,r=parseInt(i,10)||0,n=parseFloat(a)||0;return parseFloat((3600*o+60*r+n).toFixed(t))}function r(e){return`[${e.toString().replace(/,/g,", ")}]`}function n(e){return"string"==typeof e&&(e=[e]),e}class l{static ALL_WORDS_WORDLIST_ID=0;static BUILD_TARGET_BOOKMARKLET="bookmarklet";static BUILD_TARGET_CHROME="chrome";static BUILD_TARGET_FIREFOX="firefox";static DOMAIN_MODES={NORMAL:0,ADVANCED:1,DEEP:2};static FALSE=0;static FILTER_METHODS={CENSOR:0,SUBSTITUTE:1,REMOVE:2,OFF:3};static LOGGING_LEVELS={DEBUG:0,INFO:1,WARN:2,ERROR:3};static MATCH_METHODS={EXACT:0,PARTIAL:1,WHOLE:2,REGEX:3};static MESSAGING={BACKGROUND:"background",CONTEXT:"context",OPTION:"option",POPUP:"popup"};static STATS_TYPE_TEXT="text";static STATUS={DISABLED:0,NORMAL:1,ADVANCED:2,DEEP:3};static TAB_DISABLE_ONCE={NOT_SET:0,DISABLED:1,WILL_DISABLE:2};static TOP_WINDOW_FRAME_ID=0;static TRUE=1;static filterMethodName(e){return this.nameById(this.FILTER_METHODS,e)}static loggingLevelName(e){return this.nameByValue(this.LOGGING_LEVELS,e)}static matchMethodName(e){return this.nameById(this.MATCH_METHODS,e)}static nameById(e,t){return function(e,t=!0){let s=e.charAt(0).toUpperCase();return s+=t?e.toLowerCase().slice(1):e.slice(1),s}(Object.entries(e).filter((e=>e[1]===t))[0][0])}static nameByValue(e,t){return Object.keys(e).find((s=>e[s]==t))}static orderedArray(e){const t=[];return Object.values(e).sort().forEach((s=>{t.push(l.nameById(e,s))})),t}}class d extends l{static BUILD_TARGET_IOS="ios";static BUILD_TARGET_SAFARI="safari";static MUTE_METHODS={TAB:0,VIDEO_VOLUME:1,VIDEO_MUTE:2,NONE:9};static SHOW_SUBTITLES={ALL:0,FILTERED:1,UNFILTERED:2,NONE:3};static STATS_TYPE_AUDIO="audio";static STATUS={DISABLED:0,NORMAL:1,ADVANCED:2,DEEP:3,MUTE_PAGE:4,CAPTIONS:5}}class u{level;prefix;static app="APF";static debugLevel=l.LOGGING_LEVELS.DEBUG;static debugName=l.loggingLevelName(this.debugLevel).toLowerCase();static defaultLevel=l.LOGGING_LEVELS.WARN;static errorLevel=l.LOGGING_LEVELS.ERROR;static errorName=l.loggingLevelName(this.errorLevel).toLowerCase();static infoLevel=l.LOGGING_LEVELS.INFO;static infoName=l.loggingLevelName(this.infoLevel).toLowerCase();static warnLevel=l.LOGGING_LEVELS.WARN;static warnName=l.loggingLevelName(this.warnLevel).toLowerCase();static debug(e,...t){this.log(this.debugName,e,t)}static debugTime(e,t=[]){this.logTime(this.debugName,e,t)}static error(e,...t){this.log(this.errorName,e,t)}static errorTime(e,t=[]){this.logTime(this.errorName,e,t)}static info(e,...t){this.log(this.infoName,e,t)}static infoTime(e,t=[]){this.logTime(this.infoName,e,t)}static log(e,t,s=[]){t=`[${u.app}] ${t}`,s.length?console[e](t,s):console[e](t)}static logTime(e,t,s=[]){const i=(new Date).toLocaleString();t=`[${u.app}] ${t}`,s.length?console[e](t,i,s):console[e](t,i)}static warn(e,...t){this.log(this.warnName,e,t)}static warnTime(e,t=[]){this.logTime(this.warnName,e,t)}constructor(e){this.level=u.defaultLevel,this.prefix="",e&&(this.prefix=`[${e}] `)}debug(e,...t){u.debugLevel>=this.level&&u.log(u.debugName,`${this.prefix}${e}`,t)}debugTime(e,...t){u.debugLevel>=this.level&&u.logTime(u.debugName,`${this.prefix}${e}`,t)}error(e,...t){u.errorLevel>=this.level&&u.log(u.errorName,`${this.prefix}${e}`,t)}errorTime(e,...t){u.errorLevel>=this.level&&u.logTime(u.errorName,`${this.prefix}${e}`,t)}info(e,...t){u.infoLevel>=this.level&&u.log(u.infoName,`${this.prefix}${e}`,t)}infoTime(e,...t){u.infoLevel>=this.level&&u.logTime(u.infoName,`${this.prefix}${e}`,t)}setLevel(e){this.level=e}warn(e,...t){u.warnLevel>=this.level&&u.log(u.warnName,`${this.prefix}${e}`,t)}warnTime(e,...t){u.warnLevel>=this.level&&u.logTime(u.warnName,`${this.prefix}${e}`,t)}}class c{censorCharacter;censorFixedLength;defaultSubstitution;defaultWordMatchMethod;defaultWordRepeat;defaultWordSeparators;filterMethod;filterWordList;iWordAllowlist;loggingLevel;preserveCase;preserveFirst;preserveLast;showCounter;showSummary;substitutionMark;wordAllowlist;wordlistId;wordlists;wordlistsEnabled;words;wordSubSeparator;static initializeDefaults(...e){return Object.assign({},this._configDefaults,...e)}static _allWordlists=["All words"];static _configDefaults={censorCharacter:"*",censorFixedLength:0,defaultSubstitution:"censored",defaultWordMatchMethod:l.MATCH_METHODS.EXACT,defaultWordRepeat:l.FALSE,defaultWordSeparators:l.FALSE,filterMethod:l.FILTER_METHODS.SUBSTITUTE,filterWordList:!0,iWordAllowlist:[],loggingLevel:l.LOGGING_LEVELS.WARN,preserveCase:!0,preserveFirst:!0,preserveLast:!1,showCounter:!0,showSummary:!0,substitutionMark:!1,wordAllowlist:[],wordlistId:0,wordlists:["Wordlist 1","Wordlist 2","Wordlist 3","Wordlist 4","Wordlist 5","Wordlist 6"],wordlistsEnabled:!0,words:void 0,wordSubSeparator:";;"};static _defaultWords={ass:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"butt"},asses:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.FALSE,separators:l.FALSE,sub:"butts"},asshole:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"jerk"},badass:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.TRUE,sub:"cool"},bastard:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"idiot"},bitch:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"bench"},cocksucker:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.TRUE,sub:"suckup"},cunt:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"expletive"},dammit:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.FALSE,separators:l.TRUE,sub:"dangit"},damn:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.FALSE,separators:l.FALSE,sub:"dang"},dumbass:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"idiot"},fag:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"gay"},faggot:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"gay"},fags:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"gays"},fuck:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.TRUE,sub:"freak"},goddammit:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.TRUE,sub:"dangit"},hell:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.FALSE,separators:l.FALSE,sub:"heck"},jackass:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.TRUE,sub:"jerk"},nigga:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"bruh"},nigger:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"man"},niggers:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"people"},piss:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"pee"},pissed:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"ticked"},pussies:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"softies"},pussy:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"softie"},shit:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"crap"},slut:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"tramp"},tits:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"chest"},twat:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"dumbo"},twats:{lists:[],matchMethod:l.MATCH_METHODS.EXACT,repeat:l.TRUE,separators:l.FALSE,sub:"dumbos"},whore:{lists:[],matchMethod:l.MATCH_METHODS.PARTIAL,repeat:l.TRUE,separators:l.FALSE,sub:"tramp"}};static _defaults=this.initializeDefaults(this._configDefaults);static _persistableKeys=Object.keys(this._defaults);constructor(e={}){Object.assign(this,c._defaults,e)}get _persistableKeys(){return this.constructor._persistableKeys}addWord(e,t=this.defaultWordOptions()){return e=e.trim(),(t=Object.assign({},this.defaultWordOptions(),t)).matchMethod!==l.MATCH_METHODS.REGEX&&(e=e.toLowerCase()),!Object.keys(this.words).includes(e)&&(t.sub=t.case==l.TRUE?t.sub.trim():t.sub.trim().toLowerCase(),this.words[e]=t,!0)}defaultWordOptions(){return{lists:[],matchMethod:this.defaultWordMatchMethod,repeat:this.defaultWordRepeat,separators:this.defaultWordSeparators,sub:""}}removeWord(e){const t=(e=e.trim()).toLowerCase();return Object.keys(this.words).includes(t)?(delete this.words[t],!0):!!this.words[e]&&(delete this.words[e],!0)}repeatForWord(e){return this.words[e].repeat===l.TRUE||this.words[e].repeat===l.FALSE?this.words[e].repeat:this.defaultWordRepeat}sanitizeWords(){const e={};Object.keys(this.words).sort().forEach((t=>{e[t.trim().toLowerCase()]=this.words[t]})),this.words=e}}const h={config:{},manifestVersion:3,release:!0,target:"chrome",version:"1.0.0"},p=new u("WebConfig");class m extends c{_lastSplitKeys;collectStats;contextMenu;darkMode;domains;enabledDomainsOnly;enabledFramesOnly;password;showUpdateNotification;syncLargeKeys;get Class(){return this.constructor}static BUILD=void 0==={release:!0,config:{muteMethod:null},manifestVersion:3,target:"chrome",version:"3.1.0"}?h:{release:!0,config:{muteMethod:null},manifestVersion:3,target:"chrome",version:"3.1.0"};static _webDefaults={collectStats:!0,contextMenu:!0,darkMode:null,domains:{},enabledDomainsOnly:!1,enabledFramesOnly:!1,password:null,showUpdateNotification:!1,syncLargeKeys:!0};static _defaults=this.initializeDefaults({},this._configDefaults,this._webDefaults);static _persistableKeys=Object.keys(this._defaults);static _localConfigKeys=["domains","syncLargeKeys","words"];static _localOnlyKeys=["background","stats"];static _maxSplitKeys=64;static _largeKeys=["domains","words"];static get _maxBytes(){try{if(chrome.storage.sync.QUOTA_BYTES_PER_ITEM)return Math.round(.98*chrome.storage.sync.QUOTA_BYTES_PER_ITEM);throw"QUOTA_BYTES_PER_ITEM not defined, using default"}catch(e){return 8028}}static chromeStorageAvailable(){return!!("object"==typeof chrome&&chrome.storage&&chrome.storage.sync&&chrome.storage.local)}static combineData(e,t){if(e[t]={},void 0!==e[`_${t}0`]){const s=this.getDataContainerKeys(e,t);return s.forEach((s=>{Object.assign(e[t],e[s]),delete e[s]})),s}}static getDataContainerKeys(e,t){const s=new RegExp(`^_${t}\\d+`);return Object.keys(e).filter((e=>s.test(e))).sort()}static getLocalStorage(e){return"string"==typeof e&&(e=[e]),new Promise(((t,s)=>{chrome.storage.local.get(e,(e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(e)}))}))}static getMaxSplitKeyFromArray(e=[]){if(Array.isArray(e)){const t=e.sort()[e.length-1];if(t){const e=new RegExp("\\d+$"),s=t.match(e);if(s)return parseInt(s[0])}}}static getMaxSplitKeyFromData(e,t){const s=this.getDataContainerKeys(e,t);return this.getMaxSplitKeyFromArray(s)}static getSyncStorage(e){return"string"==typeof e&&(e=[e]),new Promise(((t,s)=>{chrome.storage.sync.get(e,(e=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(e)}))}))}static includesLargeKeys(e){return e.some((e=>this._largeKeys.includes(e)))}static async load(e=[]){e=n(e);const t={};let s;const i=[];let a=[];0===e.length&&(e=this._persistableKeys);try{if(this.includesLargeKeys(e)?(e.includes("syncLargeKeys")||e.push("syncLargeKeys"),this._localConfigKeys.forEach((t=>{e.includes(t)&&i.push(t)})),s=await this.getLocalStorage(i),t.syncLargeKeys=!1===s.syncLargeKeys?s.syncLargeKeys:this._defaults.syncLargeKeys,!1===t.syncLargeKeys?(i.forEach((e=>{void 0===s[e]?t[e]="words"===e?this._defaultWords:this._defaults[e]:t[e]=s[e]})),a=e.filter((e=>!this._localConfigKeys.includes(e)))):a=e.filter((e=>"syncLargeKeys"!==e))):a=e.filter((e=>"syncLargeKeys"!==e)),a.length){let e=[].concat(a);this._largeKeys.forEach((t=>{a.includes(t)&&(e.splice(e.indexOf(t),1),e=e.concat(this.splitKeyNames(t)))}));const s=await this.getSyncStorage(e);t._lastSplitKeys={},a.forEach((e=>{if(this._largeKeys.includes(e)){const i=this.combineData(s,e);i?(t._lastSplitKeys[e]=this.getMaxSplitKeyFromArray(i),t[e]=s[e]):(t._lastSplitKeys[e]=0,t[e]="words"===e?this._defaultWords:this._defaults[e])}else void 0===s[e]?t[e]=this._defaults[e]:t[e]=s[e]}))}return new this(t)}catch(t){throw p.error("Failed to load items.",e,t),new Error(`Failed to load items: ${r(e)}. [${t.message}]`)}}static removeLocalStorage(e){return e=n(e),new Promise(((t,s)=>{chrome.storage.local.remove(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(0)}))}))}static removeSyncStorage(e){return e=n(e),new Promise(((t,s)=>{chrome.storage.sync.remove(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(0)}))}))}static resetLocalStorage(){return new Promise(((e,t)=>{chrome.storage.local.clear((()=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(0)}))}))}static resetSyncStorage(){return new Promise(((e,t)=>{chrome.storage.sync.clear((()=>{chrome.runtime.lastError?t(chrome.runtime.lastError):e(0)}))}))}static saveLocalStorage(e){return new Promise(((t,s)=>{chrome.storage.local.set(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(0)}))}))}static saveSyncStorage(e){return new Promise(((t,s)=>{chrome.storage.sync.set(e,(()=>{chrome.runtime.lastError?s(chrome.runtime.lastError):t(0)}))}))}static splitKeyNames(e,t=0){return Array(this._maxSplitKeys-t).fill(1).map(((s,i)=>"_"+e+(i+t)))}constructor(e){if(void 0===e)throw new Error("Cannot be called directly, call load() instead.");super(e),Object.assign(this,this.Class._webDefaults,e)}ordered(){return Object.keys(this).sort().reduce(((e,t)=>("_"!=t[0]&&(e[t]=this[t]),e)),{})}async remove(e){e=n(e);let t=[];const s=[];if(e.length>0){e.forEach((e=>{"syncLargeKeys"==e?s.push(e):this.Class._largeKeys.includes(e)?this.syncLargeKeys?t=t.concat(this.Class.splitKeyNames(e)):s.push(e):t.push(e)}));try{t.length&&await this.Class.removeSyncStorage(t),s.length&&await this.Class.removeLocalStorage(s),e.forEach((e=>{delete this[e]}))}catch(t){throw p.error("Failed to remove items.",e,t),new Error(`Failed to remove items: ${r(e)}. ${t.message}`)}}}async reset(){try{await this.Class.resetSyncStorage(),await this.Class.resetLocalStorage()}catch(e){throw p.error("Failed to clear storage.",e),new Error(`Failed to clear storage. ${e.message}`)}}async resetPreserveStats(){try{await this.Class.resetSyncStorage(),await this.Class.removeLocalStorage(this.Class._localConfigKeys)}catch(e){throw p.error("Failed to clear storage.",e),new Error(`Failed to clear storage. ${e.message}`)}}async save(e=[]){e=n(e);const t={},s={};0===e.length&&(e=this._persistableKeys);let i=[];e.forEach((e=>{if("syncLargeKeys"==e)s[e]=this[e];else if(this.Class._largeKeys.includes(e))if(this.syncLargeKeys){if(Object.assign(t,this.splitData(e)),this._lastSplitKeys){const s=this.Class.getMaxSplitKeyFromData(t,e);this._lastSplitKeys[e]>s?i=i.concat(this.Class.splitKeyNames(e,s+1)):this._lastSplitKeys[e]<s&&(this._lastSplitKeys[e]=s)}}else s[e]=this[e];else t[e]=this[e]}));try{if("safari"===this.Class.BUILD.target){const e=Object.keys(s).filter((e=>null==s[e])),i=Object.keys(t).filter((e=>null==t[e]));e.length&&(await this.Class.removeLocalStorage(e),e.forEach((e=>delete s[e]))),i.length&&(await this.Class.removeSyncStorage(i),i.forEach((e=>delete t[e])))}Object.keys(t).length&&await this.Class.saveSyncStorage(t),Object.keys(s).length&&await this.Class.saveLocalStorage(s),i.length&&await this.remove(i)}catch(t){throw p.error("Failed to save items.",e,t),new Error(`Failed to save items: ${r(e)}. [${t.message}]`)}}splitData(e){const t=new TextEncoder;let s=0,i=2;const a={};let o=`_${e}${s}`;return a[o]={},i+=t.encode(`{"${o}":{}}`).length,Object.keys(this[e]).sort().forEach((r=>{let n=t.encode(`",${r}":`).length;n+=t.encode(JSON.stringify(this[e][r])).length,i+n>=this.Class._maxBytes&&(s++,o=`_${e}${s}`,a[o]={},i=t.encode(`"${o}":{}`).length),i+=n,a[o][r]=this[e][r]})),a}}class g extends m{audioWordlistId;customAudioSites;fillerAudio;muteAudio;muteAudioOnly;muteCueRequireShowing;muteMethod;showSubtitles;youTubeAutoMatchCensored;youTubeAutoSubsMax;youTubeAutoSubsMin;static get Constants(){return d}get Class(){return this.constructor}static _premiumDefaults={audioWordlistId:0,customAudioSites:null,fillerAudio:"",muteAudio:!1,muteAudioOnly:!1,muteCueRequireShowing:!1,muteMethod:this.BUILD.config.muteMethod||this.Constants.MUTE_METHODS.TAB,showSubtitles:d.SHOW_SUBTITLES.ALL,youTubeAutoMatchCensored:!0,youTubeAutoSubsMax:0,youTubeAutoSubsMin:0};static _defaults=this.initializeDefaults({},this._configDefaults,this._webDefaults,this._premiumDefaults);static _persistableKeys=Object.keys(this._defaults);static async load(e=[]){return super.load(e)}constructor(e){super(e),Object.assign(this,this.Class._premiumDefaults,e)}}const f={disabledSites:[],sites:{}},S={disabledSites:["www.hidive.com","watch.sling.com"],sites:{"tv.apple.com":[{mode:"cue",videoCueLanguage:"en"}],"play.stan.com.au":[{mode:"cue",videoCueLanguage:"en"}]}},b={disabledSites:[],sites:{"tv.apple.com":[{mode:"cue",videoCueLanguage:"en"}],"play.stan.com.au":[{mode:"cue",videoCueLanguage:"en"}]}},T={"abc.com":[{className:"akamai-caption-text",mode:"element",tagName:"DIV"},{className:"amp-caption-area",displaySelector:"div.amp-caption-area",mode:"element",muteMethod:d.MUTE_METHODS.VIDEO_VOLUME,subtitleSelector:"div.amp-caption > p",tagName:"DIV"}],"iview.abc.net.au":[{mode:"element",subtitleSelector:"div.jw-text-track-cue",tagName:"div"}],"acorn.tv":[{iframe:!0,mode:"elementChild",parentSelector:"div.vjs-text-track-display",simpleUnmute:!0,subtitleSelector:":scope div > div",tagName:"DIV"}],"smile.amazon.com":[{displayHide:"none",displaySelector:"div.webPlayerContainer div.f35bt6a",displayShow:"",iframe:!1,mode:"watcher",parentSelector:"div.webPlayerContainer div span > span",videoSelector:"div.webPlayerElement video[src]"}],"www.amazon.co.uk":[{displayHide:"none",displaySelector:"div.webPlayerContainer div.f35bt6a",displayShow:"",iframe:!1,mode:"watcher",parentSelector:"div.webPlayerContainer div span > span",videoSelector:"div.webPlayerElement video[src]"}],"www.amazon.com":[{displayHide:"none",displaySelector:"div.webPlayerContainer div.f35bt6a",displayShow:"",iframe:!1,mode:"watcher",parentSelector:"div.webPlayerContainer div span > span",videoSelector:"div.webPlayerElement video[src]"}],"www.amc.com":[{className:"ttr-container",mode:"element",subtitleSelector:"span.ttr-cue",tagName:"DIV"},{mode:"cue",videoCueLanguage:"en",videoSelector:"video"}],"www.amcplus.com":[{mode:"element",subtitleSelector:"div.vjs-text-track-cue > div",tagName:"DIV"}],"tv.apple.com":[{apfCaptions:!0,apfCaptionsSelector:"div.video-container",displaySelector:"div.video-player div.video-container > div > div",mode:"elementChild",parentSelector:"div.video-player div.video-container",subtitleSelector:":scope div > div",tagName:"DIV",videoSelector:"div.video-player div.video-container video"}],"www.att.tv":[{mode:"cue",videoSelector:"video#quickplayPlayer"}],"www.attwatchtv.com":[{mode:"cue",videoSelector:"video#quickplayPlayer"}],"www.bbc.co.uk":[{displaySelector:"smp-toucan-player >>> smp-video-layout >>> smp-subtitles >>> div",iframe:!1,mode:"watcher",subtitleSelector:"smp-toucan-player >>> smp-video-layout >>> smp-subtitles >>> div[lang] p span span",videoSelector:"smp-toucan-player >>> smp-playback >>> video"}],"www.britbox.com":[{className:"bmpui-ui-subtitle-label",mode:"element",tagName:"SPAN"},{className:"bmpui-subtitle-region-container",mode:"element",subtitleSelector:"div.bmpui-container-wrapper > span.bmpui-ui-subtitle-label",tagName:"div"}],"gem.cbc.ca":[{className:"jw-text-track-container",mode:"element",subtitleSelector:"div.jw-text-track-cue",tagName:"DIV"}],"www.cbs.com":[{mode:"cue",videoCueLanguage:"en",videoCueRequireShowing:!1}],"www.channel4.com":[{displaySelector:"div.subtitles-container",mode:"elementChild",parentSelector:"div.subtitles-container",tagName:"SPAN"}],"www.crackle.com":[{ignoreMutations:!0,mode:"elementChild",parentSelector:"div.clpp-subtitles-container",simpleUnmute:!0,tagName:"#text"}],"www.criterionchannel.com":[{iframe:!0,mode:"cue",videoCueHideCues:!0,videoCueRequireShowing:!1}],"beta.crunchyroll.com":[{apfCaptions:!0,apfCaptionsSelector:"vilosVttJs",displaySelector:"canvas#velocity-canvas",externalSub:!0,externalSubTrackMode:"hidden",externalSubVar:"window.v1config.media.subtitles",iframe:!0,mode:"cue",videoCueLanguage:"en-US",videoCueRequireShowing:!1}],"www.crunchyroll.com":[{apfCaptions:!0,apfCaptionsSelector:"vilosVttJs",displaySelector:"canvas#velocity-canvas",externalSub:!0,externalSubTrackMode:"hidden",externalSubVar:"window.v1config.media.subtitles",iframe:!0,mode:"cue",videoCueLanguage:"en-US",videoCueRequireShowing:!1,videoSelector:"video#player0"}],"www.cwtv.com":[{className:"ttr-container",convertBreaks:!0,mode:"element",subtitleSelector:"span.ttr-cue",tagName:"DIV"},{className:"ttr-line",convertBreaks:!0,mode:"element",note:"[CC]",subtitleSelector:"span.ttr-cue",tagName:"DIV"}],"www.dailywire.com":[{mode:"cue"}],"www.discoveryplus.com":[{displaySelector:"div.cjRVXG",mode:"cue",videoCueKind:"captions",videoCueLanguage:"en"}],"www.dishanywhere.com":[{className:"bmpui-ui-subtitle-label",mode:"element",tagName:"SPAN"},{className:"bmpui-subtitle-region-container",mode:"element",subtitleSelector:"div.bmpui-container-wrapper > span.bmpui-ui-subtitle-label",tagName:"div"}],"www.apps.disneyplus.com":[{displayHide:"none",displaySelector:"div#video-container div.shaka-text-container",displayShow:"flex",iframe:!1,mode:"watcher",note:"South Africa",subtitleSelector:"div#video-container div.shaka-text-container > span",videoSelector:"div#video-container video"}],"www.disneyplus.com":[{className:"dss-subtitle-renderer-wrapper",mode:"element",subtitleSelector:"div.dss-subtitle-renderer-cue-window span.dss-subtitle-renderer-line",tagName:"DIV"}],"www.fox.com":[{className:"jw-text-track-container",mode:"element",subtitleSelector:"div.jw-text-track-cue",tagName:"DIV"}],"www.fubo.tv":[{displayHide:"none",displaySelector:"div.bmpui-ui-subtitle-overlay",iframe:!1,mode:"watcher",parentSelector:"div.bmpui-ui-subtitle-overlay",subtitleSelector:"div.bmpui-ui-subtitle-overlay span"}],"www.funimation.com":[{displaySelector:"div > div.vjs-text-track-cue",mode:"element",subtitleSelector:"div.vjs-text-track-cue > div",tagName:"DIV"},{iframe:!0,mode:"elementChild",note:"Embedded videos",parentSelector:"div.vjs-text-track-display",simpleUnmute:!0,subtitleSelector:":scope div > div",tagName:"DIV"}],"fxnow.fxnetworks.com":[{iframe:!0,mode:"cue",videoSelector:"video"}],"play.google.com":[{className:"lava-timed-text-window",mode:"element",subtitleSelector:"span.lava-timed-text-caption",tagName:"DIV"}],"play.hbomax.com":[{apfCaptions:!0,displaySelector:"div[data-testid='CueBoxContainer']",displaySelectorParents:1,ignoreMutations:!0,mode:"watcher",subtitleSelector:"div[data-testid='CueBoxContainer'] > div > div > div"}],"www.hidive.com":[{className:"rmp-cc-container",mode:"element",subtitleSelector:"div.rmp-cc-cue > span",tagName:"DIV"}],"www.hulu.com":[{className:"caption-text-box",displaySelector:"div.caption-text-box",mode:"element",subtitleSelector:"p",tagName:"DIV"},{displaySelector:"div.CaptionBox",mode:"elementChild",parentSelector:"div.CaptionBox",tagName:"P"}],"www.itv.com":[{mode:"cue",videoCueLanguage:"en"}],"mediasetinfinity.mediaset.it":[{ignoreMutations:!0,mode:"elementChild",parentSelector:"div#playerContainer > div > div > div > div > div",simpleUnmute:!0,tagName:"#text",videoSelector:"div#playerContainer video"},{ignoreMutations:!0,mode:"elementChild",parentSelector:"div#playerContainer > div > div > div > div > div > div > div > div > div > div",simpleUnmute:!0,tagName:"DIV",videoSelector:"div#playerContainer video"}],"moviesanywhere.com":[{mode:"cue"}],"www.nbc.com":[{className:"ttr-line",mode:"element",subtitleSelector:"span.ttr-cue",tagName:"DIV"},{mode:"cue",videoCueLanguage:"en"}],"www.netflix.com":[{className:"player-timedtext-text-container",mode:"element",note:"Fallback compatibility",subtitleSelector:"span > span",tagName:"DIV"},{className:"player-timedtext-text-container",mode:"element",subtitleSelector:"span",tagName:"DIV"}],"www.paramountplus.com":[{mode:"cue",videoCueHideCues:!0,videoCueLanguage:"en",videoCueRequireShowing:!1,videoSelector:"div[data-role=videoContainer] video"}],"www.pbs.org":[{iframe:!0,mode:"element",subtitleSelector:"div.vjs-text-track-cue > div",tagName:"DIV"}],"www.peacocktv.com":[{displaySelector:"div.video-player__subtitles",mode:"elementChild",parentSelector:"div.video-player__subtitles > span.video-player__subtitles__cue span.video-player__subtitles__line",simpleUnmute:!0,tagName:"#text"},{className:"video-player__subtitles",displaySelector:"div.video-player__subtitles",mode:"element",subtitleSelector:"span.video-player__subtitles__cue > span.video-player__subtitles__line",tagName:"DIV"}],"www.philo.com":[{mode:"cue"}],"app.plex.tv":[{dataPropPresent:"dialogueId",mode:"element",subtitleSelector:"span > span",tagName:"DIV"},{containsSelector:"div[data-dialogue-id]",mode:"element",subtitleSelector:"span > span",tagName:"DIV"}],"pluto.tv":[{mode:"cue",videoCueHideCues:!0,videoCueRequireShowing:!1}],"www.primevideo.com":[{displayHide:"none",displaySelector:"div.webPlayerContainer div.f35bt6a",displayShow:"",iframe:!1,mode:"watcher",parentSelector:"div.webPlayerContainer div span > span",videoSelector:"div.webPlayerElement video[src]"}],"www.raiplay.it":[{mode:"elementChild",parentSelector:"div.theoplayer-texttracks div.theoplayer-webvtt-region-default",subtitleSelector:"div span",tagName:"DIV"}],"www.redbox.com":[{mode:"elementChild",parentSelector:"div.rb-text-container",subtitleSelector:"SPAN",tagName:"DIV"}],"watch.redeemtv.com":[{convertBreaks:!0,displaySelector:"div.vp-captions",mode:"elementChild",parentSelector:"div.vp-captions",tagName:"SPAN"}],"therokuchannel.roku.com":[{mode:"element",subtitleSelector:"div.vjs-text-track-cue > div",tagName:"DIV"}],"row8.com":[{iframe:!1,mode:"watcher",parentSelector:"div.vjs-text-track-display div.vjs-text-track-cue",subtitleSelector:"div",videoSelector:"app-videojs-player video"}],"www.sbs.com.au":[{className:"bmpui-subtitle-region-container",mode:"element",subtitleSelector:"DIV.bmpui-container-wrapper > SPAN.bmpui-ui-subtitle-label > SPAN",tagName:"DIV"}],"www.showmax.com":[{ignoreMutations:!0,mode:"elementChild",parentSelector:"div.contentWrapper > div.subtitles--3EXhT",simpleUnmute:!0,tagName:"#text"}],"www.showtime.com":[{mode:"cue",videoCueHideCues:!0,videoCueLanguage:"en",videoCueRequireShowing:!1}],"www.shudder.com":[{mode:"element",subtitleSelector:"div.vjs-text-track-cue > div",tagName:"DIV"}],"watch.sling.com":[{className:"bmpui-subtitle-region-container",mode:"element",subtitleSelector:"DIV.bmpui-container-wrapper > SPAN.bmpui-ui-subtitle-label",tagName:"DIV"}],"play.stan.com.au":[{ignoreMutations:!0,mode:"elementChild",parentSelector:"div.clpp-text-container",simpleUnmute:!0,tagName:"DIV"}],"www.starz.com":[{mode:"elementChild",parentSelector:"starz-captions > div.cue-list",tagName:"SPAN"}],"www.syfy.com":[{className:"ttr-line",mode:"element",subtitleSelector:"span.ttr-cue",tagName:"DIV"}],"www.tntdrama.com":[{mode:"cue",videoCueLanguage:"en",videoSelector:"video.top-media-element"}],"tubitv.com":[{mode:"elementChild",parentSelector:"div[data-id='captionsComponent']",tagName:"SPAN"}],"www.universalkids.com":[{mode:"element",subtitleSelector:"div.gwt-HTML",tagName:"DIV"}],"www.usanetwork.com":[{className:"ttr-container",mode:"element",note:"movies 2022-12",subtitleSelector:"span.ttr-cue",tagName:"DIV",videoSelector:"video[src^=blob]"},{className:"ttr-line",mode:"element",note:"free clips 2022-12",subtitleSelector:"span",tagName:"DIV",videoSelector:"video[src^=blob]"}],"vimeo.com":[{mode:"element",tagName:"SPAN",note:"Only tested with single-line captions",className:"vp-captions-line",displaySelector:"div.vp-captions > span.vp-captions-window"}],"player.vimeo.com":[{mode:"element",tagName:"SPAN",note:"For embedded videos",className:"vp-captions-line",displaySelector:"div.vp-captions > span.vp-captions-window"}],"www.vudu.com":[{displaySelector:"div#subtitleContainer > div",iframe:!0,mode:"element",subtitleSelector:"span.subtitles",tagName:"DIV"}],"vrv.co":[{displaySelector:"div.libassjs-canvas-parent",externalSub:!0,externalSubVar:"window.vilos.content.captions",iframe:!0,mode:"cue",videoCueLanguage:"en-US",videoCueRequireShowing:!1},{displaySelector:"div.libassjs-canvas-parent",externalSub:!0,externalSubVar:"window.vilos.content.subtitles",iframe:!0,mode:"cue",videoCueLanguage:"en-US",videoCueRequireShowing:!1}],"www.xfinity.com":[{apfCaptions:!0,apfCaptionsSelector:"div#viper-player-container",displaySelector:"div#viper-player-container div#inner-cc-container",mode:"watcher",subtitleSelector:"div#viper-player-container div#inner-cc-container svg > text",videoSelector:"div#viper-player-container > video"}],"m.youtube.com":[{className:"caption-window",mode:"element",subtitleSelector:"span.ytp-caption-segment",tagName:"DIV"}],"tv.youtube.com":[{className:"caption-window",mode:"element",subtitleSelector:"span.ytp-caption-segment",tagName:"DIV"}],"www.youtube.com":[{className:"caption-window",mode:"element",subtitleSelector:"span.ytp-caption-segment",tagName:"DIV"}]},w=new u("WebAudio");class v{apfCaptionRuleIds;apfCaptionsEnabled;cueRuleIds;enabledRuleIds;fetching;fillerAudio;fillerAudioPauseHandler;fillerAudioPlayHandler;filter;lastFilteredNode;lastFilteredText;lastProcessedNode;lastProcessedText;muted;muteRuleId;rules;sites;siteKey;supportedPage;supportedCaptions;unmuteTimeout;volume;watcherRuleIds;wordlistId;youTube;youTubeAutoSubsMax;youTubeAutoSubsMin;youTubeAutoSubsRule;youTubeAutoSubsTimeout;youTubeAutoSubsUnmuteDelay;static brTagRegExp=new RegExp("<br>","i");static defaultVideoSelector="video";static fillerConfig={beep:{fileName:"audio/beep.mp3",volume:.2},crickets:{fileName:"audio/crickets.mp3",volume:.4},static:{fileName:"audio/static.mp3",volume:.3}};static textTrackRuleMappings={externalSubTrackLabel:"label",videoCueKind:"kind",videoCueLabel:"label",videoCueLanguage:"language"};static getBuildTargetConfig(){switch(g.BUILD.target){case d.BUILD_TARGET_IOS:return S;case d.BUILD_TARGET_SAFARI:return b;default:return f}}static removeUnsupportedSites(e){Object.keys(e).forEach((t=>{const s=e[t];Array.isArray(s)||(e[t]=[s]),e[t]=e[t].filter((e=>null==e.buildTarget||e.buildTarget==g.BUILD.target))})),Object.keys(e).forEach((t=>{0==e[t].length&&delete e[t]}))}static supportedSites(e=!0){const t=v.getBuildTargetConfig(),s=Object.assign({},T,t.sites);return t.disabledSites.forEach((e=>{delete s[e]})),e&&v.removeUnsupportedSites(s),s}static supportedAndCustomSites(e){const t=Object.assign({},v.supportedSites(!1),e);return v.removeUnsupportedSites(t),t}constructor(e){this.filter=e,w.setLevel(this.filter.cfg.loggingLevel),this.apfCaptionRuleIds=[],this.cueRuleIds=[],this.enabledRuleIds=[],this.watcherRuleIds=[],this.filter.extension&&(this.fillerAudio=this.initFillerAudio(this.filter.cfg.fillerAudio)),this.lastFilteredNode=null,this.lastFilteredText="",this.lastProcessedText="",this.muted=!1,e.cfg.customAudioSites&&"object"==typeof e.cfg.customAudioSites||(e.cfg.customAudioSites={}),this.sites=v.supportedAndCustomSites(e.cfg.customAudioSites),this.supportedCaptions=!1,this.volume=1,this.wordlistId=e.audioWordlistId,this.youTubeAutoSubsMax=1e3*e.cfg.youTubeAutoSubsMax,this.youTubeAutoSubsMin=e.cfg.youTubeAutoSubsMin,this.youTubeAutoSubsUnmuteDelay=0,this.siteKey=this.getSiteKey(),this.rules=this.sites[this.siteKey],this.rules&&(this.rules.forEach((e=>{this.initRule(e)})),this.enabledRuleIds.length>0&&(this.supportedPage=!0,this.initYouTube()),this.apfCaptionRuleIds.length&&(this.apfCaptionsEnabled=!0),this.cueRuleIds.length&&setInterval(this.watchForVideo,250,this))}apfCaptionContainer(t,s){let i;return t.apfCaptionsSelector&&(i=e(t.apfCaptionsSelector)),i||(s||(s=e(t.videoSelector)),s&&s.parentElement&&(i=s.parentElement)),i}apfCaptionLine(e,t){const s=document.createElement("span");return s.classList.add("APF-subtitle-line"),s.style.background="black",s.style.color="white",s.style.fontSize="3vw",s.style.paddingLeft="4px",s.style.paddingRight="4px",s.style.height="18px",s.textContent=t,s}apfCaptionLines(e,t){const s=document.createElement("div");return s.classList.add("APF-subtitles"),s.style.bottom="50px",s.style.position="absolute",s.style.textAlign="center",s.style.width="100%",t.forEach((e=>{s.appendChild(e),s.appendChild(document.createElement("br"))})),s}apfTextTrack(e,t){if(t){if(t.textTracks.length){const s=Array.from(t.textTracks).find((t=>t.label==e.apfCuesLabel));if(s)return s}return t.addTextTrack("captions",e.apfCuesLabel,e.apfCuesLabel)}}buildApfCaptions(e,t,s){if(t.length){const i=t.map((t=>e.filterSubtitles&&t.modified?t.filtered:t.original)).map((t=>this.apfCaptionLine(e,t))),a=this.apfCaptionLines(e,i);s.appendChild(a)}}clean(e,t=0){const s=this.rules[t];if("watcher"===s.mode)return;s.apfCaptions&&s.displaySelector&&this.hideSubtitles(s);let i=!1;const a=[];e.nodeName&&this.textContentTag(e.nodeName)&&e.parentElement&&(e=e.parentElement);const o=s.subtitleSelector&&e.querySelectorAll?e.querySelectorAll(s.subtitleSelector):[e];if(0===o.length)return;o.forEach((e=>{const t=this.textContentTag(e.nodeName)?"textContent":"innerText";!0!==s.convertBreaks||this.textContentTag(e.nodeName)||v.brTagRegExp.test(e[t])||!v.brTagRegExp.test(e.innerHTML)||("pre"!==e.style.whiteSpace&&(e.style.whiteSpace="pre"),e.textContent=e.innerHTML.replace(v.brTagRegExp,"\n"));const o=this.replaceTextResult(e[t]);if(o.modified&&(i=!0,this.mute(s),s.filterSubtitles&&!s.apfCaptions&&(s.preserveWhiteSpace&&"pre"!==e.style.whiteSpace&&(e.style.whiteSpace="pre"),s.ignoreMutations&&this.filter.stopObserving(),e[t]=o.filtered,s.ignoreMutations&&this.filter.startObserving()),this.lastFilteredNode=e,this.lastFilteredText=e[t]),s.apfCaptions)for(const e of this.splitReplaceTextResultsOnNewlines(o))a.push(e);i||this.lastFilteredNode!=e||this.lastFilteredText!=e[t]||(i=!0),this.lastProcessedNode=e})),i||this.lastFilteredNode&&document.body.contains(this.lastFilteredNode)&&this.lastFilteredNode.textContent===this.lastFilteredText&&(i=!0);const r=this.subtitlesShouldBeShown(s,i);s.apfCaptions?this.displayApfCaptions(s,a,r):r?this.showSubtitles(s,o):this.hideSubtitles(s,o)}cleanYouTubeAutoSubs(e){null!=this.youTubeAutoSubsTimeout&&(clearTimeout(this.youTubeAutoSubsTimeout),this.youTubeAutoSubsTimeout=null);const t=this.replaceTextResult(e.textContent);if(t.modified)this.youTubeAutoSubsRule.filterSubtitles&&(e.textContent=t.filtered),this.mute(this.youTubeAutoSubsRule),this.youTubeAutoSubsUnmuteDelay=null,this.filter.updateCounterBadge(),this.youTubeAutoSubsMax&&(this.youTubeAutoSubsTimeout=window.setTimeout(this.youTubeAutoSubsMuteTimeout,this.youTubeAutoSubsMax,this));else if(this.muted)if(this.youTubeAutoSubsMin>0){const e=document.getElementsByTagName(v.defaultVideoSelector)[0].currentTime;null==this.youTubeAutoSubsUnmuteDelay?this.youTubeAutoSubsUnmuteDelay=e:(e<this.youTubeAutoSubsUnmuteDelay&&(this.youTubeAutoSubsUnmuteDelay=0),e>this.youTubeAutoSubsUnmuteDelay+this.youTubeAutoSubsMin&&this.unmute(this.youTubeAutoSubsRule))}else this.unmute(this.youTubeAutoSubsRule);if(this.filter.cfg.showSubtitles!==d.SHOW_SUBTITLES.ALL){const e=document.querySelector("div.ytp-caption-window-rollup span.captions-text");"block"==e.style.display&&(e.style.display="none")}}clearUnmuteTimeout(e){e.unmuteDelay&&null!=this.unmuteTimeout&&(clearTimeout(this.unmuteTimeout),this.unmuteTimeout=null)}cuesIncludingText(e,t,s="text"){return e.filter((e=>t.includes(e[s])))}cuesInTimeRange(e,t,s,i=0){return e.filter((e=>e.startTime>=t-i&&e.endTime<=s+i))}delayedUnmute(e,t){e.unmute(t,null,!0),this.unmuteTimeout=null}displayApfCaptions(e,t,s){const i=this.apfCaptionContainer(e);i?(this.removeApfCaptions(e,i),s&&this.buildApfCaptions(e,t,i)):w.warn("Failed to find APF Captions container.")}fillerAudioHandlePause(){this.fillerAudio.pause()}fillerAudioHandlePlay(){this.muted&&this.fillerAudio.play()}getSiteKey(){return this.sites.hasOwnProperty(this.filter.hostname)?this.filter.hostname:this.filter.iframe&&this.filter.iframe.hostname&&this.sites.hasOwnProperty(this.filter.iframe.hostname)?this.filter.iframe.hostname:""}getVideoTextTrack(e,t,s){let i=0,a=0,o=!1,r=0;s&&t[s]&&(r+=1e3),t.videoCueLabel&&(r+=100),t.videoCueLanguage&&(r+=10),t.videoCueKind&&(r+=1);for(let n=0;n<e.length;n++){const l=e[n];if(!l.cues||0===l.cues.length)continue;if(t.videoCueRequireShowing&&"showing"!==l.mode)continue;let d=0;if(s&&t[s]&&this.textTrackKeyTest(l,v.textTrackRuleMappings[s],t[s])&&(d+=1e3),t.videoCueLabel&&this.textTrackKeyTest(l,v.textTrackRuleMappings.videoCueLabel,t.videoCueLabel)&&(d+=100),t.videoCueLanguage&&this.textTrackKeyTest(l,v.textTrackRuleMappings.videoCueLanguage,t.videoCueLanguage)&&(d+=10),t.videoCueKind?this.textTrackKeyTest(l,v.textTrackRuleMappings.videoCueKind,t.videoCueKind)&&(d+=1):(this.textTrackKeyTest(l,v.textTrackRuleMappings.videoCueKind,"captions")||this.textTrackKeyTest(l,v.textTrackRuleMappings.videoCueKind,"subtitles"))&&(d+=1),d===r)return l;(d>a||!o)&&(a=d,i=n,o=!0)}if(o)return e[i]}hideCue(e,t){t.text="",t.position=100,t.size=0}hideSubtitles(t,s){if(t.displayVisibility&&t._displayElement)t._displayElement.style.visibility="hidden";else if(t.displaySelector){const i=t.rootNode&&s&&s[0]?s[0].getRootNode():document;if(i){let s=e(t.displaySelector,i);s&&t.displaySelectorParents&&(s=a(s,t.displaySelectorParents)),s&&(""===t.displayShow&&""!==s.style.display&&s.style.display!==t.displayHide&&(t.displayShow=s.style.display),s.style.setProperty("display",t.displayHide))}}else s&&s.forEach((e=>{e.innerText="",t.removeSubtitleSpacing&&e.style&&(e.style.padding&&(e.style.padding=0),e.style.margin&&(e.style.margin=0))}))}initCueRule(e){!0===e.apfCaptions&&(e.videoCueHideCues=!0),void 0===e.videoCueRequireShowing&&(e.videoCueRequireShowing=this.filter.cfg.muteCueRequireShowing),e.externalSub&&(void 0===e.externalSubTrackMode&&(e.externalSubTrackMode="showing"),void 0===e.externalSubURLKey&&(e.externalSubURLKey="url"),void 0===e.externalSubFormatKey&&(e.externalSubFormatKey="format"),void 0===e.externalSubTrackLabel&&(e.externalSubTrackLabel="APF"))}initDisplaySelector(e){void 0!==e.displaySelector&&(void 0===e.displayHide&&(e.displayHide="none"),void 0===e.displayShow&&(e.displayShow=""))}initDynamicRule(e){e._dynamic=!0,null==e.dynamicTargetMode&&e.disabled}initElementChildRule(e){e.parentSelector||e.parentSelectorAll||(e.disabled=!0),e.apfCaptions&&void 0===e.displaySelector&&(e.disabled=!0)}initElementRule(e){e.apfCaptions&&void 0===e.displaySelector&&(e.disabled=!0)}initFillerAudio(e=""){const t=v.fillerConfig[e];if(t){const e=chrome.runtime.getURL(t.fileName),s=new Audio;return s.src=e,s.loop=!0,t.volume&&(s.volume=t.volume),t.loopAfter&&(s.ontimeupdate=()=>{s.currentTime>t.loopAfter&&(s.currentTime=0)}),this.fillerAudioPauseHandler=this.fillerAudioHandlePause.bind(this),this.fillerAudioPlayHandler=this.fillerAudioHandlePlay.bind(this),s}}initRule(e){if(e._id=this.rules.indexOf(e),(void 0===e.mode||("element"==e.mode||"elementChild"==e.mode)&&!e.tagName||!0===e.iframe&&null==this.filter.iframe||!1===e.iframe&&null!=this.filter.iframe)&&(e.disabled=!0),e.disabled)w.info("Audio rule disabled",e);else{switch(null==e.filterSubtitles&&(e.filterSubtitles=!0),0==this.filter.filterText&&(e.filterSubtitles=!1),void 0===e.videoSelector&&(e.videoSelector=v.defaultVideoSelector),this.initDisplaySelector(e),null==e.muteMethod&&(e.muteMethod=this.filter.cfg.muteMethod),null==e.showSubtitles&&(e.showSubtitles=this.filter.cfg.showSubtitles),null==e.tagName||this.textContentTag(e.tagName)||(e.tagName=e.tagName.toUpperCase()),e.mode){case"cue":this.initCueRule(e),e.disabled||this.cueRuleIds.push(e._id);break;case"dynamic":this.initDynamicRule(e);break;case"elementChild":this.initElementChildRule(e);break;case"element":this.initElementRule(e);break;case"text":this.initTextRule(e);break;case"watcher":this.initWatcherRule(e),e.disabled||this.watcherRuleIds.push(e._id);break;case"ytauto":e.disabled=!0}e.disabled?"ytauto"!=e.mode&&w.info("Audio rule disabled during initialization",e):(this.enabledRuleIds.push(e._id),e.apfCaptions&&this.apfCaptionRuleIds.push(e._id),"watcher"==e.mode&&(e.toCue?setInterval(this.watcherToCue,e.checkInterval,this,e._id):setInterval(this.watcher,e.checkInterval,this,e._id)))}}initTextRule(e){e.tagName="#text",void 0===e.simpleUnmute&&(e.simpleUnmute=!0)}initWatcherRule(e){void 0===e.apfCuesLabel&&(e.apfCuesLabel="APF-Cues"),void 0===e.checkInterval&&(e.checkInterval=20),void 0===e.ignoreMutations&&(e.ignoreMutations=!0),void 0===e.simpleUnmute&&(e.simpleUnmute=!0)}initYouTube(){if(["m.youtube.com","tv.youtube.com","www.youtube.com"].includes(this.siteKey)){if(this.youTube=!0,this.filter.cfg.youTubeAutoMatchCensored){const e="\\[\\s__\\s\\]",t={lists:this.wordlistId===d.ALL_WORDS_WORDLIST_ID?[]:[this.wordlistId],matchMethod:d.MATCH_METHODS.REGEX,repeat:d.FALSE,separators:d.FALSE,sub:"[ _ ]"};this.filter.cfg.addWord(e,t)}this.youTubeAutoSubsRule={mode:"ytauto"},this.initRule(this.youTubeAutoSubsRule)}}mute(t,s){if(!this.muted){switch(this.muted=!0,this.muteRuleId=t._id,this.filter.cfg.collectStats&&this.filter.stats.mutes++,t.muteMethod){case d.MUTE_METHODS.TAB:chrome.runtime.sendMessage(this.filter.buildMessage(d.MESSAGING.BACKGROUND,{mute:!0}));break;case d.MUTE_METHODS.VIDEO_MUTE:s||(s=e(t.videoSelector)),s&&!s.muted&&(s.muted=!0),this.fillerAudio&&this.playFillerAudio(s);break;case d.MUTE_METHODS.VIDEO_VOLUME:s||(s=e(t.videoSelector)),s&&null!=s.volume&&(this.volume=s.volume,s.volume=0),this.fillerAudio&&this.playFillerAudio(s)}w.debugTime("mute()")}t&&t.unmuteDelay&&this.unmuteTimeout&&this.clearUnmuteTimeout(t)}newCue(e,t,s,i={}){try{const a="string"==typeof e?o(e):e,r="string"==typeof t?o(t):t,n=new VTTCue(a,r,s);return i.align&&(n.align=i.align),i.line&&(n.line=this.parseLineAndPositionSetting(i.line)),i.position&&(n.position=this.parseLineAndPositionSetting(i.position)),n}catch(i){w.error(`Failed to add cue: ( start: ${e}, end: ${t}, text: ${s} )`,i)}}newTextTrack(e,t,s){if(t.textTracks){const i=t.addTextTrack("captions",e.externalSubTrackLabel,e.videoCueLanguage);i.mode=e.externalSubTrackMode;for(let e=0;e<s.length;e++)i.addCue(s[e]);return i}}parseLineAndPositionSetting(e){if("string"==typeof e&&""!=e)return"auto"==e?"auto":parseInt(e)}parseSRT(e){const t=e.trim().replace("\r\n","\n").split(/[\r\n]/).map((e=>e.trim())),s=[];let i=null,a=null,o=null;for(let e=0;e<t.length;e++)if(t[e].indexOf("--\x3e")>=0){const s=t[e].split(/[ \t]+-->[ \t]+/);if(2!=s.length)throw new Error(`Error when splitting "--\x3e": ${t[e]}.`);i=s[0],a=s[1]}else if(""==t[e]){if(i&&a){const e=this.newCue(i,a,o);s.push(e),i=null,a=null,o=null}}else i&&a&&(null==o?o=t[e]:o+="\n"+t[e]);if(i&&a){const e=this.newCue(i,a,o);s.push(e)}return s}parseSSA(e){const t=[];let s,i,a,o=!1;const r=e.split("\n");for(let e=0;e<r.length;e++)if(o){if(r[e].match(/^format:/i)){const t=r[e].trim().split(",");s=t.indexOf("End"),i=t.indexOf("Start"),a=t.indexOf("Text")}else if(r[e].match(/^dialogue:/i)){const o=r[e].trim().split(","),n=o[i],l=o[s],d=o.slice(a).join(",").replace(/\{\\\w.+?\}/g,"").split("\\N").reverse();for(let e=0;e<d.length;e++)t.push(this.newCue(n,l,d[e]))}}else r[e].match(/^\[Events\]/i)&&(o=!0);return t}parseVTT(e){const t=[],s=e.split("\n"),i=new RegExp("\\s--\x3e\\s");for(let e=0;e<s.length;e++){const r=s[e].trim();if(r.match(i)){const n=r.replace(i," ").split(" ");let[l,d,...u]=n;l=l.replace(",","."),d=d.replace(",",".");const c=u.map((e=>e.split(":"))).reduce(((e,t)=>(e[t[0]]=t[1],e)),{}),h=s[e-1].trim(),p=s[e+1].trim(),m=new RegExp(`^<[cs]\\.${h}>`),g=new RegExp("</[cs]>$");let f;if(f=p.match(m)?p.replace(m,"").replace(g,""):p,h&&!h.match(/_1$/)){const e=t[t.length-1];e.startTime!=o(l)&&e.endTime==o(d)&&(a=e.startTime,l=new Date(1e3*a).toISOString().slice(11,23))}const S=this.newCue(l,d,f,c);if(h&&!h.match(/_1$/)){const e=parseInt(h.match(/_([2-9])$/)[1]),s=t.length-e+1;t.splice(s,0,S)}else t.push(S);e++}}var a;return t}playFillerAudio(e){this.playing(e)&&(this.fillerAudio.play(),e.addEventListener("pause",this.fillerAudioPauseHandler),e.addEventListener("play",this.fillerAudioPlayHandler))}playing(e){return!!(e&&e.currentTime>0&&!e.paused&&!e.ended&&e.readyState>2)}processCues(e,t){for(let s=0;s<e.length;s++){const i=e[s];if(i.hasOwnProperty("filtered"))continue;t.videoCueSync&&(i.startTime+=t.videoCueSync,i.endTime+=t.videoCueSync);const a=this.replaceTextResult(i.text);i.originalText=i.text,i.filteredText=a.filtered,a.modified?(i.filtered=!0,t.filterSubtitles&&!t.apfCaptions&&(i.text=a.filtered)):i.filtered=!1}}async processExternalSub(e,t){const s=this.getVideoTextTrack(e.textTracks,t,"externalSubTrackLabel");if(!this.fetching&&!s)try{let s;if(s=3==g.BUILD.manifestVersion?await function(e,t="context"){return new Promise(((s,i)=>{const a={destination:"background",globalVariable:e,source:t};chrome.runtime.sendMessage(a,(e=>{s(e)}))}))}(t.externalSubVar):function(e,t="APFData"){const s=document.createElement("script");s.id=t,s.textContent=`document.getElementById("${t}").textContent = JSON.stringify(${e})`,document.documentElement.appendChild(s);const i=document.querySelector(`script#${t}`).textContent;return s.remove(),JSON.parse(i)}(t.externalSubVar),!Array.isArray(s))throw new Error(`Failed to find subtitle variable: ${t.externalSubVar}.`);{const i=s.find((e=>e.language===t.videoCueLanguage));if(!i)throw new Error(`Failed to find subtitle for language: ${t.videoCueLanguage}.`);let a;if(this.fetching=!0,a="bookmarklet"==g.BUILD.target?await async function(e,t){return fetch?await async function(e,t="GET"){const s=await fetch(e,{method:t});return await s.text()}(e,t):await function(e,t){return new Promise(((s,i)=>{const a=new XMLHttpRequest;a.open(t,e),a.onload=function(){this.status>=200&&this.status<300?s(this.response):i({status:this.status,statusText:this.statusText})},a.onerror=function(){i({status:this.status,statusText:this.statusText})},a.send()}))}(e,t)}(i[t.externalSubURLKey],"GET"):await function(e,t,s="context"){return new Promise(((i,a)=>{const o={destination:"background",fetch:e,fetchMethod:t.toUpperCase(),source:s};chrome.runtime.sendMessage(o,(e=>{i(e)}))}))}(i[t.externalSubURLKey],"GET"),"string"!=typeof a||!a)throw new Error(`Failed to download external subtitles from '${i[t.externalSubURLKey]}'.`);{let s;switch(i[t.externalSubFormatKey]){case"ass":s=this.parseSSA(a);break;case"srt":s=this.parseSRT(a);break;case"vtt":s=this.parseVTT(a);break;default:throw new Error(`Unsupported subtitle type: ${i[t.externalSubFormatKey]}.`)}if(s){const i=this.newTextTrack(t,e,s).cues;if(this.processCues(i,t),this.fetching=!1,t.displaySelector){const e=document.querySelector(t.displaySelector);e&&(e.style.display="none")}}}}}catch(e){w.error(`Error using external subtitles for ${this.siteKey}.`,e)}}processWatcherCaptions(e,t,s){const i=s.initialCall;if(i){if(e._lastProcessedText&&e._lastProcessedText===t.textContent)return s.skipped=!0,!1;this.unmute(e),e._lastProcessedText="",this.lastProcessedText="",s.initialCall=!1}if(t.hasChildNodes())for(const i of t.childNodes)this.processWatcherCaptions(e,i,s);else{const i=t&&this.textContentTag(t.nodeName)?"textContent":"innerText";if(t[i]&&t[i].trim()){const a=this.replaceTextResult(t[i]);a.modified&&(this.mute(e),s.filtered=!0,e.filterSubtitles&&!e.apfCaptions&&(t[i]=a.filtered)),s.textResults.push(a)}}i&&(e._lastProcessedText=t.textContent,this.lastProcessedText=t.textContent)}processWatcherCaptionsArray(e,t,s){const i=t.map((e=>e.textContent)).join(" ");if(e._lastProcessedText&&e._lastProcessedText===i)return s.skipped=!0,!1;this.unmute(e),e._lastProcessedText="",this.lastProcessedText="",t.forEach((t=>{if(t.textContent&&t.textContent.trim()){const i=this.replaceTextResult(t.textContent);i.modified&&(this.mute(e),s.filtered=!0,e.filterSubtitles&&!e.apfCaptions&&(t.textContent=i.filtered)),s.textResults.push(i)}}));const a=t.map((e=>e.textContent)).join(" ");e._lastProcessedText=a,this.lastProcessedText=a}removeApfCaptions(t,s){if(s||(s=this.apfCaptionContainer(t)),s){const t=e("div.APF-subtitles",s);t&&t.remove()}}replaceTextResult(e,t=this.wordlistId,s=d.STATS_TYPE_AUDIO){return this.filter.replaceTextResult(e,t,s)}showSubtitles(t,s){if(t.displayVisibility&&t._displayElement)t._displayElement.style.visibility="visible";else if(t.displaySelector){const i=t.rootNode&&s&&s[0]?s[0].getRootNode():document;if(i){let s=e(t.displaySelector,i);s&&t.displaySelectorParents&&(s=a(s,t.displaySelectorParents)),s&&s.style.setProperty("display",t.displayShow)}}}splitReplaceTextResultsOnNewlines(e){const t=e.original.split("\n"),s=e.filtered.split("\n");if(1===t.length||t.length!==s.length)return[e];const i=[];for(let a=0;a<t.length;a++){const o=t[a],r=s[a],n=e.modified&&o!=r;i.push({filtered:r,modified:n,original:o})}return i}stopFillerAudio(){this.fillerAudio.pause(),this.fillerAudio.currentTime=0}subtitlesShouldBeShown(e,t=!1){switch(e.showSubtitles){case d.SHOW_SUBTITLES.ALL:return!0;case d.SHOW_SUBTITLES.FILTERED:return t;case d.SHOW_SUBTITLES.UNFILTERED:return!t;case d.SHOW_SUBTITLES.NONE:return!1}}supportedCaptionsFound(e=!0,t=!1){if(!this.filter.extension||!t&&e==this.supportedCaptions)return;const s={destination:d.MESSAGING.BACKGROUND,source:d.MESSAGING.CONTEXT,forceUpdate:t};this.supportedCaptions=e,e?(s.status=d.STATUS.CAPTIONS,chrome.runtime.sendMessage(s),w.info("Supported captions found")):(s.status=d.STATUS.MUTE_PAGE,chrome.runtime.sendMessage(s),w.info("Watching for supported captions"))}supportedDynamicNode(e,t){e.textContent===t.dynamicTextKey&&(t.mode=t.dynamicTargetMode,t.parentSelectorAll=`${e.tagName.toLowerCase()}.${Array.from(e.classList).join(".")} ${t.parentSelectorAll}`,this.initRule(t))}supportedElementNode(e,t){return!(e.nodeName!=t.tagName||!(!t.className||e.className&&e.classList.contains(t.className))||!(!t.dataPropPresent||e.dataset&&e.dataset.hasOwnProperty(t.dataPropPresent))||t.hasChildrenElements&&("number"!=typeof e.childElementCount||0==e.childElementCount)||t.subtitleSelector&&("function"!=typeof e.querySelector||!e.querySelector(t.subtitleSelector))||t.containsSelector&&("function"!=typeof e.querySelector||!e.querySelector(t.containsSelector)))}supportedElementChildNode(e,t){if(e.nodeName===t.tagName){const s=t.rootNode?e.getRootNode():document;if(s)if(t.parentSelector){const i=s.querySelector(t.parentSelector);if(i&&(i==e||i.contains(e)))return!0}else{const i=s.querySelectorAll(t.parentSelectorAll);for(let t=0;t<i.length;t++)if(i[t].contains(e))return!0}}return!1}supportedNode(e){for(let t=0;t<this.enabledRuleIds.length;t++){const s=this.enabledRuleIds[t],i=this.rules[s];let a=!1;switch(i.mode){case"element":a=this.supportedElementNode(e,i);break;case"elementChild":a=this.supportedElementChildNode(e,i);break;case"text":a=this.supportedTextNode(e,i);break;case"watcher":a=this.supportedWatcherNode(e,i);break;case"dynamic":this.supportedDynamicNode(e,i)}if(a)return this.supportedCaptionsFound(),s}return!1}supportedTextNode(e,t){if(e.nodeName===t.tagName){const s=document.querySelector(t.parentSelector);if(s&&s.contains(e))return!0}return!1}supportedWatcherNode(t,s){if(null!=s.subtitleSelector&&t.parentElement&&t.parentElement==e(s.subtitleSelector))return!0;if(null!=s.parentSelector){const i=e(s.parentSelector);if(i&&i.contains(t))return!0}return!1}textContentTag(e){return["#text","svg","text"].includes(e)}textTrackKeyTest(e,t,s){return e[t]&&s&&e[t]===s}unmute(t,s,i=!1){if(this.muted){if(t.strictUnmute&&this.muteRuleId!==t._id)return;if(!i&&t&&t.unmuteDelay>=0)return null==this.unmuteTimeout&&this.clearUnmuteTimeout(t),void(this.unmuteTimeout=window.setTimeout(this.delayedUnmute,t.unmuteDelay,this,t));switch(this.muted=!1,t.muteMethod){case d.MUTE_METHODS.TAB:chrome.runtime.sendMessage(this.filter.buildMessage(d.MESSAGING.BACKGROUND,{mute:!1}));break;case d.MUTE_METHODS.VIDEO_MUTE:this.fillerAudio&&this.stopFillerAudio(),s||(s=e(t.videoSelector)),s&&s.muted&&(s.muted=!1);break;case d.MUTE_METHODS.VIDEO_VOLUME:this.fillerAudio&&this.stopFillerAudio(),s||(s=e(t.videoSelector)),s&&null!=s.volume&&(s.volume=this.volume)}w.debugTime("unmute()")}}watcher(t,s=0){const o=t.rules[s],r=e(o.videoSelector);if(r&&t.playing(r)){o.ignoreMutations&&t.filter.stopObserving();const s={filtered:!1,initialCall:!0,textResults:[]};if(o.apfCaptions&&o.displaySelector&&t.hideSubtitles(o),o.parentSelector){const e=document.querySelector(o.parentSelector);e&&e.textContent&&e.textContent.trim()?t.processWatcherCaptions(o,e,s):t.watcherSimpleUnmute(o,r)}else if(o.subtitleSelector){const n=function(e,t=document){const s=t,a=e.split("&&&");let o=[];for(const e of a){const t=i(e,s);t&&t.length&&(o=o.concat(Array.from(t)))}return o}(o.subtitleSelector);n&&n.length?(!o.displayVisibility||o._displayElement&&document.body.contains(o._displayElement)||(o.displayElementLevels?o._displayElement=a(n[0],o.displayElementLevels):o._displayElement=e(o.displaySelector)),t.processWatcherCaptionsArray(o,n,s)):t.watcherSimpleUnmute(o,r)}if(s.skipped)return!1;t.supportedCaptionsFound();const n=t.subtitlesShouldBeShown(o,s.filtered);o.apfCaptions?t.displayApfCaptions(o,s.textResults,n):n?t.showSubtitles(o):t.hideSubtitles(o),s.filtered&&t.filter.updateCounterBadge()}else o.ignoreMutations&&t.filter.startObserving()}watchForVideo(t){for(let s=0;s<t.cueRuleIds.length;s++){const i=t.rules[s],a=e(i.videoSelector);if(a&&a.textTracks&&t.playing(a)){i.externalSub&&t.processExternalSub(a,i);const e=t.getVideoTextTrack(a.textTracks,i);if(e&&!e.oncuechange){i.videoCueHideCues||i.showSubtitles!==d.SHOW_SUBTITLES.NONE||(e.mode="hidden"),e.oncuechange=()=>{if(e.activeCues&&e.activeCues.length>0){const s=Array.from(e.activeCues),o=[];if(!s.some((e=>e.hasOwnProperty("filtered")))){const s=Array.from(e.cues);t.processCues(s,i)}const r=s.some((e=>e.filtered));r?t.mute(i,a):t.unmute(i,a);const n=t.subtitlesShouldBeShown(i,r);for(let e=0;e<s.length;e++){const a=s[e];!n&&i.videoCueHideCues&&t.hideCue(i,a),i.apfCaptions&&o.unshift({filtered:a.filteredText,original:a.originalText,modified:a.filtered})}i.apfCaptions&&t.displayApfCaptions(i,o,n),i.videoCueHideCues||(e.mode=n?"showing":"hidden"),i.displaySelector&&(i.apfCaptions||!n?t.hideSubtitles(i):t.showSubtitles(i))}else t.unmute(i,a),i.apfCaptions&&t.removeApfCaptions(i)};const s=Array.from(e.cues);t.processCues(s,i),t.supportedCaptionsFound(!0)}}}}watcherSimpleUnmute(e,t){this.unmute(e,t),e.showSubtitles>d.SHOW_SUBTITLES.ALL&&this.hideSubtitles(e)}watcherToCue(t,s=0){const a=t.rules[s],o=e(a.videoSelector);if(o&&t.playing(o)){a.ignoreMutations&&t.filter.stopObserving(),t.hideSubtitles(a);const e=t.apfTextTrack(a,o),s=o.currentTime,r={filtered:!1,initialCall:!0,textResults:[]};let n;if(a.subtitleSelector)if(n=Array.from(i(a.subtitleSelector)),n&&n.length){const i=n.map((e=>e.textContent)).join(" ");if(a._lastProcessedText&&a._lastProcessedText===i)return r.skipped=!0,!1;{t.unmute(a,o),a._lastProcessedText=i,t.lastProcessedText=i,e&&e.activeCues&&e.activeCues.length&&Array.from(e.activeCues).forEach((e=>e.endTime=s-.001));const l=o.duration;n.reverse(),n.forEach((i=>{if(i.textContent&&i.textContent.trim()){const n=t.replaceTextResult(i.textContent);r.textResults.push(n),n.modified&&(t.mute(a,o),r.filtered=!0);const d=a.filterSubtitles?n.filtered:n.original,u=t.newCue(s,l,d);u.filtered=r.filtered,u.originalText=n.original,e.addCue(u)}}));const d=t.subtitlesShouldBeShown(a,r.filtered);a.videoCueHideCues||(e.mode=d?"showing":"hidden")}}else{t.watcherSimpleUnmute(a,o),e&&e.activeCues&&e.activeCues.length&&Array.from(e.activeCues).forEach((e=>e.endTime=s-.001));const i=t.subtitlesShouldBeShown(a,r.filtered);a.videoCueHideCues||(e.mode=i?"showing":"hidden")}if(r.skipped)return!1;r.filtered&&t.filter.updateCounterBadge()}else a.ignoreMutations&&t.filter.startObserving()}youTubeAutoSubsCurrentRow(e){return!(e.parentElement.parentElement!=e.parentElement.parentElement.parentElement.lastChild)}youTubeAutoSubsMuteTimeout(e){const t=window.document.querySelector(v.defaultVideoSelector);t&&e.playing(t)&&e.unmute(e.youTubeAutoSubsRule),e.youTubeAutoSubsTimeout=null}youTubeAutoSubsNodeIsSubtitleText(e){const t=document.querySelector("div.caption-window");return!(!t||!t.contains(e))}youTubeAutoSubsPresent(){const e=!!document.querySelector("div.ytp-caption-window-rollup");return e&&this.supportedCaptionsFound(),e}youTubeAutoSubsSupportedNode(e){return"#text"==e.nodeName&&""!=e.textContent&&!!this.youTubeAutoSubsNodeIsSubtitleText(e)}}s(350);class y{advanced;cfg;cfgKey;deep;disabled;enabled;framesOff;framesOn;hostname;tab;wordlistId;static get Constants(){return l}get Class(){return this.constructor}static _domainCfgDefaults={adv:void 0,deep:void 0,disabled:void 0,enabled:void 0,framesOff:void 0,framesOn:void 0,wordlist:void 0};static byHostname(e,t){const s=this.findDomainKey(e,t)||e,i=this.byKey(s,t);return i.hostname=e,i}static byKey(e,t){return new this(e,t[e])}static findDomainKey(e,t){return Object.keys(t).sort(((e,t)=>t.length-e.length)).find((t=>new RegExp(`(^|.)${t}$`).test(e)))}static getCurrentTab(){return new Promise(((e,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{e(t[0])}))}))}static sortedKeys(e){return Object.keys(e).sort(((e,t)=>{const s=this.sortingKey(e),i=this.sortingKey(t);return s==i?e<t?-1:e>t?1:0:s<i?-1:s>i?1:0}))}static sortingKey(e){const t=e.split(".");switch(t.length){case 1:case 2:return t[0];case 3:return t[1];case 4:return t[1].match(/^\d+$/)?e:t[3].length?t[1]:t[2];default:return t[2]}}constructor(e,t){this.cfgKey=e,this.cfg={},t?this.cfg=t:Object.assign(this.cfg,this.Class._domainCfgDefaults),this.updateFromCfg()}getModeIndex(){return this.advanced?this.Class.Constants.DOMAIN_MODES.ADVANCED:this.deep?this.Class.Constants.DOMAIN_MODES.DEEP:this.Class.Constants.DOMAIN_MODES.NORMAL}async save(e){if(e.domains)return this.updateCfg(),"{}"===JSON.stringify(this.cfg)?delete e.domains[this.cfgKey]:e.domains[this.cfgKey]=this.cfg,await e.save("domains")}updateCfg(){this.cfg.adv=!0===this.advanced||void 0,this.cfg.deep=!0===this.deep||void 0,this.cfg.disabled=!0===this.disabled||void 0,this.cfg.enabled=!0===this.enabled||void 0,this.cfg.framesOff=!0===this.framesOff||void 0,this.cfg.framesOn=!0===this.framesOn||void 0,this.cfg.wordlist=this.wordlistId>=0?this.wordlistId:void 0}updateFromCfg(){this.advanced=this.cfg.adv,this.deep=this.cfg.deep,this.disabled=this.cfg.disabled,this.enabled=this.cfg.enabled,this.framesOff=this.cfg.framesOff,this.framesOn=this.cfg.framesOn,this.wordlistId=this.cfg.wordlist}updateFromModeIndex(e){switch(e){case this.Class.Constants.DOMAIN_MODES.NORMAL:this.advanced=!1,this.deep=!1;break;case this.Class.Constants.DOMAIN_MODES.ADVANCED:this.advanced=!0,this.deep=!1;break;case this.Class.Constants.DOMAIN_MODES.DEEP:this.advanced=!1,this.deep=!0}}}class E{_filterMethod;case;escaped;lists;matchMethod;matchRepeated;matchSeparators;regExp;sub;subs;unicode;value;static _edgePunctuationRegExp=/(^[,.'"!?%$+]|[,.'"!?%$+]$)/;static _escapeRegExp=/[\/\\^$*+?.()|[\]{}]/g;static _unicodeRegExp=/[^\u0000-\u00ff]/;static _unicodeWordBoundary="[\\s.,'\"+!?|-]";static nonWordRegExp=new RegExp("^\\s*[^\\w]+\\s*$","g");static separatorsRegExp="[-_ ]*";static whitespaceRegExp=/^\s+$/;static allLowerCase(e){return e.toLowerCase()===e}static allUpperCase(e){return e.toUpperCase()===e}static capitalizeEachWord(e){return e.split(/[-_ ]+/i).forEach((t=>{e=e.replace(t,this.capitalizeFirst(t))})),e}static capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}static containsDoubleByte(e){return!!e.length&&(e.charCodeAt(0)>127||E._unicodeRegExp.test(e))}static eachWordCapitalized(e){return e.split(/[-_ ]+/i).every((e=>this.firstCapitalized(e)))}static escapeRegExp(e){return e.replace(E._escapeRegExp,"\\$&")}static firstCapitalized(e){const t=e.charAt(0);return t===t.toUpperCase()&&t!==t.toLowerCase()}constructor(e,t,s){this.value=e,this.case=t.case>l.FALSE?l.TRUE:l.FALSE,this.lists=void 0===t.lists?[]:t.lists,this.matchMethod=void 0===t.matchMethod?s.defaultWordMatchMethod:t.matchMethod,this.matchRepeated=void 0===t.repeat?s.defaultWordRepeat:t.repeat,this.matchSeparators=void 0===t.separators?s.defaultWordSeparators:t.separators,this.sub=t.sub||s.defaultSubstitution,this.subs=this.sub.split(s.wordSubSeparator),this._filterMethod=void 0===t._filterMethod?s.filterMethod:t._filterMethod,this.unicode=E.containsDoubleByte(e),this.escaped=this.matchMethod===l.MATCH_METHODS.REGEX?this.value:E.escapeRegExp(this.value),this.regExp=this.buildRegExp()}buildRegExp(){try{switch(this.matchMethod){case l.MATCH_METHODS.PARTIAL:return this._filterMethod===l.FILTER_METHODS.REMOVE?this.unicode?new RegExp("(^|"+E._unicodeWordBoundary+"?)([\\w-]*"+this.processedPhrase()+"[\\w-]*)("+E._unicodeWordBoundary+"?|$)",this.regexOptions()):this.hasEdgePunctuation()?new RegExp("(^|\\s)([\\w-]*"+this.processedPhrase()+"[\\w-]*)(\\s|$)",this.regexOptions()):new RegExp("\\s?\\b[\\w-]*"+this.processedPhrase()+"[\\w-]*\\b\\s?",this.regexOptions()):new RegExp(this.processedPhrase(),this.regexOptions());case l.MATCH_METHODS.WHOLE:return this.unicode?new RegExp("(^|"+E._unicodeWordBoundary+"*)([\\S]*"+this.processedPhrase()+"[\\S]*)("+E._unicodeWordBoundary+"*|$)",this.regexOptions()):this.hasEdgePunctuation()?new RegExp("(^|\\s)([\\S]*"+this.processedPhrase()+"[\\S]*)(\\s|$)",this.regexOptions()):new RegExp("\\b[\\w-]*"+this.processedPhrase()+"[\\w-]*\\b",this.regexOptions());case l.MATCH_METHODS.REGEX:return new RegExp(this.value,this.regexOptions());case l.MATCH_METHODS.EXACT:default:return this.unicode||"-"!=this.value[0]&&"-"!=this.value[this.value.length-1]||(this.unicode=!0),this._filterMethod===l.FILTER_METHODS.REMOVE?this.unicode?new RegExp("(^|"+E._unicodeWordBoundary+")("+this.processedPhrase()+")("+E._unicodeWordBoundary+"|$)",this.regexOptions()):this.hasEdgePunctuation()?new RegExp("(^|\\s)("+this.processedPhrase()+")(\\s|$)",this.regexOptions()):new RegExp("\\s?\\b"+this.processedPhrase()+"\\b\\s?",this.regexOptions()):this.unicode?new RegExp("(^|"+E._unicodeWordBoundary+"+)("+this.processedPhrase()+")("+E._unicodeWordBoundary+"+|$)",this.regexOptions()):this.hasEdgePunctuation()?new RegExp("(^|\\s)("+this.processedPhrase()+")(\\s|$)",this.regexOptions()):new RegExp("\\b"+this.processedPhrase()+"\\b",this.regexOptions())}}catch(e){throw new Error(`Failed to create RegExp for '${this.value}'. [${e.name}: ${e.message}]`)}}hasEdgePunctuation(){return E._edgePunctuationRegExp.test(this.value)}processedPhrase(){const e=this.escaped.includes("\\");let t="";const s=this.escaped.length-1;for(let i=0;i<this.escaped.length;i++)e&&"\\"===this.escaped[i]&&(t+=this.escaped[i],i++),t+=this.escaped[i],this.matchRepeated&&(t+="+"),this.matchSeparators&&i!=s&&(t+=E.separatorsRegExp);return t}regexOptions(){let e="gi";return this.unicode&&(e+="u"),e}}const C=new u("Wordlist");class x{all;list;regExps;constructor(e,t){this.all=[],this.list=[],this.regExps=[],C.setLevel(e.loggingLevel),Object.keys(e.words).sort(((e,t)=>t.length-e.length)).forEach((s=>{if(t===l.ALL_WORDS_WORDLIST_ID||!Array.isArray(e.words[s].lists)||e.words[s].lists.includes(t))try{const t=new E(s,e.words[s],e);this.list.push(s),this.all.push(t),this.regExps.push(t.regExp)}catch(e){C.warn(`Failed to add '${s}' to wordlist.`,e)}}))}find(e){return"string"==typeof e?this.all[this.list.indexOf(e)]:"number"==typeof e?this.all[e]:void 0}}class A{allowlist;cfg;counter;iAllowlist;wordlistId;wordlists;constructor(){this.allowlist=[],this.counter=0,this.iAllowlist=[],this.wordlists={}}buildWordlist(e,t=!1){return!1===e&&(e=this.wordlistId),!t&&this.wordlists[e]||(this.wordlists[e]=new x(this.cfg,e)),e}checkAllowlist(e,t,s,i){const a=this.allowlist.length,o=this.iAllowlist.length;if(a||o){if(a&&this.allowlist.includes(e))return!0;if(o&&this.iAllowlist.includes(e.toLowerCase()))return!0;if(i.matchMethod===l.MATCH_METHODS.PARTIAL){const i={matchMethod:l.MATCH_METHODS.WHOLE,repeat:l.FALSE,separators:l.FALSE,sub:""},r=new E(e,i,this.cfg).regExp;let n;for(;null!==(n=r.exec(t));){const t=4==n.length?n[2]:n[0],i=4==n.length?n.index+n[1].length:n.index;if(i<=s&&i+t.length>=s+e.length){if(a&&this.allowlist.includes(t))return!0;if(o&&this.iAllowlist.includes(t.toLowerCase()))return!0}}}}return!1}foundMatch(e,t){this.counter++}init(e=!1){this.iAllowlist=this.cfg.iWordAllowlist,this.allowlist=this.cfg.wordAllowlist,void 0===this.wordlistId&&(this.wordlistId=null==this.cfg.wordlistId?l.ALL_WORDS_WORDLIST_ID:this.cfg.wordlistId),this.buildWordlist(e)}matchData(e,t,s,i){const a=e.find(t),o=i.pop(),r=i.pop(),n=i,d=n.length>0&&a.matchMethod!==l.MATCH_METHODS.REGEX;return d&&(s=n[1]),{word:a,string:o,match:s,matchStartIndex:r,captureGroups:n,internalCaptureGroups:d}}rebuildWordlists(){Object.keys(this.wordlists).forEach((e=>{this.buildWordlist(parseInt(e),!0)}))}replaceText(e,t=!1,s=l.STATS_TYPE_TEXT){t=this.buildWordlist(t);const i=this.wordlists[t];switch(this.cfg.filterMethod){case l.FILTER_METHODS.OFF:case l.FILTER_METHODS.CENSOR:i.regExps.forEach(((t,a)=>{e=e.replace(t,((e,...t)=>{const{word:o,string:r,match:n,matchStartIndex:l,captureGroups:d,internalCaptureGroups:u}=this.matchData(i,a,e,t);if(this.checkAllowlist(n,r,l,o))return n;s&&this.foundMatch(o,s);let c="";const h=this.cfg.censorFixedLength>0?this.cfg.censorFixedLength:n.length;return c=this.cfg.preserveFirst&&this.cfg.preserveLast?n[0]+this.cfg.censorCharacter.repeat(h-2)+n.slice(-1):this.cfg.preserveFirst?n[0]+this.cfg.censorCharacter.repeat(h-1):this.cfg.preserveLast?this.cfg.censorCharacter.repeat(h-1)+n.slice(-1):this.cfg.censorCharacter.repeat(h),u&&(c=d[0]+c+d[2]),c}))}));break;case l.FILTER_METHODS.SUBSTITUTE:i.regExps.forEach(((t,a)=>{e=e.replace(t,((e,...t)=>{const{word:o,string:r,match:n,matchStartIndex:d,captureGroups:u,internalCaptureGroups:c}=this.matchData(i,a,e,t);if(this.checkAllowlist(n,r,d,o))return n;s&&this.foundMatch(o,s);let h=this.shuffleSubstitution(o.subs);return o.matchMethod==l.MATCH_METHODS.REGEX&&u.length&&o.sub.includes("\\1")&&(u.forEach(((e,t)=>{h=h.replace(`\\${t+1}`,this.cfg.preserveCase?e:e.toLowerCase())})),h!==o.sub)?(this.cfg.substitutionMark&&(h="["+h+"]"),h):(o.case==l.FALSE&&this.cfg.preserveCase&&(E.allUpperCase(n)?h=h.toUpperCase():E.eachWordCapitalized(n)?h=E.capitalizeEachWord(h):E.firstCapitalized(n)&&(h=E.capitalizeFirst(h))),this.cfg.substitutionMark&&(h="["+h+"]"),c&&(h=u[0]+h+u[2]),h)}))}));break;case l.FILTER_METHODS.REMOVE:i.regExps.forEach(((t,a)=>{e=e.replace(t,((e,...t)=>{const{word:o,string:r,match:n,matchStartIndex:l,captureGroups:d,internalCaptureGroups:u}=this.matchData(i,a,e,t);return this.checkAllowlist(n.trim(),r,l,o)?n:(s&&this.foundMatch(o,s),u?E.whitespaceRegExp.test(d[0])&&E.whitespaceRegExp.test(d[2])?d[0]:E.nonWordRegExp.test(d[0])||E.nonWordRegExp.test(d[2])?(d[0]+d[2]).trim():"":E.whitespaceRegExp.test(n[0])&&E.whitespaceRegExp.test(n[n.length-1])?n[0]:"")}))}))}return e}replaceTextResult(e,t=!1,s=l.STATS_TYPE_TEXT){const i={original:e,filtered:this.replaceText(e,t,s),modified:!1};return i.modified=i.filtered!=e,i}shuffleSubstitution(e){return function(e){const t=e.length;return t<=1?e[0]:e[Math.floor(Math.random()*t)]}(e)}}class N{xpathDocText;xpathNodeText;static disabledProtocols=new RegExp("(^chrome:|^about:|^[a-zA-Z]+-extension:)","i");static forbiddenNodeRegExp=new RegExp("^s*(<[a-z].+?/?>|{.+?:.+?;.*}|https?://[^s]+$)");static forbiddenTags=["SCRIPT","STYLE","INPUT","TEXTAREA","IFRAME","LINK"];static isForbiddenNode(e){return!!e.isContentEditable||!(!e.parentNode||!e.parentNode.isContentEditable&&!N.forbiddenTags.includes(e.parentNode.nodeName))||N.forbiddenTags.includes(e.nodeName)}}const M=new u("WebFilter");class _ extends A{domain;extension;filterText;hostname;iframe;lastCounter;location;observer;processMutationTarget;processNode;shadowObserver;stats;summary;static get Config(){return m}static get Constants(){return l}static get Domain(){return y}static get Page(){return N}get Class(){return this.constructor}static observerConfig={characterData:!0,characterDataOldValue:!0,childList:!0,subtree:!0};constructor(){super(),this.extension=!0,this.filterText=!0,this.lastCounter=0,this.processMutationTarget=!1,this.stats={words:{}},this.summary={}}get _defaultStats(){return{words:{}}}get _defaultWordStat(){return{[this.Class.Constants.STATS_TYPE_TEXT]:0}}_processStatsBeforeSaving(e){}_processWordStat(e,t){e.words[t]||(e.words[t]=this._defaultWordStat),e.words[t][this.Class.Constants.STATS_TYPE_TEXT]+=this.stats.words[t][this.Class.Constants.STATS_TYPE_TEXT]}advancedReplaceText(e,t,s=this.Class.Constants.STATS_TYPE_TEXT){if(e.parentNode||e===document)for(const i of this.wordlists[t].regExps)findAndReplaceDOMText(e,{preset:"prose",find:i,replace:(e,i)=>0===e.index?this.replaceText(i[0],t,s):""});else this.cleanText(e,t,s)}beforeProcessingPage(e){}buildInitStateMessage(e){e.iframe=!!this.iframe,e.advanced=this.domain.advanced,e.deep=this.domain.deep,e.status=this.Class.Constants.STATUS.NORMAL,e.advanced&&(e.status=this.Class.Constants.STATUS.ADVANCED),e.deep&&(e.status=this.Class.Constants.STATUS.DEEP),this.cfg.showCounter&&e.status!=this.Class.Constants.STATUS.NORMAL&&(e.counter=this.counter)}buildMessage(e,t={}){return Object.assign({destination:e,source:this.Class.Constants.MESSAGING.CONTEXT},t)}cleanChildNode(e,t,s=this.Class.Constants.STATS_TYPE_TEXT){if(e.nodeName)if(e.textContent&&""!=e.textContent.trim()){const i=this.replaceTextResult(e.textContent,t,s);i.modified&&this.filterText&&(e.textContent=i.filtered)}else"IMG"==e.nodeName?(this.cleanNodeAttribute(e,"alt",t,s),this.cleanNodeAttribute(e,"title",t,s)):e.shadowRoot&&this.filterShadowRoot(e.shadowRoot,t,s)}cleanNode(e,t,s=this.Class.Constants.STATS_TYPE_TEXT){if(this.Class.Page.isForbiddenNode(e))return!1;if(e.shadowRoot&&this.filterShadowRoot(e.shadowRoot,t,s),e.childNodes.length>0)for(let i=0;i<e.childNodes.length;i++)this.cleanNode(e.childNodes[i],t,s);else this.cleanChildNode(e,this.wordlistId,s)}cleanNodeAttribute(e,t,s,i=this.Class.Constants.STATS_TYPE_TEXT){if(""!=e[t]){const a=this.replaceTextResult(e[t],s,i);a.modified&&this.filterText&&(e[t]=a.filtered)}}async cleanPage(){if(this.cfg=await this.Class.Config.load(),M.setLevel(this.cfg.loggingLevel),0===Object.keys(this.cfg.words).length)return M.warn("No words to filter. Exiting."),!1;if(this.filterText=this.cfg.filterMethod!==this.Class.Constants.FILTER_METHODS.OFF,this.domain=this.Class.Domain.byHostname(this.hostname,this.cfg.domains),M.info("Config loaded.",this.cfg),!this.shouldProcessFrame)return M.info(`Filter disabled on frames for current domain (${this.iframe.href})`),!1;const e=await this.getBackgroundData(),t=this.buildMessage(this.Class.Constants.MESSAGING.BACKGROUND);return this.shouldBeDisabled(e)?(t.disabled=!0,M.info(`Disabled for page '${this.hostname}'.`),chrome.runtime.sendMessage(t),!1):(this.beforeProcessingPage(t),this.sendInitState(t),!t.disabled&&(this.setDomainWordlist(),this.onMessage(),this.init(),M.infoTime("Filter initialized.",this),this.processInitialPage(),M.infoTime("Initial page filtered."),this.startObserving(document),void(this.cfg.collectStats&&(this.persistStats(),window.setTimeout(this.persistStats.bind(this),3e3),window.setTimeout(this.persistStats.bind(this),6e3),window.setInterval(this.persistStats.bind(this),1e4)))))}cleanText(e,t,s=this.Class.Constants.STATS_TYPE_TEXT){if(this.Class.Page.isForbiddenNode(e))return!1;if(e.shadowRoot&&this.filterShadowRoot(e.shadowRoot,t,s),e.childElementCount>0){const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);for(;i.nextNode();)if(i.currentNode.childNodes.length>0)for(const e of i.currentNode.childNodes)this.cleanText(e,t,s);else this.Class.Page.isForbiddenNode(i.currentNode)||this.cleanChildNode(i.currentNode,t,s)}else this.cleanChildNode(e,t,s)}filterShadowRoot(e,t,s=this.Class.Constants.STATS_TYPE_TEXT){this.shadowObserver.observe(e,this.Class.observerConfig),this.processNode(e,t,s)}foundMatch(e,t){if(super.foundMatch(e,t),this.cfg.showSummary)if(this.summary[e.value])this.filterText?this.summary[e.value].count+=1:this.counter--;else{let t;t=e.matchMethod===this.Class.Constants.MATCH_METHODS.REGEX?e.sub||this.cfg.defaultSubstitution:this.replaceText(e.value,this.Class.Constants.ALL_WORDS_WORDLIST_ID,null),this.summary[e.value]={filtered:t,count:1}}if(this.cfg.collectStats){const s=this.stats.words;s[e.value]||(s[e.value]={[this.Class.Constants.STATS_TYPE_TEXT]:0}),this.filterText&&t==this.Class.Constants.STATS_TYPE_TEXT&&s[e.value][this.Class.Constants.STATS_TYPE_TEXT]++}}getBackgroundData(){return new Promise(((e,t)=>{const s=this.buildMessage(this.Class.Constants.MESSAGING.BACKGROUND,{backgroundData:!0,iframe:!!this.iframe});chrome.runtime.sendMessage(s,(t=>{t||(t={disabledTab:!1}),e(t)}))}))}async getStatsFromStorage(){const{stats:e}=await this.Class.Config.getLocalStorage({stats:this._defaultStats});return e}handleUrlUpdateMessage(){}init(e=!1){super.init(e),this.domain.advanced?this.processNode=this.advancedReplaceText:this.domain.deep?(this.processMutationTarget=!0,this.processNode=this.cleanNode):this.processNode=this.cleanText,this.observer=new MutationObserver(this.processMutations.bind(this)),this.shadowObserver=new MutationObserver(this.processMutations.bind(this))}initPageDetails(){if(window!=window.top){this.iframe=document.location;try{this.hostname=window.parent.location.hostname}catch(e){document.referrer?this.hostname=new URL(document.referrer).hostname:this.hostname=document.location.hostname}}else this.hostname=document.location.hostname}onMessage(){chrome.runtime.onMessage.addListener(((e,t,s)=>{if(e.destination!==this.Class.Constants.MESSAGING.CONTEXT)return!0;switch(e.source){case this.Class.Constants.MESSAGING.BACKGROUND:e.urlUpdate?this.handleUrlUpdateMessage():M.error("Received unhandled message.",JSON.stringify(e));break;case this.Class.Constants.MESSAGING.POPUP:e.summary?this.shouldSendPopupSummary&&chrome.runtime.sendMessage(this.popupSummaryMessage):M.error("Received unhandled message.",JSON.stringify(e));break;default:M.error("Received message without a supported source:",JSON.stringify(e))}s()}))}async persistStats(){if(!this.Class.Config.chromeStorageAvailable())return!1;try{const e=Object.keys(this.stats.words);if(e.length){const t=await this.getStatsFromStorage();for(const s of e)this._processWordStat(t,s);null==t.startedAt&&(t.startedAt=Date.now()),this._processStatsBeforeSaving(t),await this.Class.Config.saveLocalStorage({stats:t}),this.stats=this._defaultStats}}catch(e){"Extension context invalidated."!==e.message&&M.warn("Failed to save stats.",e)}}get popupSummaryMessage(){return this.buildMessage(this.Class.Constants.MESSAGING.POPUP,{summary:this.summary})}processAddedNode(e){this.processNode(e,this.wordlistId)}processAddedNodes(e){for(const t of e)this.shouldProcessAddedNode(t)&&this.processAddedNode(t)}processInitialPage(){this.processNode(document,this.wordlistId),this.updateCounterBadge()}processMutation(e){this.shouldProcessAddedNodes(e)&&this.processAddedNodes(e.addedNodes),this.shouldProcessRemovedNodes(e)&&this.processRemovedNodes(e.removedNodes),this.shouldProcessMutationTargetNode(e)&&this.processMutationTargetNode(e)}processMutationTargetNode(e){"#text"===e.target.nodeName?this.shouldProcessMutationTargetText(e)&&this.processMutationTargetText(e):this.processMutationTarget&&this.processNode(e.target,this.wordlistId)}processMutationTargetText(e){const t=e.target,s=this.replaceTextResult(t.data,this.wordlistId);s.modified&&(t.data=s.filtered)}processMutations(e){for(const t of e)this.processMutation(t);this.updateCounterBadge()}processRemovedNode(e){}processRemovedNodes(e){for(const t of e)this.processRemovedNode(t)}setDomainWordlist(){void 0!==this.domain.wordlistId&&(this.wordlistId=this.domain.wordlistId)}sendInitState(e){this.buildInitStateMessage(e),chrome.runtime.sendMessage(e)}shouldBeDisabled(e){return e.disabledTab||this.cfg.enabledDomainsOnly&&!this.domain.enabled||this.domain.disabled}shouldProcessAddedNode(e){return!this.Class.Page.isForbiddenNode(e)}shouldProcessAddedNodes(e){return e.addedNodes.length}get shouldProcessFrame(){return!this.iframe||this.cfg.enabledFramesOnly&&this.domain.framesOn||!this.cfg.enabledFramesOnly&&!this.domain.framesOff}shouldProcessMutationTargetNode(e){return null!=e.target}shouldProcessMutationTargetText(e){return!this.Class.Page.isForbiddenNode(e.target)}shouldProcessRemovedNodes(e){return!1}get shouldSendPopupSummary(){return this.cfg.showSummary&&this.counter>0}startObserving(e=document,t=this.observer){t.observe(e,this.Class.observerConfig)}stopObserving(e=this.observer){const t=e.takeRecords(),s=this.shadowObserver.takeRecords();e.disconnect(),this.shadowObserver.disconnect(),t&&this.processMutations(t),s&&this.processMutations(s)}updateCounterBadge(){if(chrome.runtime&&this.counter>this.lastCounter)try{if(this.lastCounter=this.counter,this.cfg.showCounter){const e=this.buildMessage(this.Class.Constants.MESSAGING.BACKGROUND,{counter:this.counter});chrome.runtime.sendMessage(e)}if(this.cfg.showSummary){const e=this.buildMessage(this.Class.Constants.MESSAGING.POPUP,{summary:this.summary});chrome.runtime.sendMessage(e)}}catch(e){"Extension context invalidated."!==e.message&&M.warn("Failed to sendMessage to update counter.",e)}}}const R=new u("WebFilter"),O=new class extends _{audio;audioOnly;audioWordlistId;mutePage;static get Config(){return g}static get Constants(){return d}static get Wordlist(){return x}get Class(){return this.constructor}constructor(){super(),this.audioOnly=!1,this.audioWordlistId=this.Class.Constants.ALL_WORDS_WORDLIST_ID,this.mutePage=!1,this.stats=this._defaultStats}get _defaultStats(){const e=super._defaultStats;return e.mutes=0,e}get _defaultWordStat(){const e=super._defaultWordStat;return e[this.Class.Constants.STATS_TYPE_AUDIO]=0,e}beforeProcessingPage(e){this.audioOnly=!!this.cfg.muteAudioOnly,this.cfg.muteAudio&&(this.audio=new v(this),this.mutePage=this.audio.supportedPage,this.mutePage&&(R.info(`[Audio] Enabling audio muting on ${this.hostname}.`),this.cfg.wordlistsEnabled&&this.wordlistId!=this.audio.wordlistId&&(this.wordlists[this.audio.wordlistId]=new this.Class.Wordlist(this.cfg,this.audio.wordlistId)))),this.audioOnly&&!this.mutePage&&(e.disabled=!0,R.info(`'[Audio] ${this.hostname}' is not an audio page and audio only mode is enabled. Exiting.`))}_processStatsBeforeSaving(e){e.mutes+=this.stats.mutes}_processWordStat(e,t){super._processWordStat(e,t);const s=this.Class.Constants.STATS_TYPE_AUDIO;null==e.words[t][s]&&(e.words[t][s]=0),e.words[t][s]+=this.stats.words[t][s]}buildInitStateMessage(e){this.cfg.muteAudio&&this.cfg.muteMethod==this.Class.Constants.MUTE_METHODS.TAB&&(e.clearMute=!0),super.buildInitStateMessage(e),e.mutePage=this.mutePage,e.mutePage&&(e.status=this.Class.Constants.STATUS.MUTE_PAGE),this.cfg.showCounter&&e.status!=this.Class.Constants.STATUS.NORMAL&&(e.counter=this.counter)}cleanAudio(e){if(this.audio.youTube&&this.audio.youTubeAutoSubsPresent())this.audio.youTubeAutoSubsSupportedNode(e)?this.audio.youTubeAutoSubsCurrentRow(e)?this.audio.cleanYouTubeAutoSubs(e):this.audioOnly||this.processNode(e,this.wordlistId):this.audioOnly||this.audio.youTubeAutoSubsNodeIsSubtitleText(e)||this.processNode(e,this.wordlistId);else{const t=this.audio.supportedNode(e);!1!==t?this.audio.clean(e,t):this.audioOnly||this.processNode(e,this.wordlistId)}}foundMatch(e,t){if(super.foundMatch(e,t),this.cfg.collectStats){const s=this.stats.words,i=this.Class.Constants.STATS_TYPE_AUDIO;s[e.value].hasOwnProperty(i)||(s[e.value][i]=0),this.filterText&&t==i&&s[e.value][i]++}}handleUrlUpdateMessage(){this.mutePage&&this.audio.supportedCaptionsFound(!1,!0)}get popupSummaryMessage(){const e=super.popupSummaryMessage;return e.mutePage=this.mutePage,e}processAddedNode(e){this.mutePage?this.cleanAudio(e):this.audioOnly||super.processAddedNode(e)}processInitialPage(){this.audioOnly||super.processInitialPage()}processMutationTargetText(e){const t=e.target;if(this.mutePage){const s=this.audio.supportedNode(t),i=!1!==s?this.audio.rules[s]:this.audio.rules[0];if(!1!==s&&i.simpleUnmute)this.audio.muted&&e.oldValue&&this.audio.lastFilteredText&&this.audio.lastFilteredText.includes(e.oldValue)&&this.audio.unmute(i),this.audio.clean(t,s);else if(i.simpleUnmute&&this.audio.muted&&!t.parentElement)this.audio.lastFilteredText&&this.audio.lastFilteredText.includes(t.textContent)&&this.audio.unmute(i);else if(!this.audioOnly){const e=this.replaceTextResult(t.data,this.wordlistId);e.modified&&(t.data=e.filtered)}}else this.audioOnly||super.processMutationTargetText(e)}processRemovedNode(e){if("VIDEO"==e.nodeName&&this.audio.supportedCaptions&&this.audio.supportedCaptionsFound(!1,!0),this.audio.apfCaptionsEnabled&&(e==this.audio.lastProcessedNode||e.contains(this.audio.lastProcessedNode))){const e=this.audio.rules[this.audio.apfCaptionRuleIds[0]];this.audio.removeApfCaptions(e)}if(this.audio.muted){const t=this.audio.supportedNode(e),s=!1!==t?this.audio.rules[t]:this.audio.rules[0];(!1!==t||e==this.audio.lastFilteredNode||e.contains(this.audio.lastFilteredNode)||s.simpleUnmute&&e.textContent&&this.audio.lastFilteredText&&this.audio.lastFilteredText.includes(e.textContent))&&(this.audio.unmute(s),s.apfCaptions&&this.audio.removeApfCaptions(s))}}setDomainWordlist(){super.setDomainWordlist(),void 0!==this.domain.audioWordlistId&&(this.audioWordlistId=this.domain.audioWordlistId)}shouldBeDisabled(e){return e.disabledTab||this.cfg.enabledDomainsOnly&&!this.domain.enabled&&!this.cfg.muteAudioOnly||this.domain.disabled}shouldProcessRemovedNodes(e){return this.mutePage&&(this.audio.muted||this.audio.apfCaptionsEnabled)}get shouldSendPopupSummary(){return this.cfg.showSummary&&(this.counter>0||this.mutePage)}};"undefined"!=typeof window&&["[object Window]","[object ContentScriptGlobalScope]"].includes({}.toString.call(window))&&(O.initPageDetails(),O.cleanPage())})()})();