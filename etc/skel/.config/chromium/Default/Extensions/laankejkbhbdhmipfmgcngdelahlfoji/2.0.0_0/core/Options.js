define(["core/Logger","core/CoreAPI","core/Layout","components/Prompt/BasePrompt","core/Prompt","core/Time","core/vendor/jquery.min","core/vendor/jquery.simplemodal.min"],function(Logger,API,Layout,BasePrompt,Prompt,Time,$){function log(funcName,message,payload,level){Logger.log("Options."+funcName,message,payload,level)}return{init:function(callback){log("init","Initializing Options",null,"DEBUG");var self=this;API.Settings.init(function(){API.Analytics.init(),$("a.close").click(function(){API.Chrome.Tab.getSelected(null,function(tab){API.Chrome.Tab.remove(tab.id)})}),self.initNav(),self.initChallenge(),self.initMaxTimeAllowed(),self.initActiveDays(),self.initActiveHours(!0),self.initResetTime(!0),self.initBlockedSites(),self.initAllowedSites(),self.initNuclearOption(!0),self.initCustomizeInterface(),self.initImportExport(),self.initRescue(),self.initPrompting(),"function"==typeof callback&&callback()})},initNav:function(){log("initNav","Initializing Options nav",null,"TRACE");var hash,self=this;return $("#nav li:not(#help):not(#logo)").click(function(){var link=$(this).data("link");self.selectNav(link)}),window.location.hash?(hash=(hash=window.location.hash.replace("#","")).replace("Tab",""),this.selectNav(hash)):this.selectNav("maxTimeAllowed"),!1},selectNav:function(navItem){log("selectNav","Selecting nav item",navItem,"TRACE"),$("#nav li a").removeClass("active"),$(`[data-link="${navItem}"] a`).addClass("active"),$("#body *[data-option]:not(.hidden)").addClass("hidden"),$("#body *[data-option]."+navItem).removeClass("hidden"),window.location.hash="#"+navItem+"Tab"},initMaxTimeAllowed:function(){log("initMaxTimeAllowed","Initializing max time allowed",null,"TRACE");var self=this;$("#maxTimeAllowed").keydown(function(event){self.allowOnlyNumbers(event)}),API.StayFocusd.isMaxTimeAllowedExceeded()&&($("#maxTimeAllowed").prop("disabled",!0),$("#maxTimeAllowedButton").prop("disabled",!0),$("#maxTimeAllowedMsg").html(API.Chrome.Translation.get("timeExpiredCannotChangeUntilTomorrow")),$("#maxTimeAllowedMsg").show())},setMaxTimeAllowed:function(maxTimeAllowed){log("setMaxTimeAllowed","Setting max time allowed to "+maxTimeAllowed),!1===API.StayFocusd.setMaxTimeAllowed(maxTimeAllowed)&&$("#maxTimeAllowed").val(API.StayFocusd.getMaxTimeAllowed())},initActiveDays:function(){log("initActiveDays","Initializing active days",null,"TRACE");var activeDays=API.StayFocusd.getActiveDays(),todayDay=(new Date).getDay(),self=this;$(".activeDay").each(function(){var checkbox=$(this),day=parseInt(checkbox.val());!0===activeDays.inArray(day)&&checkbox.prop("checked",!0),day===todayDay&&(checkbox.prop("checked")?checkbox.prop("disabled",!0):checkbox.click(function(){checkbox.prop("disabled",!0)}))}),$(".activeDay").click(function(){self.setActiveDays()})},setActiveDays:function(){var activeDays=[],todayDay=(new Date).getDay();$(".activeDay:checked").each(function(){var day=parseInt($(this).val(),10);day===todayDay&&$(this).prop("disabled",!0),activeDays.push(day)}),log("setActiveDays","Setting active days",activeDays),API.StayFocusd.setActiveDays(activeDays)},initActiveHours:function(initClick){log("initActiveHours","Initializing active hours",null,"TRACE");var timestamp,queueDay,queueYear,queueHour,queueAmpm,months,self=this,initClick=(!0===initClick&&$("#setActiveHours").click(function(){self.setActiveHours()}),API.StayFocusd.getActiveHours()),startTime=API.Date.parseMilitaryTime(initClick.startTime),initClick=API.Date.parseMilitaryTime(initClick.endTime),activeHoursQueue=($(".start .hour option[value="+startTime.hour+"]").prop("selected",!0),$(".start .min option[value="+startTime.min+"]").prop("selected",!0),$(".start .ampm option[value="+startTime.ampm+"]").prop("selected",!0),$(".end .hour option[value="+initClick.hour+"]").prop("selected",!0),$(".end .min option[value="+initClick.min+"]").prop("selected",!0),$(".end .ampm option[value="+initClick.ampm+"]").prop("selected",!0),API.StayFocusd.getActiveHoursQueue());0!=activeHoursQueue&&(timestamp=parseInt(activeHoursQueue.timestamp,10),startTime=activeHoursQueue.startTime,initClick=activeHoursQueue.endTime,timestamp=(activeHoursQueue=new Date(timestamp)).getMonth(),queueDay=activeHoursQueue.getDate(),queueYear=activeHoursQueue.getFullYear(),queueHour=activeHoursQueue.getHours(),activeHoursQueue=activeHoursQueue.getMinutes(),queueAmpm=API.Chrome.Translation.get("timeAM"),0===queueHour&&(queueHour=12,queueAmpm=API.Chrome.Translation.get("timeAM")),12<queueHour&&(queueHour=12===queueHour?12:queueHour-12,queueAmpm=API.Chrome.Translation.get("timePM")),activeHoursQueue=API.Date.toTwoDigits(activeHoursQueue),months=[API.Chrome.Translation.get("january"),API.Chrome.Translation.get("february"),API.Chrome.Translation.get("march"),API.Chrome.Translation.get("april"),API.Chrome.Translation.get("may"),API.Chrome.Translation.get("june"),API.Chrome.Translation.get("july"),API.Chrome.Translation.get("august"),API.Chrome.Translation.get("september"),API.Chrome.Translation.get("october"),API.Chrome.Translation.get("november"),API.Chrome.Translation.get("december")],startTime=API.Date.parseMilitaryTime(startTime),initClick=API.Date.parseMilitaryTime(initClick),months=API.Chrome.Translation.get("initActiveHoursMsg",[months[timestamp]+" "+queueDay+", "+queueYear,queueHour+":"+activeHoursQueue+" "+queueAmpm,startTime.display,initClick.display]),$("#activeHoursMsg").html(months),$("#activeHoursMsg").show())},setActiveHours:function(){log("setActiveHours","Setting active hours");var months=[API.Chrome.Translation.get("january"),API.Chrome.Translation.get("february"),API.Chrome.Translation.get("march"),API.Chrome.Translation.get("april"),API.Chrome.Translation.get("may"),API.Chrome.Translation.get("june"),API.Chrome.Translation.get("july"),API.Chrome.Translation.get("august"),API.Chrome.Translation.get("september"),API.Chrome.Translation.get("october"),API.Chrome.Translation.get("november"),API.Chrome.Translation.get("december")],todayDate=new Date,todayMonth=todayDate.getMonth(),todayDay=todayDate.getDate(),todayDate=todayDate.getFullYear(),todayDay=API.Date.toTwoDigits(todayDay),months=months[todayMonth]+" "+todayDay+", "+todayDate,todayMonth=$(".start .hour").val(),todayDay=$(".start .min").val(),todayDate=$(".start .ampm").val(),startDisplayHour=0===todayMonth?12:todayMonth,todayMonth=(todayMonth="pm"===todayDate?parseInt(todayMonth,10)+12:todayMonth)+":"+todayDay,startTimestamp=new Date(months+" "+todayMonth+":00").getTime(),endHour=$(".end .hour").val(),endMin=$(".end .min").val(),endAmpm=$(".end .ampm").val(),endDisplayHour=0===endHour?12:endHour,endHour=(endHour="pm"===endAmpm?parseInt(endHour,10)+12:endHour)+":"+endMin,confirmed=!0;new Date(months+" "+endHour+":00").getTime()<=startTimestamp&&(months=startDisplayHour+":"+todayDay+" "+todayDate.toUpperCase(),startTimestamp=endDisplayHour+":"+endMin+" "+endAmpm.toUpperCase(),confirmed=confirm(API.Chrome.Translation.get("activeOverMidnight",[months,startTimestamp]))),confirmed&&(API.StayFocusd.setActiveHoursQueue(todayMonth,endHour),!1===API.StayFocusd.isFirstInstallAllowanceActive()?alert(API.Chrome.Translation.get("activeHoursQueued")):alert(API.Chrome.Translation.get("activeHoursSet"))),this.initActiveHours()},initResetTime:function(initClick){log("initResetTime","Initializing daily reset time",null,"TRACE");var timestamp,queueDay,queueYear,queueHour,queueAmpm,months,self=this,initClick=(!0===initClick&&$("#setResetTime").click(function(){self.setResetTime()}),API.StayFocusd.getResetTime()),parsedTime=API.Date.parseMilitaryTime(initClick),resetTimeQueue=($(".reset .hour option[value="+parsedTime.hour+"]").prop("selected",!0),$(".reset .min option[value="+parsedTime.min+"]").prop("selected",!0),$(".reset .ampm option[value="+parsedTime.ampm+"]").prop("selected",!0),API.StayFocusd.getResetTimeQueue());!1!==resetTimeQueue&&(timestamp=parseInt(resetTimeQueue.timestamp,10),initClick=resetTimeQueue.resetTime,timestamp=(resetTimeQueue=new Date(timestamp)).getMonth(),queueDay=resetTimeQueue.getDate(),queueYear=resetTimeQueue.getFullYear(),queueHour=resetTimeQueue.getHours(),resetTimeQueue=resetTimeQueue.getMinutes(),queueAmpm=API.Chrome.Translation.get("timeAM"),0===queueHour&&(queueHour=12,queueAmpm=API.Chrome.Translation.get("timeAM")),12<queueHour&&(queueHour=12===queueHour?12:queueHour-12,queueAmpm=API.Chrome.Translation.get("timePM")),resetTimeQueue=API.Date.toTwoDigits(resetTimeQueue),months=[API.Chrome.Translation.get("january"),API.Chrome.Translation.get("february"),API.Chrome.Translation.get("march"),API.Chrome.Translation.get("april"),API.Chrome.Translation.get("may"),API.Chrome.Translation.get("june"),API.Chrome.Translation.get("july"),API.Chrome.Translation.get("august"),API.Chrome.Translation.get("september"),API.Chrome.Translation.get("october"),API.Chrome.Translation.get("november"),API.Chrome.Translation.get("december")],parsedTime=API.Date.parseMilitaryTime(initClick),initClick=API.Chrome.Translation.get("initResetTimeMsg",[months[timestamp]+" "+queueDay+", "+queueYear,queueHour+":"+resetTimeQueue+" "+queueAmpm,parsedTime.display]),$("#resetTimeMsg").html(initClick),$("#resetTimeMsg").show())},setResetTime:function(){var resetHour=$(".reset .hour").val(),resetMin=$(".reset .min").val(),resetHour=(resetHour="pm"===$(".reset .ampm").val()?parseInt(resetHour,10)+12:resetHour)+":"+resetMin;log("setResetTime","Setting daily reset time to "+resetHour),API.StayFocusd.setResetTimeQueue(resetHour),!1===API.StayFocusd.isFirstInstallAllowanceActive()?alert(API.Chrome.Translation.get("dailyResetQueued")):alert(API.Chrome.Translation.get("dailyResetSet")),this.initResetTime()},initBlockedSites:function(){log("initBlockedSites","Initializing blocked sites",null,"TRACE"),API.Component.load({name:"Blacklist",instance:"blacklist",onLoaded:function(component){component.view.setJQuery($),component.model.load(function(){component.view.inject($("#blockedSites"))})}})},initAllowedSites:function(){log("initAllowedSites","Initializing allowed sites",null,"TRACE"),API.Component.load({name:"Whitelist",instance:"whitelist",onLoaded:function(component){component.view.setJQuery($),component.model.load(function(){component.view.inject($("#allowedSites"))})}})},setNuclearOption:function(){var settings,blockHoursValue=$("#nuclearOptionForm input[name=blockHours]").val(),blockMinutesValue=$("#nuclearOptionForm input[name=blockMinutes]").val();if("0"===blockHoursValue&&"0"===blockMinutesValue||""==blockHoursValue&&""==blockMinutesValue)return alert(API.Chrome.Translation.get("greaterThanZero")),!1;confirm(this.getNuclearOptionConfirmationMsg())&&((settings={}).blockType=$("#nuclearOptionForm input[name=blockType]:checked").val(),settings.contentType=$("#nuclearOptionForm input[name=contentType]:checked").val(),settings.smartBomb={multimedia:$("#nuclearOptionForm input[name=multimedia]").prop("checked"),forms:$("#nuclearOptionForm input[name=forms]").prop("checked"),logins:$("#nuclearOptionForm input[name=logins]").prop("checked"),images:$("#nuclearOptionForm input[name=images]").prop("checked")},settings.blockLength=Time.formatTimeToMilliseconds(blockHoursValue,blockMinutesValue),settings.startType=$("#nuclearOptionForm input[name=startType]:checked").val(),settings.frequency=$("#nuclearOptionForm input[name=frequency]:checked").val(),settings.startHour=null,settings.startMin=null,settings.startAmPm=null,"atScheduledTime"===settings.startType&&(settings.startHour=$("#nuclearOptionForm select[name=startHour]").val(),settings.startMin=$("#nuclearOptionForm select[name=startMin]").val(),settings.startAmPm=$("#nuclearOptionForm select[name=startAmPm]").val()),API.NuclearOption.saveSettings(settings),log("setNuclearOption","Setting Nuclear Option",settings),"now"===settings.startType&&API.NuclearOption.activate(),this.initNuclearOption(),this.initAllowedSites(),alert(API.Chrome.Translation.get("commencingNuclearOption")))},getNuclearOptionConfirmationMsg:function(){var forms,startHour=$("#nuclearOptionForm select[name=startHour]").val(),startMin=$("#nuclearOptionForm select[name=startMin]").val(),startAmPm=$("#nuclearOptionForm select[name=startAmPm]").val(),contentType=$("#nuclearOptionForm input[name=contentType]:checked").val(),confirmMsg=API.Chrome.Translation.get("stayFocusdWillBlock")+" ";"smartBomb"===contentType&&(contentType=$("#nuclearOptionForm input[name=multimedia]").prop("checked"),forms=$("#nuclearOptionForm input[name=forms]").prop("checked"),images=$("#nuclearOptionForm input[name=images]").prop("checked"),logins=$("#nuclearOptionForm input[name=logins]").prop("checked"),contentTypes=[],contentType&&contentTypes.push(API.Chrome.Translation.get("multimedia")),forms&&contentTypes.push(API.Chrome.Translation.get("forms")),logins&&contentTypes.push(API.Chrome.Translation.get("logins")),images&&contentTypes.push(API.Chrome.Translation.get("images")),confirmMsg+=contentTypes.join("/")+" "+API.Chrome.Translation.get("for")+" ");var confirmMsg=(confirmMsg=(confirmMsg+=$("#nuclearOptionForm input[name=blockType]:checked + label").text())+(contentType=$("#nuclearOptionForm input[name=blockHours]").val(),forms=$("#nuclearOptionForm input[name=blockMinutes]").val(),` ${API.Chrome.Translation.get("forTime")} ${""==contentType?0:contentType} ${API.Chrome.Translation.get("hourOrMore")} ${""==forms?0:forms} `+API.Chrome.Translation.get("minOrMore")))+(" "+API.Chrome.Translation.get("startingTime")+" "),logins=$("#nuclearOptionForm input[name=startType]:checked").val();switch(logins){case"now":confirmMsg+=API.Chrome.Translation.get("rightNow");break;case"whenMaxTimeAllowedExceeded":confirmMsg+=API.Chrome.Translation.get("whenMaxTimeExceeded");break;case"atScheduledTime":confirmMsg=(confirmMsg=(confirmMsg+=API.Chrome.Translation.get("atTime")+" ")+("00"===startHour?"12":startHour)+(":"+startMin))+(" "+startAmPm.toUpperCase())}var images=$("#nuclearOptionForm input[name=frequency]:checked").val(),contentTypes=(new Date).getDay(),contentType="everyWeekday"!=images||0<contentTypes&&contentTypes<6;return confirmMsg+="activeDays"===images?" "+API.Chrome.Translation.get("onActiveDays")+".":"now"===logins?".":contentType?" "+API.Chrome.Translation.get("today")+".":" "+API.Chrome.Translation.get("onMonday")+".","atScheduledTime"===logins&&API.Date.hasTimePassed(startHour,startMin,startAmPm)&&contentType?confirmMsg+="\n\n"+API.Chrome.Translation.get("selectedTimeHasPassed")+" "+API.Chrome.Translation.get("nuclearOptionImmediately"):"whenMaxTimeAllowedExceeded"===logins&&API.StayFocusd.isMaxTimeAllowedExceeded()&&(confirmMsg+="\n\n"+API.Chrome.Translation.get("maxTimeHasBeenExceeded")+" "+API.Chrome.Translation.get("nuclearOptionImmediately")),confirmMsg+="\n\n"+API.Chrome.Translation.get("areYouSure")},initNuclearOption:function(initClick){log("initNuclearOption","Initializing Nuclear Option",null,"TRACE");var self=this;!0===initClick&&($("#activateNuclearOptionButton").click(function(){self.setNuclearOption()}),$("#nuclearOptionForm input[name=blockHours]").keydown(function(event){self.allowOnlyNumbers(event)}),$("#nuclearOptionForm input[name=blockMinutes]").keydown(function(event){self.validateInputMinutes(event)}),$("#nuclearOptionForm input[name=startType]").click(function(){"atScheduledTime"===$(this).val()?$("#nuclearOptionScheduledTime").show():$("#nuclearOptionScheduledTime").hide(),"now"===$(this).val()?$("#nuclearOptionFrequency").hide():$("#nuclearOptionFrequency").show()}),$("#nuclearOptionForm input[name=contentType]").click(function(){"smartBomb"===$(this).val()?$("#smartBombOptions").show():$("#smartBombOptions").hide()})),this.setNuclearOptionDefaults(),API.NuclearOption.isActive()&&(this.restrictNuclearOptionSettings(),initClick=API.NuclearOption.getExpiration(),initClick=(initClick=API.Date.timestampToDisplayDate(initClick)).hours+":"+initClick.minutes+" "+initClick.ampm+" on "+initClick.month+"/"+initClick.day+"/"+initClick.year,$("#nuclearOptionMsg").html(API.Chrome.Translation.get("nuclearOptionActiveUntil")+" "+initClick+"."),$("#nuclearOptionMsg").show())},restrictNuclearOptionSettings:function(){function checkBlockLength(value){var currentBlockLength=API.NuclearOption.getBlockLength();void 0!==currentBlockLength&&value<currentBlockLength&&(alert(API.Chrome.Translation.get("cannotChooseMoreLenientSetting")),$(this).val(currentBlockLength))}log("restrictNuclearOptionSettings","Restricting Nuclear Option settings"),this.disallowMoreLenientNuclearOption("blockType",["all","allExceptAllowed","blocked"]),this.disallowMoreLenientNuclearOption("contentType",["wholeSite","smartBomb"]),this.disallowMoreLenientNuclearOption("startType",["now","whenMaxTimeAllowedExceeded","atScheduledTime"]),this.disallowMoreLenientNuclearOption("frequency",["everyDay","everyWeekday","activeDays","todayOnly"]),$("#nuclearOptionForm input[name=blockHours]").change(function(){checkBlockLength($(this).val())}),$("#nuclearOptionForm input[name=blockMinutes]").change(function(){checkBlockLength($(this).val())}),$("#nuclearOptionForm input[value=atScheduledTime]").prop("checked")&&$("#nuclearOptionScheduledTime select").prop("disabled",!0)},disallowMoreLenientNuclearOption:function(inputName,leniency){log("disallowMoreLenientNuclearOption","Disallowing more lenient Nuclear Option settings");function alertFunction(){return alert(API.Chrome.Translation.get("cannotChooseMoreLenientSetting")),!1}for(var leniencyObj={},i=0;i<leniency.length;i++)leniencyObj[leniency[i]]=i;var level,inputValue=$("#nuclearOptionForm input[name="+inputName+"]:checked").val();for(level in leniencyObj)leniencyObj[inputValue]<leniencyObj[level]&&$("#nuclearOptionForm input[value="+level+"]").click(alertFunction)},setNuclearOptionDefaults:function(){log("setNuclearOptionDefaults","Setting Nuclear Option defaults");var type,nuclearOption=API.NuclearOption,blockType=nuclearOption.getBlockType(),blockType=($("#nuclearOptionForm input[value="+blockType+"]").prop("checked",!0),nuclearOption.getContentType()),smartBomb=($("#nuclearOptionForm input[value="+blockType+"]").prop("checked",!0),"smartBomb"===blockType?$("#smartBombOptions").show():$(".smartBombOption").prop("checked",!0),nuclearOption.getSmartBomb());for(type in smartBomb)smartBomb.hasOwnProperty(type)&&smartBomb[type]&&$("#nuclearOptionForm input[name="+type+"]").prop("checked",!0);var startMin,blockType=this.getBlockTimeForNuclear(),blockType=($("#nuclearOptionForm input[name=blockHours]").val(blockType.hours),$("#nuclearOptionForm input[name=blockMinutes]").val(blockType.minutes),nuclearOption.getStartType()),frequency=($("#nuclearOptionForm input[value="+blockType+"]").prop("checked",!0),nuclearOption.getFrequency());$("#nuclearOptionForm input[value="+frequency+"]").prop("checked",!0),"atScheduledTime"===blockType&&(frequency=nuclearOption.getStartHour(),startMin=nuclearOption.getStartMin(),nuclearOption=nuclearOption.getStartAmPm(),$("#nuclearOptionForm select[name=startHour]").val(frequency),$("#nuclearOptionForm select[name=startMin]").val(startMin),$("#nuclearOptionForm select[name=startAmPm]").val(nuclearOption),$("#nuclearOptionScheduledTime").show()),"now"===blockType?$("#nuclearOptionFrequency").hide():$("#nuclearOptionFrequency").show()},getBlockTimeForNuclear(){var blockLength=API.NuclearOption.getBlockLength();return Time.formatMillisecondsToTime(blockLength)},validateInputMinutes:function(event){this.allowOnlyNumbers(event),59<event.target.value+event.key&&event.preventDefault()},allowOnlyNumbers:function(event){const KeyCodes_Delete=46,KeyCodes_Backspace=8,KeyCodes_Tab=9;event.keyCode!==KeyCodes_Delete&&event.keyCode!==KeyCodes_Backspace&&event.keyCode!==KeyCodes_Tab&&(event.keyCode<48||57<event.keyCode&&(event.keyCode<96||105<event.keyCode))&&event.preventDefault()},initChallenge:function(){log("initChallenge","Initializing challenge",null,"TRACE");var self=this;API.Component.load({name:"Challenge",instance:"challengeOverlay",view:"overlay",onLoaded:function(component){component.view.setJQuery($),component.model.load(function(){component.view.inject($("#challengeContainer")),$("#productivityBypass").click(function(){self.initProductivityBypass()})})}}),API.Component.load({name:"Challenge",instance:"challengeOptions",view:"options",onLoaded:function(component){component.view.setJQuery($),component.model.load(function(){component.view.inject($("#requireChallenge")),component.model.isRequired()&&!self.isRescueMode()&&self.showChallenge(),$("#showChallenge").click(function(){self.showChallenge()})})}})},showChallenge:function(){return API.Analytics.event("SHOW_CHALLENGE_OVERLAY"),log("showChallenge","Showing challenge"),$("#challengeContainer").modal({opacity:80,overlayId:"overlay",escClose:!1}),!1},initProductivityBypass:function(){log("initProductivityBypass","Initializing productivity bypass",null,"DEBUG"),$("li[data-option]:not(li[data-bypass])").hide(),$("li[data-option]:not(li[data-bypass])").html(""),$("#blockWholeSite").prop("checked",!0),$("#nav li[data-option]:not(li[data-bypass])").hide(),$("*[data-hide-on-bypass]").hide(),this.selectNav("maxTimeAllowed"),$.modal.close()},initCustomizeInterface:function(){log("initCustomizeInterface","Initializing customize interface",null,"TRACE");var self=this,$disableSync=$("#disableSync"),$hideAllowSiteLink=$("#hideAllowSiteLink"),$hideInfoBar=$("#hideInfoBar"),$disableUpdatePopup=$("#disableUpdatePopup"),$saveNotificationsButton=$("#saveNotificationsButton"),$saveCustomMsgButton=$("#saveCustomMsgButton"),$customNotificationsInput=$("#customNotifications input"),$disableSync=(this.initActivityMonitor(),$disableSync.click(function(){self.toggleDisableSync()}),this.isSyncDisabled()&&$disableSync.prop("checked",!0),$hideAllowSiteLink.click(function(){self.toggleAllowSiteLink()}),!0===this.isAllowSiteLinkHidden()&&$hideAllowSiteLink.prop("checked",!0),$hideInfoBar.click(function(){self.toggleInfoBar()}),this.isInfoBarHidden()&&$hideInfoBar.prop("checked",!0),$disableUpdatePopup.click(function(){self.toggleUpdatePopup()}),API.StayFocusd.isUpdatePopupDisabled()&&$disableUpdatePopup.prop("checked",!0),API.StayFocusd.isUpdatePopupDisabled()&&$disableUpdatePopup.prop("checked",!0),API.Notification.get());this.setNotificationOptionDefaults($disableSync),$customNotificationsInput.keydown(function(event){self.allowOnlyNumbers(event)}),$saveNotificationsButton.click(function(){self.saveNotifications()}),$saveCustomMsgButton.click(function(){self.saveCustomMsg()}),$("#customStayFocusdMsg").val(API.Settings.get("customStayFocusdMsg")),this.initUploadingDataProperty()},initUploadingDataProperty:function(){var refusCollectDataElement=document.getElementById("refuseUploadData");0==API.Settings.get("hasAcceptedPrivacyPolicy")&&refusCollectDataElement.setAttribute("checked",!0),refusCollectDataElement.addEventListener("click",function(el){el=el.target.checked;API.Settings.set({hasAcceptedPrivacyPolicy:!el}),log("refuseUploadData","Set flag to",el)})},initActivityMonitor:function(){log("initActivityMonitor","Initializing ActivityMonitor",null,"TRACE"),API.Component.load({name:"ActivityMonitor",instance:"activityMonitor",view:"options",onLoaded:function(component){var layout=new Layout("Options");component.model.init(),component.view.setJQuery($),layout.connect(component.view,$("#activityMonitorOptions")),layout.inject(component.model,component.view)}})},saveNotifications:function(){log("saveNotifications","Saving notifications");for(var notifications=[],i=0;i<5;i++){var unit,value=$("#customNotifications input[name=value"+i+"]").val();0!==value.length&&(unit=$("#customNotifications select[name=unit"+i+"]").val(),value=parseFloat(value),notifications.push(value="min"===unit?60*value:value))}API.Notification.saveSettings(notifications),alert(API.Chrome.Translation.get("notificationSettingsSaved"))},saveCustomMsg:function(){log("saveCustomMsg","Saving custom message");var value=$("#customStayFocusdMsg").val();API.Settings.set({customStayFocusdMsg:value}),alert(API.Chrome.Translation.get("customMsgSaved"))},setNotificationOptionDefaults:function(notifications){for(var i in log("setNotificationOptionDefaults","Setting notification defaults",notifications),notifications){var value,seconds;notifications.hasOwnProperty(i)&&(seconds=parseInt(notifications[i]),isNaN(seconds)||(value=59<seconds?seconds/60:seconds,seconds=59<seconds?"min":"sec",$("#customNotifications input[name=value"+i+"]").val(value),$("#customNotifications select[name=unit"+i+"]").val(seconds)))}},toggleDisableSync:function(){this.isSyncDisabled()?(log("toggleDisableSync","Enabling sync"),API.Settings.set({disableSync:!1}),API.PubSub.publish("Options.checkbox.toggle.DISABLE_SYNC",{disableSync:!1})):(log("toggleDisableSync","Disabling sync"),API.PubSub.publish("Options.checkbox.toggle.DISABLE_SYNC",{disableSync:!0}),API.Settings.set({disableSync:!0}))},isSyncDisabled:function(){return!0===API.Settings.get("disableSync")},toggleAllowSiteLink:function(){var isAllowSiteLinkHidden=this.isAllowSiteLinkHidden();log("toggleAllowSiteLink",(isAllowSiteLinkHidden?"Showing":"Hiding")+" allow site link"),API.Settings.set({hideAllowSiteLink:!isAllowSiteLinkHidden})},isAllowSiteLinkHidden:function(){return API.Settings.get("hideAllowSiteLink")},toggleInfoBar:function(){var isInfoBarHidden=this.isInfoBarHidden();log("toggleInfoBar",(isInfoBarHidden?"Showing":"Hiding")+" info bar"),API.Settings.set({hideInfoBar:!isInfoBarHidden})},isInfoBarHidden:function(){return!0===API.Settings.get("hideInfoBar")},toggleUpdatePopup:function(){var isUpdatePopupDisabled=API.StayFocusd.isUpdatePopupDisabled();log("toggleUpdatePopup",(isUpdatePopupDisabled?"Enabling":"Disabling")+" update popup"),API.Settings.set({disableUpdatePopup:!isUpdatePopupDisabled})},initImportExport:function(){log("initImportExport","Initializing import/export settings",null,"TRACE");var self=this;$("#exportSettings").click(function(){self.exportSettings()}),API.StayFocusd.isMaxTimeAllowedExceeded()?($("#importSettings").prop("disabled",!0),$("#importSettingsMsg").html(API.Chrome.Translation.get("cannotImportAfterTimeExpired")),$("#importSettingsMsg").show()):$("#importSettings").click(function(){self.importSettings()})},exportSettings:function(){log("exportSettings","Exporting settings"),API.Storage.getAll(null,function(settings){var type,fileName;settings=encodeURIComponent(JSON.stringify(settings)),type="text/json",fileName=`StayFocusd_${function(date,format){const map={mm:date.getMonth()+1,dd:date.getDate(),yyyy:date.getFullYear()};return format.replace(/yyyy|mm|dd/gi,matched=>map[matched])}(new Date,"yyyy-mm-dd")}.json`,settings=new Blob([settings],{type:type}),(type=document.createElement("a")).download=fileName,type.href=window.URL.createObjectURL(settings),type.style.display="none",document.body.appendChild(type),type.click()})},importSettings:function(){var fileList=document.getElementById("settingsFile").files,self=this;if(!(fileList instanceof FileList)||0===fileList.length)return alert(API.Chrome.Translation.get("mustSelectSettingsFile")),!1;var fileReader=new FileReader;fileReader.onloadend=(fileList[0],function(e){self.saveImportedSettings(e.target.result)}),log("importSettings","Importing settings",fileList[0]),fileReader.readAsText(fileList[0])},saveImportedSettings:function(settingsJSON){log("saveImportedSettings","Saving imported settings",settingsJSON);var $importedSettings=$("#importedSettings");$("#importedSettings ul").html(""),$importedSettings.show();try{var settings=JSON.parse(decodeURIComponent(settingsJSON));"SYNC"in settings||"LOCAL"in settings||"HTML5"in settings?this.saveBucketedSettings(settings):this.saveLegacySettings(settings)}catch(e){log("saveImportedSettings",e.message,null,"ERROR"),$importedSettings.html('<h4 class="text-error">'+API.Chrome.Translation.get("problemImportingSettings")+"</h4>"),$importedSettings.append("<p>"+API.Chrome.Translation.get("canOnlyImportExportedFile")+"</p>"),$importedSettings.append("<p>"+API.Chrome.Translation.get("importEmailSupport")+"<p>")}},saveBucketedSettings:function(settings){log("saveBucketedSettings","Saving bucketed settings",settings);var bucket,self=this,$importedSettings=$("#importedSettings"),$importResults=$("#importResults");for(bucket in settings)settings.hasOwnProperty(bucket)&&!function(bckt){API.Settings.set(settings[bckt],function(){var ulID=bckt.toLowerCase()+"ImportResults";$importResults.append("<h3>"+bckt+':</h3><ul id="'+ulID+'"></ul>'),self.outputImportedSettingsToHTML(settings[bckt],$("#"+ulID))},bckt,!0)}(bucket);$importedSettings.append('<h4 class="text-success">'+API.Chrome.Translation.get("done").toUpperCase()+"!</h4>"),$importedSettings.append("<p>"+API.Chrome.Translation.get("refreshToSeeImportedSettings")+"</p>")},saveLegacySettings:function(settings){log("saveLegacySettings","Saving legacy settings",settings);var self=this,$importedSettings=$("#importedSettings"),adjustedSettings=this.coerceImportedSettingsValues(settings),adjustedSettings=this.convertSyncValues(adjustedSettings);$("#importResults").append('<ul id="legacyImportResults"></ul>'),API.Settings.set(adjustedSettings,function(){self.outputImportedSettingsToHTML(adjustedSettings,$("#legacyImportResults")),$importedSettings.append('<h4 class="text-success">'+API.Chrome.Translation.get("done").toUpperCase()+"!</h4>"),$importedSettings.append("<p>"+API.Chrome.Translation.get("refreshToSeeImportedSettings")+"</p>")},null,!0)},outputImportedSettingsToHTML:function(settings,$outputTo){for(var key in log("outputImportedSettingsToHTML","Outputting imported settings to HTML"),settings){var value;settings.hasOwnProperty(key)&&(value=API.Object.isObjLiteral(settings[key])?JSON.stringify(settings[key]):settings[key],$outputTo.append("<li><b>"+key+":</b><br />"+value+"</li>"))}},coerceImportedSettingsValues:function(settings){var key,value,adjustedSettings={};for(key in settings)settings.hasOwnProperty(key)&&("true"===(value=settings[key])||"false"===value?value="true"===value:"null"===value?value=null:API.Object.isJSON(value)?value=JSON.parse(value):!isNaN(parseInt(value))&&isFinite(value)&&(value=parseInt(value)),adjustedSettings[key]=value);return adjustedSettings},convertSyncValues:function(settings){if(void 0!==settings.disableSync&&!0!==settings.disableSync)for(var key in settings)settings.hasOwnProperty(key)&&0===key.indexOf("sync_")&&(settings[key.substring(5)]=settings[key],delete settings[key]);return settings},initRescue:function(){var self,disclaimer;log("initRescue","Initializing rescue mode"),this.isRescueMode()&&($("#nav li").hide(),$('[data-link="rescueMe"], #help, #logo').show(),this.selectNav("rescueMe"),self=this,disclaimer=" The extension will now reload. This page will close once you click OK.",window.guc=this.generateUnlockCode.bind(this),$("#killNuclearOption").click(function(){self.isValidUnlockCode()&&(API.Settings.remove("nuclearOptionSettings"),alert("The Nuclear Option has been killed."+disclaimer),API.Chrome.Extension.reload())}),$("#killStalkerOption").click(function(){self.isValidUnlockCode()&&(API.Settings.remove("outgoingLink"),alert("The Stalker Option has been killed."+disclaimer),API.Chrome.Extension.reload())}),$("#killChallenge").click(function(){self.isValidUnlockCode()&&API.Component.load({name:"Challenge",onLoaded:function(component){component.model.setRequired(!1),alert("The Challenge has been killed."+disclaimer),API.Chrome.Extension.reload()}})}))},isRescueMode:function(){return"#rescueMeTab"===window.location.hash},isValidUnlockCode:function(){var codeNum,codeArray,code=prompt("Please enter your unlock code");return code&&(codeNum=(codeArray=code.split("-"))[0]||null,codeArray=codeArray[1]||null,codeNum)&&codeArray&&code===this.generateUnlockCode(codeNum)?(codeArray=parseInt(codeNum),(new Date).getTime()<=codeArray+216e5):(alert("You must enter a valid unlock code"),!1)},generateUnlockCode:function(ts){for(var ts=ts||(new Date).getTime(),numStr=ts.toString(),len=numStr.length,str="",i=0;i<len;i++)str+=String.fromCharCode(99+parseInt(numStr[i]));return ts+"-"+str},initPrompting:function(){(new BasePrompt).init(Prompt.PromptType.PrompBirthYear,Prompt.PromptType.PromptReview)}}}),Array.prototype.inArray=function(needle){for(var key in this)if(this.hasOwnProperty(key)&&this[key]==needle)return!0;return!1};