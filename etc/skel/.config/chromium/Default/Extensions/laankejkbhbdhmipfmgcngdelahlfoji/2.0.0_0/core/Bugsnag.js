define(["core/vendor/bugsnag.min","utils/serialize"],(Bugsnag,serialize)=>{let API,enabledErrorShown=!1;function fixStackTrace(event){event.errors.forEach(err=>{err.stacktrace=err.stacktrace.map(frame=>(frame.file=frame.file.replace(/chrome-extension:/g,"chrome_extension:"),frame.file=frame.file.replace(/moz-extension:/g,"moz_extension:"),frame.file=frame.file.replace(/safari-extension:/g,"safari_extension:"),frame.file=frame.file.replace(/safari-web-extension:/g,"safari_web_extension:"),frame))})}function getErrorFromArgs(...args){return args.find(arg=>arg instanceof Error)??function(args){return args.map(arg=>{return"string"==typeof(value=arg)||"boolean"==typeof value||"number"==typeof value?String(arg):JSON.stringify(serialize(arg));var value}).join(" ")}([args])}function excludeFuncFromStacktrace(func){return event=>{event.errors.forEach(err=>{var sliceAt=1+err.stacktrace.findIndex(trace=>trace.method===func.name);err.stacktrace=err.stacktrace.slice(sliceAt)})}}let VALID_STACKTRACE_PREFIX="";return{bugsnagClient:null,apiKey:"14be373dfe46ae64888094a22d25ce46",sampleGroup:0,initAPI(theAPI){(API=theAPI).mixin("Bugsnag",{init:this.init.bind(this)})},async init(context){VALID_STACKTRACE_PREFIX=function(){var[,protocol,id]=/(.*?):\/\/(.*)/.exec(API.Chrome.Extension.getURL("/"))??["","",""];return protocol.replace(/-/g,"_")+"://"+id}(),null==this.bugsnagClient&&(this.bugsnagClient=Bugsnag.start({apiKey:this.apiKey,appType:"Web Extension",collectUserIp:!1,appVersion:API.Chrome.Extension.getVersion(),enabledReleaseStages:["production"],releaseStage:"production",context:context??"unknown",logger:null,generateAnonymousId:!1,onError:[fixStackTrace,this.isValidEvent.bind(this)]}),this.sampleGroup=await API.Storage.getOrSetAsync("bugsnagSamplingGroup",100*Math.random()))},notifyError(...args){this.enabled()&&this.bugsnagClient.notify(getErrorFromArgs(args),event=>{excludeFuncFromStacktrace(this.notifyError)(event),event.severity="error"})},notifyWarning(...args){this.enabled()&&this.bugsnagClient.notify(getErrorFromArgs(args),event=>{excludeFuncFromStacktrace(this.notifyWarning)(event),event.severity="warning"})},logBreadcrumb(...args){this.enabled()&&this.bugsnagClient.leaveBreadcrumb("string"==typeof args[0]?args[0]:"(no message)",{args:serialize(args)},"log")},async isValidEvent(event){if(!this.enabled())return!1;const bugsnagIgnoreMatches=API.RemoteConfig.get("bugsnagIgnoreMatches");return!!event.errors&&!!event.errors.find(error=>function(error){return!!error?.stacktrace?.find(frame=>frame.file.startsWith(VALID_STACKTRACE_PREFIX))}(error)&&!function(error,ignoreMatches){return ignoreMatches.find(ignored=>error.errorMessage.match(ignored))}(error,bugsnagIgnoreMatches))},enabled(){var defaultSampling;return this.bugsnagClient?!!(API.Settings.get("hasAcceptedPrivacyPolicy")??!1)&&(defaultSampling=API.RemoteConfig.get("bugsnagSampling"),this.sampleGroup<defaultSampling):(enabledErrorShown=enabledErrorShown||!0,!1)}}});