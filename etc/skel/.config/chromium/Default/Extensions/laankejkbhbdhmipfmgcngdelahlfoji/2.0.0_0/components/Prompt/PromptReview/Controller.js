define(["core/CoreAPI","core/vendor/DropletJS.PubSub.min","components/Prompt/PromptReview/View","core/Time","core/AppConsts"],function(API,PubSub,View,Time,AppConsts){var log=API.Utils.createScopedLog("PromptReviewController");return class{view=null;CHROME_STORE_URL=`https://chrome.google.com/webstore/detail/stayfocusd-block-distract/${AppConsts.APP_ID}/reviews`;PROMPT_AT_TIME_OF_DAY=14*Time.HOUR;DEFAULT_INTERVAL=2*Time.DAY;constructor(){log("construct","Constructing PromptReviewController",null,"DEBUG"),this.view=new View}async initAsync(){return new Promise(async resolve=>(log("init","Initializing controller",null,"DEBUG"),await API.Settings.initAsync(),await this.canShowPrompt()?(this.mountView(),resolve(!0)):resolve(!1)))}mountView(){API.Analytics.event("PROMPT_REVIEW_SHOW"),this.view.init(),this.addListeners()}addListeners(){log("addListeners","Adding listeners",null,"TRACE"),PubSub.listen("PromptReview.openStore",async _=>{API.Analytics.event("REVIEW_PROMPT_CTA_CLICKED"),API.Chrome.Tab.create({url:this.CHROME_STORE_URL}),await API.Settings.setAsync({promptReview:!0})}),PubSub.listen("PromptReview.close",_=>{API.Analytics.event("REVIEW_PROMPT_DISMISSED"),this.reschedulePrompt()})}async canShowPrompt(){var isPromptReview=API.Settings.get("promptReview");if(1!=isPromptReview)return null==(isPromptReview=API.Settings.get("promptReviewAt"))?(await this.reschedulePrompt(),!1):new Date(isPromptReview)<=new Date}async reschedulePrompt(){let interval=API.Settings.get("promptReviewInterval");null==interval?interval=this.DEFAULT_INTERVAL:interval*=2;var nextPromptAt=Time.getToday()+interval+this.PROMPT_AT_TIME_OF_DAY;await API.Settings.setAsync({promptReviewAt:nextPromptAt}),await API.Settings.setAsync({promptReviewInterval:interval})}}});