define(["core/Logger","core/CoreAPI"],function(Logger,API){function log(originator,funcName,message,payload,level){Logger.log(originator+"."+funcName,message,payload,level)}return class{bp=null;defaultText=null;keyCounter=0;minLength=0;required=null;text=null;constructor(){var bpArray=["s","b","p","a","y"];this.bp="_"+bpArray[1]+bpArray[4]+bpArray[2]+bpArray[3]+bpArray[0]+bpArray[0],this.addListeners()}addListeners(){var self=this;API.PubSub.listen("ChallengeModel.text.set",function(message,payload){self.text=payload.text})}load(onLoaded){this.defaultText=API.Chrome.Translation.get("defaultChallengeText"),this.minLength=decodeURIComponent(this.defaultText).length,this.required=API.Settings.get("challengeRequired"),this.clearProductivityBypass(),"function"==typeof onLoaded&&onLoaded()}setRequired(required){API.Analytics.event("TOGGLE_SETTINGS_CHALLENGE_REQUIRED",{required:required}),API.Settings.set({challengeRequired:required}),this.required=required}isRequired(){return!0===this.required}getText(useDefault){return useDefault?this.text=this.defaultText:this.text||(this.text=API.Settings.get("challengeText"),this.text="string"==typeof this.text?decodeURIComponent(this.text):this.defaultText,this.text.length<this.minLength&&(this.text=this.defaultText)),this.text}setText(newText){return this.isLongEnough(newText)?this.isUniqueEnough(newText)?(newText=(newText=(newText=(newText=newText.split("\n").join(" ")).split("\r").join(" ")).split("\t").join(" ")).replace(/ +(?= )/g,""),newText=API.Utils.sanitizeMSWordChars(newText),void API.Settings.set({challengeText:encodeURIComponent(newText)},function(){API.PubSub.publish("ChallengeModel.text.set",{text:newText}),alert(API.Chrome.Translation.get("challengeTextSet"))})):(alert(API.Chrome.Translation.get("notEnoughVariation")),!1):(alert(API.Chrome.Translation.get("challengeTextTooShort",this.minLength.toString())),!1)}resetText(){this.setText(this.defaultText)}setProductivityBypass(){log(this.originator,"setProductivityBypass","Setting productivity bypass"),API.Settings.set({productivityBypass:!0})}clearProductivityBypass(){log(this.originator,"clearProductivityBypass","Clearing productivity bypass"),API.Settings.remove("productivityBypass")}isProductivityBypassActive(){return!0===API.Settings.get("productivityBypass")}isRightLength(inputText){return this.keyCounter===inputText.length}isLongEnough(text){return text.length>=this.minLength}isUniqueEnough(text){for(var usedLetters=[],i=0;i<text.length;i++){var thisLetter=text.charAt(i);usedLetters.inArray(thisLetter)||usedLetters.push(thisLetter)}return 5<=usedLetters.length}isCorrect(inputText,offset){var sourceSnippet=this.text.substring(0,Math.max(inputText.length+offset,0)),bpSnippet=this.bp.substring(0,Math.max(inputText.length+offset,0)),inputText=inputText.substring(0,Math.max(inputText.length+offset,0));return inputText===sourceSnippet||inputText===bpSnippet}isComplete(inputText){return inputText.length===this.text.length||inputText===this.bp}getKeyCounter(){return this.keyCounter}updateKeyCounter(value){this.keyCounter=value}resetKeyCounter(){this.keyCounter=0}}});