define(["core/Logger","core/CoreAPI","core/vendor/jquery.min"],function(Logger,API,$){function log(originator,funcName,message,payload,level){Logger.log(originator+"."+funcName,message,payload,level)}return class{view=null;model=null;timer=null;init(){log(this.originator,"init","Initializing controller",null,"DEBUG"),this.model.init(),this.addListeners(),API.PubSub.publish("ActivityMonitor.component.initialized"),this.view.bindActivityDetectors()}activate(){log(this.originator,"activate","Activating ActivityMonitor"),this.view.bindActivityDetectors(),this.startTimer()}addListeners(){log(this.originator,"addListeners","Adding listeners",null,"DEBUG");var self=this;API.PubSub.listen("ActivityMonitor.overlay.shown",function(message,payload){self.stopTimer()}),API.PubSub.listen("ActivityMonitor.overlay.hidden",function(message,payload){self.resetTimer(),self.startTimer()}),API.PubSub.listen("ActivityMonitor.activity.detected",function(message,payload){self.resetTimer()}),API.PubSub.listen("*.tab.selected",function(message,payload){self.onTabSelected(payload.tab,payload.blockable)}),API.PubSub.listen("*.tab.activity",function(message,payload){self.model.blockable&&payload.tab?.audible&&self.resetTimer()}),API.PubSub.listen("*.page.killed",function(message,payload){self.killPage(payload.redirectURL)})}onTabSelected(selectedTab,blockable){log(this.originator,"onTabSelected","New tab selected",{selectedTab:selectedTab,blockable:blockable},"TRACE"),null!==this.model.currentTabID&&this.stopTimer(),this.model.currentTabID=selectedTab.id,this.model.currentURL=selectedTab.url,this.model.blockable=blockable,this.resetTimer(),this.view.hide(),blockable&&!this.model.isDisabled()&&this.startTimer()}startTimer(){log(this.originator,"startTimer","Starting timer with "+this.model.interval+"-second interval"),clearInterval(this.timer),this.timer=setInterval(this.tick.bind(this),1e3*this.model.interval)}stopTimer(){log(this.originator,"stopTimer","Stopping timer"),clearInterval(this.timer),this.timer=null}resetTimer(){log(this.originator,"resetTimer","Resetting timer",null,"TRACE"),this.model.elapsedTime=0}killPage(redirectURL){API.Analytics.event("BLOCK_PAGE",{isNuclear:NuclearOption.isActive(),hostname:window.location.hostname}),log(this.originator,"killPage","Killing page",redirectURL,"WARN"),top.location.href=redirectURL+"?content&customMsg="+API.Settings.get("customStayFocusdMsg")}tick(){this.model.elapsedTime+=this.model.interval,log(this.originator,"tick","Elapsed time: "+this.model.elapsedTime+" secs",null,"DEBUG"),this.model.isMaxInactiveTimeExceeded()&&(log(this.originator,"tick","Max inactive time exceeded: ",this.model.maxInactiveTime,"WARN"),this.view.show())}}});