var Pd=Object.defineProperty,Vd=(k,x,p)=>x in k?Pd(k,x,{enumerable:!0,configurable:!0,writable:!0,value:p}):k[x]=p,te=(k,x,p)=>(Vd(k,"symbol"!=typeof x?x+"":x,p),p),wn=(k,x,p)=>{if(!x.has(k))throw TypeError("Cannot "+p)},g=(k,x,p)=>(wn(k,x,"read from private field"),p?p.call(k):x.get(k)),pe=(k,x,p)=>{if(x.has(k))throw TypeError("Cannot add the same private member more than once");x instanceof WeakSet?x.add(k):x.set(k,p)},Y=(k,x,p,Ne)=>(wn(k,x,"write to private field"),Ne?Ne.call(k,p):x.set(k,p),p),Et=(k,x,p)=>(wn(k,x,"access private method"),p),webExtUsage=function(k){var ee,ne,We,z,J,Ke,ct,Ye,Te,dt,Xt,Ts,ei,Tt,Ls,Ss,ti,x,t,L,cs;(t=x=x||{}).assertEqual=r=>r,t.assertIs=function(r){},t.assertNever=function(r){throw new Error},t.arrayToEnum=r=>{var i={};for(const a of r)i[a]=a;return i},t.getValidEnumValues=r=>{var i=t.objectKeys(r).filter(o=>"number"!=typeof r[r[o]]),a={};for(const o of i)a[o]=r[o];return t.objectValues(a)},t.objectValues=r=>t.objectKeys(r).map(function(i){return r[i]}),t.objectKeys="function"==typeof Object.keys?r=>Object.keys(r):r=>{var i=[];for(const a in r)Object.prototype.hasOwnProperty.call(r,a)&&i.push(a);return i},t.find=(r,i)=>{for(const a of r)if(i(a))return a},t.isInteger="function"==typeof Number.isInteger?r=>Number.isInteger(r):r=>"number"==typeof r&&isFinite(r)&&Math.floor(r)===r,t.joinValues=function(r,i=" | "){return r.map(a=>"string"==typeof a?`'${a}'`:a).join(i)},t.jsonStringifyReplacer=(r,i)=>"bigint"==typeof i?i.toString():i;const p=x.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ne=t=>{switch(typeof t){case"undefined":return p.undefined;case"string":return p.string;case"number":return isNaN(t)?p.nan:p.number;case"boolean":return p.boolean;case"function":return p.function;case"bigint":return p.bigint;case"symbol":return p.symbol;case"object":return Array.isArray(t)?p.array:null===t?p.null:t.then&&"function"==typeof t.then&&t.catch&&"function"==typeof t.catch?p.promise:typeof Map<"u"&&t instanceof Map?p.map:typeof Set<"u"&&t instanceof Set?p.set:typeof Date<"u"&&t instanceof Date?p.date:p.object;default:return p.unknown}},_=x.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class $e extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};var s=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,s):this.__proto__=s,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const s=e||function(i){return i.message},n={_errors:[]},r=i=>{for(const a of i.issues)if("invalid_union"===a.code)a.unionErrors.map(r);else if("invalid_return_type"===a.code)r(a.returnTypeError);else if("invalid_arguments"===a.code)r(a.argumentsError);else if(0===a.path.length)n._errors.push(s(a));else{let o=n,d=0;for(;d<a.path.length;){var l=a.path[d];d===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(s(a))):o[l]=o[l]||{_errors:[]},o=o[l],d++}}};return r(this),n}toString(){return this.message}get message(){return JSON.stringify(this.issues,x.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=s=>s.message){var s={},n=[];for(const r of this.issues)(0<r.path.length?(s[r.path[0]]=s[r.path[0]]||[],s[r.path[0]]):n).push(e(r));return{formErrors:n,fieldErrors:s}}get formErrors(){return this.flatten()}}$e.create=t=>new $e(t);const It=(t,e)=>{let s;switch(t.code){case _.invalid_type:s=t.received===p.undefined?"Required":`Expected ${t.expected}, received `+t.received;break;case _.invalid_literal:s="Invalid literal value, expected "+JSON.stringify(t.expected,x.jsonStringifyReplacer);break;case _.unrecognized_keys:s="Unrecognized key(s) in object: "+x.joinValues(t.keys,", ");break;case _.invalid_union:s="Invalid input";break;case _.invalid_union_discriminator:s="Invalid discriminator value. Expected "+x.joinValues(t.options);break;case _.invalid_enum_value:s=`Invalid enum value. Expected ${x.joinValues(t.options)}, received '${t.received}'`;break;case _.invalid_arguments:s="Invalid function arguments";break;case _.invalid_return_type:s="Invalid function return type";break;case _.invalid_date:s="Invalid date";break;case _.invalid_string:"object"==typeof t.validation?"startsWith"in t.validation?s=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?s=`Invalid input: must end with "${t.validation.endsWith}"`:x.assertNever(t.validation):s="regex"!==t.validation?"Invalid "+t.validation:"Invalid";break;case _.too_small:s="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:"number"===t.type?"Number must be "+(t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than ")+t.minimum:"date"===t.type?"Date must be "+(t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than ")+new Date(t.minimum):"Invalid input";break;case _.too_big:s="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:"number"===t.type?`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} `+t.maximum:"date"===t.type?`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} `+new Date(t.maximum):"Invalid input";break;case _.custom:s="Invalid input";break;case _.invalid_intersection_types:s="Intersection results could not be merged";break;case _.not_multiple_of:s="Number must be a multiple of "+t.multipleOf;break;case _.not_finite:s="Number must be finite";break;default:s=e.defaultError,x.assertNever(t)}return{message:s}};let bn=It;function ss(){return bn}const ns=t=>{var{data:e,path:t,errorMaps:n,issueData:r}=t,t=[...t,...r.path||[]],a={...r,path:t};let o="";n=n.filter(l=>!!l).slice().reverse();for(const l of n)o=l(a,{data:e,defaultError:o}).message;return{...r,path:t,message:r.message||o}};function w(t,e){e=ns({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,bn,It].filter(n=>!!n)});t.common.issues.push(e)}class he{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,s){var n=[];for(const r of s){if("aborted"===r.status)return I;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,s){var n=[];for(const r of s)n.push({key:await r.key,value:await r.value});return he.mergeObjectSync(e,n)}static mergeObjectSync(e,s){var n={};for(const r of s){var{key:i,value:a}=r;if("aborted"===i.status||"aborted"===a.status)return I;"dirty"===i.status&&e.dirty(),"dirty"===a.status&&e.dirty(),(typeof a.value<"u"||r.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}}const I=Object.freeze({status:"aborted"}),xn=t=>({status:"dirty",value:t}),ce=t=>({status:"valid",value:t}),Ds=t=>"aborted"===t.status,Ps=t=>"dirty"===t.status,rs=t=>"valid"===t.status,is=t=>t instanceof Promise;!function(t){t.errToObj=e=>"string"==typeof e?{message:e}:e||{},t.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(L=L||{});class Ce{constructor(e,s,n,r){this.parent=e,this.data=s,this._path=n,this._key=r}get path(){return this._path.concat(this._key)}}const Tn=(t,e)=>{if(rs(e))return{success:!0,data:e.value};if(t.common.issues.length)return{success:!1,error:new $e(t.common.issues)};throw new Error("Validation failed but no issues detected.")};function R(t){if(!t)return{};const{errorMap:e,invalid_type_error:s,required_error:n,description:r}=t;if(e&&(s||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(a,o)=>"invalid_type"!==a.code?{message:o.defaultError}:"u"<typeof o.data?{message:null!=n?n:o.defaultError}:{message:null!=s?s:o.defaultError},description:r}}class O{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Ne(e.data)}_getOrReturnCtx(e,s){return s||{common:e.parent.common,data:e.data,parsedType:Ne(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new he,ctx:{common:e.parent.common,data:e.data,parsedType:Ne(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){e=this._parse(e);if(is(e))throw new Error("Synchronous parse encountered promise.");return e}_parseAsync(e){e=this._parse(e);return Promise.resolve(e)}parse(e,s){e=this.safeParse(e,s);if(e.success)return e.data;throw e.error}safeParse(e,s){var n={common:{issues:[],async:null!=(n=null==s?void 0:s.async)&&n,contextualErrorMap:null==s?void 0:s.errorMap},path:(null==s?void 0:s.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ne(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Tn(n,s)}async parseAsync(e,s){e=await this.safeParseAsync(e,s);if(e.success)return e.data;throw e.error}async safeParseAsync(e,s){s={common:{issues:[],contextualErrorMap:null==s?void 0:s.errorMap,async:!0},path:(null==s?void 0:s.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ne(e)},e=this._parse({data:e,path:s.path,parent:s}),e=await(is(e)?e:Promise.resolve(e));return Tn(s,e)}refine(e,s){return this._refinement((r,i)=>{const a=e(r),o=()=>i.addIssue({code:_.custom,...(r=>"string"==typeof s||"u"<typeof s?{message:s}:"function"==typeof s?s(r):s)(r)});return typeof Promise<"u"&&a instanceof Promise?a.then(d=>!!d||(o(),!1)):!!a||(o(),!1)})}refinement(e,s){return this._refinement((n,r)=>!!e(n)||(r.addIssue("function"==typeof s?s(n,r):s),!1))}_refinement(e){return new Oe({schema:this,typeName:S.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return De.create(this)}nullable(){return it.create(this)}nullish(){return this.optional().nullable()}array(){return ke.create(this)}promise(){return At.create(this)}or(e){return Mt.create([this,e])}and(e){return Ct.create(this,e)}transform(e){return new Oe({schema:this,typeName:S.ZodEffects,effect:{type:"transform",transform:e}})}default(e){var s="function"==typeof e?e:()=>e;return new $t({innerType:this,defaultValue:s,typeName:S.ZodDefault})}brand(){return new In({typeName:S.ZodBranded,type:this,...R(void 0)})}catch(e){var s="function"==typeof e?e:()=>e;return new hs({innerType:this,defaultValue:s,typeName:S.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return Ut.create(this,e)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ii=/^c[^\s-]{8,}$/i,ai=/^([a-f0-9]{8}-[a-f0-9]{4}-[1-5][a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}|00000000-0000-0000-0000-000000000000)$/i,oi=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i,ci=t=>t.precision?t.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${t.precision}}(([+-]\\d{2}:\\d{2})|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${t.precision}}Z$`):0===t.precision?t.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}:\\d{2})|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):t.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}:\\d{2})|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");class Ue extends O{constructor(){super(...arguments),this._regex=(e,s,n)=>this.refinement(r=>e.test(r),{validation:s,code:_.invalid_string,...L.errToObj(n)}),this.nonempty=e=>this.min(1,L.errToObj(e)),this.trim=()=>new Ue({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}_parse(e){var i;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==p.string)return w(i=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.string,received:i.parsedType}),I;var n=new he;let r;for(const i of this._def.checks)if("min"===i.kind)e.data.length<i.value&&(r=this._getOrReturnCtx(e,r),w(r,{code:_.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if("max"===i.kind)e.data.length>i.value&&(r=this._getOrReturnCtx(e,r),w(r,{code:_.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if("length"===i.kind){var a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(r=this._getOrReturnCtx(e,r),a?w(r,{code:_.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&w(r,{code:_.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if("email"===i.kind)oi.test(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{validation:"email",code:_.invalid_string,message:i.message}),n.dirty());else if("uuid"===i.kind)ai.test(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{validation:"uuid",code:_.invalid_string,message:i.message}),n.dirty());else if("cuid"===i.kind)ii.test(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{validation:"cuid",code:_.invalid_string,message:i.message}),n.dirty());else if("url"===i.kind)try{new URL(e.data)}catch{w(r=this._getOrReturnCtx(e,r),{validation:"url",code:_.invalid_string,message:i.message}),n.dirty()}else"regex"===i.kind?(i.regex.lastIndex=0,i.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{validation:"regex",code:_.invalid_string,message:i.message}),n.dirty())):"trim"===i.kind?e.data=e.data.trim():"startsWith"===i.kind?e.data.startsWith(i.value)||(r=this._getOrReturnCtx(e,r),w(r,{code:_.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):"endsWith"===i.kind?e.data.endsWith(i.value)||(r=this._getOrReturnCtx(e,r),w(r,{code:_.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):"datetime"===i.kind?ci(i).test(e.data)||(r=this._getOrReturnCtx(e,r),w(r,{code:_.invalid_string,validation:"datetime",message:i.message}),n.dirty()):x.assertNever(i);return{status:n.value,value:e.data}}_addCheck(e){return new Ue({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...L.errToObj(e)})}url(e){return this._addCheck({kind:"url",...L.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...L.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...L.errToObj(e)})}datetime(e){var s;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:"u"<typeof(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!=(s=null==e?void 0:e.offset)&&s,...L.errToObj(null==e?void 0:e.message)})}regex(e,s){return this._addCheck({kind:"regex",regex:e,...L.errToObj(s)})}startsWith(e,s){return this._addCheck({kind:"startsWith",value:e,...L.errToObj(s)})}endsWith(e,s){return this._addCheck({kind:"endsWith",value:e,...L.errToObj(s)})}min(e,s){return this._addCheck({kind:"min",value:e,...L.errToObj(s)})}max(e,s){return this._addCheck({kind:"max",value:e,...L.errToObj(s)})}length(e,s){return this._addCheck({kind:"length",value:e,...L.errToObj(s)})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get minLength(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return e}get maxLength(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return e}}function di(t,e){var s=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=n<s?s:n;return parseInt(t.toFixed(s).replace(".",""))%parseInt(e.toFixed(s).replace(".",""))/Math.pow(10,s)}Ue.create=t=>{var e;return new Ue({checks:[],typeName:S.ZodString,coerce:null!=(e=null==t?void 0:t.coerce)&&e,...R(t)})};class Ge extends O{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){var i;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==p.number)return w(i=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.number,received:i.parsedType}),I;let n;var r=new he;for(const i of this._def.checks)"int"===i.kind?x.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),w(n,{code:_.invalid_type,expected:"integer",received:"float",message:i.message}),r.dirty()):"min"===i.kind?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),w(n,{code:_.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):"max"===i.kind?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),w(n,{code:_.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),r.dirty()):"multipleOf"===i.kind?0!==di(e.data,i.value)&&(n=this._getOrReturnCtx(e,n),w(n,{code:_.not_multiple_of,multipleOf:i.value,message:i.message}),r.dirty()):"finite"===i.kind?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),w(n,{code:_.not_finite,message:i.message}),r.dirty()):x.assertNever(i);return{status:r.value,value:e.data}}gte(e,s){return this.setLimit("min",e,!0,L.toString(s))}gt(e,s){return this.setLimit("min",e,!1,L.toString(s))}lte(e,s){return this.setLimit("max",e,!0,L.toString(s))}lt(e,s){return this.setLimit("max",e,!1,L.toString(s))}setLimit(e,s,n,r){return new Ge({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:n,message:L.toString(r)}]})}_addCheck(e){return new Ge({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:L.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:L.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:L.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:L.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:L.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:L.toString(s)})}finite(e){return this._addCheck({kind:"finite",message:L.toString(e)})}get minValue(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind)}}Ge.create=t=>new Ge({checks:[],typeName:S.ZodNumber,coerce:(null==t?void 0:t.coerce)||!1,...R(t)});class Nt extends O{_parse(e){var n;return this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==p.bigint?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.bigint,received:n.parsedType}),I):ce(e.data)}}Nt.create=t=>{var e;return new Nt({typeName:S.ZodBigInt,coerce:null!=(e=null==t?void 0:t.coerce)&&e,...R(t)})};class kt extends O{_parse(e){var n;return this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==p.boolean?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.boolean,received:n.parsedType}),I):ce(e.data)}}kt.create=t=>new kt({typeName:S.ZodBoolean,coerce:(null==t?void 0:t.coerce)||!1,...R(t)});class st extends O{_parse(e){var i;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==p.date)return w(i=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.date,received:i.parsedType}),I;if(isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return w(i,{code:_.invalid_date}),I}var n=new he;let r;for(const i of this._def.checks)"min"===i.kind?e.data.getTime()<i.value&&(r=this._getOrReturnCtx(e,r),w(r,{code:_.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):"max"===i.kind?e.data.getTime()>i.value&&(r=this._getOrReturnCtx(e,r),w(r,{code:_.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):x.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new st({...this._def,checks:[...this._def.checks,e]})}min(e,s){return this._addCheck({kind:"min",value:e.getTime(),message:L.toString(s)})}max(e,s){return this._addCheck({kind:"max",value:e.getTime(),message:L.toString(s)})}get minDate(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return null!=e?new Date(e):null}}st.create=t=>new st({checks:[],coerce:(null==t?void 0:t.coerce)||!1,typeName:S.ZodDate,...R(t)});class as extends O{_parse(e){var n;return this._getType(e)!==p.symbol?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.symbol,received:n.parsedType}),I):ce(e.data)}}as.create=t=>new as({typeName:S.ZodSymbol,...R(t)});class Ot extends O{_parse(e){var n;return this._getType(e)!==p.undefined?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.undefined,received:n.parsedType}),I):ce(e.data)}}Ot.create=t=>new Ot({typeName:S.ZodUndefined,...R(t)});class Rt extends O{_parse(e){var n;return this._getType(e)!==p.null?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.null,received:n.parsedType}),I):ce(e.data)}}Rt.create=t=>new Rt({typeName:S.ZodNull,...R(t)});class mt extends O{constructor(){super(...arguments),this._any=!0}_parse(e){return ce(e.data)}}mt.create=t=>new mt({typeName:S.ZodAny,...R(t)});class nt extends O{constructor(){super(...arguments),this._unknown=!0}_parse(e){return ce(e.data)}}nt.create=t=>new nt({typeName:S.ZodUnknown,...R(t)});class Ze extends O{_parse(e){e=this._getOrReturnCtx(e);return w(e,{code:_.invalid_type,expected:p.never,received:e.parsedType}),I}}Ze.create=t=>new Ze({typeName:S.ZodNever,...R(t)});class os extends O{_parse(e){var n;return this._getType(e)!==p.undefined?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.void,received:n.parsedType}),I):ce(e.data)}}os.create=t=>new os({typeName:S.ZodVoid,...R(t)});class ke extends O{_parse(e){const{ctx:s,status:n}=this._processInputParams(e),r=this._def;var o;return s.parsedType!==p.array?(w(s,{code:_.invalid_type,expected:p.array,received:s.parsedType}),I):(null!==r.exactLength&&(e=s.data.length>r.exactLength.value,o=s.data.length<r.exactLength.value,e||o)&&(w(s,{code:e?_.too_big:_.too_small,minimum:o?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty()),null!==r.minLength&&s.data.length<r.minLength.value&&(w(s,{code:_.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&s.data.length>r.maxLength.value&&(w(s,{code:_.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),s.common.async?Promise.all(s.data.map((a,o)=>r.type._parseAsync(new Ce(s,a,s.path,o)))).then(a=>he.mergeArray(n,a)):(o=s.data.map((a,o)=>r.type._parseSync(new Ce(s,a,s.path,o))),he.mergeArray(n,o)))}get element(){return this._def.type}min(e,s){return new ke({...this._def,minLength:{value:e,message:L.toString(s)}})}max(e,s){return new ke({...this._def,maxLength:{value:e,message:L.toString(s)}})}length(e,s){return new ke({...this._def,exactLength:{value:e,message:L.toString(s)}})}nonempty(e){return this.min(1,e)}}ke.create=(t,e)=>new ke({type:t,minLength:null,maxLength:null,exactLength:null,typeName:S.ZodArray,...R(e)}),(cs||(cs={})).mergeShapes=(e,s)=>({...e,...s});const Sn=t=>e=>new W({...t,shape:()=>({...t.shape(),...e})});function yt(t){if(t instanceof W){const e={};for(const s in t.shape){var n=t.shape[s];e[s]=De.create(yt(n))}return new W({...t._def,shape:()=>e})}return t instanceof ke?ke.create(yt(t.element)):t instanceof De?De.create(yt(t.unwrap())):t instanceof it?it.create(yt(t.unwrap())):t instanceof Le?Le.create(t.items.map(e=>yt(e))):t}class W extends O{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=Sn(this._def),this.extend=Sn(this._def)}_getCached(){var e,s;return null!==this._cached?this._cached:(e=this._def.shape(),s=x.objectKeys(e),this._cached={shape:e,keys:s})}_parse(e){var l;if(this._getType(e)!==p.object)return w(l=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.object,received:l.parsedType}),I;const{status:n,ctx:r}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof Ze&&"strip"===this._def.unknownKeys))for(const l in r.data)a.includes(l)||o.push(l);const d=[];for(const l of a){var h=i[l],m=r.data[l];d.push({key:{status:"valid",value:l},value:h._parse(new Ce(r,m,r.path,l)),alwaysSet:l in r.data})}if(this._def.catchall instanceof Ze){const l=this._def.unknownKeys;if("passthrough"===l)for(const h of o)d.push({key:{status:"valid",value:h},value:{status:"valid",value:r.data[h]}});else if("strict"===l)0<o.length&&(w(r,{code:_.unrecognized_keys,keys:o}),n.dirty());else if("strip"!==l)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const h of o){const m=r.data[h];d.push({key:{status:"valid",value:h},value:l._parse(new Ce(r,m,r.path,h)),alwaysSet:h in r.data})}}return r.common.async?Promise.resolve().then(async()=>{var l=[];for(const h of d){var m=await h.key;l.push({key:m,value:await h.value,alwaysSet:h.alwaysSet})}return l}).then(l=>he.mergeObjectSync(n,l)):he.mergeObjectSync(n,d)}get shape(){return this._def.shape()}strict(e){return L.errToObj,new W({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(s,n)=>{var i,r=null!=(i=null==(i=(r=this._def).errorMap)?void 0:i.call(r,s,n).message)?i:n.defaultError;return"unrecognized_keys"===s.code?{message:null!=(i=L.errToObj(e).message)?i:r}:{message:r}}}:{}})}strip(){return new W({...this._def,unknownKeys:"strip"})}passthrough(){return new W({...this._def,unknownKeys:"passthrough"})}setKey(e,s){return this.augment({[e]:s})}merge(e){return new W({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>cs.mergeShapes(this._def.shape(),e._def.shape()),typeName:S.ZodObject})}catchall(e){return new W({...this._def,catchall:e})}pick(e){const s={};return x.objectKeys(e).map(n=>{this.shape[n]&&(s[n]=this.shape[n])}),new W({...this._def,shape:()=>s})}omit(e){const s={};return x.objectKeys(this.shape).map(n=>{-1===x.objectKeys(e).indexOf(n)&&(s[n]=this.shape[n])}),new W({...this._def,shape:()=>s})}deepPartial(){return yt(this)}partial(e){const s={};if(e)x.objectKeys(this.shape).map(n=>{-1===x.objectKeys(e).indexOf(n)?s[n]=this.shape[n]:s[n]=this.shape[n].optional()});else for(const n in this.shape){var r=this.shape[n];s[n]=r.optional()}return new W({...this._def,shape:()=>s})}required(e){const s={};if(e)x.objectKeys(this.shape).map(n=>{if(-1===x.objectKeys(e).indexOf(n))s[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof De;)i=i._def.innerType;s[n]=i}});else for(const n in this.shape){let i=this.shape[n];for(;i instanceof De;)i=i._def.innerType;s[n]=i}return new W({...this._def,shape:()=>s})}keyof(){return En(x.objectKeys(this.shape))}}W.create=(t,e)=>new W({shape:()=>t,unknownKeys:"strip",catchall:Ze.create(),typeName:S.ZodObject,...R(e)}),W.strictCreate=(t,e)=>new W({shape:()=>t,unknownKeys:"strict",catchall:Ze.create(),typeName:S.ZodObject,...R(e)}),W.lazycreate=(t,e)=>new W({shape:t,unknownKeys:"strip",catchall:Ze.create(),typeName:S.ZodObject,...R(e)});class Mt extends O{_parse(e){const s=this._processInputParams(e)["ctx"],n=this._def.options;if(s.common.async)return Promise.all(n.map(async i=>{var a={...s,common:{...s.common,issues:[]},parent:null};return{result:await i._parseAsync({data:s.data,path:s.path,parent:a}),ctx:a}})).then(function(i){for(const o of i)if("valid"===o.result.status)return o.result;for(const o of i)if("dirty"===o.result.status)return s.common.issues.push(...o.ctx.common.issues),o.result;return i=i.map(o=>new $e(o.ctx.common.issues)),w(s,{code:_.invalid_union,unionErrors:i}),I});{let i;var a=[];for(const d of n){var l={...s,common:{...s.common,issues:[]},parent:null},h=d._parseSync({data:s.data,path:s.path,parent:l});if("valid"===h.status)return h;"dirty"!==h.status||i||(i={result:h,ctx:l}),l.common.issues.length&&a.push(l.common.issues)}return i?(s.common.issues.push(...i.ctx.common.issues),i.result):(e=a.map(d=>new $e(d)),w(s,{code:_.invalid_union,unionErrors:e}),I)}}get options(){return this._def.options}}Mt.create=(t,e)=>new Mt({options:t,typeName:S.ZodUnion,...R(e)});const ds=t=>t instanceof Dt?ds(t.schema):t instanceof Oe?ds(t.innerType()):t instanceof Pt?[t.value]:t instanceof Vt?t.options:t instanceof jt?Object.keys(t.enum):t instanceof $t?ds(t._def.innerType):t instanceof Ot?[void 0]:t instanceof Rt?[null]:null;class ls extends O{_parse(e){var n,r,e=this._processInputParams(e)["ctx"];return e.parsedType!==p.object?(w(e,{code:_.invalid_type,expected:p.object,received:e.parsedType}),I):(n=this.discriminator,r=e.data[n],(r=this.optionsMap.get(r))?e.common.async?r._parseAsync({data:e.data,path:e.path,parent:e}):r._parseSync({data:e.data,path:e.path,parent:e}):(w(e,{code:_.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),I))}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,s,n){var r=new Map;for(const i of s){var a=ds(i.shape[e]);if(!a)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of a){if(r.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value `+String(o));r.set(o,i)}}return new ls({typeName:S.ZodDiscriminatedUnion,discriminator:e,options:s,optionsMap:r,...R(n)})}}function Vs(t,e){var s=Ne(t),n=Ne(e);if(t===e)return{valid:!0,data:t};if(s===p.object&&n===p.object){const r=x.objectKeys(e),i=x.objectKeys(t).filter(o=>-1!==r.indexOf(o)),a={...t,...e};for(const o of i){var d=Vs(t[o],e[o]);if(!d.valid)return{valid:!1};a[o]=d.data}return{valid:!0,data:a}}if(s!==p.array||n!==p.array)return s===p.date&&n===p.date&&+t==+e?{valid:!0,data:t}:{valid:!1};if(t.length!==e.length)return{valid:!1};var r=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],d=Vs(a,o);if(!d.valid)return{valid:!1};r.push(d.data)}return{valid:!0,data:r}}class Ct extends O{_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=(i,a)=>{var o;return Ds(i)||Ds(a)?I:(o=Vs(i.value,a.value)).valid?((Ps(i)||Ps(a))&&s.dirty(),{status:s.value,value:o.data}):(w(n,{code:_.invalid_intersection_types}),I)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>r(i,a)):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Ct.create=(t,e,s)=>new Ct({left:t,right:e,typeName:S.ZodIntersection,...R(s)});class Le extends O{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==p.array)return w(n,{code:_.invalid_type,expected:p.array,received:n.parsedType}),I;if(n.data.length<this._def.items.length)return w(n,{code:_.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),I;!this._def.rest&&n.data.length>this._def.items.length&&(w(n,{code:_.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),s.dirty());e=n.data.map((a,o)=>{var d=this._def.items[o]||this._def.rest;return d?d._parse(new Ce(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(e).then(a=>he.mergeArray(s,a)):he.mergeArray(s,e)}get items(){return this._def.items}rest(e){return new Le({...this._def,rest:e})}}Le.create=(t,e)=>{if(Array.isArray(t))return new Le({items:t,typeName:S.ZodTuple,rest:null,...R(e)});throw new Error("You must pass an array of schemas to z.tuple([ ... ])")};class Lt extends O{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){var{status:e,ctx:n}=this._processInputParams(e);if(n.parsedType!==p.object)return w(n,{code:_.invalid_type,expected:p.object,received:n.parsedType}),I;var r=[],i=this._def.keyType,a=this._def.valueType;for(const o in n.data)r.push({key:i._parse(new Ce(n,o,n.path,o)),value:a._parse(new Ce(n,n.data[o],n.path,o))});return n.common.async?he.mergeObjectAsync(e,r):he.mergeObjectSync(e,r)}get element(){return this._def.valueType}static create(e,s,n){return s instanceof O?new Lt({keyType:e,valueType:s,typeName:S.ZodRecord,...R(n)}):new Lt({keyType:Ue.create(),valueType:e,typeName:S.ZodRecord,...R(s)})}}class us extends O{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==p.map)return w(n,{code:_.invalid_type,expected:p.map,received:n.parsedType}),I;const r=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,d],l)=>({key:r._parse(new Ce(n,o,n.path,[l,"key"])),value:i._parse(new Ce(n,d,n.path,[l,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const d of a){var l=await d.key,h=await d.value;if("aborted"===l.status||"aborted"===h.status)return I;"dirty"!==l.status&&"dirty"!==h.status||s.dirty(),o.set(l.value,h.value)}return{status:s.value,value:o}})}var o=new Map;for(const d of a){var l=d.key,h=d.value;if("aborted"===l.status||"aborted"===h.status)return I;"dirty"!==l.status&&"dirty"!==h.status||s.dirty(),o.set(l.value,h.value)}return{status:s.value,value:o}}}us.create=(t,e,s)=>new us({valueType:e,keyType:t,typeName:S.ZodMap,...R(s)});class rt extends O{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==p.set)return w(n,{code:_.invalid_type,expected:p.set,received:n.parsedType}),I;e=this._def;null!==e.minSize&&n.data.size<e.minSize.value&&(w(n,{code:_.too_small,minimum:e.minSize.value,type:"set",inclusive:!0,exact:!1,message:e.minSize.message}),s.dirty()),null!==e.maxSize&&n.data.size>e.maxSize.value&&(w(n,{code:_.too_big,maximum:e.maxSize.value,type:"set",inclusive:!0,exact:!1,message:e.maxSize.message}),s.dirty());const i=this._def.valueType;function a(d){var l=new Set;for(const h of d){if("aborted"===h.status)return I;"dirty"===h.status&&s.dirty(),l.add(h.value)}return{status:s.value,value:l}}e=[...n.data.values()].map((d,l)=>i._parse(new Ce(n,d,n.path,l)));return n.common.async?Promise.all(e).then(d=>a(d)):a(e)}min(e,s){return new rt({...this._def,minSize:{value:e,message:L.toString(s)}})}max(e,s){return new rt({...this._def,maxSize:{value:e,message:L.toString(s)}})}size(e,s){return this.min(e,s).max(e,s)}nonempty(e){return this.min(1,e)}}rt.create=(t,e)=>new rt({valueType:t,minSize:null,maxSize:null,typeName:S.ZodSet,...R(e)});class _t extends O{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const s=this._processInputParams(e)["ctx"];if(s.parsedType!==p.function)return w(s,{code:_.invalid_type,expected:p.function,received:s.parsedType}),I;function n(o,d){return ns({data:o,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,ss(),It].filter(l=>!!l),issueData:{code:_.invalid_arguments,argumentsError:d}})}function r(o,d){return ns({data:o,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,ss(),It].filter(l=>!!l),issueData:{code:_.invalid_return_type,returnTypeError:d}})}const i={errorMap:s.common.contextualErrorMap},a=s.data;return this._def.returns instanceof At?ce(async(...o)=>{const d=new $e([]),l=await this._def.args.parseAsync(o,i).catch(y=>{throw d.addIssue(n(o,y)),d}),h=await a(...l);return this._def.returns._def.type.parseAsync(h,i).catch(y=>{throw d.addIssue(r(h,y)),d})}):ce((...o)=>{var d=this._def.args.safeParse(o,i);if(!d.success)throw new $e([n(o,d.error)]);o=a(...d.data),d=this._def.returns.safeParse(o,i);if(d.success)return d.data;throw new $e([r(o,d.error)])})}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new _t({...this._def,args:Le.create(e).rest(nt.create())})}returns(e){return new _t({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,s,n){return new _t({args:e||Le.create([]).rest(nt.create()),returns:s||nt.create(),typeName:S.ZodFunction,...R(n)})}}class Dt extends O{get schema(){return this._def.getter()}_parse(e){e=this._processInputParams(e).ctx;return this._def.getter()._parse({data:e.data,path:e.path,parent:e})}}Dt.create=(t,e)=>new Dt({getter:t,typeName:S.ZodLazy,...R(e)});class Pt extends O{_parse(e){return e.data!==this._def.value?(w(this._getOrReturnCtx(e),{code:_.invalid_literal,expected:this._def.value}),I):{status:"valid",value:e.data}}get value(){return this._def.value}}function En(t,e){return new Vt({values:t,typeName:S.ZodEnum,...R(e)})}Pt.create=(t,e)=>new Pt({value:t,typeName:S.ZodLiteral,...R(e)});class Vt extends O{_parse(e){var s,n;if("string"!=typeof e.data)return s=this._getOrReturnCtx(e),n=this._def.values,w(s,{expected:x.joinValues(n),received:s.parsedType,code:_.invalid_type}),I;if(-1!==this._def.values.indexOf(e.data))return ce(e.data);{const s=this._getOrReturnCtx(e),n=this._def.values;return w(s,{received:s.data,code:_.invalid_enum_value,options:n}),I}}get options(){return this._def.values}get enum(){var e={};for(const s of this._def.values)e[s]=s;return e}get Values(){var e={};for(const s of this._def.values)e[s]=s;return e}get Enum(){var e={};for(const s of this._def.values)e[s]=s;return e}}Vt.create=En;class jt extends O{_parse(e){var r,s=x.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==p.string&&n.parsedType!==p.number)return r=x.objectValues(s),w(n,{expected:x.joinValues(r),received:n.parsedType,code:_.invalid_type}),I;if(-1!==s.indexOf(e.data))return ce(e.data);{const r=x.objectValues(s);return w(n,{received:n.data,code:_.invalid_enum_value,options:r}),I}}get enum(){return this._def.values}}jt.create=(t,e)=>new jt({values:t,typeName:S.ZodNativeEnum,...R(e)});class At extends O{_parse(e){const s=this._processInputParams(e)["ctx"];return s.parsedType!==p.promise&&!1===s.common.async?(w(s,{code:_.invalid_type,expected:p.promise,received:s.parsedType}),I):(e=s.parsedType===p.promise?s.data:Promise.resolve(s.data),ce(e.then(r=>this._def.type.parseAsync(r,{path:s.path,errorMap:s.common.contextualErrorMap}))))}}At.create=(t,e)=>new At({type:t,typeName:S.ZodPromise,...R(e)});class Oe extends O{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===S.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=this._def.effect||null;if("preprocess"===r.type)return e=r.transform(n.data),n.common.async?Promise.resolve(e).then(o=>this._def.schema._parseAsync({data:o,path:n.path,parent:n})):this._def.schema._parseSync({data:e,path:n.path,parent:n});const i={addIssue:a=>{w(n,a),a.fatal?s.abort():s.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),"refinement"===r.type){const a=o=>{var d=r.refinement(o,i);if(n.common.async)return Promise.resolve(d);if(d instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};return!1===n.common.async?"aborted"===(e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n})).status?I:("dirty"===e.status&&s.dirty(),a(e.value),{status:s.value,value:e.value}):this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>"aborted"===o.status?I:("dirty"===o.status&&s.dirty(),a(o.value).then(()=>({status:s.value,value:o.value}))))}if("transform"===r.type){if(!1!==n.common.async)return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>rs(a)?Promise.resolve(r.transform(a.value,i)).then(o=>({status:s.value,value:o})):a);{const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!rs(a))return a;const o=r.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:s.value,value:o}}}x.assertNever(r)}}Oe.create=(t,e,s)=>new Oe({schema:t,typeName:S.ZodEffects,effect:e,...R(s)}),Oe.createWithPreprocess=(t,e,s)=>new Oe({schema:e,effect:{type:"preprocess",transform:t},typeName:S.ZodEffects,...R(s)});class De extends O{_parse(e){return this._getType(e)===p.undefined?ce(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}De.create=(t,e)=>new De({innerType:t,typeName:S.ZodOptional,...R(e)});class it extends O{_parse(e){return this._getType(e)===p.null?ce(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}it.create=(t,e)=>new it({innerType:t,typeName:S.ZodNullable,...R(e)});class $t extends O{_parse(e){e=this._processInputParams(e).ctx;let n=e.data;return e.parsedType===p.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:e.path,parent:e})}removeDefault(){return this._def.innerType}}$t.create=(t,e)=>new $t({innerType:t,typeName:S.ZodDefault,defaultValue:"function"==typeof e.default?e.default:()=>e.default,...R(e)});class hs extends O{_parse(e){e=this._processInputParams(e).ctx,e=this._def.innerType._parse({data:e.data,path:e.path,parent:e});return is(e)?e.then(r=>({status:"valid",value:"valid"===r.status?r.value:this._def.defaultValue()})):{status:"valid",value:"valid"===e.status?e.value:this._def.defaultValue()}}removeDefault(){return this._def.innerType}}hs.create=(t,e)=>new hs({innerType:t,typeName:S.ZodCatch,defaultValue:"function"==typeof e.default?e.default:()=>e.default,...R(e)});class fs extends O{_parse(e){var n;return this._getType(e)!==p.nan?(w(n=this._getOrReturnCtx(e),{code:_.invalid_type,expected:p.nan,received:n.parsedType}),I):{status:"valid",value:e.data}}}fs.create=t=>new fs({typeName:S.ZodNaN,...R(t)});var S,li=Symbol("zod_brand");class In extends O{_parse(e){var e=this._processInputParams(e)["ctx"],n=e.data;return this._def.type._parse({data:n,path:e.path,parent:e})}unwrap(){return this._def.type}}class Ut extends O{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);return n.common.async?(async()=>{var i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===i.status?I:"dirty"===i.status?(s.dirty(),xn(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})():"aborted"===(e=this._def.in._parseSync({data:n.data,path:n.path,parent:n})).status?I:"dirty"===e.status?(s.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}static create(e,s){return new Ut({in:e,out:s,typeName:S.ZodPipeline})}}const Nn=(t,e={},s)=>t?mt.create().superRefine((n,r)=>{t(n)||(n="function"==typeof e?e(n):e,r.addIssue({code:"custom",..."string"==typeof n?{message:n}:n,fatal:s}))}):mt.create(),ui={object:W.lazycreate},de=(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline"}(S=S||{}),Ue.create),H=Ge.create,fi=fs.create,pi=Nt.create,ps=kt.create,gi=st.create,mi=as.create,yi=Ot.create,_i=Rt.create,kn=mt.create,Ai=nt.create,vi=Ze.create,wi=os.create,bi=ke.create,ve=W.create,xi=W.strictCreate,js=Mt.create,Ti=ls.create,Si=Ct.create,Ei=Le.create,On=Lt.create,Ii=us.create,Ni=rt.create,ki=_t.create,Oi=Dt.create,Ri=Pt.create,vt=Vt.create,Mi=jt.create,Ci=At.create,Rn=Oe.create,Li=De.create,Di=it.create,Pi=Oe.createWithPreprocess,Vi=Ut.create;li=Object.freeze({__proto__:null,defaultErrorMap:It,setErrorMap:function(t){bn=t},getErrorMap:ss,makeIssue:ns,EMPTY_PATH:[],addIssueToContext:w,ParseStatus:he,INVALID:I,DIRTY:xn,OK:ce,isAborted:Ds,isDirty:Ps,isValid:rs,isAsync:is,get util(){return x},ZodParsedType:p,getParsedType:Ne,ZodType:O,ZodString:Ue,ZodNumber:Ge,ZodBigInt:Nt,ZodBoolean:kt,ZodDate:st,ZodSymbol:as,ZodUndefined:Ot,ZodNull:Rt,ZodAny:mt,ZodUnknown:nt,ZodNever:Ze,ZodVoid:os,ZodArray:ke,get objectUtil(){return cs},ZodObject:W,ZodUnion:Mt,ZodDiscriminatedUnion:ls,ZodIntersection:Ct,ZodTuple:Le,ZodRecord:Lt,ZodMap:us,ZodSet:rt,ZodFunction:_t,ZodLazy:Dt,ZodLiteral:Pt,ZodEnum:Vt,ZodNativeEnum:jt,ZodPromise:At,ZodEffects:Oe,ZodTransformer:Oe,ZodOptional:De,ZodNullable:it,ZodDefault:$t,ZodCatch:hs,ZodNaN:fs,BRAND:li,ZodBranded:In,ZodPipeline:Ut,custom:Nn,Schema:O,ZodSchema:O,late:ui,get ZodFirstPartyTypeKind(){return S},coerce:{string:t=>Ue.create({...t,coerce:!0}),number:t=>Ge.create({...t,coerce:!0}),boolean:t=>kt.create({...t,coerce:!0}),bigint:t=>Nt.create({...t,coerce:!0}),date:t=>st.create({...t,coerce:!0})},any:kn,array:bi,bigint:pi,boolean:ps,date:gi,discriminatedUnion:Ti,effect:Rn,enum:vt,function:ki,instanceof:(t,e={message:"Input not instance of "+t.name})=>Nn(s=>s instanceof t,e,!0),intersection:Si,lazy:Oi,literal:Ri,map:Ii,nan:fi,nativeEnum:Mi,never:vi,null:_i,nullable:Di,number:H,object:ve,oboolean:()=>ps().optional(),onumber:()=>H().optional(),optional:Li,ostring:()=>de().optional(),pipeline:Vi,preprocess:Pi,promise:Ci,record:On,set:Ni,strictObject:xi,string:de,symbol:mi,transformer:Rn,tuple:Ei,undefined:yi,union:js,unknown:Ai,void:wi,NEVER:I,ZodIssueCode:_,quotelessJson:t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:$e});const gs=()=>de().uuid(),ji=/^(?=.{1,255}$)[0-9A-Za-z_](?:(?:[0-9A-Za-z_]|-){0,61}[0-9A-Za-z_])?(?:\.[0-9A-Za-z_](?:(?:[0-9A-Za-z_]|-){0,61}[0-9A-Za-z_])?)*\.?$/,Mn=()=>de().regex(ji);ve({id:gs(),host:Mn(),startedAt:H().positive(),endedAt:H().nullable().optional()}).strict();var Cn=ve({id:gs(),sessionId:gs(),adUrl:de().url(),timestamp:H().positive().describe("The time in ms since 1970 that this ad was seen at")}).strict(),$i=Cn.extend({type:vt(["image"]),additionalDetails:ve({width:H().nonnegative(),height:H().nonnegative()})}).strict(),Cn=Cn.extend({type:vt(["iframe"]),additionalDetails:ve({width:H().nonnegative(),height:H().nonnegative()})}).strict();js([$i,Cn]);const $s=gs,Ln=Mn,Us=()=>ps().nullable().optional(),Zs=()=>ps().nullable().optional(),Dn=(ve({id:$s(),host:Ln(),startedAt:H().positive(),endedAt:H().nullable().optional(),imported:Us(),generated:Zs()}).strict(),ve({id:de(),sessionId:$s(),timestamp:H().positive().describe("The time in ms since 1970 that this ad was seen at"),imported:Us()}).strict()),Zi=Dn.extend({type:vt(["basic-display"]),details:ve({type:vt(["image","iframe"]),url:de().url().describe("The URL the ad is accessible at"),width:H().nonnegative(),height:H().nonnegative()}).strict()}),Wi=Dn.extend({type:vt(["youtube/hulu/vast","pathmatics"]),details:On(de(),kn())}),zi=js([Zi,Wi]),Bs=$s,Ws=Us,Fi=Zs,zs=()=>Ln().describe("The mobile app bundle ID or website hostname"),Hi=ve({id:Bs(),appId:zs(),createdBy:de({description:"The install id that created the session"}),startedAt:H().positive(),endedAt:H(),imported:Ws(),generated:Fi()}).strict(),qi=ve({id:Bs(),appId:zs(),createdBy:de(),startedAt:H().positive(),endedAt:H().nullable().optional(),imported:Ws(),generated:Zs()}).strict(),Gi=zi,Pn=Bs,Vn=Ws,jn=zs,Xi=Hi,Ki=qi,Yi=ve({id:Pn(),appId:jn(),path:de().startsWith("/"),referrer:de().nullish(),createdBy:de(),startedAt:H().positive(),endedAt:H(),imported:Vn()}).strict(),Ji=ve({id:Pn(),appId:jn(),path:de().startsWith("/"),referrer:de().nullish(),createdBy:de(),startedAt:H().positive(),endedAt:H().nullish(),imported:Vn()}).strict(),Qi=Gi,$n=Xi,Fs=Ki,Un=Yi,Zn=Ji,Hs=Qi;class qs{constructor(e,s){this.db=e,this.storeName=s}async deleteAll(){var s=(await this.db).transaction(this.storeName,"readwrite");let n=await s.objectStore(this.storeName).openCursor();for(;n;)await n.delete(),n=await n.continue();await s.done}async findAll(){return(await this.db).getAll(this.storeName)}}const Zt=class extends qs{constructor(t){super(t.db,Zt.STORE_NAME_LATEST),this.config=t}async findAds(t,e){return(await this.db).getAllFromIndex(this.storeName,Zt.INDEX_TIMESTAMP,IDBKeyRange.bound(t,e,!1,!0))}async findAdsForSession(t){return(await this.db).getAllFromIndex(this.storeName,Zt.INDEX_SESSION_ID,t)}async upsertAd(t){var n,r,e=await this.db,t=Hs.parse(t);return null!=(r=(n=this.config).onAdUpserted)&&r.call(n,t),await e.put(this.storeName,t),t}};let K=Zt;K.STORE_NAME_1="ads",K.STORE_NAME_2="ads-2",K.STORE_NAME_LATEST=Zt.STORE_NAME_2,K.INDEX_SESSION_ID="idx_ad_sessionId",K.INDEX_TIMESTAMP="idx_ad_timestamp";let ms;const ea=new Uint8Array(16);function ta(){if(ms||(ms=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))return ms(ea);throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported")}const ie=[];for(let t=0;t<256;++t)ie.push((t+256).toString(16).slice(1));const Bn={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function Bt(t,e,s){if(Bn.randomUUID&&!e&&!t)return Bn.randomUUID();var n=(t=t||{}).random||(t.rng||ta)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){s=s||0;for(let r=0;r<16;++r)e[s+r]=n[r];return e}return function(t,e=0){return(ie[t[e+0]]+ie[t[e+1]]+ie[t[e+2]]+ie[t[e+3]]+"-"+ie[t[e+4]]+ie[t[e+5]]+"-"+ie[t[e+6]]+ie[t[e+7]]+"-"+ie[t[e+8]]+ie[t[e+9]]+"-"+ie[t[e+10]]+ie[t[e+11]]+ie[t[e+12]]+ie[t[e+13]]+ie[t[e+14]]+ie[t[e+15]]).toLowerCase()}(n)}function na(t){var e;return{id:t.id,appId:t.appId,path:t.path,referrer:t.referrer,createdBy:t.createdBy,endedAt:null!=(e=t.endedAt)?e:-1,startedAt:t.startedAt,imported:t.imported}}function Xs(t){return{id:t.id,appId:t.appId,path:t.path,referrer:t.referrer,createdBy:t.createdBy,endedAt:-1===t.endedAt?null:t.endedAt,startedAt:t.startedAt,imported:t.imported}}const Wt=class extends qs{constructor(t){super(t.db,Wt.STORE_NAME_LATEST),this.config=t}async startPageView(t){var e=await this.db,t=Zn.parse({...t,id:Bt(),createdBy:await this.config.getInstallId(),endedAt:void 0}),n=na(t);return await e.add(this.storeName,n),t}async endPageView(t,e){var s=await this.db,n=await s.get(this.storeName,t.id);if(null==n)throw Error("Cannot update: PageView not found with id="+t.id);t={...n,endedAt:e};return await s.put(this.storeName,t),Xs(t)}async getActivePageViews(){return(await(await this.db).getAllFromIndex(this.storeName,Wt.INDEX_ENDED_AT,-1)).map(Xs)}async findPageViewsByEndedAt(t,e){return(await(await this.db).getAllFromIndex(this.storeName,Wt.INDEX_ENDED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(Xs)}async deleteAllGeneratedPageViews(){var e=(await this.db).transaction(this.storeName,"readwrite");let s=await e.store.openCursor();for(;s;)s.value.imported&&await s.delete(),s=await s.continue();await e.done}};let Pe=Wt;function Wn(t,e,s,n){return new(s=s||Promise)(function(i,a){function o(h){try{l(n.next(h))}catch(m){a(m)}}function d(h){try{l(n.throw(h))}catch(m){a(m)}}function l(h){h.done?i(h.value):function(i){return i instanceof s?i:new s(function(a){a(i)})}(h.value).then(o,d)}l((n=n.apply(t,e||[])).next())})}function zn(t,e){var n,r,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},a={next:o(0),throw:o(1),return:o(2)};return"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function o(l){return function(h){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;a&&l[a=0]&&(s=0),s;)try{if(n=1,r&&(i=2&l[0]?r.return:l[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,l[1])).done)return i;switch(r=0,(l=i?[2&l[0],i.value]:l)[0]){case 0:case 1:i=l;break;case 4:return s.label++,{value:l[1],done:!1};case 5:s.label++,r=l[1],l=[0];continue;case 7:l=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===l[0]||2===l[0])){s=0;continue}if(3===l[0]&&(!i||l[1]>i[0]&&l[1]<i[3]))s.label=l[1];else if(6===l[0]&&s.label<i[1])s.label=i[1],i=l;else{if(!(i&&s.label<i[2])){i[2]&&s.ops.pop(),s.trys.pop();continue}s.label=i[2],s.ops.push(l)}}l=e.call(t,s)}catch(h){l=[6,h],r=0}finally{n=i=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,h])}}}Pe.STORE_NAME_1="page_views",Pe.STORE_NAME_LATEST=Wt.STORE_NAME_1,Pe.INDEX_ENDED_AT="idx_page_view_endedAt",Pe.INDEX_STARTED_AT="idx_page_view_startedAt";var ra=new Error("request for lock canceled"),ia=function(){function t(e,s){void 0===s&&(s=ra),this._value=e,this._cancelError=s,this._weightedQueues=[],this._weightedWaiters=[]}return t.prototype.acquire=function(e){var s=this;if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));return new Promise(function(n,r){s._weightedQueues[e-1]||(s._weightedQueues[e-1]=[]),s._weightedQueues[e-1].push({resolve:n,reject:r}),s._dispatch()})},t.prototype.runExclusive=function(e,s){return void 0===s&&(s=1),Wn(this,void 0,void 0,function(){var r,n;return zn(this,function(a){switch(a.label){case 0:return[4,this.acquire(s)];case 1:n=a.sent(),r=n[0],n=n[1],a.label=2;case 2:return a.trys.push([2,,4,5]),[4,e(r)];case 3:return[2,a.sent()];case 4:return n(),[7];case 5:return[2]}})})},t.prototype.waitForUnlock=function(e){var s=this;if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));return new Promise(function(n){s._weightedWaiters[e-1]||(s._weightedWaiters[e-1]=[]),s._weightedWaiters[e-1].push(n),s._dispatch()})},t.prototype.isLocked=function(){return this._value<=0},t.prototype.getValue=function(){return this._value},t.prototype.setValue=function(e){this._value=e,this._dispatch()},t.prototype.release=function(e){if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));this._value+=e,this._dispatch()},t.prototype.cancel=function(){var e=this;this._weightedQueues.forEach(function(s){return s.forEach(function(n){return n.reject(e._cancelError)})}),this._weightedQueues=[]},t.prototype._dispatch=function(){for(var s=this._value;0<s;s--){var r,i,e=null==(e=this._weightedQueues[s-1])?void 0:e.shift();e&&(r=this._value,i=s,this._value-=s,s=this._value+1,e.resolve([r,this._newReleaser(i)]))}this._drainUnlockWaiters()},t.prototype._newReleaser=function(e){var s=this,n=!1;return function(){n||(n=!0,s.release(e))}},t.prototype._drainUnlockWaiters=function(){for(var e=this._value;0<e;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(function(s){return s()}),this._weightedWaiters[e-1]=[])},t}(),Fn=function(){function t(e){this._semaphore=new ia(1,e)}return t.prototype.acquire=function(){return Wn(this,void 0,void 0,function(){var e;return zn(this,function(n){switch(n.label){case 0:return[4,this._semaphore.acquire()];case 1:return e=n.sent(),[2,e[1]]}})})},t.prototype.runExclusive=function(e){return this._semaphore.runExclusive(function(){return e()})},t.prototype.isLocked=function(){return this._semaphore.isLocked()},t.prototype.waitForUnlock=function(){return this._semaphore.waitForUnlock()},t.prototype.release=function(){this._semaphore.isLocked()&&this._semaphore.release()},t.prototype.cancel=function(){return this._semaphore.cancel()},t}(),zt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},$i={exports:{}};typeof globalThis<"u"?globalThis:typeof self<"u"&&self,function(s){var n,r;if(!((r=(n=globalThis.chrome)==null?void 0:n.runtime)!=null&&r.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const i="The message port closed before a response was received.",a=o=>{const d={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(d).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class l extends WeakMap{constructor(b,M=void 0){super(M),this.createItem=b}get(b){return this.has(b)||this.set(b,this.createItem(b)),super.get(b)}}const h=T=>T&&typeof T=="object"&&typeof T.then=="function",m=(T,b)=>(...M)=>{o.runtime.lastError?T.reject(new Error(o.runtime.lastError.message)):b.singleCallbackArg||M.length<=1&&b.singleCallbackArg!==!1?T.resolve(M[0]):T.resolve(M)},y=T=>T==1?"argument":"arguments",E=(T,b)=>function(P,...G){if(G.length<b.minArgs)throw new Error(`Expected at least ${b.minArgs} ${y(b.minArgs)} for ${T}(), got ${G.length}`);if(G.length>b.maxArgs)throw new Error(`Expected at most ${b.maxArgs} ${y(b.maxArgs)} for ${T}(), got ${G.length}`);return new Promise((fe,ye)=>{if(b.fallbackToNoCallback)try{P[T](...G,m({resolve:fe,reject:ye},b))}catch(C){console.warn(`${T} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,C),P[T](...G),b.fallbackToNoCallback=!1,b.noCallback=!0,fe()}else b.noCallback?(P[T](...G),fe()):P[T](...G,m({resolve:fe,reject:ye},b))})},U=(T,b,M)=>new Proxy(b,{apply(P,G,fe){return M.call(G,T,...fe)}});let A=Function.call.bind(Object.prototype.hasOwnProperty);const V=(T,b={},M={})=>{let P=Object.create(null),G={has(ye,C){return C in T||C in P},get(ye,C,_e){if(C in P)return P[C];if(!(C in T))return;let Q=T[C];if(typeof Q=="function")if(typeof b[C]=="function")Q=U(T,T[C],b[C]);else if(A(M,C)){let Je=E(C,M[C]);Q=U(T,T[C],Je)}else Q=Q.bind(T);else if(typeof Q=="object"&&Q!==null&&(A(b,C)||A(M,C)))Q=V(Q,b[C],M[C]);else if(A(M,"*"))Q=V(Q,b[C],M["*"]);else return Object.defineProperty(P,C,{configurable:!0,enumerable:!0,get(){return T[C]},set(Je){T[C]=Je}}),Q;return P[C]=Q,Q},set(ye,C,_e,Q){return C in P?P[C]=_e:T[C]=_e,!0},defineProperty(ye,C,_e){return Reflect.defineProperty(P,C,_e)},deleteProperty(ye,C){return Reflect.deleteProperty(P,C)}},fe=Object.create(T);return new Proxy(fe,G)},D=T=>({addListener(b,M,...P){b.addListener(T.get(M),...P)},hasListener(b,M){return b.hasListener(T.get(M))},removeListener(b,M){b.removeListener(T.get(M))}}),$=new l(T=>typeof T!="function"?T:function(M){const P=V(M,{},{getContent:{minArgs:0,maxArgs:0}});T(P)}),me=new l(T=>typeof T!="function"?T:function(M,P,G){let fe=!1,ye,C=new Promise(lt=>{ye=function(Se){fe=!0,lt(Se)}}),_e;try{_e=T(M,P,ye)}catch(lt){_e=Promise.reject(lt)}const Q=_e!==!0&&h(_e);if(_e!==!0&&!Q&&!fe)return!1;const Je=lt=>{lt.then(Se=>{G(Se)},Se=>{let Yt;Se&&(Se instanceof Error||typeof Se.message=="string")?Yt=Se.message:Yt="An unexpected error occurred",G({__mozWebExtensionPolyfillReject__:!0,message:Yt})}).catch(Se=>{console.error("Failed to send onMessage rejected reply",Se)})};return Je(Q?_e:C),!0}),Kt=({reject:T,resolve:b},M)=>{o.runtime.lastError?o.runtime.lastError.message===i?b():T(new Error(o.runtime.lastError.message)):M&&M.__mozWebExtensionPolyfillReject__?T(new Error(M.message)):b(M)},Re=(T,b,M,...P)=>{if(P.length<b.minArgs)throw new Error(`Expected at least ${b.minArgs} ${y(b.minArgs)} for ${T}(), got ${P.length}`);if(P.length>b.maxArgs)throw new Error(`Expected at most ${b.maxArgs} ${y(b.maxArgs)} for ${T}(), got ${P.length}`);return new Promise((G,fe)=>{const ye=Kt.bind(null,{resolve:G,reject:fe});P.push(ye),M.sendMessage(...P)})},ae={devtools:{network:{onRequestFinished:D($)}},runtime:{onMessage:D(me),onMessageExternal:D(me),sendMessage:Re.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:Re.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},ze={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return d.privacy={network:{"*":ze},services:{"*":ze},websites:{"*":ze}},V(o,ae,d)};s.exports=a(chrome)}else s.exports=globalThis.browser}($i);const j=$i.exports;class aa{constructor(e,s=Date.now()){this.logMethod=e,this.startedAt=s}log(e){var s=Date.now()-this.startedAt;this.logMethod(e.replace(/\{duration\}/g,(s/1e3).toFixed(3)+"s"))}}function ys(t){return Math.round(t/1e3)}function ca(){return new Promise(t=>setTimeout(t,0))}function da(t){const e=new Fn;return(...s)=>e.runExclusive(()=>t(...s))}async function Ys(t){return(await j.storage.local.get(t))[t]}async function Ft(t,e){void 0===e?await j.storage.local.remove(t):await j.storage.local.set({[t]:e})}function la(t,e){const s="string"==typeof e;return t.reduce((r,i)=>{var a=(r=>s?r[e]:e(r))(i);return r[a]=null!=(a=null==(a=r[a])?void 0:a.concat(i))?a:[i],r},{})}function ua(t,e){const s="string"==typeof e;return t.reduce((r,i)=>{return r[(r=>s?r[e]:e(r))(i)]=i,r},{})}function ha(){let t,e;return[new Promise((n,r)=>{t=n,e=r}),t,e]}function pa(t,e,s,n){return n&&t.audible||t.active&&e.focused&&function(t){return"docked"!==t.state&&"minimized"!==t.state}(e)&&s}function qn(t){var e=t.objectStoreNames.length,s=[];for(let n=0;n<e;n++){var r=t.objectStoreNames.item(n);r&&s.push(r)}return s}function Gn(t){var e;return{id:t.id,appId:t.appId,createdBy:t.createdBy,endedAt:null!=(e=t.endedAt)?e:-1,startedAt:t.startedAt,imported:t.imported,generated:t.generated}}function at(t){return{id:t.id,appId:t.appId,createdBy:t.createdBy,endedAt:-1===t.endedAt?null:t.endedAt,startedAt:t.startedAt,imported:t.imported,generated:t.generated}}const Be=class extends qs{constructor(t){super(t.db,Be.STORE_NAME_LATEST),this.config=t}async startSession(t){var e=await this.db,t=Fs.parse({...t,id:Bt(),createdBy:await this.config.getInstallId(),endedAt:void 0}),n=Gn(t);return await e.add(this.storeName,n),t}async createSessions(t){const e=await this.db,s=await this.config.getInstallId(),n=e.transaction(Be.STORE_NAME_LATEST,"readwrite"),r=n.objectStore(Be.STORE_NAME_LATEST),i=t.map(o=>Fs.parse({...o,id:Bt(),createdBy:s})),a=i.map(Gn);return await Promise.all([...a.map(o=>r.add(o)),n.done]),i}async endSession(t,e){var s=await this.db,a=(216e5<=e-t.startedAt&&(null!=(a=(i=this.config).onLongSessionDetected)&&a.call(i,t,e),e=t.startedAt+6e5),await s.get(this.storeName,t.id));if(null==a)throw Error("Cannot update: Session not found with id="+t.id);var i={...a,endedAt:e};return await s.put(this.storeName,i),at(i)}async findAllSessions(){return(await super.findAll()).map(at)}async findSessions(t,e){return(await(await this.db).getAllFromIndex(this.storeName,Be.INDEX_STARTED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(at)}async findSessionsByEndedAt(t,e){return(await(await this.db).getAllFromIndex(this.storeName,Be.INDEX_ENDED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(at)}async findOldestSession(){var s=(await(await this.db).getAllFromIndex(this.storeName,Be.INDEX_STARTED_AT,IDBKeyRange.lowerBound(0,!0))).shift();return s?at(s):void 0}async getSession(t){var s=await(await this.db).get(this.storeName,t);if(null==s)throw Error(`No session with id=${t} was found`);return at(s)}async getActiveSessions(){return(await(await this.db).getAllFromIndex(this.storeName,Be.INDEX_ENDED_AT,-1)).map(at)}async deleteAllGeneratedSessions(){var e=(await this.db).transaction(this.storeName,"readwrite");let s=await e.store.openCursor();for(;s;){var n=s.value;(n.imported||n.generated)&&await s.delete(),s=await s.continue()}await e.done}};let q=Be;q.STORE_NAME_1="sessions",q.STORE_NAME_2="sessions_2",q.STORE_NAME_LATEST=Be.STORE_NAME_2,q.INDEX_ENDED_AT="idx_session_endedAt",q.INDEX_STARTED_AT="idx_session_startedAt";var se=(t=>(t[t.V2=2]="V2",t[t.V3=3]="V3",t[t.V4=4]="V4",t[t.V5=5]="V5",t[t.V6=6]="V6",t[t.V7=7]="V7",t[t.V8=8]="V8",t))({});const Xn=li.object({version:li.nativeEnum(se),stores:li.object({[q.STORE_NAME_LATEST]:li.array($n).optional(),[Pe.STORE_NAME_LATEST]:li.array(Un).optional(),[K.STORE_NAME_LATEST]:li.array(Hs).optional()})}),ga=li.object({version:li.nativeEnum(se),stores:li.record(li.string(),li.array(li.any()))});function Kn(t){return{id:t.id,sessionId:t.sessionId,timestamp:t.timestamp,type:"basic-display",details:{type:t.type,height:t.additionalDetails.height,width:t.additionalDetails.width,url:t.adUrl}}}function _s(t,e){return{id:t.id,appId:t.host,createdBy:e,startedAt:t.startedAt,endedAt:null!=(e=t.endedAt)?e:-1,imported:t.imported,generated:t.generated}}async function Aa({dbPromise:t,usageBackup:e,logger:s,getInstallId:n}){var t=await t,n=(null!=s&&s.debug("[import-backup] Importing...",e),await n()),a=await Xn.parseAsync(await async function Yn(t,e,s){if(t.version===e)return t;const n=Ta[t.version];if(null==n)throw Error(`Failed to upgrade backup version ${t.version}, version not supported`);const r=await n(t,s);return Yn(r,e,s)}(e,t.version,{installId:n})),e=qn(t),d=t.transaction(e,"readwrite");for(const l of e){var h=a.stores[l];if(null!=h&&h.length){var m=d.objectStore(l);for(const y of h)null!=s&&s.debug(`[import-backup]: ${l}:`,y),await m.put({...y,imported:!0})}}await d.done}const Qs=t=>e=>({...e,version:t}),Ta={[se.V2]:Qs(se.V3),[se.V3]:t=>{return{version:se.V4,stores:{[q.STORE_NAME_2]:t.stores[q.STORE_NAME_2],[K.STORE_NAME_2]:null==(t=t.stores[K.STORE_NAME_2])?void 0:t.map(Kn)}}},[se.V4]:Qs(se.V5),[se.V5]:(t,{installId:e})=>{var s;return{version:se.V6,stores:{[q.STORE_NAME_2]:null==(s=t.stores[q.STORE_NAME_2])?void 0:s.map(n=>_s(n,e)),[K.STORE_NAME_2]:t.stores[K.STORE_NAME_2]}}},[se.V6]:(t,{installId:e})=>{var s;return{version:se.V7,stores:{[q.STORE_NAME_2]:null==(s=t.stores[q.STORE_NAME_2])?void 0:s.map(n=>"host"in n?_s(n,e):n),[K.STORE_NAME_2]:t.stores[K.STORE_NAME_2]}}},[se.V7]:Qs(se.V8),[se.V8]:t=>t};const Sa=(t,e)=>e.some(s=>t instanceof s);let Jn,Qn;const er=new WeakMap,en=new WeakMap,tr=new WeakMap,tn=new WeakMap,sn=new WeakMap;let nn={get(t,e,s){if(t instanceof IDBTransaction){if("done"===e)return en.get(t);if("objectStoreNames"===e)return t.objectStoreNames||tr.get(t);if("store"===e)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Xe(t[e])},set(t,e,s){return t[e]=s,!0},has(t,e){return t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t}};function Ra(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Qn=Qn||[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]).includes(t)?function(...e){return t.apply(rn(this),e),Xe(er.get(this))}:function(...e){return Xe(t.apply(rn(this),e))}:function(e,...s){s=t.call(rn(this),e,...s);return tr.set(s,e.sort?e.sort():[e]),Xe(s)}}function Ma(t){return"function"==typeof t?Ra(t):(t instanceof IDBTransaction&&function(t){var e;en.has(t)||(e=new Promise((s,n)=>{const r=()=>{t.removeEventListener("complete",i),t.removeEventListener("error",a),t.removeEventListener("abort",a)},i=()=>{s(),r()},a=()=>{n(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",i),t.addEventListener("error",a),t.addEventListener("abort",a)}),en.set(t,e))}(t),Sa(t,Jn=Jn||[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])?new Proxy(t,nn):t)}function Xe(t){var e;return t instanceof IDBRequest?function(t){var e=new Promise((s,n)=>{const r=()=>{t.removeEventListener("success",i),t.removeEventListener("error",a)},i=()=>{s(Xe(t.result)),r()},a=()=>{n(t.error),r()};t.addEventListener("success",i),t.addEventListener("error",a)});return e.then(s=>{s instanceof IDBCursor&&er.set(s,t)}).catch(()=>{}),sn.set(e,t),e}(t):tn.has(t)?tn.get(t):((e=Ma(t))!==t&&(tn.set(t,e),sn.set(e,t)),e)}const rn=t=>sn.get(t);const La=["get","getKey","getAll","getAllKeys","count"],Da=["put","add","delete","clear"],an=new Map;function sr(t,e){if(t instanceof IDBDatabase&&!(e in t)&&"string"==typeof e){if(an.get(e))return an.get(e);const s=e.replace(/FromIndex$/,""),n=e!==s,r=Da.includes(s);return s in(n?IDBIndex:IDBObjectStore).prototype&&(r||La.includes(s))?(t=async function(a,...o){a=this.transaction(a,r?"readwrite":"readonly");let l=a.store;return n&&(l=l.index(o.shift())),(await Promise.all([l[s](...o),r&&a.done]))[0]},an.set(e,t),t):void 0}}nn=(t=>({...t,get:(e,s,n)=>sr(e,s)||t.get(e,s,n),has:(e,s)=>!!sr(e,s)||t.has(e,s)}))(nn);const As=()=>{},Ua=[As,As,As,async function({db:t,tx:e}){var s=e.objectStore(q.STORE_NAME_1),n=e.objectStore(q.STORE_NAME_2),r=e.objectStore(K.STORE_NAME_1),i=e.objectStore(K.STORE_NAME_2);for(const o of await s.index(q.INDEX_STARTED_AT).getAll()){var d=function(t){return{...t,id:Bt()}}(o),l=(await n.add(d),await r.index(K.INDEX_SESSION_ID).getAll(o.id));for(const h of l){var m=function(t,e){return{...t,id:Bt(),sessionId:e}}(h,d.id);await i.add(m)}}t.deleteObjectStore(s.name),t.deleteObjectStore(r.name)},async function({tx:t}){var e=t.objectStore(K.STORE_NAME_2);for(const n of await e.getAll()){var r=Kn(n);await e.put(r)}},As,async function({tx:t,ctx:e}){var s=t.objectStore(q.STORE_NAME_2);for(const r of await s.getAll()){var i=_s(r,e.installId);await s.put(i)}},async function({tx:t,ctx:e}){var i,s=t.objectStore(q.STORE_NAME_2);for(const r of await s.getAll())"host"in r&&(i=_s(r,e.installId),await s.put(i))}];function bt(t,e,s,n){t.indexNames.contains(e)?t.index(e):t.createIndex(e,s,n)}function on({db:t,tx:e},s,n){return t.objectStoreNames.contains(s)?e.objectStore(s):t.createObjectStore(s,n)}const Ba=se.V8;async function Wa(t){const e=await t.getInstallId();return function(t,e,{blocked:s,upgrade:n,blocking:r,terminated:i}){const a=indexedDB.open(t,e),o=Xe(a);return n&&a.addEventListener("upgradeneeded",d=>{n(Xe(a.result),d.oldVersion,d.newVersion,Xe(a.transaction),d)}),s&&a.addEventListener("blocked",d=>s(d.oldVersion,d.newVersion,d)),o.then(d=>{i&&d.addEventListener("close",()=>i()),r&&d.addEventListener("versionchange",l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}("UsageSdkDb",Ba,{async upgrade(s,n,r,i){s={db:s,oldVersion:n,newVersion:r,tx:i,ctx:{installId:e}};(function(t){var e=on(t,q.STORE_NAME_LATEST,{keyPath:"id"}),e=(bt(e,q.INDEX_STARTED_AT,"startedAt",{unique:!1}),bt(e,q.INDEX_ENDED_AT,"endedAt",{unique:!1}),on(t,Pe.STORE_NAME_LATEST,{keyPath:"id"})),e=(bt(e,Pe.INDEX_STARTED_AT,"startedAt",{unique:!1}),bt(e,Pe.INDEX_ENDED_AT,"endedAt",{unique:!1}),on(t,K.STORE_NAME_LATEST,{keyPath:"id"}));bt(e,K.INDEX_SESSION_ID,"sessionId",{unique:!1}),bt(e,K.INDEX_TIMESTAMP,"timestamp",{unique:!1})})(s),await async function(t,{logger:e}){if(0===t.oldVersion||null==t.newVersion)null!=e&&e.debug("[usage-database] Skipping migrations for new databases",{oldVersion:t.oldVersion,newVersion:t.newVersion});else{var s=t.oldVersion+1,n=t.newVersion,r=Ua.slice(s,n+1);if(0===r.length)null!=e&&e.log("[usage-database] No migrations to run");else{null!=e&&e.log(`[usage-database] Running migrations ${s} -> `+n);for(const i of r)await i(t)}}}(s,{logger:null})}})}Cn={exports:{}};!function(t,e){var n="__lodash_hash_undefined__",r=1,i=2,a=9007199254740991,o="[object Arguments]",d="[object Array]",l="[object AsyncFunction]",h="[object Boolean]",m="[object Date]",y="[object Error]",E="[object Function]",U="[object GeneratorFunction]",A="[object Map]",V="[object Number]",D="[object Null]",$="[object Object]",me="[object Promise]",Kt="[object Proxy]",Re="[object RegExp]",ae="[object Set]",ze="[object String]",T="[object Symbol]",b="[object Undefined]",M="[object WeakMap]",P="[object ArrayBuffer]",G="[object DataView]",xc=/^\[object .+?Constructor\]$/,Tc=/^(?:0|[1-9]\d*)$/,Z={},Or=(Z["[object Float32Array]"]=Z["[object Float64Array]"]=Z["[object Int8Array]"]=Z["[object Int16Array]"]=Z["[object Int32Array]"]=Z["[object Uint8Array]"]=Z["[object Uint8ClampedArray]"]=Z["[object Uint16Array]"]=Z["[object Uint32Array]"]=!0,Z[o]=Z[d]=Z[P]=Z[h]=Z[G]=Z[m]=Z[y]=Z[E]=Z[A]=Z[V]=Z[$]=Z[Re]=Z[ae]=Z[ze]=Z[M]=!1,"object"==typeof zt&&zt&&zt.Object===Object&&zt),Sc="object"==typeof self&&self&&self.Object===Object&&self,Sc=Or||Sc||Function("return this")(),e=e&&!e.nodeType&&e,Mr=e&&t&&!t.nodeType&&t,Mr=Mr&&Mr.exports===e,fn=Mr&&Or.process,e=function(){try{return fn&&fn.binding&&fn.binding("util")}catch{}}(),Or=e&&e.isTypedArray;function Cc(c){var u=-1,f=Array(c.size);return c.forEach(function(v,B){f[++u]=[B,v]}),f}function Dc(c){var u=-1,f=Array(c.size);return c.forEach(function(v){f[++u]=v}),f}var e=Array.prototype,Vc=Function.prototype,Es=Object.prototype,pn=Sc["__core-js_shared__"],Pr=Vc.toString,je=Es.hasOwnProperty,Vr=(Vc=/[^.]+$/.exec(pn&&pn.keys&&pn.keys.IE_PROTO||""))?"Symbol(src)_1."+Vc:"",jr=Es.toString,jc=RegExp("^"+Pr.call(je).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),pn=Mr?Sc.Buffer:void 0,Vc=Sc.Symbol,Ur=Sc.Uint8Array,Zr=Es.propertyIsEnumerable,$c=e.splice,ut=Vc?Vc.toStringTag:void 0,Br=Object.getOwnPropertySymbols,Mr=pn?pn.isBuffer:void 0,Zc=function(c,u){return function(f){return c(u(f))}}(Object.keys,Object),e=St(Sc,"DataView"),Jt=St(Sc,"Map"),pn=St(Sc,"Promise"),yn=St(Sc,"Set"),Sc=St(Sc,"WeakMap"),Qt=St(Object,"create"),Bc=pt(e),Wc=pt(Jt),zc=pt(pn),Fc=pt(yn),Hc=pt(Sc),Vc=Vc?Vc.prototype:void 0,An=Vc?Vc.valueOf:void 0;function ht(c){var u=-1,f=null==c?0:c.length;for(this.clear();++u<f;){var v=c[u];this.set(v[0],v[1])}}function He(c){var u=-1,f=null==c?0:c.length;for(this.clear();++u<f;){var v=c[u];this.set(v[0],v[1])}}function ft(c){var u=-1,f=null==c?0:c.length;for(this.clear();++u<f;){var v=c[u];this.set(v[0],v[1])}}function Ns(c){var u=-1,f=null==c?0:c.length;for(this.__data__=new ft;++u<f;)this.add(c[u])}function Qe(c){c=this.__data__=new He(c);this.size=c.size}function gd(c,u){var F,f=Rs(c),v=!f&&Od(c),B=!f&&!v&&vn(c),N=!f&&!v&&!B&&Jr(c),X=f||v||B||N,re=X?function(c,u){for(var f=-1,v=Array(c);++f<c;)v[f]=u(f);return v}(c.length,String):[],oe=re.length;for(F in c)!u&&!je.call(c,F)||X&&("length"==F||B&&("offset"==F||"parent"==F)||N&&("buffer"==F||"byteLength"==F||"byteOffset"==F)||function(c,u){return(u=null==u?a:u)&&("number"==typeof c||Tc.test(c))&&-1<c&&c%1==0&&c<u}(F,oe))||re.push(F);return re}function ks(c,u){for(var f=c.length;f--;)if(Gr(c[f][0],u))return f;return-1}function md(c,u,f){u=u(c);return Rs(c)?u:function(c,u){for(var f=-1,v=u.length,B=c.length;++f<v;)c[B+f]=u[f];return c}(u,f(c))}function es(c){return null==c?void 0===c?b:D:(ut&&ut in Object(c)?function(c){var u=je.call(c,ut),f=c[ut];try{var v=!(c[ut]=void 0)}catch{}var B=jr.call(c);return v&&(u?c[ut]=f:delete c[ut]),B}:function(c){return jr.call(c)})(c)}function zr(c){return ts(c)&&es(c)==o}function Fr(c,u,f,v,B){return c===u||(null==c||null==u||!ts(c)&&!ts(u)?c!=c&&u!=u:function(c,u,f,v,B,N){var X=Rs(c),re=Rs(u),oe=X?d:et(c),re=re?d:et(u),Ae=(oe=oe==o?$:oe)==$,Me=(re=re==o?$:re)==$,re=oe==re;if(re&&vn(c)){if(!vn(u))return!1;Ae=!(X=!0)}if(re&&!Ae)return N=N||new Qe,X||Jr(c)?Hr(c,u,f,v,B,N):function(c,u,f,v,B,N,X){switch(f){case G:if(c.byteLength!=u.byteLength||c.byteOffset!=u.byteOffset)return!1;c=c.buffer,u=u.buffer;case P:return!(c.byteLength!=u.byteLength||!N(new Ur(c),new Ur(u)));case h:case m:case V:return Gr(+c,+u);case y:return c.name==u.name&&c.message==u.message;case Re:case ze:return c==u+"";case A:var re=Cc;case ae:var oe=v&r;if(re=re||Dc,c.size!=u.size&&!oe)return!1;oe=X.get(c);if(oe)return oe==u;v|=i,X.set(c,u);oe=Hr(re(c),re(u),v,B,N,X);return X.delete(c),oe;case T:if(An)return An.call(c)==An.call(u)}return!1}(c,u,oe,f,v,B,N);if(!(f&r)){X=Ae&&je.call(c,"__wrapped__"),oe=Me&&je.call(u,"__wrapped__");if(X||oe)return Ae=X?c.value():c,Me=oe?u.value():u,N=N||new Qe,B(Ae,Me,f,v,N)}return re&&(N=N||new Qe,function(c,u,f,v,B,N){var X=f&r,re=qr(c),oe=re.length,Ae=qr(u).length;if(oe!=Ae&&!X)return!1;for(var Me=oe;Me--;){var ue=re[Me];if(!(X?ue in u:je.call(u,ue)))return!1}Ae=N.get(c);if(Ae&&N.get(u))return Ae==u;var Ie=!0;N.set(c,u),N.set(u,c);for(var tt=X;++Me<oe;){ue=re[Me];var Qr,qe=c[ue],gt=u[ue];if(!(void 0===(Qr=v?X?v(gt,qe,ue,u,c,N):v(qe,gt,ue,c,u,N):Qr)?qe===gt||B(qe,gt,f,v,N):Qr)){Ie=!1;break}tt=tt||"constructor"==ue}{var Cs;Ie&&!tt&&(Ae=c.constructor,Cs=u.constructor,Ae!=Cs)&&"constructor"in c&&"constructor"in u&&!("function"==typeof Ae&&Ae instanceof Ae&&"function"==typeof Cs&&Cs instanceof Cs)&&(Ie=!1)}return N.delete(c),N.delete(u),Ie}(c,u,f,v,B,N))}(c,u,f,v,Fr,B))}function _d(c){return Yr(c)&&!function(c){return Vr&&Vr in c}(c)&&(Xr(c)?jc:xc).test(pt(c))}function vd(c){if(!function(c){var u=c&&c.constructor,u="function"==typeof u&&u.prototype||Es;return c===u}(c))return Zc(c);var f,u=[];for(f in Object(c))je.call(c,f)&&"constructor"!=f&&u.push(f);return u}function Hr(c,u,f,v,B,N){var X=f&r,re=c.length,oe=u.length;if(re!=oe&&!(X&&re<oe))return!1;oe=N.get(c);if(oe&&N.get(u))return oe==u;var Ae=-1,Me=!0,ue=f&i?new Ns:void 0;for(N.set(c,u),N.set(u,c);++Ae<re;){var tt,Ee=c[Ae],Ie=u[Ae];if(void 0!==(tt=v?X?v(Ie,Ee,Ae,u,c,N):v(Ee,Ie,Ae,c,u,N):tt)){if(tt)continue;Me=!1;break}if(ue){if(!function(c,u){for(var f=-1,v=null==c?0:c.length;++f<v;)if(u(c[f],f,c))return 1}(u,function(qe,gt){return!ue.has(gt)&&(Ee===qe||B(Ee,qe,f,v,N))&&ue.push(gt)})){Me=!1;break}}else if(Ee!==Ie&&!B(Ee,Ie,f,v,N)){Me=!1;break}}return N.delete(c),N.delete(u),Me}function qr(c){return md(c,Cd,Td)}function Os(c,u){c=c.__data__;return function(c){var u=typeof c;return"string"==u||"number"==u||"symbol"==u||"boolean"==u?"__proto__"!==c:null===c}(u)?c["string"==typeof u?"string":"hash"]:c.map}function St(c,u){c=function(c,u){return null==c?void 0:c[u]}(c,u);return _d(c)?c:void 0}ht.prototype.clear=function(){this.__data__=Qt?Qt(null):{},this.size=0},ht.prototype.delete=function(c){return c=this.has(c)&&delete this.__data__[c],this.size-=c?1:0,c},ht.prototype.get=function(c){var f,u=this.__data__;return Qt?(f=u[c])===n?void 0:f:je.call(u,c)?u[c]:void 0},ht.prototype.has=function(c){var u=this.__data__;return Qt?void 0!==u[c]:je.call(u,c)},ht.prototype.set=function(c,u){var f=this.__data__;return this.size+=this.has(c)?0:1,f[c]=Qt&&void 0===u?n:u,this},He.prototype.clear=function(){this.__data__=[],this.size=0},He.prototype.delete=function(c){var u=this.__data__;return!((c=ks(u,c))<0||(c==u.length-1?u.pop():$c.call(u,c,1),--this.size,0))},He.prototype.get=function(c){var u=this.__data__;return(c=ks(u,c))<0?void 0:u[c][1]},He.prototype.has=function(c){return-1<ks(this.__data__,c)},He.prototype.set=function(c,u){var f=this.__data__,v=ks(f,c);return v<0?(++this.size,f.push([c,u])):f[v][1]=u,this},ft.prototype.clear=function(){this.size=0,this.__data__={hash:new ht,map:new(Jt||He),string:new ht}},ft.prototype.delete=function(c){return c=Os(this,c).delete(c),this.size-=c?1:0,c},ft.prototype.get=function(c){return Os(this,c).get(c)},ft.prototype.has=function(c){return Os(this,c).has(c)},ft.prototype.set=function(c,u){var f=Os(this,c),v=f.size;return f.set(c,u),this.size+=f.size==v?0:1,this},Ns.prototype.add=Ns.prototype.push=function(c){return this.__data__.set(c,n),this},Ns.prototype.has=function(c){return this.__data__.has(c)},Qe.prototype.clear=function(){this.__data__=new He,this.size=0},Qe.prototype.delete=function(c){var u=this.__data__,c=u.delete(c);return this.size=u.size,c},Qe.prototype.get=function(c){return this.__data__.get(c)},Qe.prototype.has=function(c){return this.__data__.has(c)},Qe.prototype.set=function(c,u){var f=this.__data__;if(f instanceof He){var v=f.__data__;if(!Jt||v.length<199)return v.push([c,u]),this.size=++f.size,this;f=this.__data__=new ft(v)}return f.set(c,u),this.size=f.size,this};var Td=Br?function(c){return null==c?[]:(c=Object(c),function(c,u){for(var f=-1,v=null==c?0:c.length,B=0,N=[];++f<v;){var X=c[f];u(X,f,c)&&(N[B++]=X)}return N}(Br(c),function(u){return Zr.call(c,u)}))}:function(){return[]},et=es;function pt(c){if(null!=c){try{return Pr.call(c)}catch{}try{return c+""}catch{}}return""}function Gr(c,u){return c===u||c!=c&&u!=u}(e&&et(new e(new ArrayBuffer(1)))!=G||Jt&&et(new Jt)!=A||pn&&et(pn.resolve())!=me||yn&&et(new yn)!=ae||Sc&&et(new Sc)!=M)&&(et=function(c){var u=es(c),c=u==$?c.constructor:void 0,c=c?pt(c):"";if(c)switch(c){case Bc:return G;case Wc:return A;case zc:return me;case Fc:return ae;case Hc:return M}return u});var Od=zr(function(){return arguments}())?zr:function(c){return ts(c)&&je.call(c,"callee")&&!Zr.call(c,"callee")},Rs=Array.isArray;var vn=Mr||function(){return!1};function Xr(c){if(Yr(c))return(c=es(c))==E||c==U||c==l||c==Kt}function Kr(c){return"number"==typeof c&&-1<c&&c%1==0&&c<=a}function Yr(c){var u=typeof c;return null!=c&&("object"==u||"function"==u)}function ts(c){return null!=c&&"object"==typeof c}var Jr=Or?function(c){return function(u){return c(u)}}(Or):function(c){return ts(c)&&Kr(c.length)&&!!Z[es(c)]};function Cd(c){return(function(c){return null!=c&&Kr(c.length)&&!Xr(c)}(c)?gd:vd)(c)}t.exports=function(c,u){return Fr(c,u)}}(Cn,Cn.exports);const Ha=Cn.exports;function nr(t,e){if(t="string"==typeof t?function(t){if(t){var e=s=>{s=new URL(s);if(!/^https?:/.test(s.protocol))throw Error("Invalid URL, ignored protocol found");if(!s.hostname)throw Error("Invalid URL, no hostname");if(s.hostname.lastIndexOf(".")>=s.hostname.length-2)throw Error("Invalid URL, bad domain ending");return s};try{return e(t)}catch{}if(!t.includes("://"))try{return e("https://"+t)}catch{}}}(t.trim()):t){let s=null==(e=null==e?void 0:e.removeGenericPrefixes)||e,n=t.hostname;return{hostname:n=s?n.replace(/^(m|mobile|amp|www|www1|www2|www3|tab|item|checkout|secure|user|account|accounts|web|app|open|i|v|preview|cdn|l|id|nid|user|sso|signin|login|auth0|play|api|click|detail|dashboard|console|manage|support|help)\./,"").replace(/.*\.zoom\.us/,"zoom.us").replace(/.*\.slack\.com/,"slack.com").replace(/.*\.wikipedia\.org/,"wikipedia.org").replace(/.*\.amazonaws\.com/,"amazonaws.com").replace(/.*\.netsuite\.com/,"netsuite.com"):n,path:function(t){return t.endsWith("/")?t.substring(0,Math.max(1,t.length-1)):t}(t.pathname)}}}const vs="tab-history-map",rr=class{constructor(t){this.tabHistoryMap=this.restoreTabHistory(),this.lock=new Fn;let e=0;j.tabs.onCreated.addListener(s=>this.lock.runExclusive(async()=>{var n;null!=s.id&&(null!=t&&t.debug(`[referrer] ${e++} tabs.onCreated`,s),null!=s.openerTabId)&&(n=null==(n=(await this.tabHistoryMap)[s.openerTabId])?void 0:n[0])&&await this.addHistory(s.id,n)})),j.webNavigation.onCommitted.addListener(s=>this.lock.runExclusive(async()=>{null!=t&&t.debug(`[referrer] ${e++} webNavigation.onCommitted`,s);var{frameId:n,tabId:r,url:i,transitionQualifiers:a}=s;0===n&&((a.includes("forward_back")||a.includes("from_address_bar"))&&await this.addHistory(r,void 0),await this.addHistory(r,i))})),j.runtime.onStartup.addListener(()=>this.resetHistory()),j.runtime.onSuspend.addListener(()=>this.resetHistory()),j.tabs.onRemoved.addListener(s=>this.removeHistory(s))}async restoreTabHistory(){var t=await Ys(vs);return null!=t?t:{}}async addHistory(t,e){var s=await this.tabHistoryMap,r=null!=(r=s[t])?r:s[t]=[];e!==r[0]&&r.unshift(this.sanatizeReferrerUrl(e)),r.splice(rr.MAX_HISTORY_COUNT_PER_TAB),await Ft(vs,s)}sanatizeReferrerUrl(t){if(t)try{var e=new URL(t);return e.search="",e.username="",e.password="",e.hash="",e.href}catch{}}getReferrerFor(t,e){return this.lock.runExclusive(async()=>{var n,r;return null==t||!e||null==(n=(await this.tabHistoryMap)[t])||-1===(r=n.findIndex(i=>i===e))?void 0:n[r+1]})}resetHistory(){return Ft(vs,{})}async removeHistory(t){var e=await this.tabHistoryMap;delete e[t],await Ft(vs,e)}};let ir=rr;ir.MAX_HISTORY_COUNT_PER_TAB=10;class ar{constructor(){this.map={}}markAsProcessed(e){e.forEach(s=>this.map[s.id]=!0)}isProcessed(e){return null!=(e=this.map[e.id])&&e}}const Ve=class{constructor(t,e){this.wakeUpTimeoutDisabled=!1,this.hasRecentUserActivity=!0,this.sessionUpdatedListeners=[],this.pageViewUpdatedListeners=[],this.checkSessionsListeners=[],this.latestTriggerId=0,this.updateSessions=da(async r=>{var o,y,m,i=`[update-sessions] [${r.triggerId}]`;null!=(o=this.logger)&&o.debug(i+" Waiting for startup to stop previous sessions..."),await this.startupPromise,null!=(o=this.logger)&&o.debug(i+" Processing @ "+new Date(r.timestamp).toLocaleTimeString()),this.pingLastAliveAt(),this.invokeCheckSessionsListeners(),await this.config.enabled()&&(o=this.logger?new aa(this.logger.debug.bind(this.logger)):void 0,m=await this.getComputeDependencies(),null!=o&&o.log(i+" Got required data after {duration}"),y=this.findSessionChanges(r,m),null!=o&&o.log(i+" Computed session changes after {duration}"),m=await this.findPageViewChanges(r,m),null!=o&&o.log(i+" Computed page view changes after {duration}"),await this.saveSessionChanges(r.timestamp,y),null!=o&&o.log(i+" Session changes committed to the database after {duration}"),await this.savePageViewChanges(r.timestamp,m),null!=o)&&o.log(i+" Page view changes committed to the database after {duration}"),null!=(y=this.logger)&&y.log(i+" Done")}),this.config=e,this.sessionsRepo=t.sessionsRepo,this.pageViewsRepo=t.pageViewsRepo,this.updateSessions=this.updateSessions.bind(this),void 0===e.logger?this.logger=console:this.logger=e.logger;var[t,e]=ha();this.startupPromise=t,this.allowSessionUpdates=e}setupTriggers(){var t,e;this.referrers=new ir(this.logger),null!=(e=(t=this.config).setupCustomTriggers)&&e.call(t,{triggerSessionChangeCheck:this.basicTrigger.bind(this),setHasRecentUserActivity:this.setHasRecentUserActivity.bind(this)}),this.setupExtensionApiTriggers(),this.setupIdleTriggers(),this.setupStartupTriggers()}addSessionUpdatedListener(t){this.sessionUpdatedListeners.push(t)}addPageViewUpdatedListener(t){this.pageViewUpdatedListeners.push(t)}addCheckSessionsListener(t){this.checkSessionsListeners.push(t)}setupExtensionApiTriggers(){j.webNavigation.onCompleted.addListener(async t=>{0<t.frameId||await this.basicTrigger("webNavigation.onCompleted",Math.floor(t.timeStamp))}),j.tabs.onCreated.addListener(()=>this.basicTrigger("tabs.onCreated")),j.tabs.onUpdated.addListener(()=>this.basicTrigger("tabs.onUpdated")),j.tabs.onActivated.addListener(()=>this.basicTrigger("tabs.onActivated")),j.tabs.onRemoved.addListener(()=>this.basicTrigger("tabs.onRemoved")),j.windows.onCreated.addListener(()=>this.basicTrigger("windows.onCreated")),j.windows.onFocusChanged.addListener(()=>this.basicTrigger("windows.onFocusChanged")),j.windows.onRemoved.addListener(()=>this.basicTrigger("windows.onRemoved")),this.onWindowStateChanged(t=>this.basicTrigger("SessionMonitor.onWindowStateChanged",t))}setupIdleTriggers(){}setupStartupTriggers(){const t=Date.now();this.config.isOnStartupAvailable()?(j.runtime.onStartup.addListener(()=>{this.wakeUpTimeoutDisabled=!0,this.startupFlow({cleanupSessions:!0,trigger:"runtime.onStartup",timestamp:t})}),setTimeout(()=>{this.wakeUpTimeoutDisabled||this.startupFlow({cleanupSessions:!1,trigger:"setTimeout",timestamp:t})},Ve.ALWAYS_STARTUP_AFTER_MS)):(j.alarms.clear("ping-last-alive-at"),j.alarms.create("ping-last-alive-at",{delayInMinutes:Ve.LAST_ALIVE_AT_INTERVAL_MS/1e3,periodInMinutes:Ve.LAST_ALIVE_AT_INTERVAL_MS/1e3}),j.alarms.onAlarm.addListener(s=>{if("ping-last-alive-at"===s.name)return this.pingLastAliveAt()}),this.getLastAliveAt().then(s=>{this.wakeUpTimeoutDisabled=!0;s=null!=s&&Date.now()-s>2*Ve.LAST_ALIVE_AT_INTERVAL_MS;this.startupFlow({cleanupSessions:s,trigger:s?"time since last alive at > 2 * lastAliveInterval":"time since last alive at <= 2 * lastAliveInterval",timestamp:t})})),j.runtime.onInstalled.addListener(s=>{this.wakeUpTimeoutDisabled=!0,this.startupFlow({cleanupSessions:"install"!==s.reason,trigger:"runtime.onInstalled",timestamp:t})});var e=j.runtime["onSuspend"];null!=e&&e.addListener(()=>this.endAllActiveSessions(Date.now()))}basicTrigger(t,e=Date.now()){var n,s=this.latestTriggerId++;return null!=(n=this.logger)&&n.log(`[update-sessions] [${s}] Queued by ${t} @ `+new Date(e).toLocaleTimeString()),this.updateSessions({timestamp:e,triggerId:s,triggeredBy:t})}onWindowStateChanged(t){let e={};this.getWindowStates().then(s=>{e=s}),setInterval(async()=>{var s=Date.now(),n=await this.getWindowStates();Ha(e,n)||(t(s),e=n)},Ve.WINDOW_STATE_POLLING_INTERVAL_MS)}async getWindowStates(){return(await j.windows.getAll()).reduce((e,s)=>(null!=s.id&&(e[s.id]=s.state),e),{})}async startupFlow({cleanupSessions:t,trigger:e,timestamp:s}){t&&await this.cleanupActiveSessionsOnStartup(s),await this.pingLastAliveAt(),await ca().then(()=>this.allowSessionUpdates()),await this.basicTrigger(e,s)}async cleanupActiveSessionsOnStartup(t){var a,e=await this.getLastAliveAt();if(null!=(r=this.logger)&&r.debug("[on-startup] onStartup()",{lastActivity:e&&new Date(e).toISOString(),now:new Date(t).toISOString()}),null==e)throw Error("lastActivity was not set yet");null!=(r=this.logger)&&r.log("[on-startup] Ending sessions after quit...");var r=e+Ve.LAST_ALIVE_AT_POLL_INTERVAL_MS,n=Math.min(t,r);null!=(a=this.logger)&&a.log("[on-startup] Timing details:",{lastActivity:new Date(e).toISOString(),now:new Date(t).toISOString(),quitAt:new Date(r).toISOString(),endAt:new Date(n).toISOString()}),await this.endAllActiveSessions(n),null!=(a=this.logger)&&a.log("[on-startup] Startup finished!")}async getComputeDependencies(){var[t,e]=await Promise.all([j.windows.getAll(),j.tabs.query({})]),s=await this.sessionsRepo.getActiveSessions(),n=await this.pageViewsRepo.getActivePageViews();return{isTabActiveWhenPlayingAudio:await this.config.isTabActiveWhenPlayingAudio(),hostnameToTabsMap:e.reduce((r,i)=>{var o=null==(o=nr(i.url))?void 0:o.hostname;return o&&(null==r[o]&&(r[o]=[]),null!=(o=r[o])&&o.push(i)),r},{}),allActiveSessions:s,allActivePageViews:n,appIdToActiveSessionMap:la(null!=s?s:[],"appId"),windowIdToWindowMap:ua(t,"id"),processedActiveSessionCache:new ar,processedActivePageViewCache:new ar}}findSessionChanges(t,e){var i,a,d,l;const s=[],n=[];for([d,l]of Object.entries(e.hostnameToTabsMap))if(d)try{if(null==l||!l.length)throw Error("This shouldn't be possible");var h=e.appIdToActiveSessionMap[d],m=!(null==h||!h.length),y=!!l.find(E=>this.isTabActive(E,e));!m&&y?s.push({appId:d,startedAt:t.timestamp}):m&&!y&&n.push(...h),m&&e.processedActiveSessionCache.markAsProcessed(h)}catch(h){null!=(i=this.logger)&&i.error(`[update-sessions] Failed find sessions to change for ${d}:`,h)}return(null!=(a=null==(a=e.allActiveSessions)?void 0:a.filter(d=>!e.processedActiveSessionCache.isProcessed(d)))?a:[]).forEach(d=>n.push(d)),{toStart:s,toEnd:n,count:s.length+n.length}}async findPageViewChanges(t,e){var s=Object.values(e.hostnameToTabsMap).flat().filter(a=>!!a&&this.isTabActive(a,e)),n=[],r=[...e.allActivePageViews];for(const a of s){const o=nr(a.url);if(null!=o){var d=e.allActivePageViews.filter(l=>l.appId===(null==o?void 0:o.hostname)&&l.path===o.path);if(0<d.length)for(const l of d){var h=r.findIndex(m=>m.id===l.id);0<=h&&r.splice(h,1)}else n.push({appId:o.hostname,path:o.path,startedAt:t.timestamp,referrer:await(null==(d=this.referrers)?void 0:d.getReferrerFor(a.id,a.url))})}}return{toStart:n,toEnd:r,count:n.length+r.length}}async saveSessionChanges(t,e){var s=e.toEnd.map(a=>{var d,o=new Date(t).toLocaleTimeString();return null!=(d=this.logger)&&d.log(`[change-session] Stop session ${a.appId} @ ${o} (${t-a.startedAt}ms)`),this.sessionsRepo.endSession(a,t)}),n=e.toStart.map(a=>{var o;return null!=(o=this.logger)&&o.log(`[change-session] Start session ${a.appId} @ `+new Date(a.startedAt).toLocaleTimeString(),{session:a}),this.sessionsRepo.startSession(a)}),s=await Promise.allSettled(s),n=await Promise.allSettled(n);this.logSettledErrors("sessions","ending",s),this.logSettledErrors("sessions","starting",n),0<e.count&&this.invokeSessionUpdatedListeners()}async savePageViewChanges(t,e){var s=e.toEnd.map(a=>{var d,o=new Date(t).toLocaleTimeString();return null!=(d=this.logger)&&d.log(`[change-session] Stop page view ${a.appId}${a.path} @ ${o} (${t-a.startedAt}ms)`),this.pageViewsRepo.endPageView(a,t)}),n=e.toStart.map(a=>{var o;return null!=(o=this.logger)&&o.log(`[change-session] Start page view ${a.appId}${a.path} @ `+new Date(a.startedAt).toLocaleTimeString(),{session:a}),this.pageViewsRepo.startPageView(a)}),s=await Promise.allSettled(s),n=await Promise.allSettled(n);this.logSettledErrors("page views","ending",s),this.logSettledErrors("page views","starting",n),0<e.count&&this.invokePageViewUpdatedListeners()}logSettledErrors(t,e,s){var r,n=s.map(i=>{if("rejected"===i.status)return i.reason}).filter(i=>null!=i);0<n.length&&null!=(r=this.logger)&&r.warn(`[update-sessions] ${n.length}/${s.length} transactions failed when ${e} `+t,n)}isTabActive(t,e){var n;return null==t.windowId?(null!=(n=this.logger)&&n.warn("[update-sessions] Checking if tab without a windowId is active"),!1):!!(n=e.windowIdToWindowMap[t.windowId])&&pa(t,n,this.hasRecentUserActivity,e.isTabActiveWhenPlayingAudio)}async endAllActiveSessions(t){var s,e=await this.sessionsRepo.getActiveSessions();0===e.length?null!=(s=this.logger)&&s.log("[stop-active-sessions] No active sessions to stop"):(null!=(s=this.logger)&&s.log("[stop-active-sessions] Stopping all active sessions:",{activeSessions:e,timestamp:t}),await this.saveSessionChanges(t,{toStart:[],toEnd:e,count:e.length}),null!=(s=this.logger)&&s.log("[stop-active-sessions] All active sessions stopped!"))}async pingLastAliveAt(){var e,t=Date.now();null!=(e=this.logger)&&e.debug("[SessionMonitor] Updating last time browser was known to be open",t),await Ft(Ve.LAST_ALIVE_AT_KEY,t),clearTimeout(this.lastAlivePing),this.lastAlivePing=setTimeout(()=>this.pingLastAliveAt(),Ve.LAST_ALIVE_AT_POLL_INTERVAL_MS)}getLastAliveAt(){return Ys(Ve.LAST_ALIVE_AT_KEY)}invokeCheckSessionsListeners(){this.checkSessionsListeners.forEach(t=>t())}invokeSessionUpdatedListeners(){this.sessionUpdatedListeners.forEach(t=>t())}invokePageViewUpdatedListeners(){this.pageViewUpdatedListeners.forEach(t=>t())}setHasRecentUserActivity(t){this.hasRecentUserActivity=t}};let ot=Ve;ot.LAST_ALIVE_AT_KEY="last-activity-time-ms",ot.LAST_ALIVE_AT_INTERVAL_MS=6e4,ot.LAST_ALIVE_AT_POLL_INTERVAL_MS=3e4,ot.ALWAYS_STARTUP_AFTER_MS=5e3,ot.WINDOW_STATE_POLLING_INTERVAL_MS=5e3;var or=1/0,cr=9007199254740991,Ka=17976931348623157e292,dr=NaN,Ya="[object Function]",Ja="[object GeneratorFunction]",Qa="[object Symbol]",eo=/^\s+|\s+$/g,to=/^[-+]0x[0-9a-f]+$/i,so=/^0b[01]+$/i,no=/^0o[0-7]+$/i,ro=/^(?:0|[1-9]\d*)$/,io=parseInt,lr=Object.prototype.toString,oo=Math.ceil,co=Math.max;function ho(t,e,s){var n;if(ws(s))return("number"==(n=typeof e)?function(t){return null!=t&&function(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=cr}(t.length)&&!function(t){t=ws(t)?lr.call(t):"";return t==Ya||t==Ja}(t)}(s)&&function(t,e){return(e=null==e?cr:e)&&("number"==typeof t||ro.test(t))&&-1<t&&t%1==0&&t<e}(e,s.length):"string"==n&&e in s)&&function(t,e){return t===e||t!=t&&e!=e}(s[e],t)}function ws(t){var e=typeof t;return t&&("object"==e||"function"==e)}var xo=function(t,e,s){e=(s?ho(t,e,s):void 0===e)?1:co(function(t){var t=function(t){return t?(t=function(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return t&&"object"==typeof t}(t)&&lr.call(t)==Qa}(t))return dr;ws(t)&&(t=ws(e="function"==typeof t.valueOf?t.valueOf():t)?e+"":e);if("string"!=typeof t)return 0===t?t:+t;t=t.replace(eo,"");var e=so.test(t);return e||no.test(t)?io(t.slice(2),e?2:8):to.test(t)?dr:+t}(t))!==or&&t!==-or?t==t?t:0:(t<0?-1:1)*Ka:0===t?t:0}(t),s=t%1;return t==t?s?t-s:t:0}(e),0);var n=t?t.length:0;if(!n||e<1)return[];for(var r=0,i=0,a=Array(oo(n/e));r<n;)a[i++]=function(t,e,s){var n=-1,r=t.length;(s=r<s?r:s)<0&&(s+=r),r=s<(e=e<0?r<-e?0:r+e:e)?0:s-e>>>0,e>>>=0;for(var i=Array(r);++n<r;)i[n]=t[n+e];return i}(t,r,r+=e);return a};const To=100;function So(t){const e=void 0===t.logger?console:t.logger;async function n(i,a){var d,l;let o;try{null!=e&&e.log(`[${i.label}-uploader] Beginning upload @ `+new Date(a).toISOString());var[h,m,y]=await Promise.all([i.getLastUploadedAt(),t.db,t.enabled()]);if(y){var E=await i.getModelsToUpload({db:m,lastUploadedAt:h,uploadStartedAt:a}),U=null!=(l=await(null==(d=t.getUploadBatchSize)?void 0:d.call(t)))?l:To,A=xo(E,U),V=await async function(){var[d,a,o]=await Promise.all([t.getAppId(),t.getInstallId(),null==(d=t.getBirthYear)?void 0:d.call(t)]);return{appId:d,installId:a,birthYear:o}}();o={models:E,batches:A,body:V},null!=e&&e.debug(`[${i.label}-uploader] Data`,o);for(const $ of A){null!=e&&e.debug(`[${i.label}-uploader] Uploading`,{batch:$,requestSkipped:!!t.dev}),t.dev||await i.upload(V,$);var me=$[$.length-1];null!=(null==me?void 0:me.endedAt)&&await i.setLastUploadedAt(me.endedAt)}await i.setLastUploadedAt(a);var D=(Date.now()-a)/1e3;null!=e&&e.log(`[${i.label}-uploader] Uploaded ${E.length} items in ${A.length} batches in ${D}s`),i.onSuccess({total:E.length,batches:A.length,batchSize:U,durationInSec:D})}else null!=e&&e.log(`[${i.label}-uploader] Uploads are disabled`)}catch(h){null!=e&&e.error(`[${i.label}-uploader] Failed to upload`,h,o),i.onFailure(h)}}return{uploadAll:async function(){const i=Date.now();await Promise.allSettled(t.uploaders.map(a=>n(a,i)))}}}$i=ur;function ur(t,e,s){var n=fr(t=t instanceof RegExp?hr(t,s):t,e=e instanceof RegExp?hr(e,s):e,s);return n&&{start:n[0],end:n[1],pre:s.slice(0,n[0]),body:s.slice(n[0]+t.length,n[1]),post:s.slice(n[1]+e.length)}}function hr(t,e){e=e.match(t);return e?e[0]:null}function fr(t,e,s){var n,r,i,a,o,d=s.indexOf(t),l=s.indexOf(e,d+1),h=d;if(0<=d&&0<l){if(t===e)return[d,l];for(n=[],i=s.length;0<=h&&!o;)h==d?(n.push(h),d=s.indexOf(t,h+1)):1==n.length?o=[n.pop(),l]:((r=n.pop())<i&&(i=r,a=l),l=s.indexOf(e,h+1)),h=d<l&&0<=d?d:l;n.length&&(o=[i,a])}return o}ur.range=fr;var pr=$i,No=function(t){return t?function Ht(t,e){var s=[],n=pr("{","}",t);if(!n)return[t];var r=n.pre,i=n.post.length?Ht(n.post,!1):[""];if(/\$$/.test(n.pre))for(var a=0;a<i.length;a++){var o=r+"{"+n.body+"}"+i[a];s.push(o)}else{var y,E,d=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(n.body),l=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(n.body),h=d||l,d=0<=n.body.indexOf(",");if(!h&&!d)return n.post.match(/,.*\}/)?(t=n.pre+"{"+n.body+dn+n.post,Ht(t)):[t];if(h)y=n.body.split(/\.\./);else if(1===(y=Ar(n.body)).length&&1===(y=Ht(y[0],!1).map(Mo)).length)return i.map(function(M){return n.pre+y[0]+M});if(h){var d=ln(y[0]),A=ln(y[1]),V=Math.max(y[0].length,y[1].length),D=3==y.length?Math.abs(ln(y[2])):1,$=Lo,t=A<d,Kt=(t&&(D*=-1,$=Do),y.some(Co));E=[];for(var ae,ze,Re=d;$(Re,A);Re+=D)l?"\\"===(ae=String.fromCharCode(Re))&&(ae=""):(ae=String(Re),Kt&&0<(ze=V-ae.length)&&(ze=new Array(1+ze).join("0"),ae=Re<0?"-"+ze+ae.slice(1):ze+ae)),E.push(ae)}else{E=[];for(var b=0;b<y.length;b++)E.push.apply(E,Ht(y[b],!1))}for(b=0;b<E.length;b++)for(a=0;a<i.length;a++){o=r+E[b]+i[a];e&&!h&&!o||s.push(o)}}return s}(function(t){return t.split("\\\\").join(gr).split("\\{").join(mr).split("\\}").join(dn).split("\\,").join(yr).split("\\.").join(_r)}(t="{}"===t.substr(0,2)?"\\{\\}"+t.substr(2):t),!0).map(Oo):[]},gr="\0SLASH"+Math.random()+"\0",mr="\0OPEN"+Math.random()+"\0",dn="\0CLOSE"+Math.random()+"\0",yr="\0COMMA"+Math.random()+"\0",_r="\0PERIOD"+Math.random()+"\0";function ln(t){return parseInt(t,10)==t?parseInt(t,10):t.charCodeAt(0)}function Oo(t){return t.split(gr).join("\\").split(mr).join("{").split(dn).join("}").split(yr).join(",").split(_r).join(".")}function Ar(t){var e,s,n,r;return t?(e=[],(s=pr("{","}",t))?(n=s.pre,r=s.body,s=s.post,(n=n.split(","))[n.length-1]+="{"+r+"}",r=Ar(s),s.length&&(n[n.length-1]+=r.shift(),n.push.apply(n,r)),e.push.apply(e,n),e):t.split(",")):[""]}function Mo(t){return"{"+t+"}"}function Co(t){return/^-?0\d/.test(t)}function Lo(t,e){return t<=e}function Do(t,e){return e<=t}const Po=65536,bs=t=>{if("string"!=typeof t)throw new TypeError("invalid pattern");if(t.length>Po)throw new TypeError("pattern is too long")},Vo={"[:alnum:]":["\\p{L}\\p{Nl}\\p{Nd}",!0],"[:alpha:]":["\\p{L}\\p{Nl}",!0],"[:ascii:]":["\\x00-\\x7f",!1],"[:blank:]":["\\p{Zs}\\t",!0],"[:cntrl:]":["\\p{Cc}",!0],"[:digit:]":["\\p{Nd}",!0],"[:graph:]":["\\p{Z}\\p{C}",!0,!0],"[:lower:]":["\\p{Ll}",!0],"[:print:]":["\\p{C}",!0],"[:punct:]":["\\p{P}",!0],"[:space:]":["\\p{Z}\\t\\r\\n\\v\\f",!0],"[:upper:]":["\\p{Lu}",!0],"[:word:]":["\\p{L}\\p{Nl}\\p{Nd}\\p{Pc}",!0],"[:xdigit:]":["A-Fa-f0-9",!1]},qt=t=>t.replace(/[[\]\\-]/g,"\\$&"),jo=t=>t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),vr=t=>t.join(""),Gt=(t,{windowsPathsNoEscape:e=!1}={})=>e?t.replace(/\[([^\/\\])\]/g,"$1"):t.replace(/((?!\\).|^)\[([^\/\\])\]/g,"$1$2").replace(/\\([^\/])/g,"$1"),Uo=new Set(["!","?","+","*","@"]),wr=t=>Uo.has(t),un="(?!\\.)",Bo=new Set(["[","."]),Wo=new Set(["..","."]),zo=new Set("().*{}+?[]^$\\!"),hn="[^/]",ge=(hn,hn,class{constructor(e,s,n={}){pe(this,Ts),te(this,"type"),pe(this,ee,void 0),pe(this,ne,void 0),pe(this,We,!1),pe(this,z,[]),pe(this,J,void 0),pe(this,Ke,void 0),pe(this,ct,void 0),pe(this,Ye,!1),pe(this,Te,void 0),pe(this,dt,void 0),pe(this,Xt,!1),(this.type=e)&&Y(this,ne,!0),Y(this,J,s),Y(this,ee,g(this,J)?g(g(this,J),ee):this),Y(this,Te,g(this,ee)===this?n:g(g(this,ee),Te)),Y(this,ct,g(this,ee)===this?[]:g(g(this,ee),ct)),"!"!==e||g(g(this,ee),Ye)||g(this,ct).push(this),Y(this,Ke,g(this,J)?g(g(this,J),z).length:0)}get hasMagic(){if(void 0===g(this,ne))for(const e of g(this,z))if("string"!=typeof e&&(e.type||e.hasMagic))return Y(this,ne,!0);return g(this,ne)}toString(){return void 0!==g(this,dt)?g(this,dt):this.type?Y(this,dt,this.type+"("+g(this,z).map(e=>String(e)).join("|")+")"):Y(this,dt,g(this,z).map(e=>String(e)).join(""))}push(...e){for(const s of e)if(""!==s){if("string"!=typeof s&&!(s instanceof ge&&g(s,J)===this))throw new Error("invalid part: "+s);g(this,z).push(s)}}toJSON(){var s,e=null===this.type?g(this,z).slice().map(n=>"string"==typeof n?n:n.toJSON()):[this.type,...g(this,z).map(n=>n.toJSON())];return this.isStart()&&!this.type&&e.unshift([]),this.isEnd()&&(this===g(this,ee)||g(g(this,ee),Ye)&&"!"===(null==(s=g(this,J))?void 0:s.type))&&e.push({}),e}isStart(){var s;if(g(this,ee)!==this){if(null==(s=g(this,J))||!s.isStart())return!1;if(0!==g(this,Ke)){var e=g(this,J);for(let n=0;n<g(this,Ke);n++){var r=g(e,z)[n];if(!(r instanceof ge&&"!"===r.type))return!1}}}return!0}isEnd(){var s;return g(this,ee)===this||"!"===(null==(s=g(this,J))?void 0:s.type)||!(null==(s=g(this,J))||!s.isEnd())&&(this.type?(s=g(this,J)?g(g(this,J),z).length:0,g(this,Ke)===s-1):null==(s=g(this,J))?void 0:s.isEnd())}copyIn(e){"string"==typeof e?this.push(e):this.push(e.clone(this))}clone(e){var s=new ge(this.type,e);for(const n of g(this,z))s.copyIn(n);return s}static fromGlob(e,s={}){var r,n=new ge(null,void 0,s);return Et(r=ge,Tt,Ls).call(r,e,n,0,s),n}toMMPattern(){var e,s,n,i,r;return this!==g(this,ee)?g(this,ee).toMMPattern():(e=this.toString(),[s,n,r,i]=this.toRegExpSource(),r||g(this,ne)||g(this,Te).nocase&&!g(this,Te).nocaseMagicOnly&&e.toUpperCase()!==e.toLowerCase()?(r=(g(this,Te).nocase?"i":"")+(i?"u":""),Object.assign(new RegExp(`^${s}$`,r),{_src:s,_glob:e})):n)}toRegExpSource(){if(g(this,ee)===this&&Et(this,Ts,ei).call(this),!this.type){const i=this.isStart()&&this.isEnd(),a=g(this,z).map(h=>{var[A,,h,U]="string"==typeof h?Et(A=ge,Ss,ti).call(A,h,g(this,ne),i):h.toRegExpSource();return Y(this,ne,g(this,ne)||h),Y(this,We,g(this,We)||U),A}).join("");let o="";!this.isStart()||"string"!=typeof g(this,z)[0]||1===g(this,z).length&&Wo.has(g(this,z)[0])||(m=Bo,y=g(this,Te).dot&&m.has(a.charAt(0))||a.startsWith("\\.")&&m.has(a.charAt(2))||a.startsWith("\\.\\.")&&m.has(a.charAt(4)),m=!g(this,Te).dot&&m.has(a.charAt(0)),o=y?"(?!\\.\\.?(?:$|/))":m?un:"");let d="";return this.isEnd()&&g(g(this,ee),Ye)&&"!"===(null==(y=g(this,J))?void 0:y.type)&&(d="(?:$|\\/)"),[o+a+d,Gt(a),Y(this,ne,!!g(this,ne)),g(this,We)]}var i,m="!"===this.type?"(?:(?!(?:":"(?:",y=g(this,z).map(i=>{if("string"==typeof i)throw new Error("string type in extglob ast??");var[i,,,l]=i.toRegExpSource();return Y(this,We,g(this,We)||l),i}).filter(i=>!(this.isStart()&&this.isEnd()&&!i)).join("|");if(this.isStart()&&this.isEnd()&&!y&&"!"!==this.type)return i=this.toString(),Y(this,z,[i]),this.type=null,Y(this,ne,void 0),[i,Gt(this.toString()),!1,!1];let n="";if("!"===this.type&&g(this,Xt))n=(this.isStart()&&!g(this,Te).dot?un:"")+"[^/]+?";else{const i="!"===this.type?"))"+(this.isStart()&&!g(this,Te).dot?un:"")+"[^/]*?)":"@"===this.type?")":")"+this.type;n=m+y+i}return[n,Gt(y),Y(this,ne,!!g(this,ne)),g(this,We)]}});let xt=ge;ee=new WeakMap,ne=new WeakMap,We=new WeakMap,z=new WeakMap,J=new WeakMap,Ke=new WeakMap,ct=new WeakMap,Ye=new WeakMap,Te=new WeakMap,dt=new WeakMap,Xt=new WeakMap,Ts=new WeakSet,ei=function(){if(this!==g(this,ee))throw new Error("should only call on root");var e;if(!g(this,Ye))for(this.toString(),Y(this,Ye,!0);e=g(this,ct).pop();)if("!"===e.type){let s=e,n=g(s,J);for(;n;){for(let r=g(s,Ke)+1;!n.type&&r<g(n,z).length;r++)for(const i of g(e,z)){if("string"==typeof i)throw new Error("string part in extglob AST??");i.copyIn(g(n,z)[r])}s=n,n=g(s,J)}}return this},Tt=new WeakSet,Ls=function(e,s,n,r){var E,U;let i=!1,a=!1,o=-1,d=!1;if(null===s.type){let A=n,V="";for(;A<e.length;){var $,D=e.charAt(A++);i||"\\"===D?(i=!i,V+=D):a?(A===o+1?"^"!==D&&"!"!==D||(d=!0):"]"!==D||A===o+2&&d||(a=!1),V+=D):"["===D?(a=!0,o=A,d=!1,V+=D):!r.noext&&wr(D)&&"("===e.charAt(A)?(s.push(V),V="",$=new ge(D,s),A=Et(E=ge,Tt,Ls).call(E,e,$,A,r),s.push($)):V+=D}return s.push(V),A}let l=n+1,h=new ge(null,s);var m=[];let y="";for(;l<e.length;){var A=e.charAt(l++);if(i||"\\"===A)i=!i,y+=A;else if(a)l===o+1?"^"!==A&&"!"!==A||(d=!0):"]"!==A||l===o+2&&d||(a=!1),y+=A;else if("["===A)a=!0,o=l,d=!1,y+=A;else if(wr(A)&&"("===e.charAt(l)){h.push(y),y="";var V=new ge(A,h);h.push(V),l=Et(U=ge,Tt,Ls).call(U,e,V,l,r)}else if("|"===A)h.push(y),y="",m.push(h),h=new ge(null,s);else{if(")"===A)return""===y&&0===g(s,z).length&&Y(s,Xt,!0),h.push(y),y="",s.push(...m,h),l;y+=A}}return s.type=null,Y(s,ne,void 0),Y(s,z,[e.substring(n-1)]),l},Ss=new WeakSet,ti=function(e,s,n=!1){let r=!1,i="",a=!1;for(let o=0;o<e.length;o++){var d=e.charAt(o);if(r)r=!1,i+=(zo.has(d)?"\\":"")+d;else if("\\"===d)o===e.length-1?i+="\\\\":r=!0;else{if("["===d){var[l,h,m,y]=((t,e)=>{var s=e;if("["!==t.charAt(s))throw new Error("not in a brace expression");var n=[],r=[];let i=s+1,a=!1,o=!1,d=!1,l=!1,h=s,m="";e:for(;i<t.length;){var A=t.charAt(i);if("!"!==A&&"^"!==A||i!==s+1){if("]"===A&&a&&!d){h=i+1;break}if(a=!0,"\\"!==A||d){if("["===A&&!d)for(var[V,[D,$,me]]of Object.entries(Vo))if(t.startsWith(V,i)){if(m)return["$.",!1,t.length-s,!0];i+=V.length,(me?r:n).push(D),o=o||$;continue e}d=!1,m?(A>m?n.push(qt(m)+"-"+qt(A)):A===m&&n.push(qt(A)),m="",i++):t.startsWith("-]",i+1)?(n.push(qt(A+"-")),i+=2):t.startsWith("-",i+1)?(m=A,i+=2):(n.push(qt(A)),i++)}else d=!0,i++}else l=!0,i++}if(h<i)return["",!1,0,!1];if(!n.length&&!r.length)return["$.",!1,t.length-s,!0];if(0===r.length&&1===n.length&&/^\\?.$/.test(n[0])&&!l){const A=2===n[0].length?n[0].slice(-1):n[0];return[jo(A),!1,h-s,!1]}var e="["+(l?"^":"")+vr(n)+"]",E="["+(l?"":"^")+vr(r)+"]";return[n.length&&r.length?"("+e+"|"+E+")":n.length?e:E,o,h-s,!0]})(e,o);if(m){i+=l,a=a||h,o+=m-1,s=s||y;continue}}"*"===d?(i+=n&&"*"===e?"[^/]+?":"[^/]*?",s=!0):"?"===d?(i+=hn,s=!0):i+=d.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}}return[i,Gt(e),!!s,a]},pe(xt,Tt),pe(xt,Ss);const le=(t,e,s={})=>(bs(e),!(!s.nocomment&&"#"===e.charAt(0))&&new xs(e,s).match(t)),qo=/^\*+([^+@!?\*\[\(]*)$/,Go=t=>e=>!e.startsWith(".")&&e.endsWith(t),Xo=t=>e=>e.endsWith(t),Ko=t=>(t=t.toLowerCase(),e=>!e.startsWith(".")&&e.toLowerCase().endsWith(t)),Yo=t=>(t=t.toLowerCase(),e=>e.toLowerCase().endsWith(t)),Jo=/^\*+\.\*+$/,Qo=t=>!t.startsWith(".")&&t.includes("."),ec=t=>"."!==t&&".."!==t&&t.includes("."),tc=/^\.\*+$/,sc=t=>"."!==t&&".."!==t&&t.startsWith("."),nc=/^\*+$/,rc=t=>0!==t.length&&!t.startsWith("."),ic=t=>0!==t.length&&"."!==t&&".."!==t,ac=/^\?+([^+@!?\*\[\(]*)?$/,oc=([t,e=""])=>{const s=Tr([t]);return e?(e=e.toLowerCase(),n=>s(n)&&n.toLowerCase().endsWith(e)):s},cc=([t,e=""])=>{const s=Sr([t]);return e?(e=e.toLowerCase(),n=>s(n)&&n.toLowerCase().endsWith(e)):s},dc=([t,e=""])=>{const s=Sr([t]);return e?n=>s(n)&&n.endsWith(e):s},lc=([t,e=""])=>{const s=Tr([t]);return e?n=>s(n)&&n.endsWith(e):s},Tr=([t])=>{const e=t.length;return s=>s.length===e&&!s.startsWith(".")},Sr=([t])=>{const e=t.length;return s=>s.length===e&&"."!==s&&".."!==s},Er="object"==typeof process&&process?"object"==typeof process.env&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",Ir_win32={sep:"\\"},Ir_posix={sep:"/"},uc=("win32"===Er?Ir_win32:Ir_posix).sep,be=(le.sep=uc,Symbol("globstar **")),xe=(le.GLOBSTAR=be,le.filter=(t,e={})=>s=>le(s,t,e),(t,e={})=>Object.assign({},t,e)),Nr=(le.defaults=t=>{if(!t||"object"!=typeof t||!Object.keys(t).length)return le;const e=le;return Object.assign((n,r,i={})=>e(n,r,xe(t,i)),{Minimatch:class extends e.Minimatch{constructor(r,i={}){super(r,xe(t,i))}static defaults(r){return e.defaults(xe(t,r)).Minimatch}},AST:class extends e.AST{constructor(r,i,a={}){super(r,i,xe(t,a))}static fromGlob(r,i={}){return e.AST.fromGlob(r,xe(t,i))}},unescape:(n,r={})=>e.unescape(n,xe(t,r)),escape:(n,r={})=>e.escape(n,xe(t,r)),filter:(n,r={})=>e.filter(n,xe(t,r)),defaults:n=>e.defaults(xe(t,n)),makeRe:(n,r={})=>e.makeRe(n,xe(t,r)),braceExpand:(n,r={})=>e.braceExpand(n,xe(t,r)),match:(n,r,i={})=>e.match(n,r,xe(t,i)),sep:e.sep,GLOBSTAR:be})},(t,e={})=>(bs(t),e.nobrace||!/\{(?:(?!\{).)*\}/.test(t)?[t]:No(t)));le.braceExpand=Nr;le.makeRe=(t,e={})=>new xs(t,e).makeRe();le.match=(t,e,s={})=>{const n=new xs(e,s);return t=t.filter(r=>n.match(r)),n.options.nonull&&!t.length&&t.push(e),t};const kr=/[?*]|[+@!]\(.*?\)|\[|\]/,Ac=t=>t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");class xs{constructor(e,s={}){te(this,"options"),te(this,"set"),te(this,"pattern"),te(this,"windowsPathsNoEscape"),te(this,"nonegate"),te(this,"negate"),te(this,"comment"),te(this,"empty"),te(this,"preserveMultipleSlashes"),te(this,"partial"),te(this,"globSet"),te(this,"globParts"),te(this,"nocase"),te(this,"isWindows"),te(this,"platform"),te(this,"windowsNoMagicRoot"),te(this,"regexp"),bs(e),this.options=s=s||{},this.pattern=e,this.platform=s.platform||Er,this.isWindows="win32"===this.platform,this.windowsPathsNoEscape=!!s.windowsPathsNoEscape||!1===s.allowWindowsEscape,this.windowsPathsNoEscape&&(this.pattern=this.pattern.replace(/\\/g,"/")),this.preserveMultipleSlashes=!!s.preserveMultipleSlashes,this.regexp=null,this.negate=!1,this.nonegate=!!s.nonegate,this.comment=!1,this.empty=!1,this.partial=!!s.partial,this.nocase=!!this.options.nocase,this.windowsNoMagicRoot=void 0!==s.windowsNoMagicRoot?s.windowsNoMagicRoot:!(!this.isWindows||!this.nocase),this.globSet=[],this.globParts=[],this.set=[],this.make()}hasMagic(){if(this.options.magicalBraces&&1<this.set.length)return!0;for(const e of this.set)for(const s of e)if("string"!=typeof s)return!0;return!1}debug(){}make(){var e=this.pattern,s=this.options;if(s.nocomment||"#"!==e.charAt(0))if(e){this.parseNegate(),this.globSet=[...new Set(this.braceExpand())],s.debug&&(this.debug=(...i)=>console.error(...i)),this.debug(this.pattern,this.globSet);e=this.globSet.map(i=>this.slashSplit(i)),s=(this.globParts=this.preprocess(e),this.debug(this.pattern,this.globParts),this.globParts.map((i,a,o)=>{if(this.isWindows&&this.windowsNoMagicRoot){var d=!(""!==i[0]||""!==i[1]||"?"!==i[2]&&kr.test(i[2])||kr.test(i[3])),l=/^[a-z]:/i.test(i[0]);if(d)return[...i.slice(0,4),...i.slice(4).map(h=>this.parse(h))];if(l)return[i[0],...i.slice(1).map(h=>this.parse(h))]}return i.map(d=>this.parse(d))}));if(this.debug(this.pattern,s),this.set=s.filter(i=>-1===i.indexOf(!1)),this.isWindows)for(let i=0;i<this.set.length;i++){var a=this.set[i];""===a[0]&&""===a[1]&&"?"===this.globParts[i][2]&&"string"==typeof a[3]&&/^[a-z]:$/i.test(a[3])&&(a[2]="?")}this.debug(this.pattern,this.set)}else this.empty=!0;else this.comment=!0}preprocess(e){if(this.options.noglobstar)for(let n=0;n<e.length;n++)for(let r=0;r<e[n].length;r++)"**"===e[n][r]&&(e[n][r]="*");var{optimizationLevel:s=1}=this.options;return e=2<=s?(e=this.firstPhasePreProcess(e),this.secondPhasePreProcess(e)):1<=s?this.levelOneOptimize(e):this.adjascentGlobstarOptimize(e)}adjascentGlobstarOptimize(e){return e.map(s=>{let n=-1;for(;-1!==(n=s.indexOf("**",n+1));){let r=n;for(;"**"===s[r+1];)r++;r!==n&&s.splice(n,r-n)}return s})}levelOneOptimize(e){return e.map(s=>0===(s=s.reduce((n,r)=>{var i=n[n.length-1];return"**"===r&&"**"===i||(".."===r&&i&&".."!==i&&"."!==i&&"**"!==i?n.pop():n.push(r)),n},[])).length?[""]:s)}levelTwoFileOptimize(e){Array.isArray(e)||(e=this.slashSplit(e));let s=!1;do{if(s=!1,!this.preserveMultipleSlashes){for(let r=1;r<e.length-1;r++){var i=e[r];1===r&&""===i&&""===e[0]||"."!==i&&""!==i||(s=!0,e.splice(r,1),r--)}"."!==e[0]||2!==e.length||"."!==e[1]&&""!==e[1]||(s=!0,e.pop())}let n=0;for(;-1!==(n=e.indexOf("..",n+1));){var r=e[n-1];r&&"."!==r&&".."!==r&&"**"!==r&&(s=!0,e.splice(n-1,2),n-=2)}}while(s);return 0===e.length?[""]:e}firstPhasePreProcess(e){let s=!1;do{s=!1;for(var n of e){let r=-1;for(;-1!==(r=n.indexOf("**",r+1));){let a=r;for(;"**"===n[a+1];)a++;a>r&&n.splice(r+1,a-r);var o=n[r+1],d=n[r+2],l=n[r+3];".."===o&&d&&"."!==d&&".."!==d&&l&&"."!==l&&".."!==l&&(s=!0,n.splice(r,1),(o=n.slice(0))[r]="**",e.push(o),r--)}if(!this.preserveMultipleSlashes){for(let a=1;a<n.length-1;a++){const o=n[a];1===a&&""===o&&""===n[0]||"."!==o&&""!==o||(s=!0,n.splice(a,1),a--)}"."!==n[0]||2!==n.length||"."!==n[1]&&""!==n[1]||(s=!0,n.pop())}let i=0;for(;-1!==(i=n.indexOf("..",i+1));){var a=n[i-1];if(a&&"."!==a&&".."!==a&&"**"!==a){s=!0;const d=1===i&&"**"===n[i+1]?["."]:[];n.splice(i-1,2,...d),0===n.length&&n.push(""),i-=2}}}}while(s);return e}secondPhasePreProcess(e){for(let s=0;s<e.length-1;s++)for(let n=s+1;n<e.length;n++){var r=this.partsMatch(e[s],e[n],!this.preserveMultipleSlashes);r&&(e[s]=r,e[n]=[])}return e.filter(s=>s.length)}partsMatch(e,s,n=!1){let r=0,i=0,a=[],o="";for(;r<e.length&&i<s.length;)if(e[r]===s[i])a.push("b"===o?s[i]:e[r]),r++,i++;else if(n&&"**"===e[r]&&s[i]===e[r+1])a.push(e[r]),r++;else{if(n&&"**"===s[i]&&e[r]===s[i+1])a.push(s[i]);else{if("*"!==e[r]||!s[i]||!this.options.dot&&s[i].startsWith(".")||"**"===s[i]){if("*"!==s[i]||!e[r]||!this.options.dot&&e[r].startsWith(".")||"**"===e[r])return!1;if("a"===o)return!1;o="b",a.push(s[i])}else{if("b"===o)return!1;o="a",a.push(e[r])}r++}i++}return e.length===s.length&&a}parseNegate(){if(!this.nonegate){var e=this.pattern;let s=!1,n=0;for(let r=0;r<e.length&&"!"===e.charAt(r);r++)s=!s,n++;n&&(this.pattern=e.slice(n)),this.negate=s}}matchOne(e,s,n=!1){var r=this.options;if(this.isWindows){var A=""===e[0]&&""===e[1]&&"?"===e[2]&&"string"==typeof e[3]&&/^[a-z]:$/i.test(e[3]),V=""===s[0]&&""===s[1]&&"?"===s[2]&&"string"==typeof s[3]&&/^[a-z]:$/i.test(s[3]);if(A&&V){var D=e[3],$=s[3];D.toLowerCase()===$.toLowerCase()&&(e[3]=$)}else if(V&&"string"==typeof e[0]){const D=s[3],$=e[0];D.toLowerCase()===$.toLowerCase()&&(s[3]=$,s=s.slice(3))}else if(A&&"string"==typeof s[0]){const D=e[3];D.toLowerCase()===s[0].toLowerCase()&&(s[0]=D,e=e.slice(3))}}var{optimizationLevel:D=1}=this.options;2<=D&&(e=this.levelTwoFileOptimize(e)),this.debug("matchOne",this,{file:e,pattern:s}),this.debug("matchOne",e.length,s.length);for(var a=0,o=0,d=e.length,l=s.length;a<d&&o<l;a++,o++){this.debug("matchOne loop");var h=s[o],m=e[a];if(this.debug(s,h,m),!1===h)return!1;if(h===be){this.debug("GLOBSTAR",[s,h,m]);var y=a,E=o+1;if(E===l){for(this.debug("** at the end");a<d;a++)if("."===e[a]||".."===e[a]||!r.dot&&"."===e[a].charAt(0))return!1;return!0}for(;y<d;){var U=e[y];if(this.debug(`
globstar while`,e,y,s,E,U),this.matchOne(e.slice(y),s.slice(E),n))return this.debug("globstar found match!",y,d,U),!0;if("."===U||".."===U||!r.dot&&"."===U.charAt(0)){this.debug("dot detected!",e,y,s,E);break}this.debug("globstar swallow a segment, and continue"),y++}return!(!n||(this.debug(`
>>> no match, partial?`,e,y,s,E),y!==d))}let A;if("string"==typeof h?(A=m===h,this.debug("string match",h,m,A)):(A=h.test(m),this.debug("pattern match",h,m,A)),!A)return!1}if(a===d&&o===l)return!0;if(a===d)return n;if(o===l)return a===d-1&&""===e[a];throw new Error("wtf?")}braceExpand(){return Nr(this.pattern,this.options)}parse(e){bs(e);var s=this.options;if("**"===e)return be;if(""===e)return"";let n,r=null;e.match(nc)?r=s.dot?ic:rc:(n=e.match(qo))?r=(s.nocase?s.dot?Yo:Ko:s.dot?Xo:Go)(n[1]):(n=e.match(ac))?r=(s.nocase?s.dot?cc:oc:s.dot?dc:lc)(n):e.match(Jo)?r=s.dot?ec:Qo:e.match(tc)&&(r=sc);s=xt.fromGlob(e,this.options).toMMPattern();return r?Object.assign(s,{test:r}):s}makeRe(){if(!this.regexp&&!1!==this.regexp){var e=this.set;if(e.length){const s=this.options,n=s.noglobstar?"[^/]*?":s.dot?"(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?":"(?:(?!(?:\\/|^)\\.).)*?",r=new Set(s.nocase?["i"]:[]);let i=e.map(d=>{const l=d.map(h=>{if(h instanceof RegExp)for(const m of h.flags.split(""))r.add(m);return"string"==typeof h?Ac(h):h===be?be:h._src});return l.forEach((h,m)=>{var y=l[m+1],E=l[m-1];h===be&&E!==be&&(void 0===E?void 0!==y&&y!==be?l[m+1]="(?:\\/|"+n+"\\/)?"+y:l[m]=n:void 0===y?l[m-1]=E+"(?:\\/|"+n+")?":y!==be&&(l[m-1]=E+"(?:\\/|\\/"+n+"\\/)"+y,l[m+1]=be))}),l.filter(h=>h!==be).join("/")}).join("|");var[e,o]=1<e.length?["(?:",")"]:["",""];i="^"+e+i+o+"$",this.negate&&(i="^(?!"+i+").+$");try{this.regexp=new RegExp(i,[...r].join(""))}catch{this.regexp=!1}}else this.regexp=!1}return this.regexp}slashSplit(e){return this.preserveMultipleSlashes?e.split("/"):this.isWindows&&/^\/\/[^\/]+/.test(e)?["",...e.split(/\/+/)]:e.split(/\/+/)}match(e,s=this.partial){if(this.debug("match",e,this.pattern),this.comment)return!1;if(this.empty)return""===e;if("/"===e&&s)return!0;var n=this.options,r=(this.isWindows&&(e=e.split("\\").join("/")),this.slashSplit(e)),i=(this.debug(this.pattern,"split",r),this.set);this.debug(this.pattern,"set",i);let a=r[r.length-1];if(!a)for(let o=r.length-2;!a&&0<=o;o--)a=r[o];for(let o=0;o<i.length;o++){var d=i[o];let l=r;if(n.matchBase&&1===d.length&&(l=[a]),this.matchOne(l,d,s))return!!n.flipNegate||!this.negate}return!n.flipNegate&&this.negate}static defaults(e){return le.defaults(e).Minimatch}}return le.AST=xt,le.Minimatch=xs,le.escape=(t,{windowsPathsNoEscape:e=!1}={})=>e?t.replace(/[?*()[\]]/g,"[$&]"):t.replace(/[?*()[\]\\]/g,"\\$&"),le.unescape=Gt,k.Ad=Hs,k.DatabaseVersions=se,k.IdbAdsRepo=K,k.IdbPageViewsRepo=Pe,k.IdbSessionsRepo=q,k.OldUsageBackupJson=ga,k.PageView=Zn,k.PageViewEntity=Un,k.Session=Fs,k.SessionEntity=$n,k.SessionMonitor=ot,k.UsageBackupJson=Xn,k.defineWebUsageUploader=function(t){var e=function({api:t,onSuccess:e,onFailure:s,lastUploadedAtStorageKey:n}){return{label:"sessions",onSuccess:e,onFailure:s,async getLastUploadedAt(){var r=await Ys(n);return null!=r?r:1},setLastUploadedAt(r){return Ft(n,r)},async getModelsToUpload({db:r,lastUploadedAt:i,uploadStartedAt:a}){return(await r.sessionsRepo.findSessionsByEndedAt(i,a)).filter(d=>!d.imported)},async upload(r,i){i=i.reduce((o,d)=>{var h;if(null==d.endedAt)throw Error("Cannot upload a session that is in progress");var l={duration:ys(d.endedAt-d.startedAt),timestamp:ys(d.startedAt)};return 0<l.duration&&(null==o[h=d.appId]&&(o[h]={sessions:[]}),o[d.appId].sessions.push(l)),o},{});await t.uploadSessions({...r,websites:i})}}}({api:t.api,...t.sessions}),s=function({api:t,onSuccess:e,onFailure:s,lastUploadedAtStorageKey:n,getUploadAllowlist:r}){return{label:"page-views",onSuccess:e,onFailure:s,async getLastUploadedAt(){var a=(await j.storage.local.get(n))[n];return null!=a?a:1},setLastUploadedAt(i){return j.storage.local.set({[n]:i})},async getModelsToUpload({db:i,lastUploadedAt:a,uploadStartedAt:o}){const d=await i.pageViewsRepo.findPageViewsByEndedAt(a,o),l=null!=(i=await r())?i:[];return d.filter(m=>!m.imported&&!!l.find(y=>le(m.appId+m.path,y)))},async upload(i,a){a=a.reduce((d,l)=>{var m,U;if(null==l.endedAt)throw Error("Cannot upload a page view that is in progress");var h={duration:ys(l.endedAt-l.startedAt),timestamp:ys(l.startedAt),referrer:l.referrer};return 0<h.duration&&(null==d[m=l.appId]&&(d[m]={}),null==(m=d[l.appId])[U=l.path]&&(m[U]={page_views:[]}),d[l.appId][l.path].page_views.push(h)),d},{});await t.uploadPageViews({...i,websites:a})}}}({api:t.api,...t.pageViews});return So({...t,uploaders:[e,s]})},k.initUsageSdkInBackground=function(t){return(t=new ot(t.db,t)).setupTriggers(),{sessionMonitor:t}},k.openIdbUsageDatabase=function(t){const e=Wa(t),s=void 0===t.logger?console:t.logger;return{indexedDb:e,sessionsRepo:new q({db:e,...t}),pageViewsRepo:new Pe({db:e,...t}),adsRepo:new K({db:e,...t}),exportBackup:()=>async function(t){var s={version:(t=await t).version,stores:{}},n=qn(t),r=t.transaction(n,"readonly");for(const i of n){var o=await r.objectStore(i).getAll();o.forEach(d=>{delete d.imported}),s.stores[i]=o}return await r.done,s}(e),importBackup:n=>Aa({dbPromise:e,usageBackup:n,getInstallId:t.getInstallId,logger:s})}},Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),k}({});"function"==typeof define&&define.amd&&define(()=>webExtUsage);