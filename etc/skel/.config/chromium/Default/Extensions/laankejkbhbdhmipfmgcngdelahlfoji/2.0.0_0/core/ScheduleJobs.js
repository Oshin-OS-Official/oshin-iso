define(["core/vendor/web-ext-usage","core/vendor/st-panel-api","core/Time","core/AppConsts"],function(WebExtUsage,PanelAPI,Time,AppConst){let API;const JobId={UploadWebUsage:"@alarm/upload-web-usage"};return{initAPI(theAPI){(API=theAPI).mixin("ScheduleJobs",{init:this.init.bind(this)})},init(){API.Chrome.Alarms.addListener("onAlarm",async alarm=>{var funcName,payload,level;alarm.name===JobId.UploadWebUsage&&(funcName="Alarm fired",alarm=alarm.name,Logger.log("ScheduleJobs."+funcName,alarm,payload,level),await this.uploadWebUsageJob())}),API.Chrome.Alarms.ensure(JobId.UploadWebUsage,{periodInMinutes:Time.HOUR/Time.MINUTE})},async uploadWebUsageJob(){var usageDatabase=await API.WebUsage.getUsageDatabase(),api=PanelAPI.createPanelApiClient({ofetchDefaults:{baseURL:"https://stayfocusd.st-panel-api.com"}});await WebExtUsage.defineWebUsageUploader({db:usageDatabase,enabled:async()=>{var uploadEnabled=await API.RemoteConfig.get("uploadWebUsage"),hasAcceptedPrivacyPolicy=await API.Storage.getAsync("hasAcceptedPrivacyPolicy",!0);return uploadEnabled&&hasAcceptedPrivacyPolicy},getAppId:()=>AppConst.APP_ID,dev:!1,getInstallId:()=>API.Storage.getAsync(AppConst.INSTALL_ID_KEY),getBirthYear:()=>API.Settings.get("age")??void 0,logger:null,getUploadBatchSize:()=>API.RemoteConfig.get("usageUploadBatchSize"),api:api,sessions:{lastUploadedAtStorageKey:"@stayfocusd/sessions-last-uploaded-at-key",onFailure:()=>API.Analytics.event("WEB_USAGE_UPLOAD_FAILED"),onSuccess:details=>API.Analytics.event("WEB_USAGE_UPLOAD_COMPLETED",details)},pageViews:{lastUploadedAtStorageKey:"@stayfocusd/page-views-last-uploaded-at-key",onFailure:()=>API.Analytics.event("PAGE_VIEWS_UPLOAD_FAILED"),onSuccess:details=>API.Analytics.event("PAGE_VIEWS_UPLOAD_COMPLETED",details),getUploadAllowlist:()=>API.RemoteConfig.get("pageViewAllowlist")}}).uploadAll()}}});