define(["core/Logger","core/DomainParser","core/NuclearOption","core/Notification","core/ReferrerMonitor","core/Message","core/Time"],function(Logger,DomainParser,NuclearOption,Notification,ReferrerMonitor,Message,Time){var API,StayFocusd={CHROME_STORAGE_SYNC_RATE:15,maxTimeAllowed:10,firstInstallAllowance:60,elapsedTime:0,interval:1,timer:null,maxTimeAllowedExceeded:!1,apiURL:"https://www.stayfocusd.com",redirectURL:"https://www.stayfocusd.com",uninstallUrl:"https://www.stayfocusd.com/goodbye/",currentURL:null,version:null,selectedTabID:null,active:null,popupPort:null,lastChromeStorageSync:0,initAPI:function(theAPI){API=theAPI,window.API=API;var self=this;API.mixin("StayFocusd",{getActiveDays:this.getActiveDays.bind(this),getActiveHours:this.getActiveHours.bind(this),getActiveHoursQueue:this.getActiveHoursQueue.bind(this),getAPIURL:function(){return self.apiURL},getCurrentURL:function(){return self.currentURL},getMaxTimeAllowed:this.getMaxTimeAllowed.bind(this),getResetTime:this.getResetTime.bind(this),getResetTimeQueue:this.getResetTimeQueue.bind(this),getTotalSecondsRemaining:this.getTotalSecondsRemaining.bind(this),isActive:this.isActive.bind(this),isFirstInstallAllowanceActive:this.isFirstInstallAllowanceActive.bind(this),isMaxTimeAllowedExceeded:this.isMaxTimeAllowedExceeded.bind(this),isOutgoingLinksOptionActive:this.isOutgoingLinksOptionActive.bind(this),isUpdatePopupDisabled:this.isUpdatePopupDisabled.bind(this),localizeHTML:this.localizeHTML.bind(this),setActiveDays:this.setActiveDays.bind(this),setActiveHoursQueue:this.setActiveHoursQueue.bind(this),setMaxTimeAllowed:this.setMaxTimeAllowed.bind(this),setResetTimeQueue:this.setResetTimeQueue.bind(this)})},async init(){await this.initSettings(),await this.initRemoteConfig(),await this.initAnalytics(),await this.initRequirements(),await this.initIcon(),await this.initBlacklist(),await this.initWhitelist(),await this.initNuclearOption(),await this.initNotification(),await this.initListeners(),await this.initOnboarding(),await this.initUpdateCheck(),await this.initUninstallURL(),await this.initWebUsageCollect(),await this.initScheduleJobs(),this.getElapsedTime(elapsedTime=>{this.elapsedTime=elapsedTime}),this.maxTimeAllowed=this.getMaxTimeAllowed(),this.maxTimeAllowedExceeded=this.isMaxTimeAllowedExceeded()},async initSettings(){await API.Settings.initAsync(),API.Storage.setBucket(["backupKeys","disableUpdatePopup","isUpdated","previousVersion","outgoingLink","productivityBypass"],"HTML5"),API.Storage.addOnChangeListener((changes,areaName)=>{API.Settings.refresh(()=>{API.PubSub.publish("Settings.data.refreshed",{areaName:areaName,changes:changes})})}),this.isFirstInstall()&&this.setFirstInstallAllowance(),!0===this.isNewDay()&&this.resetElapsedTime()},async initRemoteConfig(){await API.RemoteConfig.init(),await API.Chrome.Alarms.ensure("remote-config",{periodInMinutes:30}),API.Chrome.Alarms.addListener("onAlarm",async alarm=>{"remote-config"===alarm.name&&await API.RemoteConfig.refresh()}),await API.RemoteConfig.refresh()},initAnalytics(){API.Analytics.init()},async initWebUsageCollect(){await API.WebUsage.init(),chrome.runtime.onConnect.addListener(port=>{"getUsageSummaryData"==port.name&&port.onMessage.addListener(async msg=>{var sessions,usageDatabase;"usage.getUsageSummaryData.request"==msg.message&&(sessions=await(usageDatabase=await API.WebUsage.getUsageDatabase()).sessionsRepo.findSessions(msg.startDate,msg.endDate),usageDatabase=await usageDatabase.adsRepo.findAds(msg.startDate,msg.endDate),port.postMessage({message:"usage.getUsageSummaryData.response",startDate:msg.startDate,endDate:msg.endDate,sessions:sessions,ads:usageDatabase}))})})},initScheduleJobs(){API.ScheduleJobs.init()},async initRequirements(){await API.Requirements.init()},async initIcon(){(await API.Component.loadAsync({name:"Icon",instance:"icon"})).controller.init()},async initBlacklist(){(await API.Component.loadAsync({name:"Blacklist",instance:"blacklist"})).controller.init()},async initWhitelist(){(await API.Component.loadAsync({name:"Whitelist",instance:"whitelist"})).controller.init()},async initNuclearOption(){await NuclearOption.initAsync()},async initNotification(){await Notification.initAsync()},initListeners(){API.PubSub.subscribe({async:!0,handler:(message,payload,callback)=>(callback=callback||(()=>!0),!payload||!payload.tabID||payload.sender&&payload.sender.tab||API.Chrome.Message.sendToTab(payload.tabID,{message:message.toString(),payload:payload},callback),!0)}),API.Chrome.Message.on.addListener((request,sender,callback)=>(request.payload=request.payload||{},request.payload.sender=sender||{},sender.tab&&API.PubSub.publish({message:request.message,payload:request.payload,onPublish:"function"==typeof callback?callback:()=>{}}),!0)),API.PubSub.listen("Settings.data.refreshed",(message,payload)=>{this.checkURL()}),API.PubSub.listen("ReferrerMonitor.outgoingLink.clicked",(message,payload)=>{API.Storage.set({outgoingLink:payload.outgoingLink})}),API.PubSub.listen("ActivityMonitor.component.initialized",(message,payload)=>{API.Chrome.Tab.getSelected(null,tab=>{API.PubSub.publish("StayFocusd.tab.selected",{tab:tab,tabID:tab.id,blockable:this.isBlockable(tab.url)})})}),API.PubSub.listen({message:"ActivityMonitor.overlay.hidden",async:!0,handler:(message,payload,callback)=>{var response={countdownStarted:this.startCountdown()};"function"==typeof callback&&callback(response)}}),API.PubSub.listen({message:"ActivityMonitor.overlay.shown",async:!0,handler:(message,payload,callback)=>{var response={countdownStopped:this.stopCountdown()};"function"==typeof callback&&callback(response)}}),API.PubSub.listen({message:"StayFocusd.referrer.get",async:!0,handler:(message,payload,callback)=>{var response={referrer:document.referrer};"function"==typeof callback&&callback(response)}}),API.Chrome.Extension.addListener("onConnect",port=>{"popup"===port.name&&this.onPopupConnected(port)}),API.Chrome.Tab.getSelected(null,tab=>{this.onTabStateChange(tab)}),API.Chrome.Tab.addListener("onSelectionChanged",(tabId,selectInfo)=>{API.Chrome.Tab.getSelected(null,tab=>{this.onTabStateChange(tab)})}),API.Chrome.Tab.addListener("onUpdated",(tabId,selectInfo)=>{API.Chrome.Tab.getSelected(null,tab=>{this.onTabStateChange(tab)})}),API.Chrome.Tab.addListener("onRemoved",(tabId,removeInfo)=>{API.Chrome.Tab.getSelected(null,tab=>{void 0===tab&&this.stopCountdown()})}),API.Chrome.Window.addListener("onRemoved",windowID=>{this.stopCountdown()}),API.Chrome.Window.addListener("onFocusChanged",(windowId,selectInfo)=>{API.Chrome.Tab.getSelected(null,tab=>{this.onTabStateChange(tab)}),API.Chrome.Window.getLastFocused(windowObj=>{void 0!==windowObj&&API.Chrome.Tab.getAllInWindow(windowObj.id,tabs=>{for(var wTab in tabs)tabs.hasOwnProperty(wTab)&&tabs[wTab].selected&&this.checkURL(tabs[wTab].url)})})}),API.Chrome.Window.addListener("onCreated",(windowObj,selectInfo)=>{API.Chrome.Tab.getAllInWindow(windowObj.id,tabs=>{for(var wTab in tabs)tabs.hasOwnProperty(wTab)&&tabs[wTab].selected&&this.checkURL(tabs[wTab].url)})})},initUpdateCheck(){var details;window.onInstalledDetails&&"update"===(details=window.onInstalledDetails).reason&&details.previousVersion&&API.Storage.get("previousVersion",prevVersion=>{API.Storage.get("disableUpdatePopup",disableUpdatePopup=>{prevVersion!==details.previousVersion&&("true"!==disableUpdatePopup&&!0!==disableUpdatePopup&&API.Icon.showBadge("NEW","GREEN"),API.Storage.set({isUpdated:!0,previousVersion:details.previousVersion}))})})},async initOnboarding(){await this.getFirstSensorTowerInstallDate();const onboardingOpenedAtStorageKey="onboarding-opened-at",openOnboarding=async()=>{await API.Storage.setAsync({[onboardingOpenedAtStorageKey]:Date.now()}),await API.Chrome.Tab.create({url:this.getOptionsPage(),active:!0})};var reason,isOnboardingCompleted;window.onInstalledDetails&&(reason=onInstalledDetails["reason"],isOnboardingCompleted=await API.Requirements.isOnboardingCompleted(),"install"!==reason||isOnboardingCompleted||(API.Settings.set({isNewUser:!0}),await openOnboarding()),isOnboardingCompleted||API.Settings.get("hasAcceptedToS")||delete window.onInstalledDetails),API.Chrome.Tab.addListener("onCreated",async tab=>{var newTabTimeout=API.RemoteConfig.get("newTabTimeout"),isOnboardingCompleted=await API.Requirements.isOnboardingCompleted(),onboardingOpenedAt=await API.Storage.getAsync(onboardingOpenedAtStorageKey)??0,onboardingOpenedAt=Date.now()>=onboardingOpenedAt+newTabTimeout;!isOnboardingCompleted&&onboardingOpenedAt&&(await API.Analytics.event("OPENING_ONBOARDING_ON_TAB_CREATED"),await openOnboarding())})},initUninstallURL(){API.Chrome.Extension.setUninstallURL(this.uninstallUrl)},async onPopupConnected(port){(this.popupPort=port).onMessage.addListener(obj=>{var message=new Message(obj.message);return(message.matches("*.domain.add.BLACKLIST")||message.matches("*.domain.add.WHITELIST"))&&API.PubSub.publish({message:obj.message,payload:obj.payload,onPublish:success=>{port.postMessage({message:"StayFocusd.domain.added."+message.getDescriptor(),payload:{success:success}})}}),!0}),port.onDisconnect.addListener(data=>{this.popupPort=null}),this.postTimerUpdatedMessage()},postTimerUpdatedMessage:function(){API.PubSub.publish("StayFocusd.timer.updated",{tabID:this.selectedTabID,displayTimer:this.getDisplayTimer()}),this.popupPort&&this.popupPort.postMessage({message:"StayFocusd.timer.updated",payload:{displayTimer:this.getDisplayTimer()}})},onTabStateChange:function(tab){if(void 0===tab)return!1;this.currentURL=tab.url,this.selectedTabID=tab.id,this.checkURL(tab.url);var whitelist=API.Component.get("Whitelist","whitelist"),self=this;API.PubSub.publish("StayFocusd.tab.selected",{tab:tab,tabID:tab.id,blockable:this.isBlockable(tab.url)}),this.isBlockable(tab.url)||whitelist.model.has(tab.url)||!this.isOutgoingLinksOptionActive()||API.Storage.get("outgoingLink",function(outgoingLink){ReferrerMonitor.isBlockable(tab.url,outgoingLink)||API.PubSub.publish({message:"StayFocusd.referrer.get",payload:{tabID:tab.id},onPublish:function(response){(response=response||{}).referrer=void 0===response.referrer?"":response.referrer,self.checkURL(response.referrer,!0)}})})},checkURL:function(url,isReferrer){url=void 0===url||"string"==typeof url&&0===url.length?this.currentURL:url;var self=this;!0===this.isNewDay()&&this.resetElapsedTime(),this.stopCountdown(),API.Storage.get("outgoingLink",function(outgoingLink){self.isBlockable(url,outgoingLink)?(API.Chrome.Tab.getSelected(null,function(tab){void 0!==tab&&(NuclearOption.isActive()?API.Icon.setIcon("NUCLEAR",tab.id):API.Icon.setIcon("BLOCKED",tab.id),API.PubSub.publish("StayFocusd.outgoingLinks.bind",{tabID:tab.id}))}),self.isKillable()?self.killPage():(self.startCountdown(),(!self.isBlockable(url)&&ReferrerMonitor.isBlockable(url,outgoingLink)||isReferrer)&&API.Chrome.Tab.getSelected(null,function(tab){void 0!==tab&&API.PubSub.publish("StayFocusd.countdown.started.BLOCKED_BY_REFERRER",{tabID:tab.id,url:tab.url})}))):API.Component.get("Whitelist","whitelist").model.has(url)?API.Chrome.Tab.getSelected(null,function(tab){void 0!==tab&&API.Icon.setIcon("ALLOWED",tab.id)}):API.Chrome.Tab.getSelected(null,function(tab){void 0!==tab&&(NuclearOption.isActive()?API.Icon.setIcon("NUCLEAR",tab.id):API.Icon.setIcon("DEFAULT",tab.id))})})},startCountdown:function(){this.timer&&this.stopCountdown(),this.timer=setInterval(this.tick.bind(this),1e3*this.interval)},stopCountdown:function(){clearInterval(this.timer),this.timer=null},isOutgoingLinksOptionActive:function(){var countdownForOutgoingLinks=API.Settings.get("countdownForOutgoingLinks");return""===countdownForOutgoingLinks||null==countdownForOutgoingLinks||!0===countdownForOutgoingLinks},isKillable:function(){return this.isMaxTimeAllowedExceeded()||NuclearOption.isActive()},isProtectedURL:function(domain){return null!=domain&&0!==domain.length&&(0===domain.indexOf(this.redirectURL)||0<=domain.indexOf("rescueMe")||0<=domain.indexOf("chrome")&&domain.indexOf("chrome")<domain.indexOf("://")&&(-1<domain.indexOf("sf")||-1<domain.indexOf("devtools")))},isBlockable:function(domain,outgoingLink){var whitelist,isWhitelisted,isBlockableByNuclearOption,isBlacklisted,blacklist;return!this.isProtectedURL(domain)&&null!=domain&&""!==domain&&!1!==this.isActive()&&(blacklist=API.Component.get("Blacklist","blacklist"),whitelist=API.Component.get("Whitelist","whitelist"),isBlacklisted=blacklist.model.has(domain),isWhitelisted=whitelist.model.has(domain),!!(isBlockableByNuclearOption=NuclearOption.isBlockable(isBlacklisted,isWhitelisted))||!(!isBlacklisted||isWhitelisted)||(isBlacklisted&&isWhitelisted?(isBlacklisted=blacklist.model.find(domain),blacklist=whitelist.model.find(domain),isBlacklisted===domain&&blacklist!==domain||(isBlacklisted===domain||blacklist!==domain)&&DomainParser.isMoreGeneralURL(blacklist,isBlacklisted)):!(isWhitelisted||NuclearOption.isActive()&&!isBlockableByNuclearOption)&&!!(this.isOutgoingLinksOptionActive()&&"string"==typeof outgoingLink&&0<outgoingLink.length)&&(blacklist=0<=domain.indexOf("mail.google.com"),ReferrerMonitor.isBlockable(domain,outgoingLink))&&!whitelist.model.has(outgoingLink)&&!blacklist))},isNewDay:function(){var resetHour,resetArray,isNewDay=!1,todayDate=new Date,nowTimestamp=todayDate.getTime(),resetTimestamp=API.Settings.get("resetTimestamp"),resetTime=this.getResetTime();return null!=resetTimestamp&&""!==resetTimestamp||(resetArray=resetTime.split(":"),resetHour=parseInt(resetArray[0],10),resetArray=parseInt(resetArray[1],10),resetTimestamp=new Date(todayDate.toDateString()+" "+resetHour+":"+resetArray).getTime(),this.updateResetTimestamp(resetTime)),(resetTimestamp=parseInt(resetTimestamp))<parseInt(nowTimestamp)&&(isNewDay=!0,this.updateResetTimestamp(resetTime)),isNewDay},getElapsedTime:function(callback){var self=this;API.Storage.get("elapsedTime",function(elapsedTime){!isNaN(elapsedTime)&&void 0!==elapsedTime||(elapsedTime=0,self.resetElapsedTime()),"function"==typeof callback&&callback(elapsedTime)})},setElapsedTime:function(elapsedTime){API.Storage.setHTML5("elapsedTime",elapsedTime),(this.lastChromeStorageSync===this.CHROME_STORAGE_SYNC_RATE||this.getTotalSecondsRemaining()<this.CHROME_STORAGE_SYNC_RATE)&&(API.Storage.set({elapsedTime:elapsedTime}),this.lastChromeStorageSync=0),this.lastChromeStorageSync++},resetElapsedTime:function(){var todayDate=this.getDateString();API.Storage.set({lastReset:todayDate,elapsedTime:0}),this.maxTimeAllowedExceeded=!1,this.elapsedTime=0},updateBadge:function(){var totalSecondsRemaining=this.getTotalSecondsRemaining(),showBadge=!1,color=null;totalSecondsRemaining<=30?(showBadge=this.isBlockable(this.currentURL),color="RED"):totalSecondsRemaining<=60&&(showBadge=this.isBlockable(this.currentURL),color="YELLOW"),showBadge?API.Icon.showBadge(totalSecondsRemaining.toString(),color,this.selectedTabID):API.Icon.hideBadge(this.selectedTabID)},killPage:function(){API.Analytics.event("BLOCK_PAGE",{isNuclear:NuclearOption.isActive()});var self=this;return this.stopCountdown(),API.Chrome.Window.getLastFocused(function(windowObj){void 0!==windowObj&&API.Chrome.Tab.getAllInWindow(windowObj.id,function(tabs){for(var wTab in tabs){var customMsg;tabs.hasOwnProperty(wTab)&&tabs[wTab].selected&&(self.isMaxTimeAllowedExceeded()||NuclearOption.isActive()&&!NuclearOption.hasSmartBomb()?!0===tabs[wTab].pinned?0===tabs[wTab].url.indexOf("chrome://")?API.Chrome.Tab.remove(tabs[wTab].id,function(){}):API.PubSub.publish("StayFocusd.page.killed",{tabID:tabs[wTab].id,redirectURL:self.redirectURL}):(customMsg=API.Settings.get("customStayFocusdMsg")||"",API.Chrome.Tab.update(tabs[wTab].id,{url:self.redirectURL+"?background&customMsg="+encodeURIComponent(customMsg)})):NuclearOption.isActive()&&NuclearOption.hasSmartBomb()&&API.PubSub.publish("StayFocusd.smartBomb.activate",{tabID:tabs[wTab].id,smartBomb:NuclearOption.getSmartBomb()}))}})}),!1},getMaxTimeAllowed:function(){var maxTimeAllowed=API.Settings.get("maxTimeAllowed");return null!=maxTimeAllowed&&""!==maxTimeAllowed||(maxTimeAllowed=this.maxTimeAllowed),maxTimeAllowed=parseInt(maxTimeAllowed,10)},setMaxTimeAllowed:function(maxTimeAllowed){if(!maxTimeAllowed)return alert(API.Chrome.Translation.get("cannotSetTimeToZeroOrLess")),!1;maxTimeAllowed=parseInt(maxTimeAllowed,10);var totalSecondsRemaining=this.getTotalSecondsRemaining(),allow=!0;if(this.isMaxTimeAllowedExceeded())return alert(API.Chrome.Translation.get("cannotChangeTimeOnceTimeIsUp")),!1;if(1440<=maxTimeAllowed)return alert(API.Chrome.Translation.get("cannotSetMoreThan1440Mins")),!1;if(maxTimeAllowed<=0)return alert(API.Chrome.Translation.get("cannotSetTimeToZeroOrLess")),!1;if(this.elapsedTime/60>=maxTimeAllowed&&(alert(API.Chrome.Translation.get("allSitesBlockedImmediately")),!1===allow))return!1;if(maxTimeAllowed>this.maxTimeAllowed){if(this.isProductivityBypassActive())return alert(API.Chrome.Translation.get("completeChallengeBeforeIncreasingTime")),!1;totalSecondsRemaining<180?!0===(allow=!0===(allow=!0===(allow=!0===(allow=!0===(allow=!0===(allow=!0===(allow=!0===(allow=confirm(API.Chrome.Translation.get("lessThanThreeMins")))?confirm(API.Chrome.Translation.get("lessThanThreeMins2")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins3")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins4")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins5")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins6")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins7")):allow)?confirm(API.Chrome.Translation.get("lessThanThreeMins8")):allow)&&(alert(API.Chrome.Translation.get("tellingYourMom")),window.open("https://asc.calpoly.edu/ssl/procrastination")):!0===(allow=!0===(allow=confirm(API.Chrome.Translation.get("maybeYouShouldReconsider")))?confirm(API.Chrome.Translation.get("onlyHurtingYourself")):allow)&&alert(API.Chrome.Translation.get("meow"))}return!0===allow&&(totalSecondsRemaining=API.Chrome.Translation.get("settingsUpdated"),maxTimeAllowed<this.maxTimeAllowed&&(totalSecondsRemaining=API.Chrome.Translation.get("givingLessTime")+"\n\n"+totalSecondsRemaining),this.maxTimeAllowed=maxTimeAllowed,API.Settings.set({maxTimeAllowed:maxTimeAllowed}),alert(totalSecondsRemaining)),allow},isMaxTimeAllowedExceeded:function(){return!0===this.maxTimeAllowedExceeded||this.elapsedTime/60>this.maxTimeAllowed&&(this.maxTimeAllowedExceeded=!0)},getTotalSecondsRemaining:function(){var totalSecondsRemaining=60*this.maxTimeAllowed-this.elapsedTime;return 0<=totalSecondsRemaining?Math.floor(totalSecondsRemaining):0},getDisplayTimer:function(){var totalSecondsRemaining=this.getTotalSecondsRemaining();return Time.formatDurationInSeconds(totalSecondsRemaining)},getDateString:function(){var date=new Date,month=date.getMonth()+1,day=date.getDate();return date.getFullYear()+"-"+month+"-"+day},setActiveDays:function(activeDays){var activeDaysString=null,activeDaysString=0===activeDays.length?"none":activeDays.join("|");API.Settings.set({activeDays:activeDaysString}),API.NuclearOption.updateActiveDays(this.getActiveDays(!0))},getActiveDays:function(asWeekArray){var activeDaysString=API.Settings.get("activeDays");if("none"===activeDaysString)return[];if(null==activeDaysString||0===activeDaysString.length)return this.setActiveDays([0,1,2,3,4,5,6]),[0,1,2,3,4,5,6];if("string"!=typeof activeDaysString||-1===activeDaysString.indexOf("|"))return[activeDaysString];for(var activeDaysArray=activeDaysString.split("|"),i=0;i<activeDaysArray.length;i++)"string"==typeof activeDaysArray[i]&&(activeDaysArray[i]=parseInt(activeDaysArray[i]));return asWeekArray?this.getActiveDaysAsWeekArray(activeDaysArray):activeDaysArray},getActiveDaysAsWeekArray:function(activeDays){for(var activeDaysWeekArray=[],i=0;i<activeDays.length;i++)activeDaysWeekArray[activeDays[i]]=!0;for(var j=0;j<7;j++)activeDaysWeekArray[j]=activeDaysWeekArray[j]||!1;return activeDaysWeekArray},isActiveDay:function(){var todayDay=(new Date).getDay(),activeDays=this.getActiveDays();return null!=activeDays&&0!==activeDays.length&&activeDays.inArray(todayDay)},setActiveHours:function(startTime,endTime){API.Settings.set({activeHours:startTime+"|"+endTime})},getActiveHours:function(){var startTime=!1,endTime=!1,activeHoursQueue=this.getActiveHoursQueue(),activeHoursQueue=(!1!==activeHoursQueue&&((new Date).getTime()>activeHoursQueue.timestamp||this.isFirstInstallAllowanceActive())&&(startTime=activeHoursQueue.startTime,endTime=activeHoursQueue.endTime,this.clearActiveHoursQueue(),this.setActiveHours(startTime,endTime)),!1===startTime&&!1===endTime&&(null!=(activeHoursQueue=API.Settings.get("activeHours"))&&""!==activeHoursQueue||(this.setActiveHours("00:00","23:59"),activeHoursQueue=API.Settings.get("activeHours")),startTime=(activeHoursQueue=activeHoursQueue.split("|"))[0],endTime=activeHoursQueue[1]),startTime.split(":")),endArray=endTime.split(":");return{startTime:startTime,endTime:endTime,startHour:activeHoursQueue[0],startMin:activeHoursQueue[1],startHourInt:parseInt(activeHoursQueue[0],10),startMinInt:parseInt(activeHoursQueue[1],10),endHour:endArray[0],endMin:endArray[1],endHourInt:parseInt(endArray[0],10),endMinInt:parseInt(endArray[1],10)}},isActiveHour:function(){var activeHours=this.getActiveHours(),date=new Date,todayHour=date.getHours(),date=date.getMinutes();return!0===this.isStartTimeLater(activeHours)?this.isBetween(todayHour,date,activeHours.startHourInt,activeHours.startMinInt,23,59)||this.isBetween(todayHour,date,0,0,activeHours.endHourInt,activeHours.endMinInt):this.isBetween(todayHour,date,activeHours.startHourInt,activeHours.startMinInt,activeHours.endHourInt,activeHours.endMinInt)},isBetween:function(testHour,testMin,startHour,startMin,endHour,endMin){return startHour<testHour&&testHour<endHour||(testHour===startHour&&testHour===endHour?startMin<=testMin&&testMin<=endMin:testHour===startHour&&startMin<=testMin||testHour===endHour&&testMin<=endMin)},isStartTimeLater:function(activeHours){return activeHours.startHourInt===activeHours.endHourInt&&activeHours.startMinInt>=activeHours.endMinInt||activeHours.startHourInt>activeHours.endHourInt},setActiveHoursQueue:function(startTime,endTime){startTime=(new Date).getTime()+API.Date.hoursToMilliseconds(24)+"|"+startTime+"|"+endTime;API.Settings.set({activeHoursQueue:startTime})},getActiveHoursQueue:function(){var queue,activeHoursQueue=API.Settings.get("activeHoursQueue");return null!=activeHoursQueue&&""!==activeHoursQueue&&(activeHoursQueue=activeHoursQueue.split("|"),(queue={}).timestamp=parseInt(activeHoursQueue[0]),queue.startTime=activeHoursQueue[1],queue.endTime=activeHoursQueue[2],queue)},clearActiveHoursQueue:function(){API.Settings.remove("activeHoursQueue")},isActive:function(){return!0===NuclearOption.isActive()||!0===this.isActiveDay()&&!0===this.isActiveHour()},updateResetTimestamp:function(resetTime){var resetTime=resetTime.split(":"),resetHour=parseInt(resetTime[0],10),resetTime=parseInt(resetTime[1],10),resetHour=new Date((new Date).toDateString()+" "+resetHour+":"+resetTime).getTime()+864e5;API.Settings.set({resetTimestamp:resetHour})},setResetTime:function(resetTime){API.Settings.set({resetTime:resetTime})},getResetTime:function(){var resetTime=API.Settings.get("resetTime"),resetTimeQueue=this.getResetTimeQueue();return!1!==resetTimeQueue&&((new Date).getTime()>resetTimeQueue.timestamp||this.isFirstInstallAllowanceActive())&&(resetTime=resetTimeQueue.resetTime,this.clearResetTimeQueue(),this.setResetTime(resetTime),this.updateResetTimestamp(resetTime)),null!=resetTime&&""!==resetTime||(this.setResetTime("00:00"),this.updateResetTimestamp(resetTime="00:00")),resetTime},setResetTimeQueue:function(resetTime){resetTime=(new Date).getTime()+API.Date.hoursToMilliseconds(24)+"|"+resetTime;API.Settings.set({resetTimeQueue:resetTime})},getResetTimeQueue:function(){var queue,resetTimeQueue=API.Settings.get("resetTimeQueue");return null!=resetTimeQueue&&""!==resetTimeQueue&&(resetTimeQueue=resetTimeQueue.split("|"),(queue={}).timestamp=resetTimeQueue[0],queue.resetTime=resetTimeQueue[1],queue)},clearResetTimeQueue:function(){API.Settings.remove("resetTimeQueue")},isProductivityBypassActive:function(){return!0===API.Settings.get("productivityBypass")},isFirstInstall:function(){return"string"!=typeof API.Settings.get("firstInstallDate")},async getFirstSensorTowerInstallDate(){let ms=await API.Storage.getAsync("firstSensorTowerInstallDate");return"number"!=typeof ms&&(ms=Date.now(),await API.Storage.setAsync({firstSensorTowerInstallDate:ms})),ms},getOptionsPage:function(){return`chrome-extension://${API.Chrome.Extension.getID()}/options.html`},isUpdatePopupDisabled:function(){var disableUpdatePopup=API.Settings.get("disableUpdatePopup");return!0===disableUpdatePopup||"true"===disableUpdatePopup},setFirstInstallAllowance:function(){var date=new Date;API.Settings.set({firstInstallDate:date.toDateString()}),date.setMinutes(date.getMinutes()+this.firstInstallAllowance),API.Settings.set({firstInstallAllowanceExpiration:date.getTime()})},isFirstInstallAllowanceActive:function(){var todayDate=new Date;return API.Settings.get("firstInstallAllowanceExpiration")>todayDate.getTime()},localizeHTML:function(doc){for(var objects=doc.getElementsByTagName("*"),i=0;i<objects.length;i++)objects[i].dataset&&objects[i].dataset.i18n&&(objects[i].innerHTML=API.Chrome.Translation.get(objects[i].dataset.i18n))},tick:function(){!0===this.isNewDay()&&this.resetElapsedTime(),this.elapsedTime=parseInt(this.elapsedTime,10)+this.interval;var totalSecondsRemaining=this.getTotalSecondsRemaining();return this.postTimerUpdatedMessage(),Notification.isset(totalSecondsRemaining)&&Notification.show("block"),this.isMaxTimeAllowedExceeded()?(this.killPage(),!1):(this.updateBadge(),this.setElapsedTime(this.elapsedTime),!0)}};return window.Logger=Logger,StayFocusd}),Array.prototype.inArray=function(needle){for(var key in this)if(this.hasOwnProperty(key)&&this[key]==needle)return!0;return!1};