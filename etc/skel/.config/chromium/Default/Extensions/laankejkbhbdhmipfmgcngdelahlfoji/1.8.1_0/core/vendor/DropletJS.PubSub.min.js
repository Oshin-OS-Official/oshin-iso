window="undefined"!=typeof window?window:null,global="undefined"!=typeof global?global:null,function(root){function isArray(options){return"object"==typeof options&&null!==options&&"number"==typeof options.length}function isObjLiteral(options){return"object"==typeof options&&null!==options&&"number"!=typeof options.length}function Message(msgString){var msgArray;this.namespace=this.DEFAULT_NS,-1<msgString.indexOf(":")&&(this.namespace=msgString.substr(0,msgString.indexOf(":")),msgString=msgString.substr(msgString.indexOf(":")+1,msgString.length)),-1<msgString.indexOf(".")?(msgArray=msgString.split("."),this.msgArray=[msgArray[0]||"*",msgArray[1]||"*",msgArray[2]||"*",msgArray[3]||"*"],this.msgString=this.msgArray.join(".")):(this.msgArray=[msgString],this.msgString=msgString)}"function"!=typeof Function.prototype.bind&&(Function.prototype.bind=function(scope){var self=this;return function(){return self.apply(scope,arguments)}});Message.prototype={DEFAULT_NS:"__default",matches:function(msgString){if(this.msgString===msgString)return!0;var msg1Array=this.msgArray,msg2Array=msgString.split(".");if(msg1Array.length!==msg2Array.length)return!1;for(var msg1Bitmask="",msg2Bitmask="",longerMessageLength=(msg1Array.length>=msg2Array.length?msg1Array:msg2Array).length,i=0;i<longerMessageLength;i++){if("*"!==msg1Array[i]&&"*"!==msg2Array[i]&&msg1Array[i]!==msg2Array[i])return!1;msg1Bitmask+="*"===msg1Array[i]?"0":"1",msg2Bitmask+="*"===msg2Array[i]?"0":"1"}return msg2Bitmask<=msg1Bitmask},toString:function(){return this.msgString}};var PubSub={handlers:{},subscribers:{before:[],after:[]},getAPI:function(){return{clear:this.clear.bind(this),listen:this.listen.bind(this),once:this.once.bind(this),publish:this.publish.bind(this),stop:this.stop.bind(this),subscribe:this.subscribe.bind(this),unsubscribe:this.unsubscribe.bind(this)}},listen:function(){var options=this.processListenArgs(Array.prototype.slice.call(arguments));if(isArray(options.message))return this.each(options,this.listen.bind(this)),null;this.addHandler(options)},once:function(){var options=this.processListenArgs(Array.prototype.slice.call(arguments));if(options.limit=1,isArray(options.message))return this.each(options,this.once.bind(this)),null;this.addHandler(options)},stop:function(message){if(message)throw new Error("Message(s) must be passed to stop()");message={message:this.toMessage(message)};if(isArray(message.message))return this.each(message,this.stop.bind(this)),null;this.removeHandlers(message)},subscribe:function(){var options=this.processSubscribeArgs(Array.prototype.slice.call(arguments)),phase=options.phase;this.subscribers[phase]=this.subscribers[phase]||[],this.subscribers[phase].push(options)},unsubscribe:function(){var options=this.processUnsubscribeArgs(Array.prototype.slice.call(arguments));if(!options.phase)return this.unsubscribe(options.namespace,"before"),this.unsubscribe(options.namespace,"after"),null;var namespace=options.namespace,options=options.phase,subscribers=this.subscribers[options];if(isArray(subscribers))for(var i=0;i<subscribers.length;i++)namespace&&subscribers[i].namespace!==namespace||subscribers.splice(i,1)},publish:function(){var onComplete,options=this.processPublishArgs(Array.prototype.slice.call(arguments));if(isArray(options.message))return onComplete=options.onComplete,options.onComplete=null,this.each(options,this.publish.bind(this),onComplete),null;options.message.toString();for(var result,message=options.message,payload=options.payload,onPublish=options.onPublish,publishTo=this.subscribers.before.concat(this.getHandlers(message)).concat(this.subscribers.after),i=0;i<publishTo.length;i++)(null===publishTo[i].limit||publishTo[i].count<publishTo[i].limit)&&(result=publishTo[i].async?publishTo[i].handler(message,payload,onPublish):publishTo[i].handler(message,payload),!0!==publishTo[i].async&&"function"==typeof onPublish&&onPublish(result),publishTo[i].count+=1),"number"==typeof publishTo[i].limit&&publishTo[i].count===publishTo[i].limit&&this.removeHandlers(options,i);"function"==typeof options.onComplete&&options.onComplete()},getHandlers:function(message){var msgString,handlers=[];for(msgString in this.handlers)this.handlers.hasOwnProperty(msgString)&&message.matches(msgString)&&(handlers=handlers.concat(this.handlers[msgString]));return handlers},clear:function(){this.handlers={},this.subscribers={before:[],after:[]}},each:function(data,fn,onComplete){for(var i=0;i<data.message.length;i++){var j,thisData={};for(j in data)data.hasOwnProperty(j)&&"message"!==j&&(thisData[j]=data[j]);thisData.message=data.message[i],fn(thisData)}"function"==typeof onComplete&&onComplete()},addHandler:function(options){var msgString=options.message.toString();this.handlers[msgString]=this.handlers[msgString]||[],this.handlers[msgString].push({namespace:options.message.namespace,handler:options.handler,async:options.async,limit:"number"==typeof options.limit?options.limit:null,count:0})},removeHandlers:function(options,handlerNum){var msgString=options.message.toString(),namespace=options.message.namespace,handlers=this.handlers;if(handlers&&handlers[msgString]){if("number"==typeof handlerNum)handlers[msgString][handlerNum].namespace===namespace&&handlers[msgString].splice(handlerNum,1);else for(var i=0;i<handlers[msgString].length;i++)handlers[msgString][i].namespace===namespace&&handlers[msgString].splice(i,1);if(0===handlers[msgString].length){options=handlers,handlerNum=msgString;try{delete options[handlerNum]}catch(e){options[handlerNum]=void 0}}}},processListenArgs:function(args){var options={};if(isObjLiteral(args[0])?options=args[0]:(options.message="string"==typeof args[0]||isArray(args[0])?args[0]:null,options.handler="function"==typeof args[1]?args[1]:null),options.message&&"function"==typeof options.handler)return options.message=this.toMessage(options.message),options;throw new Error("Message(s) and handler function must be passed to listen() and/or once()")},processSubscribeArgs:function(args){var options={};if(isObjLiteral(args[0])?options=args[0]:options.handler="function"==typeof args[0]?args[0]:null,"function"!=typeof options.handler)throw new Error("Handler must be passed to subscribe()");if(options.phase=options.phase||"after",options.limit=null,options.count=0,!options.phase||options.phase in{before:1,after:1})return options;throw new Error(options.phase+" is not a valid phase for subscribe().")},processUnsubscribeArgs:function(args){var options={};if(isObjLiteral(args[0])?options=args[0]:(options.namespace="string"==typeof args[0]?args[0]:null,options.phase="string"==typeof args[1]?args[1]:null),!options.phase||options.phase in{before:1,after:1})return options;throw new Error(options.phase+" is not a valid phase for unsubscribe().")},processPublishArgs:function(args){var options={};if(isObjLiteral(args[0])?options=args[0]:(options.message="string"==typeof args[0]||isArray(args[0])?args[0]:null,options.payload=void 0!==args[1]?args[1]:null),options.message)return options.message=this.toMessage(options.message),options.async&&"function"!=typeof options.onPublish&&(options.onPublish=function(){}),options;throw new Error("Message(s) must be passed to publish()")},toMessage:function(message){if(isArray(message)){for(var messageArray=[],i=0;i<message.length;i++)message[i]instanceof Message||(messageArray[i]=new Message(message[i]));message=messageArray}else!message||message instanceof Message||(message=new Message(message));return message},log:function(funcName,message,payload,level){},setLogLevel:function(level){0}};"function"==typeof define?define(function(){return PubSub}):"undefined"!=typeof module&&module.exports?module.exports=PubSub:(root.DropletJS="object"==typeof root.DropletJS&&"null"!==root.DropletJS?root.DropletJS:{},root.DropletJS.PubSub=PubSub)}(window||global);