define(["core/CoreAPI","core/Time","core/vendor/DropletJS.PubSub.min","components/Onboarding/OnboardingView","components/Onboarding/OnboardingModel"],function(API,Time,PubSub,View,Model){return class{view=null;model=null;constructor(){this.model=new Model,this.view=new View(this.model)}async init(){this.addListeners(),await API.Requirements.incrementOnboardingShownCount(),await this.model.init(),this.view.init(),this.event("ONBOARDING_STARTED",{referrer:this.model.referrer})}addListeners(){PubSub.listen("OnboardingView.button.clicked",(_,{id})=>{switch(id){case"btnAskLater":return this.onClickAskLater();case"btnContinue":return this.onClickContinue();case"btnDecline":return this.onClickDecline();case"btnAccept":return this.onClickAccept()}}),PubSub.listen("OnboardingView.checkbox.checked",(_,{id,isChecked})=>{switch(id){case"isAge18":return this.onIs18OrOlderChecked(isChecked);case"hasAcceptedToS":return this.onAcceptToSChecked(isChecked);case"hasAcceptedPrivacyPolicy":return this.onAcceptPrivacyPolicyChecked(isChecked)}}),PubSub.listen("OnboardingView.select.changed",(_,{id,value})=>{if("ageSelect"===id)return this.onChangeAge(value)})}dismiss(){window.parent.postMessage("OnboardingOverlay.dismiss","*")}async saveModel(){await API.Settings.setAsync({is18OrOlder:this.model.is18OrOlder,age:this.model.age,hasAcceptedToS:this.model.hasAcceptedToS,hasAcceptedPrivacyPolicy:this.model.hasAcceptedPrivacyPolicy,explicitlyDeclinedPrivacyPolicy:this.model.explicitlyDeclinedPrivacyPolicy})}async declineOnboarding(){this.model.hasAcceptedPrivacyPolicy=!1,this.model.explicitlyDeclinedPrivacyPolicy=!0,await this.saveModel(),await this.event("ONBOARDING_COMPLETE",{acceptedAll:!1}),this.dismiss()}async onClickContinue(){await this.event("CLICK_ONBOARDING_CONTINUE"),await this.declineOnboarding()}async onClickDecline(){await this.event("CLICK_ONBOARDING_DECLINE"),await this.model.incrementConfirmationCount(),await this.declineOnboarding()}async onClickAskLater(){await this.event("CLICK_ONBOARDING_ASK_LATER"),await this.model.incrementConfirmationCount(),await API.Requirements.setPromptAgainAt(Date.now()+3*Time.DAY),this.dismiss()}async onClickAccept(){await this.saveModel(),this.model.hasAcceptedPrivacyPolicy&&(await this.event("ONBOARDING_ACCEPTED_ALL"),await this.event("ONBOARDING_COMPLETE",{acceptedAll:!0})),this.model.isConfirmingPrivacy?(await this.event("CLICK_ONBOARDING_ACCEPT_CONFIRM_PRIVACY"),this.model.hasAcceptedPrivacyPolicy=!0,this.view.rerender()):(await this.event("CLICK_ONBOARDING_ACCEPT_TOS"),this.dismiss())}onChangeAge(newAge){this.model.age="under13"===newAge?null:Number(newAge),this.view.rerender()}onIs18OrOlderChecked(isChecked){this.model.is18OrOlder=isChecked,this.model.hasAcceptedToS=isChecked,this.model.hasAcceptedPrivacyPolicy=isChecked,this.model.age=isChecked?null:17,this.view.rerender()}onAcceptToSChecked(isChecked){this.model.hasAcceptedToS=isChecked,this.view.rerender()}onAcceptPrivacyPolicyChecked(isChecked){this.model.hasAcceptedPrivacyPolicy=isChecked,this.view.rerender()}async event(event,properties){try{await API.Analytics.event(event,{shownCount:this.model.shownCount,confirmationCount:this.model.confirmationCount,isConfirmingPrivacy:this.model.isConfirmingPrivacy,...properties})}catch(err){}}}});