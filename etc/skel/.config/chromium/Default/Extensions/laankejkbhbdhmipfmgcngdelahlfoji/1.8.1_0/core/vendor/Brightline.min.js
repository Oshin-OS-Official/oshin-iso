!function(e,t){function l(e){return"object"==typeof e&&null!==e&&"number"!=typeof e.length}function c(e,t,n){var i,r,o;for(o in t=void 0===t?[]:t,n=void 0===n?{}:n,e)e.hasOwnProperty(o)&&(r=o,i=e[o],t.push(r),"object"==typeof i&&null!==i?n=c(i,t,n):(r=t.join("."),n[r]=i),t.pop());return n}function h(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function p(t){this.name=t,this.content="",this.touched=0,this.variables=[],this.parsedContent=[],this.variableCache={},this.usedVariables={}}function d(){this.childParentMap={},this.nodes={},this.numNodes=0,this.tree={}}function v(t,n){return this.blocks=new d,this.currentBlock=null,this.currentScope=null,this.usedVariables={},this.variableCache={},l(n)&&(r=n.logLevel||"ERROR",this.name=n.name||null),"string"==typeof t&&this.process(t),this.getAPI()}Function.prototype.bind=function(e){var t=this;return function(){return t.apply(e,arguments)}},p.prototype={NODE_ID:null,name:null,content:null,touched:null,variables:null,parsedContent:null,variableCache:null,usedVariables:null,reset:function(){this.parsedContent=[],this.usedVariables={},this.touched=0},isAlreadyParsed:function(e){return e in this.usedVariables},getName:function(){return this.name},getParsedContent:function(){return this.parsedContent},addParsedContent:function(e){this.parsedContent.push(e)},setParsedContent:function(e){this.parsedContent=e},getContent:function(){return this.content},setContent:function(e){this.content=e},setVariables:function(e){this.variables=e},getVariables:function(){return this.variables},setTouched:function(e){this.touched=e},touch:function(){this.touched+=1},getTouched:function(){return this.touched},getVariableCache:function(){return this.variableCache},setUsedVariable:function(e,t){this.usedVariables[e]=t},getNodeID:function(){return this.getName()}},d.prototype={childParentMap:null,nodes:null,numNodes:null,tree:null,log:function(e,t,n,r){},addNode:function(e,t){this.nodes[t]=e,this.numNodes+=1},getNode:function(e){return this.hasNode(e)?this.nodes[e]:null},getNodes:function(e){if(e){for(var t={},n=0;n<e.length;n++)t[e[n]]=this.getNode(e[n]);return t}return this.nodes},removeNode:function(e){if(this.hasNode(e)){try{delete this.nodes[e]}catch(n){this.nodes[e]=t}--this.numNodes}},hasNode:function(e){return e in this.nodes},isEmpty:function(){for(var e in this.nodes)if(this.nodes.hasOwnProperty(e))return!1;return!0},has:function(e){return this.hasNode(e)},getNodeID:function(e){if("string"==typeof e||"number"==typeof e)return e;if("object"==typeof e&&null!==e&&"function"==typeof e.getNodeID)return e.getNodeID();throw new Error("[Tree.getNodeID()] Cannot get node ID")},addChild:function(e,t){var n=this.getNodeID(e),r=this.getNodeID(t);if(this.hasParent(t))throw new Error("[Tree.addChild()] Child node "+r+" already has a parent");if(n===r)throw new Error("[Tree.addChild()] Parent and child node are the same. You cannot add a parent node as a child of itself, or vice-versa.");if(this.hasNode(r))throw new Error("[Tree.addChild()] The nodeID "+r+" is already in use");this.hasNode(n)||this.addNode(e,n),this.log("addChild","Adding child",{parent:e,child:t},"DEBUG"),this.addNode(t,r),n in this.tree||(this.tree[n]=[]),this.tree[n].push(r),this.childParentMap[r]=n},addChildren:function(e,t){if(!function(e){return"object"==typeof e&&null!==e&&"number"==typeof e.length}(t))throw new Error("[Tree.addChildren()] Children added to Tree must in an array");for(var n=0;n<t.length;n++)this.addChild(e,t[n])},getChild:function(e){if(this.hasNode(e))return this.getNode(e);throw new Error("[Tree.getChild()] Cannot get non-existent node "+e+" from Tree")},getChildren:function(e){e=this.getNodeID(e);return e in this.tree?this.getNodes(this.tree[e]):{}},hasChild:function(e,t){e=this.getNodeID(e),t=this.getNodeID(t);return t in this.childParentMap&&e===this.childParentMap[t]},hasChildren:function(e){e=this.getNodeID(e);return e in this.tree&&0<this.tree[e].length},removeChild:function(e,n){if(!this.isChildOf(e,n))throw new Error("[Tree.removeChild()] Cannot remove child. This node is not a child of the given parent.");for(var e=this.getNodeID(e),i=this.getNodeID(n),s=this.tree[e],o=0;o<s.length;o++)if(s[o]===i){s.splice(o,1);break}try{delete this.childParentMap[i]}catch(u){this.childParentMap[i]=t}if(0===s.length)try{delete this.tree[e]}catch(u){this.tree[e]=t}this.removeNode(i),this.hasChildren(i)&&this.removeChildren(i)},removeChildren:function(e,t){for(var n in t=void 0===t&&this.hasChildren(e)?this.getChildren(e):t)t.hasOwnProperty(n)&&this.removeChild(e,t[n])},isChildOf:function(e,t){return this.hasChild(e,t)},addParent:function(e){if(!this.isEmpty())throw new Error("[Tree.addParent()] Cannot add lone parent to a Tree that already has nodes in it. Use Tree.addChild(parent,child) instead.");var t=this.getNodeID(e);if(this.hasNode(t))throw new Error("[Tree.addParent()] Parent's node id must be unique.");this.addNode(e,t),t in this.tree||(this.tree[t]=[])},getParent:function(e){return!!this.hasParent(e)&&(e=this.getParentNodeID(e),this.getNode(e))},hasParent:function(e){return null!==this.getParentNodeID(e)},getParentNodeID:function(e){var t=null;return("string"==typeof e||"number"==typeof e)&&e in this.childParentMap?t=this.childParentMap[e]:"object"==typeof e&&null!==e&&"function"==typeof e.getNodeID&&(t=(e=e.getNodeID())in this.childParentMap?this.childParentMap[e]:null),t},isParent:function(e){return this.hasChildren(e)},remove:function(e){var n,t=this.getNodeID(e);this.hasParent(t)?(n=this.getParent(t),this.removeChild(n,e)):this.isParent(e)&&this.removeChildren(e),this.removeNode(t)}};v.prototype={blocks:null,currentBlock:null,currentScope:null,name:null,usedVariables:null,variableCache:null,getAPI:function(){return{set:this.set.bind(this),setScope:this.setScope.bind(this),clearScope:this.clearScope.bind(this),touch:this.touch.bind(this),parse:this.parse.bind(this),render:this.render.bind(this),snip:this.snip.bind(this),setLogLevel:this.setLogLevel.bind(this),setName:this.setName.bind(this),each:this.each.bind(this)}},setLogLevel:function(e){r=e},setName:function(e){this.name=e},log:function(e,t,n,r){},set:function(){var e=Array.prototype.slice.call(arguments),t=null,n=null,r=!1;return l(e[0])?(t=e[0],r=e[1],this.setObjectVars(t,r)):(t=e[0],n=e[1],r=e[2],"function"==typeof n?n=n():void 0===n&&(n=null),this.isValidKeyValuePair(t,n)&&(null===this.currentScope||r?this.variableCache[t]=n:this.currentScope.variableCache[t]=n)),this},each:function(){var s,e=Array.prototype.slice.call(arguments),t=e[0],n=e[1],r=null,i=null;for(s in"string"==typeof e[2]?r=e[2]:"function"==typeof e[2]&&(i=e[2]),i||"function"!=typeof e[3]||(i=e[3]),t)t.hasOwnProperty(s)&&(l(t[s])?this.set(t[s]):r&&this.set(r,t[s]),i&&i(t[s],s),this.parse(n))},setScope:function(e){if(this.hasBlock(e))return this.currentScope=this.getBlock(e),this;throw new Error("["+this.name+" Brightline.setScope()] Cannot set scope to non-existent block: "+e)},clearScope:function(e){return(e=void 0===e||e)||null===this.currentScope||(this.currentScope.variableCache={},this.currentScope.usedVariables={}),e&&(this.currentScope=null),this},touch:function(e){return this.getBlock(e).touch(),this},parse:function(e,t){t=void 0===t||t;e=this.getBlock(e=void 0===e?"__root__":e);return t?e.setTouched(1):e.setTouched(0),this.currentBlock=e.getName(),this.parseBlock(e),this.clearUsedVariablesFromCache(),this.clearScope(!1),e.setTouched(0),this.currentBlock="__root__",e},render:function(e){var e=this.parse(e=void 0===e?"__root__":e),n=h(e.getParsedContent().join("\n"));return this.clearScope(),e.reset(),n},snip:function(e){var e=this.parse(e=void 0===e?"__root__":e,!1),n=e.getParsedContent(),r=h(n.join("\n"));return 0===r.length&&(r=e.getContent()),n=n.slice(0,0-e.getTouched()),e.setParsedContent(n),this.clearScope(),r},setObjectVars:function(e,t){var r,n=c(e);for(r in n)n.hasOwnProperty(r)&&this.set(r,n[r],t)},getBlock:function(e){if(this.hasBlock(e))return this.blocks.getChild(e);throw new Error("["+this.name+" Brightline.getBlock()] Cannot get non-existent block: "+e)},hasBlock:function(e){return this.blocks.has(e)},process:function(e){var t=new p("__root__");t.setContent(e),this.findBlocks(t),this.insertChildBlockPlaceholders(t),this.findVariablesInBlockContent(t),this.blocks.has("__root__")||this.blocks.addParent(t)},findBlocks:function(e){var t=/<!--\s+BEGIN\s+([\.0-9A-Za-z:|_-]+)\s+-->([\s\S]*)<!--\s+END\s+\1\s+-->/gm,r=e.getContent().match(t),i=this;if(r)for(var s=0;s<r.length;s++){var o=new RegExp(t).exec(r[s]);if(o){var u=o[1],a=new p(u);if(a.setContent(o[2]),i.blocks.has(u))throw new Error("["+this.name+" Brightline.findBlocks()] Duplicate block name: "+u+". Block names must be unique.");i.blocks.addChild(e,a),i.findBlocks(a),i.insertChildBlockPlaceholders(a),i.findVariablesInBlockContent(a)}}},insertChildBlockPlaceholders:function(e){if(this.blocks.hasChildren(e)){var r,t=this.blocks.getChildren(e);for(r in t)t.hasOwnProperty(r)&&function(t){var t=t.getName(),i=e.getContent(),o=i.match("\x3c!--\\s+BEGIN\\s+"+t+"\\s+--\x3e([\\s\\S]*)\x3c!--\\s+END\\s+"+t+"\\s+--\x3e");o&&e.setContent(i.replace(o[0],"{{__"+t+"__}}"))}(t[r])}},findVariablesInBlockContent:function(e){var n=[],r=e.getContent().match(/(?!\{{__[\.0-9A-Za-z\*:|_-]+__\}})\{{([\.0-9A-Za-z\*:|_-]+)\}}/gm);if(r){for(var s,i=0;i<r.length;i++)!function(e,t){for(var n=0;n<t.length;n++)if(e===t[n])return!0;return!1}(n,r[i])&&(s=r[i].replace("{{","").replace("}}",""),n.push(s));e.setVariables(n)}},parseBlock:function(e){var n,t=this.blocks.getChildren(e);for(n in t)t.hasOwnProperty(n)&&this.parseBlock(t[n]);return this.currentBlock=e.getName(),this.replaceBlockVariables(e),this.replaceChildBlockPlaceholders(e),e.setTouched(0),e},replaceBlockVariables:function(e){var t=e.getContent(),n=e.getVariables(),r=e.getName(),i=e.getVariableCache();if(0<n.length)for(var s=0;s<n.length;s++){var o=n[s],u="{{"+o+"}}";r===this.currentBlock?o in i?(t=t.replace(u,i[o]),e.setUsedVariable(o,!0),e.touched=1):o in this.variableCache&&!e.isAlreadyParsed(o)?(t=t.replace(u,this.variableCache[o]),this.usedVariables[o]=!0,e.touched=1):t=t.replace(u,""):t=t.replace(u,"")}for(var a=e.getTouched(),f=0;f<a;f++)e.addParsedContent(t)},replaceChildBlockPlaceholders:function(e){var t=this.getParsedContent(e),n=this.blocks.getChildren(e);if(!function(e){if("object"!=typeof e||null===e)return null==e||""===e;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(n)){for(var r in n)if(n.hasOwnProperty(r)){var o,i="{{__"+n[r].getName()+"__}}",s=h(n[r].parsedContent.join(""));for(o in t)t.hasOwnProperty(o)&&-1<t[o].indexOf(i)&&(t[o]=t[o].replace(i,s));n[r].parsedContent=[]}e.setParsedContent(t)}},getParsedContent:function(e){if(0===e.parsedContent.length&&this.blocks.hasChildren(e)){var n,t=this.blocks.getChildren(e);for(n in t)if(t.hasOwnProperty(n)&&0<t[n].parsedContent.length){this.touch(e.getName()),this.replaceBlockVariables(e);break}}return e.getParsedContent()},clearUsedVariablesFromCache:function(){for(var e in this.usedVariables)if(this.usedVariables.hasOwnProperty(e))try{delete this.variableCache[e]}catch(n){this.variableCache[e]=t}this.usedVariables=[]},isValidKeyValuePair:function(e,t){return"string"==typeof e&&("string"==typeof t&&0<t.length||"number"==typeof t||"boolean"==typeof t)}},"function"==typeof define?define(function(){return v}):e.Brightline=v}(window);