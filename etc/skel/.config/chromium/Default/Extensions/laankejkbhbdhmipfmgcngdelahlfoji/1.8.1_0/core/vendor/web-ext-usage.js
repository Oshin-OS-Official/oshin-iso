var webExtUsage=function(F){"use strict";var k,t,I,Dt;(t=k=k||{}).assertEqual=r=>r,t.assertIs=function(r){},t.assertNever=function(r){throw new Error},t.arrayToEnum=r=>{var a={};for(const o of r)a[o]=o;return a},t.getValidEnumValues=r=>{var a=t.objectKeys(r).filter(c=>"number"!=typeof r[r[c]]),o={};for(const c of a)o[c]=r[c];return t.objectValues(o)},t.objectValues=r=>t.objectKeys(r).map(function(a){return r[a]}),t.objectKeys="function"==typeof Object.keys?r=>Object.keys(r):r=>{var a=[];for(const o in r)Object.prototype.hasOwnProperty.call(r,o)&&a.push(o);return a},t.find=(r,a)=>{for(const o of r)if(a(o))return o},t.isInteger="function"==typeof Number.isInteger?r=>Number.isInteger(r):r=>"number"==typeof r&&isFinite(r)&&Math.floor(r)===r,t.joinValues=function(r,a=" | "){return r.map(o=>"string"==typeof o?`'${o}'`:o).join(a)},t.jsonStringifyReplacer=(r,a)=>"bigint"==typeof a?a.toString():a;const m=k.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),ke=t=>{switch(typeof t){case"undefined":return m.undefined;case"string":return m.string;case"number":return isNaN(t)?m.nan:m.number;case"boolean":return m.boolean;case"function":return m.function;case"bigint":return m.bigint;case"symbol":return m.symbol;case"object":return Array.isArray(t)?m.array:null===t?m.null:t.then&&"function"==typeof t.then&&t.catch&&"function"==typeof t.catch?m.promise:typeof Map<"u"&&t instanceof Map?m.map:typeof Set<"u"&&t instanceof Set?m.set:typeof Date<"u"&&t instanceof Date?m.date:m.object;default:return m.unknown}},p=k.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class be extends Error{constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};var s=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,s):this.__proto__=s,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const s=e||function(a){return a.message},n={_errors:[]},r=a=>{for(const o of a.issues)if("invalid_union"===o.code)o.unionErrors.map(r);else if("invalid_return_type"===o.code)r(o.returnTypeError);else if("invalid_arguments"===o.code)r(o.argumentsError);else if(0===o.path.length)n._errors.push(s(o));else{let c=n,l=0;for(;l<o.path.length;){var u=o.path[l];l===o.path.length-1?(c[u]=c[u]||{_errors:[]},c[u]._errors.push(s(o))):c[u]=c[u]||{_errors:[]},c=c[u],l++}}};return r(this),n}toString(){return this.message}get message(){return JSON.stringify(this.issues,k.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=s=>s.message){var s={},n=[];for(const r of this.issues)(0<r.path.length?(s[r.path[0]]=s[r.path[0]]||[],s[r.path[0]]):n).push(e(r));return{formErrors:n,fieldErrors:s}}get formErrors(){return this.flatten()}}be.create=t=>new be(t);const rt=(t,e)=>{let s;switch(t.code){case p.invalid_type:s=t.received===m.undefined?"Required":`Expected ${t.expected}, received `+t.received;break;case p.invalid_literal:s="Invalid literal value, expected "+JSON.stringify(t.expected,k.jsonStringifyReplacer);break;case p.unrecognized_keys:s="Unrecognized key(s) in object: "+k.joinValues(t.keys,", ");break;case p.invalid_union:s="Invalid input";break;case p.invalid_union_discriminator:s="Invalid discriminator value. Expected "+k.joinValues(t.options);break;case p.invalid_enum_value:s=`Invalid enum value. Expected ${k.joinValues(t.options)}, received '${t.received}'`;break;case p.invalid_arguments:s="Invalid function arguments";break;case p.invalid_return_type:s="Invalid function return type";break;case p.invalid_date:s="Invalid date";break;case p.invalid_string:"object"==typeof t.validation?"startsWith"in t.validation?s=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?s=`Invalid input: must end with "${t.validation.endsWith}"`:k.assertNever(t.validation):s="regex"!==t.validation?"Invalid "+t.validation:"Invalid";break;case p.too_small:s="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:"number"===t.type?"Number must be "+(t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than ")+t.minimum:"date"===t.type?"Date must be "+(t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than ")+new Date(t.minimum):"Invalid input";break;case p.too_big:s="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:"number"===t.type?`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} `+t.maximum:"date"===t.type?`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} `+new Date(t.maximum):"Invalid input";break;case p.custom:s="Invalid input";break;case p.invalid_intersection_types:s="Intersection results could not be merged";break;case p.not_multiple_of:s="Number must be a multiple of "+t.multipleOf;break;case p.not_finite:s="Number must be finite";break;default:s=e.defaultError,k.assertNever(t)}return{message:s}};let js=rt;function Rt(){return js}const Ot=t=>{var{data:e,path:t,errorMaps:n,issueData:r}=t,t=[...t,...r.path||[]],o={...r,path:t};let c="";n=n.filter(u=>!!u).slice().reverse();for(const u of n)c=u(o,{data:e,defaultError:c}).message;return{...r,path:t,message:r.message||c}};function y(t,e){e=Ot({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,js,rt].filter(n=>!!n)});t.common.issues.push(e)}class Y{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,s){var n=[];for(const r of s){if("aborted"===r.status)return w;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,s){var n=[];for(const r of s)n.push({key:await r.key,value:await r.value});return Y.mergeObjectSync(e,n)}static mergeObjectSync(e,s){var n={};for(const r of s){var{key:a,value:o}=r;if("aborted"===a.status||"aborted"===o.status)return w;"dirty"===a.status&&e.dirty(),"dirty"===o.status&&e.dirty(),(typeof o.value<"u"||r.alwaysSet)&&(n[a.value]=o.value)}return{status:e.value,value:n}}}const w=Object.freeze({status:"aborted"}),$s=t=>({status:"dirty",value:t}),G=t=>({status:"valid",value:t}),rs=t=>"aborted"===t.status,as=t=>"dirty"===t.status,Mt=t=>"valid"===t.status,Ct=t=>t instanceof Promise;!function(t){t.errToObj=e=>"string"==typeof e?{message:e}:e||{},t.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(I=I||{});class pe{constructor(e,s,n,r){this.parent=e,this.data=s,this._path=n,this._key=r}get path(){return this._path.concat(this._key)}}const Bs=(t,e)=>{if(Mt(e))return{success:!0,data:e.value};if(t.common.issues.length)return{success:!1,error:new be(t.common.issues)};throw new Error("Validation failed but no issues detected.")};function S(t){if(!t)return{};const{errorMap:e,invalid_type_error:s,required_error:n,description:r}=t;if(e&&(s||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:r}:{errorMap:(o,c)=>"invalid_type"!==o.code?{message:c.defaultError}:"u"<typeof c.data?{message:null!=n?n:c.defaultError}:{message:null!=s?s:c.defaultError},description:r}}class T{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return ke(e.data)}_getOrReturnCtx(e,s){return s||{common:e.parent.common,data:e.data,parsedType:ke(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Y,ctx:{common:e.parent.common,data:e.data,parsedType:ke(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){e=this._parse(e);if(Ct(e))throw new Error("Synchronous parse encountered promise.");return e}_parseAsync(e){e=this._parse(e);return Promise.resolve(e)}parse(e,s){e=this.safeParse(e,s);if(e.success)return e.data;throw e.error}safeParse(e,s){var n={common:{issues:[],async:null!=(n=null==s?void 0:s.async)&&n,contextualErrorMap:null==s?void 0:s.errorMap},path:(null==s?void 0:s.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ke(e)},s=this._parseSync({data:e,path:n.path,parent:n});return Bs(n,s)}async parseAsync(e,s){e=await this.safeParseAsync(e,s);if(e.success)return e.data;throw e.error}async safeParseAsync(e,s){s={common:{issues:[],contextualErrorMap:null==s?void 0:s.errorMap,async:!0},path:(null==s?void 0:s.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:ke(e)},e=this._parse({data:e,path:s.path,parent:s}),e=await(Ct(e)?e:Promise.resolve(e));return Bs(s,e)}refine(e,s){return this._refinement((r,a)=>{const o=e(r),c=()=>a.addIssue({code:p.custom,...(r=>"string"==typeof s||"u"<typeof s?{message:s}:"function"==typeof s?s(r):s)(r)});return typeof Promise<"u"&&o instanceof Promise?o.then(l=>!!l||(c(),!1)):!!o||(c(),!1)})}refinement(e,s){return this._refinement((n,r)=>!!e(n)||(r.addIssue("function"==typeof s?s(n,r):s),!1))}_refinement(e){return new fe({schema:this,typeName:v.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return ge.create(this)}nullable(){return Ze.create(this)}nullish(){return this.optional().nullable()}array(){return le.create(this)}promise(){return Ye.create(this)}or(e){return dt.create([this,e])}and(e){return ut.create(this,e)}transform(e){return new fe({schema:this,typeName:v.ZodEffects,effect:{type:"transform",transform:e}})}default(e){var s="function"==typeof e?e:()=>e;return new gt({innerType:this,defaultValue:s,typeName:v.ZodDefault})}brand(){return new Fs({typeName:v.ZodBranded,type:this,...S(void 0)})}catch(e){var s="function"==typeof e?e:()=>e;return new jt({innerType:this,defaultValue:s,typeName:v.ZodCatch})}describe(e){return new this.constructor({...this._def,description:e})}pipe(e){return yt.create(this,e)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const nr=/^c[^\s-]{8,}$/i,rr=/^([a-f0-9]{8}-[a-f0-9]{4}-[1-5][a-f0-9]{3}-[a-f0-9]{4}-[a-f0-9]{12}|00000000-0000-0000-0000-000000000000)$/i,ar=/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;class xe extends T{constructor(){super(...arguments),this._regex=(e,s,n)=>this.refinement(r=>e.test(r),{validation:s,code:p.invalid_string,...I.errToObj(n)}),this.nonempty=e=>this.min(1,I.errToObj(e)),this.trim=()=>new xe({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}_parse(e){var a;if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==m.string)return y(a=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.string,received:a.parsedType}),w;var n=new Y;let r;for(const a of this._def.checks)if("min"===a.kind)e.data.length<a.value&&(r=this._getOrReturnCtx(e,r),y(r,{code:p.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if("max"===a.kind)e.data.length>a.value&&(r=this._getOrReturnCtx(e,r),y(r,{code:p.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),n.dirty());else if("length"===a.kind){var o=e.data.length>a.value,c=e.data.length<a.value;(o||c)&&(r=this._getOrReturnCtx(e,r),o?y(r,{code:p.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):c&&y(r,{code:p.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),n.dirty())}else if("email"===a.kind)ar.test(e.data)||(r=this._getOrReturnCtx(e,r),y(r,{validation:"email",code:p.invalid_string,message:a.message}),n.dirty());else if("uuid"===a.kind)rr.test(e.data)||(r=this._getOrReturnCtx(e,r),y(r,{validation:"uuid",code:p.invalid_string,message:a.message}),n.dirty());else if("cuid"===a.kind)nr.test(e.data)||(r=this._getOrReturnCtx(e,r),y(r,{validation:"cuid",code:p.invalid_string,message:a.message}),n.dirty());else if("url"===a.kind)try{new URL(e.data)}catch{y(r=this._getOrReturnCtx(e,r),{validation:"url",code:p.invalid_string,message:a.message}),n.dirty()}else"regex"===a.kind?(a.regex.lastIndex=0,a.regex.test(e.data)||(r=this._getOrReturnCtx(e,r),y(r,{validation:"regex",code:p.invalid_string,message:a.message}),n.dirty())):"trim"===a.kind?e.data=e.data.trim():"startsWith"===a.kind?e.data.startsWith(a.value)||(r=this._getOrReturnCtx(e,r),y(r,{code:p.invalid_string,validation:{startsWith:a.value},message:a.message}),n.dirty()):"endsWith"===a.kind?e.data.endsWith(a.value)||(r=this._getOrReturnCtx(e,r),y(r,{code:p.invalid_string,validation:{endsWith:a.value},message:a.message}),n.dirty()):"datetime"===a.kind?(o=a,(o.precision?o.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${o.precision}}(([+-]\\d{2}:\\d{2})|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${o.precision}}Z$`):0===o.precision?o.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}:\\d{2})|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):o.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}:\\d{2})|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$")).test(e.data)||(r=this._getOrReturnCtx(e,r),y(r,{code:p.invalid_string,validation:"datetime",message:a.message}),n.dirty())):k.assertNever(a);return{status:n.value,value:e.data}}_addCheck(e){return new xe({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...I.errToObj(e)})}url(e){return this._addCheck({kind:"url",...I.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...I.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...I.errToObj(e)})}datetime(e){var s;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:"u"<typeof(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!=(s=null==e?void 0:e.offset)&&s,...I.errToObj(null==e?void 0:e.message)})}regex(e,s){return this._addCheck({kind:"regex",regex:e,...I.errToObj(s)})}startsWith(e,s){return this._addCheck({kind:"startsWith",value:e,...I.errToObj(s)})}endsWith(e,s){return this._addCheck({kind:"endsWith",value:e,...I.errToObj(s)})}min(e,s){return this._addCheck({kind:"min",value:e,...I.errToObj(s)})}max(e,s){return this._addCheck({kind:"max",value:e,...I.errToObj(s)})}length(e,s){return this._addCheck({kind:"length",value:e,...I.errToObj(s)})}get isDatetime(){return!!this._def.checks.find(e=>"datetime"===e.kind)}get isEmail(){return!!this._def.checks.find(e=>"email"===e.kind)}get isURL(){return!!this._def.checks.find(e=>"url"===e.kind)}get isUUID(){return!!this._def.checks.find(e=>"uuid"===e.kind)}get isCUID(){return!!this._def.checks.find(e=>"cuid"===e.kind)}get minLength(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return e}get maxLength(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return e}}xe.create=t=>{var e;return new xe({checks:[],typeName:v.ZodString,coerce:null!=(e=null==t?void 0:t.coerce)&&e,...S(t)})};class Re extends T{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){var a;if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==m.number)return y(a=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.number,received:a.parsedType}),w;let n;var r=new Y;for(const a of this._def.checks)"int"===a.kind?k.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),y(n,{code:p.invalid_type,expected:"integer",received:"float",message:a.message}),r.dirty()):"min"===a.kind?(a.inclusive?e.data<a.value:e.data<=a.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:p.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"max"===a.kind?(a.inclusive?e.data>a.value:e.data>=a.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:p.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),r.dirty()):"multipleOf"===a.kind?0!==function(t,e){var s=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=n<s?s:n;return parseInt(t.toFixed(s).replace(".",""))%parseInt(e.toFixed(s).replace(".",""))/Math.pow(10,s)}(e.data,a.value)&&(n=this._getOrReturnCtx(e,n),y(n,{code:p.not_multiple_of,multipleOf:a.value,message:a.message}),r.dirty()):"finite"===a.kind?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),y(n,{code:p.not_finite,message:a.message}),r.dirty()):k.assertNever(a);return{status:r.value,value:e.data}}gte(e,s){return this.setLimit("min",e,!0,I.toString(s))}gt(e,s){return this.setLimit("min",e,!1,I.toString(s))}lte(e,s){return this.setLimit("max",e,!0,I.toString(s))}lt(e,s){return this.setLimit("max",e,!1,I.toString(s))}setLimit(e,s,n,r){return new Re({...this._def,checks:[...this._def.checks,{kind:e,value:s,inclusive:n,message:I.toString(r)}]})}_addCheck(e){return new Re({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:I.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:I.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:I.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:I.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:I.toString(e)})}multipleOf(e,s){return this._addCheck({kind:"multipleOf",value:e,message:I.toString(s)})}finite(e){return this._addCheck({kind:"finite",message:I.toString(e)})}get minValue(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return e}get maxValue(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return e}get isInt(){return!!this._def.checks.find(e=>"int"===e.kind)}}Re.create=t=>new Re({checks:[],typeName:v.ZodNumber,coerce:(null==t?void 0:t.coerce)||!1,...S(t)});class at extends T{_parse(e){var n;return this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==m.bigint?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.bigint,received:n.parsedType}),w):G(e.data)}}at.create=t=>{var e;return new at({typeName:v.ZodBigInt,coerce:null!=(e=null==t?void 0:t.coerce)&&e,...S(t)})};class it extends T{_parse(e){var n;return this._def.coerce&&(e.data=Boolean(e.data)),this._getType(e)!==m.boolean?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.boolean,received:n.parsedType}),w):G(e.data)}}it.create=t=>new it({typeName:v.ZodBoolean,coerce:(null==t?void 0:t.coerce)||!1,...S(t)});class De extends T{_parse(e){var a;if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==m.date)return y(a=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.date,received:a.parsedType}),w;if(isNaN(e.data.getTime())){const a=this._getOrReturnCtx(e);return y(a,{code:p.invalid_date}),w}var n=new Y;let r;for(const a of this._def.checks)"min"===a.kind?e.data.getTime()<a.value&&(r=this._getOrReturnCtx(e,r),y(r,{code:p.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),n.dirty()):"max"===a.kind?e.data.getTime()>a.value&&(r=this._getOrReturnCtx(e,r),y(r,{code:p.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),n.dirty()):k.assertNever(a);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new De({...this._def,checks:[...this._def.checks,e]})}min(e,s){return this._addCheck({kind:"min",value:e.getTime(),message:I.toString(s)})}max(e,s){return this._addCheck({kind:"max",value:e.getTime(),message:I.toString(s)})}get minDate(){let e=null;for(const s of this._def.checks)"min"===s.kind&&(null===e||s.value>e)&&(e=s.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const s of this._def.checks)"max"===s.kind&&(null===e||s.value<e)&&(e=s.value);return null!=e?new Date(e):null}}De.create=t=>new De({checks:[],coerce:(null==t?void 0:t.coerce)||!1,typeName:v.ZodDate,...S(t)});class Lt extends T{_parse(e){var n;return this._getType(e)!==m.symbol?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.symbol,received:n.parsedType}),w):G(e.data)}}Lt.create=t=>new Lt({typeName:v.ZodSymbol,...S(t)});class ot extends T{_parse(e){var n;return this._getType(e)!==m.undefined?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.undefined,received:n.parsedType}),w):G(e.data)}}ot.create=t=>new ot({typeName:v.ZodUndefined,...S(t)});class ct extends T{_parse(e){var n;return this._getType(e)!==m.null?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.null,received:n.parsedType}),w):G(e.data)}}ct.create=t=>new ct({typeName:v.ZodNull,...S(t)});class Ge extends T{constructor(){super(...arguments),this._any=!0}_parse(e){return G(e.data)}}Ge.create=t=>new Ge({typeName:v.ZodAny,...S(t)});class Ve extends T{constructor(){super(...arguments),this._unknown=!0}_parse(e){return G(e.data)}}Ve.create=t=>new Ve({typeName:v.ZodUnknown,...S(t)});class Te extends T{_parse(e){e=this._getOrReturnCtx(e);return y(e,{code:p.invalid_type,expected:m.never,received:e.parsedType}),w}}Te.create=t=>new Te({typeName:v.ZodNever,...S(t)});class Pt extends T{_parse(e){var n;return this._getType(e)!==m.undefined?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.void,received:n.parsedType}),w):G(e.data)}}Pt.create=t=>new Pt({typeName:v.ZodVoid,...S(t)});class le extends T{_parse(e){const{ctx:s,status:n}=this._processInputParams(e),r=this._def;var c;return s.parsedType!==m.array?(y(s,{code:p.invalid_type,expected:m.array,received:s.parsedType}),w):(null!==r.exactLength&&(e=s.data.length>r.exactLength.value,c=s.data.length<r.exactLength.value,e||c)&&(y(s,{code:e?p.too_big:p.too_small,minimum:c?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty()),null!==r.minLength&&s.data.length<r.minLength.value&&(y(s,{code:p.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&s.data.length>r.maxLength.value&&(y(s,{code:p.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),s.common.async?Promise.all(s.data.map((o,c)=>r.type._parseAsync(new pe(s,o,s.path,c)))).then(o=>Y.mergeArray(n,o)):(c=s.data.map((o,c)=>r.type._parseSync(new pe(s,o,s.path,c))),Y.mergeArray(n,c)))}get element(){return this._def.type}min(e,s){return new le({...this._def,minLength:{value:e,message:I.toString(s)}})}max(e,s){return new le({...this._def,maxLength:{value:e,message:I.toString(s)}})}length(e,s){return new le({...this._def,exactLength:{value:e,message:I.toString(s)}})}nonempty(e){return this.min(1,e)}}le.create=(t,e)=>new le({type:t,minLength:null,maxLength:null,exactLength:null,typeName:v.ZodArray,...S(e)}),(Dt||(Dt={})).mergeShapes=(e,s)=>({...e,...s});const Ws=t=>e=>new P({...t,shape:()=>({...t.shape(),...e})});class P extends T{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=Ws(this._def),this.extend=Ws(this._def)}_getCached(){var e,s;return null!==this._cached?this._cached:(e=this._def.shape(),s=k.objectKeys(e),this._cached={shape:e,keys:s})}_parse(e){var u;if(this._getType(e)!==m.object)return y(u=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.object,received:u.parsedType}),w;const{status:n,ctx:r}=this._processInputParams(e),{shape:a,keys:o}=this._getCached(),c=[];if(!(this._def.catchall instanceof Te&&"strip"===this._def.unknownKeys))for(const u in r.data)o.includes(u)||c.push(u);const l=[];for(const u of o){var h=a[u],x=r.data[u];l.push({key:{status:"valid",value:u},value:h._parse(new pe(r,x,r.path,u)),alwaysSet:u in r.data})}if(this._def.catchall instanceof Te){const u=this._def.unknownKeys;if("passthrough"===u)for(const h of c)l.push({key:{status:"valid",value:h},value:{status:"valid",value:r.data[h]}});else if("strict"===u)0<c.length&&(y(r,{code:p.unrecognized_keys,keys:c}),n.dirty());else if("strip"!==u)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const u=this._def.catchall;for(const h of c){const x=r.data[h];l.push({key:{status:"valid",value:h},value:u._parse(new pe(r,x,r.path,h)),alwaysSet:h in r.data})}}return r.common.async?Promise.resolve().then(async()=>{var u=[];for(const h of l){var x=await h.key;u.push({key:x,value:await h.value,alwaysSet:h.alwaysSet})}return u}).then(u=>Y.mergeObjectSync(n,u)):Y.mergeObjectSync(n,l)}get shape(){return this._def.shape()}strict(e){return I.errToObj,new P({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(s,n)=>{var a,r=null!=(a=null==(a=(r=this._def).errorMap)?void 0:a.call(r,s,n).message)?a:n.defaultError;return"unrecognized_keys"===s.code?{message:null!=(a=I.errToObj(e).message)?a:r}:{message:r}}}:{}})}strip(){return new P({...this._def,unknownKeys:"strip"})}passthrough(){return new P({...this._def,unknownKeys:"passthrough"})}setKey(e,s){return this.augment({[e]:s})}merge(e){return new P({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>Dt.mergeShapes(this._def.shape(),e._def.shape()),typeName:v.ZodObject})}catchall(e){return new P({...this._def,catchall:e})}pick(e){const s={};return k.objectKeys(e).map(n=>{this.shape[n]&&(s[n]=this.shape[n])}),new P({...this._def,shape:()=>s})}omit(e){const s={};return k.objectKeys(this.shape).map(n=>{-1===k.objectKeys(e).indexOf(n)&&(s[n]=this.shape[n])}),new P({...this._def,shape:()=>s})}deepPartial(){return function Xe(t){if(t instanceof P){const e={};for(const s in t.shape){var n=t.shape[s];e[s]=ge.create(Xe(n))}return new P({...t._def,shape:()=>e})}return t instanceof le?le.create(Xe(t.element)):t instanceof ge?ge.create(Xe(t.unwrap())):t instanceof Ze?Ze.create(Xe(t.unwrap())):t instanceof me?me.create(t.items.map(e=>Xe(e))):t}(this)}partial(e){const s={};if(e)k.objectKeys(this.shape).map(n=>{-1===k.objectKeys(e).indexOf(n)?s[n]=this.shape[n]:s[n]=this.shape[n].optional()});else for(const n in this.shape){var r=this.shape[n];s[n]=r.optional()}return new P({...this._def,shape:()=>s})}required(e){const s={};if(e)k.objectKeys(this.shape).map(n=>{if(-1===k.objectKeys(e).indexOf(n))s[n]=this.shape[n];else{let a=this.shape[n];for(;a instanceof ge;)a=a._def.innerType;s[n]=a}});else for(const n in this.shape){let a=this.shape[n];for(;a instanceof ge;)a=a._def.innerType;s[n]=a}return new P({...this._def,shape:()=>s})}keyof(){return zs(k.objectKeys(this.shape))}}P.create=(t,e)=>new P({shape:()=>t,unknownKeys:"strip",catchall:Te.create(),typeName:v.ZodObject,...S(e)}),P.strictCreate=(t,e)=>new P({shape:()=>t,unknownKeys:"strict",catchall:Te.create(),typeName:v.ZodObject,...S(e)}),P.lazycreate=(t,e)=>new P({shape:t,unknownKeys:"strip",catchall:Te.create(),typeName:v.ZodObject,...S(e)});class dt extends T{_parse(e){const s=this._processInputParams(e)["ctx"],n=this._def.options;if(s.common.async)return Promise.all(n.map(async a=>{var o={...s,common:{...s.common,issues:[]},parent:null};return{result:await a._parseAsync({data:s.data,path:s.path,parent:o}),ctx:o}})).then(function(a){for(const c of a)if("valid"===c.result.status)return c.result;for(const c of a)if("dirty"===c.result.status)return s.common.issues.push(...c.ctx.common.issues),c.result;return a=a.map(c=>new be(c.ctx.common.issues)),y(s,{code:p.invalid_union,unionErrors:a}),w});{let a;var o=[];for(const l of n){var u={...s,common:{...s.common,issues:[]},parent:null},h=l._parseSync({data:s.data,path:s.path,parent:u});if("valid"===h.status)return h;"dirty"!==h.status||a||(a={result:h,ctx:u}),u.common.issues.length&&o.push(u.common.issues)}return a?(s.common.issues.push(...a.ctx.common.issues),a.result):(e=o.map(l=>new be(l)),y(s,{code:p.invalid_union,unionErrors:e}),w)}}get options(){return this._def.options}}dt.create=(t,e)=>new dt({options:t,typeName:v.ZodUnion,...S(e)});const Vt=t=>t instanceof ft?Vt(t.schema):t instanceof fe?Vt(t.innerType()):t instanceof ht?[t.value]:t instanceof pt?t.options:t instanceof mt?Object.keys(t.enum):t instanceof gt?Vt(t._def.innerType):t instanceof ot?[void 0]:t instanceof ct?[null]:null;class Ut extends T{_parse(e){var n,r,e=this._processInputParams(e)["ctx"];return e.parsedType!==m.object?(y(e,{code:p.invalid_type,expected:m.object,received:e.parsedType}),w):(n=this.discriminator,r=e.data[n],(r=this.optionsMap.get(r))?e.common.async?r._parseAsync({data:e.data,path:e.path,parent:e}):r._parseSync({data:e.data,path:e.path,parent:e}):(y(e,{code:p.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),w))}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,s,n){var r=new Map;for(const a of s){var o=Vt(a.shape[e]);if(!o)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const c of o){if(r.has(c))throw new Error(`Discriminator property ${String(e)} has duplicate value `+String(c));r.set(c,a)}}return new Ut({typeName:v.ZodDiscriminatedUnion,discriminator:e,options:s,optionsMap:r,...S(n)})}}class ut extends T{_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=(a,o)=>{var c;return rs(a)||rs(o)?w:(c=function is(t,e){var s=ke(t),n=ke(e);if(t===e)return{valid:!0,data:t};if(s===m.object&&n===m.object){const r=k.objectKeys(e),a=k.objectKeys(t).filter(c=>-1!==r.indexOf(c)),o={...t,...e};for(const c of a){var l=is(t[c],e[c]);if(!l.valid)return{valid:!1};o[c]=l.data}return{valid:!0,data:o}}if(s!==m.array||n!==m.array)return s===m.date&&n===m.date&&+t==+e?{valid:!0,data:t}:{valid:!1};if(t.length!==e.length)return{valid:!1};var r=[];for(let a=0;a<t.length;a++){const o=t[a],c=e[a],l=is(o,c);if(!l.valid)return{valid:!1};r.push(l.data)}return{valid:!0,data:r}}(a.value,o.value)).valid?((as(a)||as(o))&&s.dirty(),{status:s.value,value:c.data}):(y(n,{code:p.invalid_intersection_types}),w)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([a,o])=>r(a,o)):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}ut.create=(t,e,s)=>new ut({left:t,right:e,typeName:v.ZodIntersection,...S(s)});class me extends T{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==m.array)return y(n,{code:p.invalid_type,expected:m.array,received:n.parsedType}),w;if(n.data.length<this._def.items.length)return y(n,{code:p.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),w;!this._def.rest&&n.data.length>this._def.items.length&&(y(n,{code:p.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),s.dirty());e=n.data.map((o,c)=>{var l=this._def.items[c]||this._def.rest;return l?l._parse(new pe(n,o,n.path,c)):null}).filter(o=>!!o);return n.common.async?Promise.all(e).then(o=>Y.mergeArray(s,o)):Y.mergeArray(s,e)}get items(){return this._def.items}rest(e){return new me({...this._def,rest:e})}}me.create=(t,e)=>{if(Array.isArray(t))return new me({items:t,typeName:v.ZodTuple,rest:null,...S(e)});throw new Error("You must pass an array of schemas to z.tuple([ ... ])")};class lt extends T{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){var{status:e,ctx:n}=this._processInputParams(e);if(n.parsedType!==m.object)return y(n,{code:p.invalid_type,expected:m.object,received:n.parsedType}),w;var r=[],a=this._def.keyType,o=this._def.valueType;for(const c in n.data)r.push({key:a._parse(new pe(n,c,n.path,c)),value:o._parse(new pe(n,n.data[c],n.path,c))});return n.common.async?Y.mergeObjectAsync(e,r):Y.mergeObjectSync(e,r)}get element(){return this._def.valueType}static create(e,s,n){return s instanceof T?new lt({keyType:e,valueType:s,typeName:v.ZodRecord,...S(n)}):new lt({keyType:xe.create(),valueType:e,typeName:v.ZodRecord,...S(s)})}}class Zt extends T{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==m.map)return y(n,{code:p.invalid_type,expected:m.map,received:n.parsedType}),w;const r=this._def.keyType,a=this._def.valueType,o=[...n.data.entries()].map(([c,l],u)=>({key:r._parse(new pe(n,c,n.path,[u,"key"])),value:a._parse(new pe(n,l,n.path,[u,"value"]))}));if(n.common.async){const c=new Map;return Promise.resolve().then(async()=>{for(const l of o){var u=await l.key,h=await l.value;if("aborted"===u.status||"aborted"===h.status)return w;"dirty"!==u.status&&"dirty"!==h.status||s.dirty(),c.set(u.value,h.value)}return{status:s.value,value:c}})}var c=new Map;for(const l of o){var u=l.key,h=l.value;if("aborted"===u.status||"aborted"===h.status)return w;"dirty"!==u.status&&"dirty"!==h.status||s.dirty(),c.set(u.value,h.value)}return{status:s.value,value:c}}}Zt.create=(t,e,s)=>new Zt({valueType:e,keyType:t,typeName:v.ZodMap,...S(s)});class Ue extends T{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);if(n.parsedType!==m.set)return y(n,{code:p.invalid_type,expected:m.set,received:n.parsedType}),w;e=this._def;null!==e.minSize&&n.data.size<e.minSize.value&&(y(n,{code:p.too_small,minimum:e.minSize.value,type:"set",inclusive:!0,exact:!1,message:e.minSize.message}),s.dirty()),null!==e.maxSize&&n.data.size>e.maxSize.value&&(y(n,{code:p.too_big,maximum:e.maxSize.value,type:"set",inclusive:!0,exact:!1,message:e.maxSize.message}),s.dirty());const a=this._def.valueType;function o(l){var u=new Set;for(const h of l){if("aborted"===h.status)return w;"dirty"===h.status&&s.dirty(),u.add(h.value)}return{status:s.value,value:u}}e=[...n.data.values()].map((l,u)=>a._parse(new pe(n,l,n.path,u)));return n.common.async?Promise.all(e).then(l=>o(l)):o(e)}min(e,s){return new Ue({...this._def,minSize:{value:e,message:I.toString(s)}})}max(e,s){return new Ue({...this._def,maxSize:{value:e,message:I.toString(s)}})}size(e,s){return this.min(e,s).max(e,s)}nonempty(e){return this.min(1,e)}}Ue.create=(t,e)=>new Ue({valueType:t,minSize:null,maxSize:null,typeName:v.ZodSet,...S(e)});class Ke extends T{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const s=this._processInputParams(e)["ctx"];if(s.parsedType!==m.function)return y(s,{code:p.invalid_type,expected:m.function,received:s.parsedType}),w;function n(c,l){return Ot({data:c,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,js,rt].filter(u=>!!u),issueData:{code:p.invalid_arguments,argumentsError:l}})}function r(c,l){return Ot({data:c,path:s.path,errorMaps:[s.common.contextualErrorMap,s.schemaErrorMap,js,rt].filter(u=>!!u),issueData:{code:p.invalid_return_type,returnTypeError:l}})}const a={errorMap:s.common.contextualErrorMap},o=s.data;return this._def.returns instanceof Ye?G(async(...c)=>{const l=new be([]),u=await this._def.args.parseAsync(c,a).catch(M=>{throw l.addIssue(n(c,M)),l}),h=await o(...u);return this._def.returns._def.type.parseAsync(h,a).catch(M=>{throw l.addIssue(r(h,M)),l})}):G((...c)=>{var l=this._def.args.safeParse(c,a);if(!l.success)throw new be([n(c,l.error)]);c=o(...l.data),l=this._def.returns.safeParse(c,a);if(l.success)return l.data;throw new be([r(c,l.error)])})}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Ke({...this._def,args:me.create(e).rest(Ve.create())})}returns(e){return new Ke({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,s,n){return new Ke({args:e||me.create([]).rest(Ve.create()),returns:s||Ve.create(),typeName:v.ZodFunction,...S(n)})}}class ft extends T{get schema(){return this._def.getter()}_parse(e){e=this._processInputParams(e).ctx;return this._def.getter()._parse({data:e.data,path:e.path,parent:e})}}ft.create=(t,e)=>new ft({getter:t,typeName:v.ZodLazy,...S(e)});class ht extends T{_parse(e){return e.data!==this._def.value?(y(this._getOrReturnCtx(e),{code:p.invalid_literal,expected:this._def.value}),w):{status:"valid",value:e.data}}get value(){return this._def.value}}function zs(t,e){return new pt({values:t,typeName:v.ZodEnum,...S(e)})}ht.create=(t,e)=>new ht({value:t,typeName:v.ZodLiteral,...S(e)});class pt extends T{_parse(e){var s,n;if("string"!=typeof e.data)return s=this._getOrReturnCtx(e),n=this._def.values,y(s,{expected:k.joinValues(n),received:s.parsedType,code:p.invalid_type}),w;if(-1!==this._def.values.indexOf(e.data))return G(e.data);{const s=this._getOrReturnCtx(e),n=this._def.values;return y(s,{received:s.data,code:p.invalid_enum_value,options:n}),w}}get options(){return this._def.values}get enum(){var e={};for(const s of this._def.values)e[s]=s;return e}get Values(){var e={};for(const s of this._def.values)e[s]=s;return e}get Enum(){var e={};for(const s of this._def.values)e[s]=s;return e}}pt.create=zs;class mt extends T{_parse(e){var r,s=k.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==m.string&&n.parsedType!==m.number)return r=k.objectValues(s),y(n,{expected:k.joinValues(r),received:n.parsedType,code:p.invalid_type}),w;if(-1!==s.indexOf(e.data))return G(e.data);{const r=k.objectValues(s);return y(n,{received:n.data,code:p.invalid_enum_value,options:r}),w}}get enum(){return this._def.values}}mt.create=(t,e)=>new mt({values:t,typeName:v.ZodNativeEnum,...S(e)});class Ye extends T{_parse(e){const s=this._processInputParams(e)["ctx"];return s.parsedType!==m.promise&&!1===s.common.async?(y(s,{code:p.invalid_type,expected:m.promise,received:s.parsedType}),w):(e=s.parsedType===m.promise?s.data:Promise.resolve(s.data),G(e.then(r=>this._def.type.parseAsync(r,{path:s.path,errorMap:s.common.contextualErrorMap}))))}}Ye.create=(t,e)=>new Ye({type:t,typeName:v.ZodPromise,...S(e)});class fe extends T{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===v.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:s,ctx:n}=this._processInputParams(e),r=this._def.effect||null;if("preprocess"===r.type)return e=r.transform(n.data),n.common.async?Promise.resolve(e).then(c=>this._def.schema._parseAsync({data:c,path:n.path,parent:n})):this._def.schema._parseSync({data:e,path:n.path,parent:n});const a={addIssue:o=>{y(n,o),o.fatal?s.abort():s.dirty()},get path(){return n.path}};if(a.addIssue=a.addIssue.bind(a),"refinement"===r.type){const o=c=>{var l=r.refinement(c,a);if(n.common.async)return Promise.resolve(l);if(l instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return c};return!1===n.common.async?"aborted"===(e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n})).status?w:("dirty"===e.status&&s.dirty(),o(e.value),{status:s.value,value:e.value}):this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(c=>"aborted"===c.status?w:("dirty"===c.status&&s.dirty(),o(c.value).then(()=>({status:s.value,value:c.value}))))}if("transform"===r.type){if(!1!==n.common.async)return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>Mt(o)?Promise.resolve(r.transform(o.value,a)).then(c=>({status:s.value,value:c})):o);{const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Mt(o))return o;const c=r.transform(o.value,a);if(c instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:s.value,value:c}}}k.assertNever(r)}}fe.create=(t,e,s)=>new fe({schema:t,typeName:v.ZodEffects,effect:e,...S(s)}),fe.createWithPreprocess=(t,e,s)=>new fe({schema:e,effect:{type:"preprocess",transform:t},typeName:v.ZodEffects,...S(s)});class ge extends T{_parse(e){return this._getType(e)===m.undefined?G(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ge.create=(t,e)=>new ge({innerType:t,typeName:v.ZodOptional,...S(e)});class Ze extends T{_parse(e){return this._getType(e)===m.null?G(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Ze.create=(t,e)=>new Ze({innerType:t,typeName:v.ZodNullable,...S(e)});class gt extends T{_parse(e){e=this._processInputParams(e).ctx;let n=e.data;return e.parsedType===m.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:e.path,parent:e})}removeDefault(){return this._def.innerType}}gt.create=(t,e)=>new gt({innerType:t,typeName:v.ZodDefault,defaultValue:"function"==typeof e.default?e.default:()=>e.default,...S(e)});class jt extends T{_parse(e){e=this._processInputParams(e).ctx,e=this._def.innerType._parse({data:e.data,path:e.path,parent:e});return Ct(e)?e.then(r=>({status:"valid",value:"valid"===r.status?r.value:this._def.defaultValue()})):{status:"valid",value:"valid"===e.status?e.value:this._def.defaultValue()}}removeDefault(){return this._def.innerType}}jt.create=(t,e)=>new jt({innerType:t,typeName:v.ZodCatch,defaultValue:"function"==typeof e.default?e.default:()=>e.default,...S(e)});class $t extends T{_parse(e){var n;return this._getType(e)!==m.nan?(y(n=this._getOrReturnCtx(e),{code:p.invalid_type,expected:m.nan,received:n.parsedType}),w):{status:"valid",value:e.data}}}$t.create=t=>new $t({typeName:v.ZodNaN,...S(t)});var v,cr=Symbol("zod_brand");class Fs extends T{_parse(e){var e=this._processInputParams(e)["ctx"],n=e.data;return this._def.type._parse({data:n,path:e.path,parent:e})}unwrap(){return this._def.type}}class yt extends T{_parse(e){const{status:s,ctx:n}=this._processInputParams(e);return n.common.async?(async()=>{var a=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===a.status?w:"dirty"===a.status?(s.dirty(),$s(a.value)):this._def.out._parseAsync({data:a.value,path:n.path,parent:n})})():"aborted"===(e=this._def.in._parseSync({data:n.data,path:n.path,parent:n})).status?w:"dirty"===e.status?(s.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}static create(e,s){return new yt({in:e,out:s,typeName:v.ZodPipeline})}}const Hs=(t,e={},s)=>t?Ge.create().superRefine((n,r)=>{t(n)||(n="function"==typeof e?e(n):e,r.addIssue({code:"custom",..."string"==typeof n?{message:n}:n,fatal:s}))}):Ge.create(),dr={object:P.lazycreate},X=(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline"}(v=v||{}),xe.create),V=Re.create,lr=$t.create,fr=at.create,Bt=it.create,hr=De.create,pr=Lt.create,mr=ot.create,gr=ct.create,qs=Ge.create,yr=Ve.create,_r=Te.create,Ar=Pt.create,vr=le.create,ae=P.create,wr=P.strictCreate,os=dt.create,br=Ut.create,xr=ut.create,Tr=me.create,Gs=lt.create,Sr=Zt.create,Er=Ue.create,Ir=Ke.create,Nr=ft.create,kr=ht.create,Je=pt.create,Rr=mt.create,Or=Ye.create,Xs=fe.create,Mr=ge.create,Cr=Ze.create,Lr=fe.createWithPreprocess,Pr=yt.create;cr=Object.freeze({__proto__:null,defaultErrorMap:rt,setErrorMap:function(t){js=t},getErrorMap:Rt,makeIssue:Ot,EMPTY_PATH:[],addIssueToContext:y,ParseStatus:Y,INVALID:w,DIRTY:$s,OK:G,isAborted:rs,isDirty:as,isValid:Mt,isAsync:Ct,get util(){return k},ZodParsedType:m,getParsedType:ke,ZodType:T,ZodString:xe,ZodNumber:Re,ZodBigInt:at,ZodBoolean:it,ZodDate:De,ZodSymbol:Lt,ZodUndefined:ot,ZodNull:ct,ZodAny:Ge,ZodUnknown:Ve,ZodNever:Te,ZodVoid:Pt,ZodArray:le,get objectUtil(){return Dt},ZodObject:P,ZodUnion:dt,ZodDiscriminatedUnion:Ut,ZodIntersection:ut,ZodTuple:me,ZodRecord:lt,ZodMap:Zt,ZodSet:Ue,ZodFunction:Ke,ZodLazy:ft,ZodLiteral:ht,ZodEnum:pt,ZodNativeEnum:mt,ZodPromise:Ye,ZodEffects:fe,ZodTransformer:fe,ZodOptional:ge,ZodNullable:Ze,ZodDefault:gt,ZodCatch:jt,ZodNaN:$t,BRAND:cr,ZodBranded:Fs,ZodPipeline:yt,custom:Hs,Schema:T,ZodSchema:T,late:dr,get ZodFirstPartyTypeKind(){return v},coerce:{string:t=>xe.create({...t,coerce:!0}),number:t=>Re.create({...t,coerce:!0}),boolean:t=>it.create({...t,coerce:!0}),bigint:t=>at.create({...t,coerce:!0}),date:t=>De.create({...t,coerce:!0})},any:qs,array:vr,bigint:fr,boolean:Bt,date:hr,discriminatedUnion:br,effect:Xs,enum:Je,function:Ir,instanceof:(t,e={message:"Input not instance of "+t.name})=>Hs(s=>s instanceof t,e,!0),intersection:xr,lazy:Nr,literal:kr,map:Sr,nan:lr,nativeEnum:Rr,never:_r,null:gr,nullable:Cr,number:V,object:ae,oboolean:()=>Bt().optional(),onumber:()=>V().optional(),optional:Mr,ostring:()=>X().optional(),pipeline:Pr,preprocess:Lr,promise:Or,record:Gs,set:Er,strictObject:wr,string:X,symbol:pr,transformer:Xs,tuple:Tr,undefined:mr,union:os,unknown:yr,void:Ar,NEVER:w,ZodIssueCode:p,quotelessJson:t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:be});const Wt=()=>X().uuid(),Dr=/^(?=.{1,255}$)[0-9A-Za-z_](?:(?:[0-9A-Za-z_]|-){0,61}[0-9A-Za-z_])?(?:\.[0-9A-Za-z_](?:(?:[0-9A-Za-z_]|-){0,61}[0-9A-Za-z_])?)*\.?$/,Ks=()=>X().regex(Dr);ae({id:Wt(),host:Ks(),startedAt:V().positive(),endedAt:V().nullable().optional()}).strict();var Ys=ae({id:Wt(),sessionId:Wt(),adUrl:X().url(),timestamp:V().positive().describe("The time in ms since 1970 that this ad was seen at")}).strict(),Vr=Ys.extend({type:Je(["image"]),additionalDetails:ae({width:V().nonnegative(),height:V().nonnegative()})}).strict(),Ys=Ys.extend({type:Je(["iframe"]),additionalDetails:ae({width:V().nonnegative(),height:V().nonnegative()})}).strict();os([Vr,Ys]);const cs=Wt,Js=Ks,ds=()=>Bt().nullable().optional(),us=()=>Bt().nullable().optional(),Qs=(ae({id:cs(),host:Js(),startedAt:V().positive(),endedAt:V().nullable().optional(),imported:ds(),generated:us()}).strict(),ae({id:X(),sessionId:cs(),timestamp:V().positive().describe("The time in ms since 1970 that this ad was seen at"),imported:ds()}).strict()),Zr=Qs.extend({type:Je(["basic-display"]),details:ae({type:Je(["image","iframe"]),url:X().url().describe("The URL the ad is accessible at"),width:V().nonnegative(),height:V().nonnegative()}).strict()}),$r=Qs.extend({type:Je(["youtube/hulu/vast","pathmatics"]),details:Gs(X(),qs())}),Br=os([Zr,$r]),ls=cs,fs=ds,Wr=us,hs=()=>Js().describe("The mobile app bundle ID or website hostname"),zr=ae({id:ls(),appId:hs(),createdBy:X({description:"The install id that created the session"}),startedAt:V().positive(),endedAt:V(),imported:fs(),generated:Wr()}).strict(),Fr=ae({id:ls(),appId:hs(),createdBy:X(),startedAt:V().positive(),endedAt:V().nullable().optional(),imported:fs(),generated:us()}).strict(),Hr=Br,en=ls,tn=fs,sn=hs,qr=zr,Gr=Fr,Xr=ae({id:en(),appId:sn(),path:X(),referrer:X().nullish(),createdBy:X(),startedAt:V().positive(),endedAt:V(),imported:tn()}).strict(),Kr=ae({id:en(),appId:sn(),path:X(),referrer:X().nullish(),createdBy:X(),startedAt:V().positive(),endedAt:V().nullish(),imported:tn()}).strict(),Yr=Hr,nn=qr,ps=Gr,rn=Xr,an=Kr,ms=Yr;class gs{constructor(e,s){this.db=e,this.storeName=s}async deleteAll(){var s=(await this.db).transaction(this.storeName,"readwrite");let n=await s.objectStore(this.storeName).openCursor();for(;n;)await n.delete(),n=await n.continue();await s.done}async findAll(){return(await this.db).getAll(this.storeName)}}const _t=class extends gs{constructor(t){super(t.db,_t.STORE_NAME_LATEST),this.config=t}async findAds(t,e){return(await this.db).getAllFromIndex(this.storeName,_t.INDEX_TIMESTAMP,IDBKeyRange.bound(t,e,!1,!0))}async findAdsForSession(t){return(await this.db).getAllFromIndex(this.storeName,_t.INDEX_SESSION_ID,t)}async upsertAd(t){var n,r,e=await this.db,t=ms.parse(t);return null!=(r=(n=this.config).onAdUpserted)&&r.call(n,t),await e.put(this.storeName,t),t}};let $=_t;$.STORE_NAME_1="ads",$.STORE_NAME_2="ads-2",$.STORE_NAME_LATEST=_t.STORE_NAME_2,$.INDEX_SESSION_ID="idx_ad_sessionId",$.INDEX_TIMESTAMP="idx_ad_timestamp";let zt;const Jr=new Uint8Array(16);function Qr(){if(zt||(zt=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))return zt(Jr);throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported")}const H=[];for(let t=0;t<256;++t)H.push((t+256).toString(16).slice(1));const on={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function At(t,e,s){if(on.randomUUID&&!e&&!t)return on.randomUUID();var n=(t=t||{}).random||(t.rng||Qr)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,e){s=s||0;for(let r=0;r<16;++r)e[s+r]=n[r];return e}return function(t,e=0){return(H[t[e+0]]+H[t[e+1]]+H[t[e+2]]+H[t[e+3]]+"-"+H[t[e+4]]+H[t[e+5]]+"-"+H[t[e+6]]+H[t[e+7]]+"-"+H[t[e+8]]+H[t[e+9]]+"-"+H[t[e+10]]+H[t[e+11]]+H[t[e+12]]+H[t[e+13]]+H[t[e+14]]+H[t[e+15]]).toLowerCase()}(n)}function _s(t){return{id:t.id,appId:t.appId,path:t.path,referrer:t.referrer,createdBy:t.createdBy,endedAt:-1===t.endedAt?null:t.endedAt,startedAt:t.startedAt,imported:t.imported}}const vt=class extends gs{constructor(t){super(t.db,vt.STORE_NAME_LATEST),this.config=t}async startPageView(t){var e=await this.db,t=an.parse({...t,id:At(),createdBy:await this.config.getInstallId(),endedAt:void 0}),n=function(t){var e;return{id:t.id,appId:t.appId,path:t.path,referrer:t.referrer,createdBy:t.createdBy,endedAt:null!=(e=t.endedAt)?e:-1,startedAt:t.startedAt,imported:t.imported}}(t);return await e.add(this.storeName,n),t}async endPageView(t,e){var s=await this.db,n=await s.get(this.storeName,t.id);if(null==n)throw Error("Cannot update: PageView not found with id="+t.id);t={...n,endedAt:e};return await s.put(this.storeName,t),_s(t)}async getActivePageViews(){return(await(await this.db).getAllFromIndex(this.storeName,vt.INDEX_ENDED_AT,-1)).map(_s)}async findPageViewsByEndedAt(t,e){return(await(await this.db).getAllFromIndex(this.storeName,vt.INDEX_ENDED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(_s)}async deleteAllGeneratedPageViews(){var e=(await this.db).transaction(this.storeName,"readwrite");let s=await e.store.openCursor();for(;s;)s.value.imported&&await s.delete(),s=await s.continue();await e.done}};let ye=vt;function cn(t,e,s,n){return new(s=s||Promise)(function(a,o){function c(h){try{u(n.next(h))}catch(x){o(x)}}function l(h){try{u(n.throw(h))}catch(x){o(x)}}function u(h){h.done?a(h.value):function(a){return a instanceof s?a:new s(function(o){o(a)})}(h.value).then(c,l)}u((n=n.apply(t,e||[])).next())})}function dn(t,e){var n,r,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},o={next:c(0),throw:c(1),return:c(2)};return"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(u){return function(h){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;o&&u[o=0]&&(s=0),s;)try{if(n=1,r&&(a=2&u[0]?r.return:u[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,u[1])).done)return a;switch(r=0,(u=a?[2&u[0],a.value]:u)[0]){case 0:case 1:a=u;break;case 4:return s.label++,{value:u[1],done:!1};case 5:s.label++,r=u[1],u=[0];continue;case 7:u=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===u[0]||2===u[0])){s=0;continue}if(3===u[0]&&(!a||u[1]>a[0]&&u[1]<a[3]))s.label=u[1];else if(6===u[0]&&s.label<a[1])s.label=a[1],a=u;else{if(!(a&&s.label<a[2])){a[2]&&s.ops.pop(),s.trys.pop();continue}s.label=a[2],s.ops.push(u)}}u=e.call(t,s)}catch(h){u=[6,h],r=0}finally{n=a=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,h])}}}ye.STORE_NAME_1="page_views",ye.STORE_NAME_LATEST=vt.STORE_NAME_1,ye.INDEX_ENDED_AT="idx_page_view_endedAt",ye.INDEX_STARTED_AT="idx_page_view_startedAt";var sa=new Error("request for lock canceled"),na=function(){function t(e,s){void 0===s&&(s=sa),this._value=e,this._cancelError=s,this._weightedQueues=[],this._weightedWaiters=[]}return t.prototype.acquire=function(e){var s=this;if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));return new Promise(function(n,r){s._weightedQueues[e-1]||(s._weightedQueues[e-1]=[]),s._weightedQueues[e-1].push({resolve:n,reject:r}),s._dispatch()})},t.prototype.runExclusive=function(e,s){return void 0===s&&(s=1),cn(this,void 0,void 0,function(){var r,n;return dn(this,function(o){switch(o.label){case 0:return[4,this.acquire(s)];case 1:n=o.sent(),r=n[0],n=n[1],o.label=2;case 2:return o.trys.push([2,,4,5]),[4,e(r)];case 3:return[2,o.sent()];case 4:return n(),[7];case 5:return[2]}})})},t.prototype.waitForUnlock=function(e){var s=this;if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));return new Promise(function(n){s._weightedWaiters[e-1]||(s._weightedWaiters[e-1]=[]),s._weightedWaiters[e-1].push(n),s._dispatch()})},t.prototype.isLocked=function(){return this._value<=0},t.prototype.getValue=function(){return this._value},t.prototype.setValue=function(e){this._value=e,this._dispatch()},t.prototype.release=function(e){if((e=void 0===e?1:e)<=0)throw new Error("invalid weight ".concat(e,": must be positive"));this._value+=e,this._dispatch()},t.prototype.cancel=function(){var e=this;this._weightedQueues.forEach(function(s){return s.forEach(function(n){return n.reject(e._cancelError)})}),this._weightedQueues=[]},t.prototype._dispatch=function(){for(var s=this._value;0<s;s--){var r,a,e=null==(e=this._weightedQueues[s-1])?void 0:e.shift();e&&(r=this._value,a=s,this._value-=s,s=this._value+1,e.resolve([r,this._newReleaser(a)]))}this._drainUnlockWaiters()},t.prototype._newReleaser=function(e){var s=this,n=!1;return function(){n||(n=!0,s.release(e))}},t.prototype._drainUnlockWaiters=function(){for(var e=this._value;0<e;e--)this._weightedWaiters[e-1]&&(this._weightedWaiters[e-1].forEach(function(s){return s()}),this._weightedWaiters[e-1]=[])},t}(),un=function(){function t(e){this._semaphore=new na(1,e)}return t.prototype.acquire=function(){return cn(this,void 0,void 0,function(){var e;return dn(this,function(n){switch(n.label){case 0:return[4,this._semaphore.acquire()];case 1:return e=n.sent(),[2,e[1]]}})})},t.prototype.runExclusive=function(e){return this._semaphore.runExclusive(function(){return e()})},t.prototype.isLocked=function(){return this._semaphore.isLocked()},t.prototype.waitForUnlock=function(){return this._semaphore.waitForUnlock()},t.prototype.release=function(){this._semaphore.isLocked()&&this._semaphore.release()},t.prototype.cancel=function(){return this._semaphore.cancel()},t}(),wt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Vr={exports:{}};typeof globalThis<"u"?globalThis:typeof self<"u"&&self,function(s){var n,r;if(!((r=(n=globalThis.chrome)==null?void 0:n.runtime)!=null&&r.id))throw new Error("This script should only be loaded in a browser extension.");if(typeof globalThis.browser>"u"||Object.getPrototypeOf(globalThis.browser)!==Object.prototype){const a="The message port closed before a response was received.",o=c=>{const l={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(l).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class u extends WeakMap{constructor(A,N=void 0){super(N),this.createItem=A}get(A){return this.has(A)||this.set(A,this.createItem(A)),super.get(A)}}const h=_=>_&&typeof _=="object"&&typeof _.then=="function",x=(_,A)=>(...N)=>{c.runtime.lastError?_.reject(new Error(c.runtime.lastError.message)):A.singleCallbackArg||N.length<=1&&A.singleCallbackArg!==!1?_.resolve(N[0]):_.resolve(N)},M=_=>_==1?"argument":"arguments",ee=(_,A)=>function(R,...Z){if(Z.length<A.minArgs)throw new Error(`Expected at least ${A.minArgs} ${M(A.minArgs)} for ${_}(), got ${Z.length}`);if(Z.length>A.maxArgs)throw new Error(`Expected at most ${A.maxArgs} ${M(A.maxArgs)} for ${_}(), got ${Z.length}`);return new Promise((Q,te)=>{if(A.fallbackToNoCallback)try{R[_](...Z,x({resolve:Q,reject:te},A))}catch(E){console.warn(`${_} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,E),R[_](...Z),A.fallbackToNoCallback=!1,A.noCallback=!0,Q()}else A.noCallback?(R[_](...Z),Q()):R[_](...Z,x({resolve:Q,reject:te},A))})},oe=(_,A,N)=>new Proxy(A,{apply(R,Z,Q){return N.call(Z,_,...Q)}});let J=Function.call.bind(Object.prototype.hasOwnProperty);const Ae=(_,A={},N={})=>{let R=Object.create(null),Z={has(te,E){return E in _||E in R},get(te,E,se){if(E in R)return R[E];if(!(E in _))return;let B=_[E];if(typeof B=="function")if(typeof A[E]=="function")B=oe(_,_[E],A[E]);else if(J(N,E)){let Me=ee(E,N[E]);B=oe(_,_[E],Me)}else B=B.bind(_);else if(typeof B=="object"&&B!==null&&(J(A,E)||J(N,E)))B=Ae(B,A[E],N[E]);else if(J(N,"*"))B=Ae(B,A[E],N["*"]);else return Object.defineProperty(R,E,{configurable:!0,enumerable:!0,get(){return _[E]},set(Me){_[E]=Me}}),B;return R[E]=B,B},set(te,E,se,B){return E in R?R[E]=se:_[E]=se,!0},defineProperty(te,E,se){return Reflect.defineProperty(R,E,se)},deleteProperty(te,E){return Reflect.deleteProperty(R,E)}},Q=Object.create(_);return new Proxy(Q,Z)},ve=_=>({addListener(A,N,...R){A.addListener(_.get(N),...R)},hasListener(A,N){return A.hasListener(_.get(N))},removeListener(A,N){A.removeListener(_.get(N))}}),ne=new u(_=>typeof _!="function"?_:function(N){const R=Ae(N,{},{getContent:{minArgs:0,maxArgs:0}});_(R)}),xt=new u(_=>typeof _!="function"?_:function(N,R,Z){let Q=!1,te,E=new Promise(Be=>{te=function(ce){Q=!0,Be(ce)}}),se;try{se=_(N,R,te)}catch(Be){se=Promise.reject(Be)}const B=se!==!0&&h(se);if(se!==!0&&!B&&!Q)return!1;const Me=Be=>{Be.then(ce=>{Z(ce)},ce=>{let St;ce&&(ce instanceof Error||typeof ce.message=="string")?St=ce.message:St="An unexpected error occurred",Z({__mozWebExtensionPolyfillReject__:!0,message:St})}).catch(ce=>{console.error("Failed to send onMessage rejected reply",ce)})};return Me(B?se:E),!0}),Os=({reject:_,resolve:A},N)=>{c.runtime.lastError?c.runtime.lastError.message===a?A():_(new Error(c.runtime.lastError.message)):N&&N.__mozWebExtensionPolyfillReject__?_(new Error(N.message)):A(N)},Tt=(_,A,N,...R)=>{if(R.length<A.minArgs)throw new Error(`Expected at least ${A.minArgs} ${M(A.minArgs)} for ${_}(), got ${R.length}`);if(R.length>A.maxArgs)throw new Error(`Expected at most ${A.maxArgs} ${M(A.maxArgs)} for ${_}(), got ${R.length}`);return new Promise((Z,Q)=>{const te=Os.bind(null,{resolve:Z,reject:Q});R.push(te),N.sendMessage(...R)})},tt={devtools:{network:{onRequestFinished:ve(ne)}},runtime:{onMessage:ve(xt),onMessageExternal:ve(xt),sendMessage:Tt.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:Tt.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},st={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return l.privacy={network:{"*":st},services:{"*":st},websites:{"*":st}},Ae(c,tt,l)};s.exports=o(chrome)}else s.exports=globalThis.browser}(Vr);const O=Vr.exports;class ra{constructor(e,s=Date.now()){this.logMethod=e,this.startedAt=s}log(e){var s=Date.now()-this.startedAt;this.logMethod(e.replace(/\{duration\}/g,(s/1e3).toFixed(3)+"s"))}}function Ft(t){return Math.round(t/1e3)}async function vs(t){return(await O.storage.local.get(t))[t]}async function bt(t,e){void 0===e?await O.storage.local.remove(t):await O.storage.local.set({[t]:e})}function ca(t,e){const s="string"==typeof e;return t.reduce((r,a)=>{var o=(r=>s?r[e]:e(r))(a);return r[o]=null!=(o=null==(o=r[o])?void 0:o.concat(a))?o:[a],r},{})}function da(t,e){const s="string"==typeof e;return t.reduce((r,a)=>{return r[(r=>s?r[e]:e(r))(a)]=a,r},{})}function fn(t){var e=t.objectStoreNames.length,s=[];for(let n=0;n<e;n++){var r=t.objectStoreNames.item(n);r&&s.push(r)}return s}function hn(t){var e;return{id:t.id,appId:t.appId,createdBy:t.createdBy,endedAt:null!=(e=t.endedAt)?e:-1,startedAt:t.startedAt,imported:t.imported,generated:t.generated}}function je(t){return{id:t.id,appId:t.appId,createdBy:t.createdBy,endedAt:-1===t.endedAt?null:t.endedAt,startedAt:t.startedAt,imported:t.imported,generated:t.generated}}const Se=class extends gs{constructor(t){super(t.db,Se.STORE_NAME_LATEST),this.config=t}async startSession(t){var e=await this.db,t=ps.parse({...t,id:At(),createdBy:await this.config.getInstallId(),endedAt:void 0}),n=hn(t);return await e.add(this.storeName,n),t}async createSessions(t){const e=await this.db,s=await this.config.getInstallId(),n=e.transaction(Se.STORE_NAME_LATEST,"readwrite"),r=n.objectStore(Se.STORE_NAME_LATEST),a=t.map(c=>ps.parse({...c,id:At(),createdBy:s})),o=a.map(hn);return await Promise.all([...o.map(c=>r.add(c)),n.done]),a}async endSession(t,e){var s=await this.db,o=(216e5<=e-t.startedAt&&(null!=(o=(a=this.config).onLongSessionDetected)&&o.call(a,t,e),e=t.startedAt+6e5),await s.get(this.storeName,t.id));if(null==o)throw Error("Cannot update: Session not found with id="+t.id);var a={...o,endedAt:e};return await s.put(this.storeName,a),je(a)}async findAllSessions(){return(await super.findAll()).map(je)}async findSessions(t,e){return(await(await this.db).getAllFromIndex(this.storeName,Se.INDEX_STARTED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(je)}async findSessionsByEndedAt(t,e){return(await(await this.db).getAllFromIndex(this.storeName,Se.INDEX_ENDED_AT,IDBKeyRange.bound(t,e,!1,!0))).map(je)}async findOldestSession(){var s=(await(await this.db).getAllFromIndex(this.storeName,Se.INDEX_STARTED_AT,IDBKeyRange.lowerBound(0,!0))).shift();return s?je(s):void 0}async getSession(t){var s=await(await this.db).get(this.storeName,t);if(null==s)throw Error(`No session with id=${t} was found`);return je(s)}async getActiveSessions(){return(await(await this.db).getAllFromIndex(this.storeName,Se.INDEX_ENDED_AT,-1)).map(je)}async deleteAllGeneratedSessions(){var e=(await this.db).transaction(this.storeName,"readwrite");let s=await e.store.openCursor();for(;s;){var n=s.value;(n.imported||n.generated)&&await s.delete(),s=await s.continue()}await e.done}};let U=Se;U.STORE_NAME_1="sessions",U.STORE_NAME_2="sessions_2",U.STORE_NAME_LATEST=Se.STORE_NAME_2,U.INDEX_ENDED_AT="idx_session_endedAt",U.INDEX_STARTED_AT="idx_session_startedAt";var W=(t=>(t[t.V2=2]="V2",t[t.V3=3]="V3",t[t.V4=4]="V4",t[t.V5=5]="V5",t[t.V6=6]="V6",t[t.V7=7]="V7",t[t.V8=8]="V8",t))({});const pn=cr.object({version:cr.nativeEnum(W),stores:cr.object({[U.STORE_NAME_LATEST]:cr.array(nn).optional(),[ye.STORE_NAME_LATEST]:cr.array(rn).optional(),[$.STORE_NAME_LATEST]:cr.array(ms).optional()})}),ha=cr.object({version:cr.nativeEnum(W),stores:cr.record(cr.string(),cr.array(cr.any()))});function mn(t){return{id:t.id,sessionId:t.sessionId,timestamp:t.timestamp,type:"basic-display",details:{type:t.type,height:t.additionalDetails.height,width:t.additionalDetails.width,url:t.adUrl}}}function Ht(t,e){return{id:t.id,appId:t.host,createdBy:e,startedAt:t.startedAt,endedAt:null!=(e=t.endedAt)?e:-1,imported:t.imported,generated:t.generated}}async function ya({dbPromise:t,usageBackup:e,logger:s,getInstallId:n}){var t=await t,n=(null!=s&&s.debug("[import-backup] Importing...",e),await n()),o=await pn.parseAsync(await async function gn(t,e,s){if(t.version===e)return t;const n=ba[t.version];if(null==n)throw Error(`Failed to upgrade backup version ${t.version}, version not supported`);const r=await n(t,s);return gn(r,e,s)}(e,t.version,{installId:n})),e=fn(t),l=t.transaction(e,"readwrite");for(const u of e){var h=o.stores[u];if(null!=h&&h.length){var x=l.objectStore(u);for(const M of h)null!=s&&s.debug(`[import-backup]: ${u}:`,M),await x.put({...M,imported:!0})}}await l.done}const bs=t=>e=>({...e,version:t}),ba={[W.V2]:bs(W.V3),[W.V3]:t=>{return{version:W.V4,stores:{[U.STORE_NAME_2]:t.stores[U.STORE_NAME_2],[$.STORE_NAME_2]:null==(t=t.stores[$.STORE_NAME_2])?void 0:t.map(mn)}}},[W.V4]:bs(W.V5),[W.V5]:(t,{installId:e})=>{var s;return{version:W.V6,stores:{[U.STORE_NAME_2]:null==(s=t.stores[U.STORE_NAME_2])?void 0:s.map(n=>Ht(n,e)),[$.STORE_NAME_2]:t.stores[$.STORE_NAME_2]}}},[W.V6]:(t,{installId:e})=>{var s;return{version:W.V7,stores:{[U.STORE_NAME_2]:null==(s=t.stores[U.STORE_NAME_2])?void 0:s.map(n=>"host"in n?Ht(n,e):n),[$.STORE_NAME_2]:t.stores[$.STORE_NAME_2]}}},[W.V7]:bs(W.V8),[W.V8]:t=>t};const xa=(t,e)=>e.some(s=>t instanceof s);let yn,_n;const An=new WeakMap,xs=new WeakMap,vn=new WeakMap,Ts=new WeakMap,Ss=new WeakMap;let Es={get(t,e,s){if(t instanceof IDBTransaction){if("done"===e)return xs.get(t);if("objectStoreNames"===e)return t.objectStoreNames||vn.get(t);if("store"===e)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return Oe(t[e])},set(t,e,s){return t[e]=s,!0},has(t,e){return t instanceof IDBTransaction&&("done"===e||"store"===e)||e in t}};function ka(t){return t!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(_n=_n||[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey]).includes(t)?function(...e){return t.apply(Is(this),e),Oe(An.get(this))}:function(...e){return Oe(t.apply(Is(this),e))}:function(e,...s){s=t.call(Is(this),e,...s);return vn.set(s,e.sort?e.sort():[e]),Oe(s)}}function Ra(t){return"function"==typeof t?ka(t):(t instanceof IDBTransaction&&function(t){var e;xs.has(t)||(e=new Promise((s,n)=>{const r=()=>{t.removeEventListener("complete",a),t.removeEventListener("error",o),t.removeEventListener("abort",o)},a=()=>{s(),r()},o=()=>{n(t.error||new DOMException("AbortError","AbortError")),r()};t.addEventListener("complete",a),t.addEventListener("error",o),t.addEventListener("abort",o)}),xs.set(t,e))}(t),xa(t,yn=yn||[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])?new Proxy(t,Es):t)}function Oe(t){var e;return t instanceof IDBRequest?function(t){var e=new Promise((s,n)=>{const r=()=>{t.removeEventListener("success",a),t.removeEventListener("error",o)},a=()=>{s(Oe(t.result)),r()},o=()=>{n(t.error),r()};t.addEventListener("success",a),t.addEventListener("error",o)});return e.then(s=>{s instanceof IDBCursor&&An.set(s,t)}).catch(()=>{}),Ss.set(e,t),e}(t):Ts.has(t)?Ts.get(t):((e=Ra(t))!==t&&(Ts.set(t,e),Ss.set(e,t)),e)}const Is=t=>Ss.get(t);const Ma=["get","getKey","getAll","getAllKeys","count"],Ca=["put","add","delete","clear"],Ns=new Map;function wn(t,e){if(t instanceof IDBDatabase&&!(e in t)&&"string"==typeof e){if(Ns.get(e))return Ns.get(e);const s=e.replace(/FromIndex$/,""),n=e!==s,r=Ca.includes(s);return s in(n?IDBIndex:IDBObjectStore).prototype&&(r||Ma.includes(s))?(t=async function(o,...c){o=this.transaction(o,r?"readwrite":"readonly");let u=o.store;return n&&(u=u.index(c.shift())),(await Promise.all([u[s](...c),r&&o.done]))[0]},Ns.set(e,t),t):void 0}}Es=(t=>({...t,get:(e,s,n)=>wn(e,s)||t.get(e,s,n),has:(e,s)=>!!wn(e,s)||t.has(e,s)}))(Es);const qt=()=>{},Ua=[qt,qt,qt,async function({db:t,tx:e}){var s=e.objectStore(U.STORE_NAME_1),n=e.objectStore(U.STORE_NAME_2),r=e.objectStore($.STORE_NAME_1),a=e.objectStore($.STORE_NAME_2);for(const c of await s.index(U.INDEX_STARTED_AT).getAll()){var l=function(t){return{...t,id:At()}}(c),u=(await n.add(l),await r.index($.INDEX_SESSION_ID).getAll(c.id));for(const h of u){var x=function(t,e){return{...t,id:At(),sessionId:e}}(h,l.id);await a.add(x)}}t.deleteObjectStore(s.name),t.deleteObjectStore(r.name)},async function({tx:t}){var e=t.objectStore($.STORE_NAME_2);for(const n of await e.getAll()){var r=mn(n);await e.put(r)}},qt,async function({tx:t,ctx:e}){var s=t.objectStore(U.STORE_NAME_2);for(const r of await s.getAll()){var a=Ht(r,e.installId);await s.put(a)}},async function({tx:t,ctx:e}){var a,s=t.objectStore(U.STORE_NAME_2);for(const r of await s.getAll())"host"in r&&(a=Ht(r,e.installId),await s.put(a))}];function et(t,e,s,n){t.indexNames.contains(e)?t.index(e):t.createIndex(e,s,n)}function ks({db:t,tx:e},s,n){return t.objectStoreNames.contains(s)?e.objectStore(s):t.createObjectStore(s,n)}const ja=W.V8;async function $a(t){const e=await t.getInstallId();return function(t,e,{blocked:s,upgrade:n,blocking:r,terminated:a}){const o=indexedDB.open(t,e),c=Oe(o);return n&&o.addEventListener("upgradeneeded",l=>{n(Oe(o.result),l.oldVersion,l.newVersion,Oe(o.transaction),l)}),s&&o.addEventListener("blocked",l=>s(l.oldVersion,l.newVersion,l)),c.then(l=>{a&&l.addEventListener("close",()=>a()),r&&l.addEventListener("versionchange",u=>r(u.oldVersion,u.newVersion,u))}).catch(()=>{}),c}("UsageSdkDb",ja,{async upgrade(s,n,r,a){s={db:s,oldVersion:n,newVersion:r,tx:a,ctx:{installId:e}};(function(t){var e=ks(t,U.STORE_NAME_LATEST,{keyPath:"id"}),e=(et(e,U.INDEX_STARTED_AT,"startedAt",{unique:!1}),et(e,U.INDEX_ENDED_AT,"endedAt",{unique:!1}),ks(t,ye.STORE_NAME_LATEST,{keyPath:"id"})),e=(et(e,ye.INDEX_STARTED_AT,"startedAt",{unique:!1}),et(e,ye.INDEX_ENDED_AT,"endedAt",{unique:!1}),ks(t,$.STORE_NAME_LATEST,{keyPath:"id"}));et(e,$.INDEX_SESSION_ID,"sessionId",{unique:!1}),et(e,$.INDEX_TIMESTAMP,"timestamp",{unique:!1})})(s),await async function(t,{logger:e}){if(0===t.oldVersion||null==t.newVersion)null!=e&&e.debug("[usage-database] Skipping migrations for new databases",{oldVersion:t.oldVersion,newVersion:t.newVersion});else{var s=t.oldVersion+1,n=t.newVersion,r=Ua.slice(s,n+1);if(0===r.length)null!=e&&e.log("[usage-database] No migrations to run");else{null!=e&&e.log(`[usage-database] Running migrations ${s} -> `+n);for(const a of r)await a(t)}}}(s,{logger:null})}})}Ys={exports:{}};!function(t,e){var n="__lodash_hash_undefined__",r=1,a=2,o=9007199254740991,c="[object Arguments]",l="[object Array]",u="[object AsyncFunction]",h="[object Boolean]",x="[object Date]",M="[object Error]",ee="[object Function]",oe="[object GeneratorFunction]",J="[object Map]",Ae="[object Number]",ve="[object Null]",ne="[object Object]",xt="[object Promise]",Os="[object Proxy]",Tt="[object RegExp]",tt="[object Set]",st="[object String]",_="[object Symbol]",A="[object Undefined]",N="[object WeakMap]",R="[object ArrayBuffer]",Z="[object DataView]",Ii=/^\[object .+?Constructor\]$/,Ni=/^(?:0|[1-9]\d*)$/,C={},Rn=(C["[object Float32Array]"]=C["[object Float64Array]"]=C["[object Int8Array]"]=C["[object Int16Array]"]=C["[object Int32Array]"]=C["[object Uint8Array]"]=C["[object Uint8ClampedArray]"]=C["[object Uint16Array]"]=C["[object Uint32Array]"]=!0,C[c]=C[l]=C[R]=C[h]=C[Z]=C[x]=C[M]=C[ee]=C[J]=C[Ae]=C[ne]=C[Tt]=C[tt]=C[st]=C[N]=!1,"object"==typeof wt&&wt&&wt.Object===Object&&wt),ki="object"==typeof self&&self&&self.Object===Object&&self,ki=Rn||ki||Function("return this")(),e=e&&!e.nodeType&&e,Mn=e&&t&&!t.nodeType&&t,Mn=Mn&&Mn.exports===e,Ms=Mn&&Rn.process,e=function(){try{return Ms&&Ms.binding&&Ms.binding("util")}catch{}}(),Rn=e&&e.isTypedArray;function Vi(i){var d=-1,f=Array(i.size);return i.forEach(function(g,L){f[++d]=[L,g]}),f}function Zi(i){var d=-1,f=Array(i.size);return i.forEach(function(g){f[++d]=g}),f}var e=Array.prototype,$i=Function.prototype,Kt=Object.prototype,Cs=ki["__core-js_shared__"],Dn=$i.toString,we=Kt.hasOwnProperty,Vn=($i=/[^.]+$/.exec(Cs&&Cs.keys&&Cs.keys.IE_PROTO||""))?"Symbol(src)_1."+$i:"",Un=Kt.toString,Bi=RegExp("^"+Dn.call(we).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Cs=Mn?ki.Buffer:void 0,$i=ki.Symbol,jn=ki.Uint8Array,$n=Kt.propertyIsEnumerable,Wi=e.splice,We=$i?$i.toStringTag:void 0,Bn=Object.getOwnPropertySymbols,Mn=Cs?Cs.isBuffer:void 0,Fi=function(i,d){return function(f){return i(d(f))}}(Object.keys,Object),e=nt(ki,"DataView"),Et=nt(ki,"Map"),Cs=nt(ki,"Promise"),Ds=nt(ki,"Set"),ki=nt(ki,"WeakMap"),It=nt(Object,"create"),Hi=He(e),qi=He(Et),Gi=He(Cs),Xi=He(Ds),Ki=He(ki),$i=$i?$i.prototype:void 0,Us=$i?$i.valueOf:void 0;function ze(i){var d=-1,f=null==i?0:i.length;for(this.clear();++d<f;){var g=i[d];this.set(g[0],g[1])}}function Ie(i){var d=-1,f=null==i?0:i.length;for(this.clear();++d<f;){var g=i[d];this.set(g[0],g[1])}}function Fe(i){var d=-1,f=null==i?0:i.length;for(this.clear();++d<f;){var g=i[d];this.set(g[0],g[1])}}function Jt(i){var d=-1,f=null==i?0:i.length;for(this.__data__=new Fe;++d<f;)this.add(i[d])}function Ce(i){i=this.__data__=new Ie(i);this.size=i.size}function vo(i,d){var D,f=ts(i),g=!f&&Po(i),L=!f&&!g&&Zs(i),b=!f&&!g&&!L&&Jn(i),j=f||g||L||b,z=j?function(i,d){for(var f=-1,g=Array(i);++f<i;)g[f]=d(f);return g}(i.length,String):[],q=z.length;for(D in i)!d&&!we.call(i,D)||j&&("length"==D||L&&("offset"==D||"parent"==D)||b&&("buffer"==D||"byteLength"==D||"byteOffset"==D)||function(i,d){return(d=null==d?o:d)&&("number"==typeof i||Ni.test(i))&&-1<i&&i%1==0&&i<d}(D,q))||z.push(D);return z}function Qt(i,d){for(var f=i.length;f--;)if(Gn(i[f][0],d))return f;return-1}function wo(i,d,f){d=d(i);return ts(i)?d:function(i,d){for(var f=-1,g=d.length,L=i.length;++f<g;)i[L+f]=d[f];return i}(d,f(i))}function Nt(i){return null==i?void 0===i?A:ve:(We&&We in Object(i)?function(i){var d=we.call(i,We),f=i[We];try{var g=!(i[We]=void 0)}catch{}var L=Un.call(i);return g&&(d?i[We]=f:delete i[We]),L}:function(i){return Un.call(i)})(i)}function zn(i){return kt(i)&&Nt(i)==c}function Fn(i,d,f,g,L){return i===d||(null==i||null==d||!kt(i)&&!kt(d)?i!=i&&d!=d:function(i,d,f,g,L,b){var j=ts(i),z=ts(d),q=j?l:Le(i),z=z?l:Le(d),re=(q=q==c?ne:q)==ne,he=(z=z==c?ne:z)==ne,z=q==z;if(z&&Zs(i)){if(!Zs(d))return!1;re=!(j=!0)}if(z&&!re)return b=b||new Ce,j||Jn(i)?Hn(i,d,f,g,L,b):function(i,d,f,g,L,b,j){switch(f){case Z:if(i.byteLength!=d.byteLength||i.byteOffset!=d.byteOffset)return!1;i=i.buffer,d=d.buffer;case R:return!(i.byteLength!=d.byteLength||!b(new jn(i),new jn(d)));case h:case x:case Ae:return Gn(+i,+d);case M:return i.name==d.name&&i.message==d.message;case Tt:case st:return i==d+"";case J:var z=Vi;case tt:var q=g&r;if(z=z||Zi,i.size!=d.size&&!q)return!1;q=j.get(i);if(q)return q==d;g|=a,j.set(i,d);q=Hn(z(i),z(d),g,L,b,j);return j.delete(i),q;case _:if(Us)return Us.call(i)==Us.call(d)}return!1}(i,d,q,f,g,L,b);if(!(f&r)){j=re&&we.call(i,"__wrapped__"),q=he&&we.call(d,"__wrapped__");if(j||q)return re=j?i.value():i,he=q?d.value():d,b=b||new Ce,L(re,he,f,g,b)}return z&&(b=b||new Ce,function(i,d,f,g,L,b){var j=f&r,z=qn(i),q=z.length,re=qn(d).length;if(q!=re&&!j)return!1;for(var he=q;he--;){var K=z[he];if(!(j?K in d:we.call(d,K)))return!1}re=b.get(i);if(re&&b.get(d))return re==d;var ue=!0;b.set(i,d),b.set(d,i);for(var Pe=j;++he<q;){K=z[he];var Qn,Ne=i[K],qe=d[K];if(!(void 0===(Qn=g?j?g(qe,Ne,K,d,i,b):g(Ne,qe,K,i,d,b):Qn)?Ne===qe||L(Ne,qe,f,g,b):Qn)){ue=!1;break}Pe=Pe||"constructor"==K}{var ns;ue&&!Pe&&(re=i.constructor,ns=d.constructor,re!=ns)&&"constructor"in i&&"constructor"in d&&!("function"==typeof re&&re instanceof re&&"function"==typeof ns&&ns instanceof ns)&&(ue=!1)}return b.delete(i),b.delete(d),ue}(i,d,f,g,L,b))}(i,d,f,g,Fn,L))}function xo(i){return Yn(i)&&!function(i){return Vn&&Vn in i}(i)&&(Xn(i)?Bi:Ii).test(He(i))}function So(i){if(!function(i){var d=i&&i.constructor,d="function"==typeof d&&d.prototype||Kt;return i===d}(i))return Fi(i);var f,d=[];for(f in Object(i))we.call(i,f)&&"constructor"!=f&&d.push(f);return d}function Hn(i,d,f,g,L,b){var j=f&r,z=i.length,q=d.length;if(z!=q&&!(j&&z<q))return!1;q=b.get(i);if(q&&b.get(d))return q==d;var re=-1,he=!0,K=f&a?new Jt:void 0;for(b.set(i,d),b.set(d,i);++re<z;){var Pe,de=i[re],ue=d[re];if(void 0!==(Pe=g?j?g(ue,de,re,d,i,b):g(de,ue,re,i,d,b):Pe)){if(Pe)continue;he=!1;break}if(K){if(!function(i,d){for(var f=-1,g=null==i?0:i.length;++f<g;)if(d(i[f],f,i))return 1}(d,function(Ne,qe){return!K.has(qe)&&(de===Ne||L(de,Ne,f,g,b))&&K.push(qe)})){he=!1;break}}else if(de!==ue&&!L(de,ue,f,g,b)){he=!1;break}}return b.delete(i),b.delete(d),he}function qn(i){return wo(i,Uo,ko)}function es(i,d){i=i.__data__;return function(i){var d=typeof i;return"string"==d||"number"==d||"symbol"==d||"boolean"==d?"__proto__"!==i:null===i}(d)?i["string"==typeof d?"string":"hash"]:i.map}function nt(i,d){i=function(i,d){return null==i?void 0:i[d]}(i,d);return xo(i)?i:void 0}ze.prototype.clear=function(){this.__data__=It?It(null):{},this.size=0},ze.prototype.delete=function(i){return i=this.has(i)&&delete this.__data__[i],this.size-=i?1:0,i},ze.prototype.get=function(i){var f,d=this.__data__;return It?(f=d[i])===n?void 0:f:we.call(d,i)?d[i]:void 0},ze.prototype.has=function(i){var d=this.__data__;return It?void 0!==d[i]:we.call(d,i)},ze.prototype.set=function(i,d){var f=this.__data__;return this.size+=this.has(i)?0:1,f[i]=It&&void 0===d?n:d,this},Ie.prototype.clear=function(){this.__data__=[],this.size=0},Ie.prototype.delete=function(i){var d=this.__data__;return!((i=Qt(d,i))<0||(i==d.length-1?d.pop():Wi.call(d,i,1),--this.size,0))},Ie.prototype.get=function(i){var d=this.__data__;return(i=Qt(d,i))<0?void 0:d[i][1]},Ie.prototype.has=function(i){return-1<Qt(this.__data__,i)},Ie.prototype.set=function(i,d){var f=this.__data__,g=Qt(f,i);return g<0?(++this.size,f.push([i,d])):f[g][1]=d,this},Fe.prototype.clear=function(){this.size=0,this.__data__={hash:new ze,map:new(Et||Ie),string:new ze}},Fe.prototype.delete=function(i){return i=es(this,i).delete(i),this.size-=i?1:0,i},Fe.prototype.get=function(i){return es(this,i).get(i)},Fe.prototype.has=function(i){return es(this,i).has(i)},Fe.prototype.set=function(i,d){var f=es(this,i),g=f.size;return f.set(i,d),this.size+=f.size==g?0:1,this},Jt.prototype.add=Jt.prototype.push=function(i){return this.__data__.set(i,n),this},Jt.prototype.has=function(i){return this.__data__.has(i)},Ce.prototype.clear=function(){this.__data__=new Ie,this.size=0},Ce.prototype.delete=function(i){var d=this.__data__,i=d.delete(i);return this.size=d.size,i},Ce.prototype.get=function(i){return this.__data__.get(i)},Ce.prototype.has=function(i){return this.__data__.has(i)},Ce.prototype.set=function(i,d){var f=this.__data__;if(f instanceof Ie){var g=f.__data__;if(!Et||g.length<199)return g.push([i,d]),this.size=++f.size,this;f=this.__data__=new Fe(g)}return f.set(i,d),this.size=f.size,this};var ko=Bn?function(i){return null==i?[]:(i=Object(i),function(i,d){for(var f=-1,g=null==i?0:i.length,L=0,b=[];++f<g;){var j=i[f];d(j,f,i)&&(b[L++]=j)}return b}(Bn(i),function(d){return $n.call(i,d)}))}:function(){return[]},Le=Nt;function He(i){if(null!=i){try{return Dn.call(i)}catch{}try{return i+""}catch{}}return""}function Gn(i,d){return i===d||i!=i&&d!=d}(e&&Le(new e(new ArrayBuffer(1)))!=Z||Et&&Le(new Et)!=J||Cs&&Le(Cs.resolve())!=xt||Ds&&Le(new Ds)!=tt||ki&&Le(new ki)!=N)&&(Le=function(i){var d=Nt(i),i=d==ne?i.constructor:void 0,i=i?He(i):"";if(i)switch(i){case Hi:return Z;case qi:return J;case Gi:return xt;case Xi:return tt;case Ki:return N}return d});var Po=zn(function(){return arguments}())?zn:function(i){return kt(i)&&we.call(i,"callee")&&!$n.call(i,"callee")},ts=Array.isArray;var Zs=Mn||function(){return!1};function Xn(i){if(Yn(i))return(i=Nt(i))==ee||i==oe||i==u||i==Os}function Kn(i){return"number"==typeof i&&-1<i&&i%1==0&&i<=o}function Yn(i){var d=typeof i;return null!=i&&("object"==d||"function"==d)}function kt(i){return null!=i&&"object"==typeof i}var Jn=Rn?function(i){return function(d){return i(d)}}(Rn):function(i){return kt(i)&&Kn(i.length)&&!!C[Nt(i)]};function Uo(i){return(function(i){return null!=i&&Kn(i.length)&&!Xn(i)}(i)?vo:So)(i)}t.exports=function(i,d){return Fn(i,d)}}(Ys,Ys.exports);const za=Ys.exports;function bn(t,e){if(t="string"==typeof t?function(t){if(t){var e=s=>{s=new URL(s);if(!/^https?:/.test(s.protocol))throw Error("Invalid URL, ignored protocol found");if(!s.hostname)throw Error("Invalid URL, no hostname");if(s.hostname.lastIndexOf(".")>=s.hostname.length-2)throw Error("Invalid URL, bad domain ending");return s};try{return e(t)}catch{}if(!t.includes("://"))try{return e("https://"+t)}catch{}}}(t.trim()):t){let s=null==(e=null==e?void 0:e.removeGenericPrefixes)||e,n=t.hostname;return{hostname:n=s?n.replace(/^(www|m|mobile|amp|checkout|secure|account|accounts)\./,""):n,path:function(t){return t.endsWith("/")?t.substring(0,Math.max(1,t.length-1)):t}(t.pathname)}}}const Gt="tab-history-map",xn=class{constructor(t){this.tabHistoryMap=this.restoreTabHistory(),this.lock=new un;let e=0;O.tabs.onCreated.addListener(s=>this.lock.runExclusive(async()=>{var n;null!=s.id&&(null!=t&&t.debug(`[referrer] ${e++} tabs.onCreated`,s),null!=s.openerTabId)&&(n=null==(n=(await this.tabHistoryMap)[s.openerTabId])?void 0:n[0])&&await this.addHistory(s.id,n)})),O.webNavigation.onCommitted.addListener(s=>this.lock.runExclusive(async()=>{null!=t&&t.debug(`[referrer] ${e++} webNavigation.onCommitted`,s);var{frameId:n,tabId:r,url:a,transitionQualifiers:o}=s;0===n&&((o.includes("forward_back")||o.includes("from_address_bar"))&&await this.addHistory(r,void 0),await this.addHistory(r,a))})),O.runtime.onStartup.addListener(()=>this.resetHistory()),O.runtime.onSuspend.addListener(()=>this.resetHistory()),O.tabs.onRemoved.addListener(s=>this.removeHistory(s))}async restoreTabHistory(){var t=await vs(Gt);return null!=t?t:{}}async addHistory(t,e){var s=await this.tabHistoryMap,r=null!=(r=s[t])?r:s[t]=[];e!==r[0]&&r.unshift(this.sanatizeReferrerUrl(e)),r.splice(xn.MAX_HISTORY_COUNT_PER_TAB),await bt(Gt,s)}sanatizeReferrerUrl(t){if(t)try{var e=new URL(t);return e.search="",e.username="",e.password="",e.hash="",e.href}catch{}}getReferrerFor(t,e){return this.lock.runExclusive(async()=>{var n,r;return null==t||!e||null==(n=(await this.tabHistoryMap)[t])||-1===(r=n.findIndex(a=>a===e))?void 0:n[r+1]})}resetHistory(){return bt(Gt,{})}async removeHistory(t){var e=await this.tabHistoryMap;delete e[t],await bt(Gt,e)}};let Tn=xn;Tn.MAX_HISTORY_COUNT_PER_TAB=10;class Sn{constructor(){this.map={}}markAsProcessed(e){e.forEach(s=>this.map[s.id]=!0)}isProcessed(e){return null!=(e=this.map[e.id])&&e}}const _e=class{constructor(t,e){this.wakeUpTimeoutDisabled=!1,this.hasRecentUserActivity=!0,this.sessionUpdatedListeners=[],this.pageViewUpdatedListeners=[],this.checkSessionsListeners=[],this.latestTriggerId=0,this.updateSessions=function(t){const e=new un;return(...s)=>e.runExclusive(()=>t(...s))}(async r=>{var c,M,x,a=`[update-sessions] [${r.triggerId}]`;null!=(c=this.logger)&&c.debug(a+" Waiting for startup to stop previous sessions..."),await this.startupPromise,null!=(c=this.logger)&&c.debug(a+" Processing @ "+new Date(r.timestamp).toLocaleTimeString()),this.pingLastAliveAt(),this.invokeCheckSessionsListeners(),await this.config.enabled()&&(c=this.logger?new ra(this.logger.debug.bind(this.logger)):void 0,x=await this.getComputeDependencies(),null!=c&&c.log(a+" Got required data after {duration}"),M=this.findSessionChanges(r,x),null!=c&&c.log(a+" Computed session changes after {duration}"),x=await this.findPageViewChanges(r,x),null!=c&&c.log(a+" Computed page view changes after {duration}"),await this.saveSessionChanges(r.timestamp,M),null!=c&&c.log(a+" Session changes committed to the database after {duration}"),await this.savePageViewChanges(r.timestamp,x),null!=c)&&c.log(a+" Page view changes committed to the database after {duration}"),null!=(M=this.logger)&&M.log(a+" Done")}),this.config=e,this.sessionsRepo=t.sessionsRepo,this.pageViewsRepo=t.pageViewsRepo,this.updateSessions=this.updateSessions.bind(this),void 0===e.logger?this.logger=console:this.logger=e.logger;var[t,e]=function(){let t,e;return[new Promise((n,r)=>{t=n,e=r}),t,e]}();this.startupPromise=t,this.allowSessionUpdates=e}setupTriggers(){var t,e;this.referrers=new Tn(this.logger),null!=(e=(t=this.config).setupCustomTriggers)&&e.call(t,{triggerSessionChangeCheck:this.basicTrigger.bind(this),setHasRecentUserActivity:this.setHasRecentUserActivity.bind(this)}),this.setupExtensionApiTriggers(),this.setupIdleTriggers(),this.setupStartupTriggers()}addSessionUpdatedListener(t){this.sessionUpdatedListeners.push(t)}addPageViewUpdatedListener(t){this.pageViewUpdatedListeners.push(t)}addCheckSessionsListener(t){this.checkSessionsListeners.push(t)}setupExtensionApiTriggers(){O.webNavigation.onCompleted.addListener(async t=>{0<t.frameId||await this.basicTrigger("webNavigation.onCompleted",Math.floor(t.timeStamp))}),O.tabs.onCreated.addListener(()=>this.basicTrigger("tabs.onCreated")),O.tabs.onUpdated.addListener(()=>this.basicTrigger("tabs.onUpdated")),O.tabs.onActivated.addListener(()=>this.basicTrigger("tabs.onActivated")),O.tabs.onRemoved.addListener(()=>this.basicTrigger("tabs.onRemoved")),O.windows.onCreated.addListener(()=>this.basicTrigger("windows.onCreated")),O.windows.onFocusChanged.addListener(()=>this.basicTrigger("windows.onFocusChanged")),O.windows.onRemoved.addListener(()=>this.basicTrigger("windows.onRemoved")),this.onWindowStateChanged(t=>this.basicTrigger("SessionMonitor.onWindowStateChanged",t))}setupIdleTriggers(){}setupStartupTriggers(){const t=Date.now();this.config.isOnStartupAvailable()?(O.runtime.onStartup.addListener(()=>{this.wakeUpTimeoutDisabled=!0,this.startupFlow({cleanupSessions:!0,trigger:"runtime.onStartup",timestamp:t})}),setTimeout(()=>{this.wakeUpTimeoutDisabled||this.startupFlow({cleanupSessions:!1,trigger:"setTimeout",timestamp:t})},_e.ALWAYS_STARTUP_AFTER_MS)):(O.alarms.clear("ping-last-alive-at"),O.alarms.create("ping-last-alive-at",{delayInMinutes:_e.LAST_ALIVE_AT_INTERVAL_MS/1e3,periodInMinutes:_e.LAST_ALIVE_AT_INTERVAL_MS/1e3}),O.alarms.onAlarm.addListener(s=>{if("ping-last-alive-at"===s.name)return this.pingLastAliveAt()}),this.getLastAliveAt().then(s=>{this.wakeUpTimeoutDisabled=!0;s=null!=s&&Date.now()-s>2*_e.LAST_ALIVE_AT_INTERVAL_MS;this.startupFlow({cleanupSessions:s,trigger:s?"time since last alive at > 2 * lastAliveInterval":"time since last alive at <= 2 * lastAliveInterval",timestamp:t})})),O.runtime.onInstalled.addListener(s=>{this.wakeUpTimeoutDisabled=!0,this.startupFlow({cleanupSessions:"install"!==s.reason,trigger:"runtime.onInstalled",timestamp:t})});var e=O.runtime["onSuspend"];null!=e&&e.addListener(()=>this.endAllActiveSessions(Date.now()))}basicTrigger(t,e=Date.now()){var n,s=this.latestTriggerId++;return null!=(n=this.logger)&&n.log(`[update-sessions] [${s}] Queued by ${t} @ `+new Date(e).toLocaleTimeString()),this.updateSessions({timestamp:e,triggerId:s,triggeredBy:t})}onWindowStateChanged(t){let e={};this.getWindowStates().then(s=>{e=s}),setInterval(async()=>{var s=Date.now(),n=await this.getWindowStates();za(e,n)||(t(s),e=n)},_e.WINDOW_STATE_POLLING_INTERVAL_MS)}async getWindowStates(){return(await O.windows.getAll()).reduce((e,s)=>(null!=s.id&&(e[s.id]=s.state),e),{})}async startupFlow({cleanupSessions:t,trigger:e,timestamp:s}){t&&await this.cleanupActiveSessionsOnStartup(s),await this.pingLastAliveAt(),await new Promise(t=>setTimeout(t,0)).then(()=>this.allowSessionUpdates()),await this.basicTrigger(e,s)}async cleanupActiveSessionsOnStartup(t){var o,e=await this.getLastAliveAt();if(null!=(r=this.logger)&&r.debug("[on-startup] onStartup()",{lastActivity:e&&new Date(e).toISOString(),now:new Date(t).toISOString()}),null==e)throw Error("lastActivity was not set yet");null!=(r=this.logger)&&r.log("[on-startup] Ending sessions after quit...");var r=e+_e.LAST_ALIVE_AT_POLL_INTERVAL_MS,n=Math.min(t,r);null!=(o=this.logger)&&o.log("[on-startup] Timing details:",{lastActivity:new Date(e).toISOString(),now:new Date(t).toISOString(),quitAt:new Date(r).toISOString(),endAt:new Date(n).toISOString()}),await this.endAllActiveSessions(n),null!=(o=this.logger)&&o.log("[on-startup] Startup finished!")}async getComputeDependencies(){var[t,e]=await Promise.all([O.windows.getAll(),O.tabs.query({})]),s=await this.sessionsRepo.getActiveSessions(),n=await this.pageViewsRepo.getActivePageViews();return{isTabActiveWhenPlayingAudio:await this.config.isTabActiveWhenPlayingAudio(),hostnameToTabsMap:e.reduce((r,a)=>{var c=null==(c=bn(a.url))?void 0:c.hostname;return c&&(null==r[c]&&(r[c]=[]),null!=(c=r[c])&&c.push(a)),r},{}),allActiveSessions:s,allActivePageViews:n,appIdToActiveSessionMap:ca(null!=s?s:[],"appId"),windowIdToWindowMap:da(t,"id"),processedActiveSessionCache:new Sn,processedActivePageViewCache:new Sn}}findSessionChanges(t,e){var a,o,l,u;const s=[],n=[];for([l,u]of Object.entries(e.hostnameToTabsMap))if(l)try{if(null==u||!u.length)throw Error("This shouldn't be possible");var h=e.appIdToActiveSessionMap[l],x=!(null==h||!h.length),M=!!u.find(ee=>this.isTabActive(ee,e));!x&&M?s.push({appId:l,startedAt:t.timestamp}):x&&!M&&n.push(...h),x&&e.processedActiveSessionCache.markAsProcessed(h)}catch(h){null!=(a=this.logger)&&a.error(`[update-sessions] Failed find sessions to change for ${l}:`,h)}return(null!=(o=null==(o=e.allActiveSessions)?void 0:o.filter(l=>!e.processedActiveSessionCache.isProcessed(l)))?o:[]).forEach(l=>n.push(l)),{toStart:s,toEnd:n,count:s.length+n.length}}async findPageViewChanges(t,e){var s=Object.values(e.hostnameToTabsMap).flat().filter(o=>!!o&&this.isTabActive(o,e)),n=[],r=[...e.allActivePageViews];for(const o of s){const c=bn(o.url);if(null!=c){var l=e.allActivePageViews.filter(u=>u.appId===(null==c?void 0:c.hostname)&&u.path===c.path);if(0<l.length)for(const u of l){var h=r.findIndex(x=>x.id===u.id);0<=h&&r.splice(h,1)}else n.push({appId:c.hostname,path:c.path,startedAt:t.timestamp,referrer:await(null==(l=this.referrers)?void 0:l.getReferrerFor(o.id,o.url))})}}return{toStart:n,toEnd:r,count:n.length+r.length}}async saveSessionChanges(t,e){var s=e.toEnd.map(o=>{var l,c=new Date(t).toLocaleTimeString();return null!=(l=this.logger)&&l.log(`[change-session] Stop session ${o.appId} @ ${c} (${t-o.startedAt}ms)`),this.sessionsRepo.endSession(o,t)}),n=e.toStart.map(o=>{var c;return null!=(c=this.logger)&&c.log(`[change-session] Start session ${o.appId} @ `+new Date(o.startedAt).toLocaleTimeString(),{session:o}),this.sessionsRepo.startSession(o)}),s=await Promise.allSettled(s),n=await Promise.allSettled(n);this.logSettledErrors("ending",s),this.logSettledErrors("starting",n),0<e.count&&this.invokeSessionUpdatedListeners()}async savePageViewChanges(t,e){var s=e.toEnd.map(o=>{var l,c=new Date(t).toLocaleTimeString();return null!=(l=this.logger)&&l.log(`[change-session] Stop page view ${o.appId}${o.path} @ ${c} (${t-o.startedAt}ms)`),this.pageViewsRepo.endPageView(o,t)}),n=e.toStart.map(o=>{var c;return null!=(c=this.logger)&&c.log(`[change-session] Start page view ${o.appId}${o.path} @ `+new Date(o.startedAt).toLocaleTimeString(),{session:o}),this.pageViewsRepo.startPageView(o)}),s=await Promise.allSettled(s),n=await Promise.allSettled(n);this.logSettledErrors("ending",s),this.logSettledErrors("starting",n),0<e.count&&this.invokePageViewUpdatedListeners()}logSettledErrors(t,e){var n,s=e.map(r=>{if("rejected"===r.status)return r.reason}).filter(r=>null!=r);0<s.length&&null!=(n=this.logger)&&n.warn(`[update-sessions] ${s.length}/${e.length} transations failed when ${t} sessions`,s)}isTabActive(t,e){var n;return null==t.windowId?(null!=(n=this.logger)&&n.warn("[update-sessions] Checking if tab without a windowId is active"),!1):!!(n=e.windowIdToWindowMap[t.windowId])&&function(t,e,s,n){return n&&t.audible||t.active&&e.focused&&function(t){return"docked"!==t.state&&"minimized"!==t.state}(e)&&s}(t,n,this.hasRecentUserActivity,e.isTabActiveWhenPlayingAudio)}async endAllActiveSessions(t){var s,e=await this.sessionsRepo.getActiveSessions();0===e.length?null!=(s=this.logger)&&s.log("[stop-active-sessions] No active sessions to stop"):(null!=(s=this.logger)&&s.log("[stop-active-sessions] Stopping all active sessions:",{activeSessions:e,timestamp:t}),await this.saveSessionChanges(t,{toStart:[],toEnd:e,count:e.length}),null!=(s=this.logger)&&s.log("[stop-active-sessions] All active sessions stopped!"))}async pingLastAliveAt(){var e,t=Date.now();null!=(e=this.logger)&&e.debug("[SessionMonitor] Updating last time browser was known to be open",t),await bt(_e.LAST_ALIVE_AT_KEY,t),clearTimeout(this.lastAlivePing),this.lastAlivePing=setTimeout(()=>this.pingLastAliveAt(),_e.LAST_ALIVE_AT_POLL_INTERVAL_MS)}getLastAliveAt(){return vs(_e.LAST_ALIVE_AT_KEY)}invokeCheckSessionsListeners(){this.checkSessionsListeners.forEach(t=>t())}invokeSessionUpdatedListeners(){this.sessionUpdatedListeners.forEach(t=>t())}invokePageViewUpdatedListeners(){this.pageViewUpdatedListeners.forEach(t=>t())}setHasRecentUserActivity(t){this.hasRecentUserActivity=t}};let $e=_e;$e.LAST_ALIVE_AT_KEY="last-activity-time-ms",$e.LAST_ALIVE_AT_INTERVAL_MS=6e4,$e.LAST_ALIVE_AT_POLL_INTERVAL_MS=3e4,$e.ALWAYS_STARTUP_AFTER_MS=5e3,$e.WINDOW_STATE_POLLING_INTERVAL_MS=5e3;var En=1/0,In=9007199254740991,Ga=17976931348623157e292,Nn=NaN,Xa="[object Function]",Ka="[object GeneratorFunction]",Ya="[object Symbol]",Ja=/^\s+|\s+$/g,Qa=/^[-+]0x[0-9a-f]+$/i,ei=/^0b[01]+$/i,ti=/^0o[0-7]+$/i,si=/^(?:0|[1-9]\d*)$/,ni=parseInt,kn=Object.prototype.toString,ai=Math.ceil,ii=Math.max;function di(t,e,s){var n;if(Xt(s))return("number"==(n=typeof e)?function(t){return null!=t&&function(t){return"number"==typeof t&&-1<t&&t%1==0&&t<=In}(t.length)&&!function(t){t=Xt(t)?kn.call(t):"";return t==Xa||t==Ka}(t)}(s)&&function(t,e){return(e=null==e?In:e)&&("number"==typeof t||si.test(t))&&-1<t&&t%1==0&&t<e}(e,s.length):"string"==n&&e in s)&&function(t,e){return t===e||t!=t&&e!=e}(s[e],t)}function Xt(t){var e=typeof t;return t&&("object"==e||"function"==e)}var vi=function(t,e,s){e=(s?di(t,e,s):void 0===e)?1:ii(function(t){var t=function(t){return t?(t=function(t){if("number"==typeof t)return t;if(function(t){return"symbol"==typeof t||function(t){return t&&"object"==typeof t}(t)&&kn.call(t)==Ya}(t))return Nn;Xt(t)&&(t=Xt(e="function"==typeof t.valueOf?t.valueOf():t)?e+"":e);if("string"!=typeof t)return 0===t?t:+t;t=t.replace(Ja,"");var e=ei.test(t);return e||ti.test(t)?ni(t.slice(2),e?2:8):Qa.test(t)?Nn:+t}(t))!==En&&t!==-En?t==t?t:0:(t<0?-1:1)*Ga:0===t?t:0}(t),s=t%1;return t==t?s?t-s:t:0}(e),0);var n=t?t.length:0;if(!n||e<1)return[];for(var r=0,a=0,o=Array(ai(n/e));r<n;)o[a++]=function(t,e,s){var n=-1,r=t.length;(s=r<s?r:s)<0&&(s+=r),r=s<(e=e<0?r<-e?0:r+e:e)?0:s-e>>>0,e>>>=0;for(var a=Array(r);++n<r;)a[n]=t[n+e];return a}(t,r,r+=e);return o};const wi=100;function bi(t){const e=void 0===t.logger?console:t.logger;async function n(a,o){var c,l;try{null!=e&&e.log(`[${a.label}-uploader] Beginning upload @ `+new Date(o).toISOString());var[u,h,x]=await Promise.all([a.getLastUploadedAt(),t.db,t.enabled()]);if(x){var M=await a.getModelsToUpload({db:h,lastUploadedAt:u,uploadStartedAt:o}),ee=null!=(l=await(null==(c=t.getUploadBatchSize)?void 0:c.call(t)))?l:wi,oe=vi(M,ee),J=await async function(){var[a,o]=await Promise.all([t.getAppId(),t.getInstallId()]);return{appId:a,installId:o}}();null!=e&&e.debug(`[${a.label}-uploader] Data`,{models:M,batches:oe,body:J});for(const ve of oe){null!=e&&e.debug(`[${a.label}-uploader] Uploading`,{batch:ve,requestSkipped:!!t.dev}),t.dev||await a.upload(J,ve);var ne=ve[ve.length-1];null!=(null==ne?void 0:ne.endedAt)&&await a.setLastUploadedAt(ne.endedAt)}await a.setLastUploadedAt(o);var Ae=(Date.now()-o)/1e3;null!=e&&e.log(`[${a.label}-uploader] Uploaded ${M.length} items in ${oe.length} batches in ${Ae}s`),a.onSuccess({total:M.length,batches:oe.length,batchSize:ee,durationInSec:Ae})}else null!=e&&e.log(`[${a.label}-uploader] Uploads are disabled`)}catch(u){null!=e&&e.error(`[${a.label}-uploader] Failed to upload`,u),a.onFailure(u)}}return{uploadAll:async function(){const a=Date.now();await Promise.allSettled(t.uploaders.map(o=>n(o,a)))}}}return F.Ad=ms,F.DatabaseVersions=W,F.IdbAdsRepo=$,F.IdbPageViewsRepo=ye,F.IdbSessionsRepo=U,F.OldUsageBackupJson=ha,F.PageView=an,F.PageViewEntity=rn,F.Session=ps,F.SessionEntity=nn,F.SessionMonitor=$e,F.UsageBackupJson=pn,F.defineWebUsageUploader=function(t){var e=function({api:t,onSuccess:e,onFailure:s,lastUploadedAtStorageKey:n}){return{label:"sessions",onSuccess:e,onFailure:s,async getLastUploadedAt(){var r=await vs(n);return null!=r?r:1},setLastUploadedAt(r){return bt(n,r)},async getModelsToUpload({db:r,lastUploadedAt:a,uploadStartedAt:o}){return(await r.sessionsRepo.findSessionsByEndedAt(a,o)).filter(l=>!l.imported)},async upload(r,a){a=a.reduce((c,l)=>{var h;if(null==l.endedAt)throw Error("Cannot upload a session that is in progress");var u={duration:Ft(l.endedAt-l.startedAt),timestamp:Ft(l.startedAt)};return 0<u.duration&&(null==c[h=l.appId]&&(c[h]={sessions:[]}),c[l.appId].sessions.push(u)),c},{});await t.uploadSessions({...r,websites:a})}}}({api:t.api,...t.sessions}),s=function({api:t,onSuccess:e,onFailure:s,lastUploadedAtStorageKey:n,getHostnameAllowlist:r}){return{label:"page-views",onSuccess:e,onFailure:s,async getLastUploadedAt(){var o=(await O.storage.local.get(n))[n];return null!=o?o:1},setLastUploadedAt(a){return O.storage.local.set({[n]:a})},async getModelsToUpload({db:a,lastUploadedAt:o,uploadStartedAt:c}){const l=await a.pageViewsRepo.findPageViewsByEndedAt(o,c),u=null!=(a=await r())?a:[];return l.filter(x=>!x.imported&&u.includes(x.appId))},async upload(a,o){o=o.reduce((l,u)=>{var x,oe;if(null==u.endedAt)throw Error("Cannot upload a page view that is in progress");var h={duration:Ft(u.endedAt-u.startedAt),timestamp:Ft(u.startedAt),referrer:u.referrer};return 0<h.duration&&(null==l[x=u.appId]&&(l[x]={}),null==(x=l[u.appId])[oe=u.path]&&(x[oe]={page_views:[]}),l[u.appId][u.path].page_views.push(h)),l},{});await t.uploadPageViews({...a,websites:o})}}}({api:t.api,...t.pageViews});return bi({...t,uploaders:[e,s]})},F.initUsageSdkInBackground=function(t){return(t=new $e(t.db,t)).setupTriggers(),{sessionMonitor:t}},F.openIdbUsageDatabase=function(t){const e=$a(t),s=void 0===t.logger?console:t.logger;return{indexedDb:e,sessionsRepo:new U({db:e,...t}),pageViewsRepo:new ye({db:e,...t}),adsRepo:new $({db:e,...t}),exportBackup:()=>async function(t){var s={version:(t=await t).version,stores:{}},n=fn(t),r=t.transaction(n,"readonly");for(const a of n){var c=await r.objectStore(a).getAll();c.forEach(l=>{delete l.imported}),s.stores[a]=c}return await r.done,s}(e),importBackup:n=>ya({dbPromise:e,usageBackup:n,getInstallId:t.getInstallId,logger:s})}},Object.defineProperties(F,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),F}({});"function"==typeof define&&define.amd&&define(()=>webExtUsage);