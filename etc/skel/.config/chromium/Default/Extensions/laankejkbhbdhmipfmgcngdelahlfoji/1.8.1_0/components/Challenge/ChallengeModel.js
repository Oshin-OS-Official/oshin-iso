define(["core/Logger","core/CoreAPI"],function(Logger,API){return class{bp=null;defaultText=null;keyCounter=0;minLength=0;required=null;text=null;constructor(){var bpArray=["s","b","p","a","y"];this.bp="_"+bpArray[1]+bpArray[4]+bpArray[2]+bpArray[3]+bpArray[0]+bpArray[0],this.addListeners()}addListeners(){var self=this;API.PubSub.listen("ChallengeModel.text.set",function(message,payload){self.text=payload.text})}load(onLoaded){this.defaultText=API.Chrome.Translation.get("defaultChallengeText"),this.minLength=decodeURIComponent(this.defaultText).length,this.required=API.Settings.get("challengeRequired"),this.clearProductivityBypass(),"function"==typeof onLoaded&&onLoaded()}setRequired(required){API.Analytics.event("TOGGLE_SETTINGS_CHALLENGE_REQUIRED",{required:required}),API.Settings.set({challengeRequired:required}),this.required=required}isRequired(){return!0===this.required}getText(useDefault){return useDefault?this.text=this.defaultText:this.text||(this.text=API.Settings.get("challengeText"),this.text="string"==typeof this.text?decodeURIComponent(this.text):this.defaultText,this.text.length<this.minLength&&(this.text=this.defaultText)),this.text}setText(newText){return this.isEnglish(newText)?this.isLongEnough(newText)?this.isUniqueEnough(newText)?(newText=(newText=(newText=(newText=newText.split("\n").join(" ")).split("\r").join(" ")).split("\t").join(" ")).replace(/ +(?= )/g,""),newText=API.Utils.sanitizeMSWordChars(newText),void API.Settings.set({challengeText:encodeURIComponent(newText)},function(){API.PubSub.publish("ChallengeModel.text.set",{text:newText}),alert(API.Chrome.Translation.get("challengeTextSet"))})):(alert(API.Chrome.Translation.get("notEnoughVariation")),!1):(alert(API.Chrome.Translation.get("challengeTextTooShort",this.minLength.toString())),!1):(alert(API.Chrome.Translation.get("englishCharsOnly")),!1)}resetText(){this.setText(this.defaultText)}setProductivityBypass(){API.Settings.set({productivityBypass:!0})}clearProductivityBypass(){API.Settings.remove("productivityBypass")}isProductivityBypassActive(){return!0===API.Settings.get("productivityBypass")}isRightLength(inputText){return this.keyCounter===inputText.length}isLongEnough(text){return text.length>=this.minLength}isUniqueEnough(text){for(var usedLetters=[],i=0;i<text.length;i++){var thisLetter=text.charAt(i);usedLetters.inArray(thisLetter)||usedLetters.push(thisLetter)}return 5<=usedLetters.length}isCorrect(inputText){var sourceSnippet=this.text.substring(0,inputText.length),bpSnippet=this.bp.substring(0,inputText.length);return inputText===sourceSnippet||inputText===bpSnippet}isEnglish(inputText){return!inputText.match(/[^\x00-\x7F]+/)}isComplete(inputText){return inputText.length===this.text.length||inputText===this.bp}isIgnoredKey(keyCode){switch(keyCode){case 8:case 9:case 16:case 17:case 18:case 20:case 45:case 46:return!0}return!1}getKeyCounter(){return this.keyCounter}updateKeyCounter(){this.keyCounter++}resetKeyCounter(){this.keyCounter=0}}});